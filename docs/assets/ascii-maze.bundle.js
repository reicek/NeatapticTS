"use strict";(()=>{var ge=Object.defineProperty;var bo=Object.getOwnPropertyDescriptor;var Ao=Object.getOwnPropertyNames;var So=Object.prototype.hasOwnProperty;var zt=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var H=(e,t)=>()=>(e&&(t=e(e=0)),t);var No=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ht=(e,t)=>{for(var n in t)ge(e,n,{get:t[n],enumerable:!0})},vo=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of Ao(t))!So.call(e,o)&&o!==n&&ge(e,o,{get:()=>t[o],enumerable:!(s=bo(t,o))||s.enumerable});return e};var K=e=>vo(ge({},"__esModule",{value:!0}),e);var Tt,Ot,Ht,Rt,dt,Nt=H(()=>{"use strict";lt();Tt=Symbol("connGain"),Ot=Symbol("connGater"),Ht=Symbol("connOptMoments"),Rt=Symbol("connPlasticRate"),dt=class e{from;to;weight;eligibility;previousDeltaWeight;totalDeltaWeight;xtrace;innovation;_flags;constructor(t,n,s){this.from=t,this.to=n,this.weight=s??Math.random()*.2-.1,this.eligibility=0,this.previousDeltaWeight=0,this.totalDeltaWeight=0,this.xtrace={nodes:[],values:[]},this._flags=3,this.innovation=e._nextInnovation++}toJSON(){let t={from:this.from.index??void 0,to:this.to.index??void 0,weight:this.weight,gain:this.gain,innovation:this.innovation,enabled:this.enabled};if(this._flags&4){let n=this[Ot];n&&typeof n.index<"u"&&(t.gater=n.index)}return t}static innovationID(t,n){return .5*(t+n)*(t+n+1)+n}static _nextInnovation=1;static resetInnovationCounter(t=1){e._nextInnovation=t}static _pool=[];static acquire(t,n,s){let o;return e._pool.length?(o=e._pool.pop(),o.from=t,o.to=n,o.weight=s??Math.random()*.2-.1,o[Tt]!==void 0&&delete o[Tt],o[Ot]!==void 0&&delete o[Ot],o._flags=3,o.eligibility=0,o.previousDeltaWeight=0,o.totalDeltaWeight=0,o.xtrace.nodes.length=0,o.xtrace.values.length=0,o[Ht]&&delete o[Ht],o.innovation=e._nextInnovation++):o=new e(t,n,s),o}static release(t){e._pool.push(t)}get enabled(){return(this._flags&1)!==0}set enabled(t){this._flags=t?this._flags|1:this._flags&-2}get dcMask(){return(this._flags&2)!==0?1:0}set dcMask(t){this._flags=t?this._flags|2:this._flags&-3}get hasGater(){return(this._flags&4)!==0}get plastic(){return(this._flags&8)!==0}set plastic(t){t?this._flags|=8:this._flags&=-9,!t&&this[Rt]!==void 0&&delete this[Rt]}get gain(){return this[Tt]===void 0?1:this[Tt]}set gain(t){t===1?this[Tt]!==void 0&&delete this[Tt]:this[Tt]=t}_ensureOptBag(){let t=this[Ht];return t||(t={},this[Ht]=t),t}_getOpt(t){let n=this[Ht];return n?n[t]:void 0}_setOpt(t,n){if(n===void 0){let s=this[Ht];s&&delete s[t]}else this._ensureOptBag()[t]=n}get firstMoment(){return this._getOpt("firstMoment")}set firstMoment(t){this._setOpt("firstMoment",t)}get secondMoment(){return this._getOpt("secondMoment")}set secondMoment(t){this._setOpt("secondMoment",t)}get gradientAccumulator(){return this._getOpt("gradientAccumulator")}set gradientAccumulator(t){this._setOpt("gradientAccumulator",t)}get maxSecondMoment(){return this._getOpt("maxSecondMoment")}set maxSecondMoment(t){this._setOpt("maxSecondMoment",t)}get infinityNorm(){return this._getOpt("infinityNorm")}set infinityNorm(t){this._setOpt("infinityNorm",t)}get secondMomentum(){return this._getOpt("secondMomentum")}set secondMomentum(t){this._setOpt("secondMomentum",t)}get lookaheadShadowWeight(){return this._getOpt("lookaheadShadowWeight")}set lookaheadShadowWeight(t){this._setOpt("lookaheadShadowWeight",t)}get gater(){return(this._flags&4)!==0?this[Ot]:null}set gater(t){t===null?(this._flags&4)!==0&&(this._flags&=-5,this[Ot]!==void 0&&delete this[Ot]):(this[Ot]=t,this._flags|=4)}get plasticityRate(){return this[Rt]===void 0?0:this[Rt]}set plasticityRate(t){t===void 0||t===0?(this[Rt]!==void 0&&delete this[Rt],this._flags&=-9):(this[Rt]=t,this._flags|=8)}get dropConnectActiveMask(){return this.dcMask}set dropConnectActiveMask(t){this.dcMask=t}}});var j,At=H(()=>{"use strict";j={warnings:!1,float32Mode:!1,deterministicChainMode:!1,enableGatingTraces:!0,enableNodePooling:!1,enableSlabArrayPooling:!1}});var Ne={};ht(Ne,{EPSILON:()=>xt,EXTRA_CONNECTION_PROBABILITY:()=>Se,NORM_EPSILON:()=>Fo,PROB_EPSILON:()=>Lt});var xt,Lt,Fo,Se,Pt=H(()=>{"use strict";xt=1e-9,Lt=1e-15,Fo=1e-5,Se=.5});var vt,rn=H(()=>{"use strict";Pt();vt=class{static crossEntropy(t,n){let s=0,o=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let i=0;i<n.length;i++){let a=t[i],r=n[i],c=Math.max(o,Math.min(1-o,r));a===1?s-=Math.log(c):a===0?s-=Math.log(1-c):s-=a*Math.log(c)+(1-a)*Math.log(1-c)}return s/n.length}static softmaxCrossEntropy(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=n.length,o=0;for(let h of t)o+=h;let i=o>0?t.map(h=>h/o):t.slice(),a=Math.max(...n),r=n.map(h=>Math.exp(h-a)),c=r.reduce((h,d)=>h+d,0)||1,l=r.map(h=>h/c),u=0,p=1e-15;for(let h=0;h<s;h++){let d=Math.min(1-p,Math.max(p,l[h])),f=i[h];u-=f*Math.log(d)}return u}static mse(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0;return n.forEach((o,i)=>{s+=Math.pow(t[i]-o,2)}),s/n.length}static binary(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0;return n.forEach((o,i)=>{s+=Math.round(t[i])!==Math.round(o)?1:0}),s/n.length}static mae(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0;return n.forEach((o,i)=>{s+=Math.abs(t[i]-o)}),s/n.length}static mape(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0,o=1e-15;return n.forEach((i,a)=>{let r=t[a];s+=Math.abs((r-i)/Math.max(Math.abs(r),o))}),s/n.length}static msle(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0;return n.forEach((o,i)=>{let a=t[i],r=Math.log(Math.max(a,0)+1),c=Math.log(Math.max(o,0)+1);s+=Math.pow(r-c,2)}),s/n.length}static hinge(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let s=0;return n.forEach((o,i)=>{let a=t[i];s+=Math.max(0,1-a*o)}),s/n.length}static focalLoss(t,n,s=2,o=.25){let i=0,a=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let r=0;r<n.length;r++){let c=t[r],l=Math.max(a,Math.min(1-a,n[r])),u=c===1?l:1-l,p=c===1?o:1-o;i+=-p*Math.pow(1-u,s)*Math.log(u)}return i/n.length}static labelSmoothing(t,n,s=.1){let o=0,i=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let a=0;a<n.length;a++){let r=t[a]*(1-s)+.5*s,c=Math.max(i,Math.min(1-i,n[a]));o-=r*Math.log(c)+(1-r)*Math.log(1-c)}return o/n.length}}});var qt,cn=H(()=>{"use strict";qt=class{static fixed(){return(n,s)=>n}static step(t=.9,n=100){return(o,i)=>Math.max(0,o*Math.pow(t,Math.floor(i/n)))}static exp(t=.999){return(s,o)=>s*Math.pow(t,o)}static inv(t=.001,n=2){return(o,i)=>o/(1+t*Math.pow(i,n))}static cosineAnnealing(t=1e3,n=0){return(o,i)=>{let a=i%t,r=.5*(1+Math.cos(a/t*Math.PI));return n+(o-n)*r}}static cosineAnnealingWarmRestarts(t=1e3,n=0,s=1){let o=t,i=0,a=o;return(r,c)=>{for(;c>=a;)i=a,o=Math.max(1,Math.round(o*s)),a=i+o;let l=c-i,u=.5*(1+Math.cos(l/o*Math.PI));return n+(r-n)*u}}static linearWarmupDecay(t,n,s=0){if(t<=0)throw new Error("totalSteps must be > 0");let o=Math.min(n??Math.max(1,Math.floor(t*.1)),t-1);return(i,a)=>{if(a<=o)return i*(a/Math.max(1,o));if(a>=t)return s;let r=t-o,c=(a-o)/r;return s+(i-s)*(1-c)}}static reduceOnPlateau(t){let{factor:n=.5,patience:s=10,minDelta:o=1e-4,cooldown:i=0,minRate:a=0,verbose:r=!1}=t||{},c,l,u=0,p=-1;return(h,d,f)=>{if(c===void 0&&(c=h),f!==void 0){if(l===void 0||f<l-o)l=f,u=d;else if(d-u>=s&&d>=p){let m=Math.max(a,c*n);m<c&&(c=m,p=d+i,u=d)}}return c}}}});var Do,q,ve=H(()=>{"use strict";Do={logistic:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n*(1-n):n},sigmoid:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n*(1-n):n},tanh:(e,t=!1)=>t?1-Math.pow(Math.tanh(e),2):Math.tanh(e),identity:(e,t=!1)=>t?1:e,step:(e,t=!1)=>t?0:e>0?1:0,relu:(e,t=!1)=>t?e>0?1:0:e>0?e:0,softsign:(e,t=!1)=>{let n=1+Math.abs(e);return t?1/Math.pow(n,2):e/n},sinusoid:(e,t=!1)=>t?Math.cos(e):Math.sin(e),gaussian:(e,t=!1)=>{let n=Math.exp(-Math.pow(e,2));return t?-2*e*n:n},bentIdentity:(e,t=!1)=>{let n=Math.sqrt(Math.pow(e,2)+1);return t?e/(2*n)+1:(n-1)/2+e},bipolar:(e,t=!1)=>t?0:e>0?1:-1,bipolarSigmoid:(e,t=!1)=>{let n=2/(1+Math.exp(-e))-1;return t?.5*(1+n)*(1-n):n},hardTanh:(e,t=!1)=>t?e>-1&&e<1?1:0:Math.max(-1,Math.min(1,e)),absolute:(e,t=!1)=>t?e<0?-1:1:Math.abs(e),inverse:(e,t=!1)=>t?-1:1-e,selu:(e,t=!1)=>{let n=1.6732632423543772,s=1.0507009873554805,o=e>0?e:n*Math.exp(e)-n;return t?e>0?s:(o+n)*s:o*s},softplus:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n:e>30?e:e<-30?Math.exp(e):Math.max(0,e)+Math.log(1+Math.exp(-Math.abs(e)))},swish:(e,t=!1)=>{let n=1/(1+Math.exp(-e));if(t){let s=e*n;return s+n*(1-s)}else return e*n},gelu:(e,t=!1)=>{let n=.5*(1+Math.tanh(Math.sqrt(2/Math.PI)*(e+.044715*Math.pow(e,3))));if(t){let s=Math.sqrt(2/Math.PI)*(1+.134145*e*e),o=Math.sqrt(2/Math.PI)*(e+.044715*Math.pow(e,3)),i=1/Math.cosh(o),a=i*i;return n+e*.5*s*a}else return e*n},mish:(e,t=!1)=>{let n;e>30?n=e:e<-30?n=Math.exp(e):n=Math.max(0,e)+Math.log(1+Math.exp(-Math.abs(e)));let s=Math.tanh(n);if(t){let o=1/(1+Math.exp(-e)),i=1/Math.cosh(n),a=i*i;return s+e*a*o}else return e*s}},q=Do});var St,ln=H(()=>{"use strict";St={OUTPUT:{name:"OUTPUT"},INPUT:{name:"INPUT"},SELF:{name:"SELF"}}});var W,Gt,Vt=H(()=>{"use strict";ve();W={ADD_NODE:{name:"ADD_NODE"},SUB_NODE:{name:"SUB_NODE",keep_gates:!0},ADD_CONN:{name:"ADD_CONN"},SUB_CONN:{name:"SUB_CONN"},MOD_WEIGHT:{name:"MOD_WEIGHT",min:-1,max:1},MOD_BIAS:{name:"MOD_BIAS",min:-1,max:1},MOD_ACTIVATION:{name:"MOD_ACTIVATION",mutateOutput:!0,allowed:[q.logistic,q.tanh,q.relu,q.identity,q.step,q.softsign,q.sinusoid,q.gaussian,q.bentIdentity,q.bipolar,q.bipolarSigmoid,q.hardTanh,q.absolute,q.inverse,q.selu,q.softplus,q.swish,q.gelu,q.mish]},ADD_SELF_CONN:{name:"ADD_SELF_CONN"},SUB_SELF_CONN:{name:"SUB_SELF_CONN"},ADD_GATE:{name:"ADD_GATE"},SUB_GATE:{name:"SUB_GATE"},ADD_BACK_CONN:{name:"ADD_BACK_CONN"},SUB_BACK_CONN:{name:"SUB_BACK_CONN"},SWAP_NODES:{name:"SWAP_NODES",mutateOutput:!0},REINIT_WEIGHT:{name:"REINIT_WEIGHT",min:-1,max:1},BATCH_NORM:{name:"BATCH_NORM"},ADD_LSTM_NODE:{name:"ADD_LSTM_NODE"},ADD_GRU_NODE:{name:"ADD_GRU_NODE"},ALL:[],FFW:[]};W.ALL=[W.ADD_NODE,W.SUB_NODE,W.ADD_CONN,W.SUB_CONN,W.MOD_WEIGHT,W.MOD_BIAS,W.MOD_ACTIVATION,W.ADD_GATE,W.SUB_GATE,W.ADD_SELF_CONN,W.SUB_SELF_CONN,W.ADD_BACK_CONN,W.SUB_BACK_CONN,W.SWAP_NODES,W.REINIT_WEIGHT,W.BATCH_NORM,W.ADD_LSTM_NODE,W.ADD_GRU_NODE];W.FFW=[W.ADD_NODE,W.SUB_NODE,W.ADD_CONN,W.SUB_CONN,W.MOD_WEIGHT,W.MOD_BIAS,W.MOD_ACTIVATION,W.SWAP_NODES,W.REINIT_WEIGHT,W.BATCH_NORM];Gt=W});var _t,we=H(()=>{"use strict";_t={FITNESS_PROPORTIONATE:{name:"FITNESS_PROPORTIONATE"},POWER:{name:"POWER",power:4},TOURNAMENT:{name:"TOURNAMENT",size:5,probability:.5}}});var Yt,un=H(()=>{"use strict";Yt={SINGLE_POINT:{name:"SINGLE_POINT",config:[.4]},TWO_POINT:{name:"TWO_POINT",config:[.4,.9]},UNIFORM:{name:"UNIFORM"},AVERAGE:{name:"AVERAGE"}}});var $o,tt,hn=H(()=>{"use strict";$o=Object.freeze({ALL_TO_ALL:Object.freeze({name:"ALL_TO_ALL"}),ALL_TO_ELSE:Object.freeze({name:"ALL_TO_ELSE"}),ONE_TO_ONE:Object.freeze({name:"ONE_TO_ONE"})}),tt=$o});var nt={};ht(nt,{Activation:()=>q,Cost:()=>vt,Rate:()=>qt,crossover:()=>Yt,gating:()=>St,groupConnection:()=>tt,mutation:()=>W,selection:()=>_t});var ft=H(()=>{"use strict";rn();cn();ve();ln();Vt();we();un();hn()});var se={};ht(se,{default:()=>Q});var Q,lt=H(()=>{"use strict";Nt();At();ft();Q=class e{bias;squash;type;activation;state;old;mask;previousDeltaBias;totalDeltaBias;connections;error;derivative;index;isActivating;geneId;static _globalNodeIndex=0;static _nextGeneId=1;constructor(t="hidden",n,s=Math.random){this.bias=t==="input"?0:s()*.2-.1,this.squash=n||q.logistic||(o=>o),this.type=t,this.activation=0,this.state=0,this.old=0,this.mask=1,this.previousDeltaBias=0,this.totalDeltaBias=0,this.connections={in:[],out:[],gated:[],self:[]},this.error={responsibility:0,projected:0,gated:0},typeof this.index>"u"&&(this.index=e._globalNodeIndex++),this.geneId=e._nextGeneId++}setActivation(t){this.squash=t}activate(t){return this._activateCore(!0,t)}noTraceActivate(t){return this._activateCore(!1,t)}_activateCore(t,n){if(this.mask===0)return this.activation=0,0;if(typeof n<"u"){if(this.type==="input")return this.activation=n,this.activation;this.state=n,this.activation=this.squash(this.state)*this.mask,this.derivative=this.squash(this.state,!0);for(let o of this.connections.gated)o.gain=this.activation;if(t)for(let o of this.connections.in)o.eligibility=o.from.activation;return this.activation}this.old=this.state;let s=this.bias;if(this.connections.self.length)for(let o of this.connections.self)o.dcMask!==0&&(s+=o.gain*o.weight*this.old);if(this.connections.in.length)for(let o of this.connections.in)o.dcMask===0||o.enabled===!1||(s+=o.from.activation*o.weight*o.gain);if(this.state=s,typeof this.squash!="function"&&(j.warnings&&console.warn("Invalid activation function; using identity."),this.squash=q.identity),typeof this.mask!="number"&&(this.mask=1),this.activation=this.squash(this.state)*this.mask,this.derivative=this.squash(this.state,!0),this.connections.gated.length)for(let o of this.connections.gated)o.gain=this.activation;if(t)for(let o of this.connections.in)o.eligibility=o.from.activation;return this.activation}propagate(t,n,s,o=0,i){if(s&&n>0){for(let c of this.connections.in)c.weight+=n*c.previousDeltaWeight,c.eligibility+=1e-12;this.bias+=n*this.previousDeltaBias}let a=0;if(this.type==="output")this.error.responsibility=this.error.projected=i-this.activation;else{for(let c of this.connections.out)a+=c.to.error.responsibility*c.weight*c.gain;this.error.projected=this.derivative*a,a=0;for(let c of this.connections.gated){let l=c.to,u=l.connections.self.reduce((p,h)=>p+(h.gater===this?l.old:0),0);u+=c.weight*c.from.activation,a+=l.error.responsibility*u}this.error.gated=this.derivative*a,this.error.responsibility=this.error.projected+this.error.gated}if(this.type==="constant")return;for(let c of this.connections.in){if(c.dcMask===0){c.totalDeltaWeight+=0;continue}let l=this.error.projected*c.eligibility;for(let h=0;h<c.xtrace.nodes.length;h++){let d=c.xtrace.nodes[h],f=c.xtrace.values[h];l+=d.error.responsibility*f}let u=0;typeof o=="function"?u=o(c.weight):typeof o=="object"&&o!==null?o.type==="L1"?u=o.lambda*Math.sign(c.weight):o.type==="L2"&&(u=o.lambda*c.weight):u=o*c.weight;let p=t*(l*this.mask-u);if(Number.isFinite(p)?Math.abs(p)>1e3&&(p=Math.sign(p)*1e3):(console.warn("deltaWeight is not finite, clamping to 0",{node:this.index,connection:c,deltaWeight:p}),p=0),c.totalDeltaWeight+=p,Number.isFinite(c.totalDeltaWeight)||(console.warn("totalDeltaWeight became NaN/Infinity, resetting to 0",{node:this.index,connection:c}),c.totalDeltaWeight=0),s){let h=c.totalDeltaWeight+n*c.previousDeltaWeight;Number.isFinite(h)?Math.abs(h)>1e3&&(h=Math.sign(h)*1e3):(console.warn("currentDeltaWeight is not finite, clamping to 0",{node:this.index,connection:c,currentDeltaWeight:h}),h=0),n>0&&(c.weight-=n*c.previousDeltaWeight),c.weight+=h,Number.isFinite(c.weight)?Math.abs(c.weight)>1e6&&(c.weight=Math.sign(c.weight)*1e6):(console.warn(`Weight update produced invalid value: ${c.weight}. Resetting to 0.`,{node:this.index,connection:c}),c.weight=0),c.previousDeltaWeight=h,c.totalDeltaWeight=0}}for(let c of this.connections.self){if(c.dcMask===0){c.totalDeltaWeight+=0;continue}let l=this.error.projected*c.eligibility;for(let h=0;h<c.xtrace.nodes.length;h++){let d=c.xtrace.nodes[h],f=c.xtrace.values[h];l+=d.error.responsibility*f}let u=0;typeof o=="function"?u=o(c.weight):typeof o=="object"&&o!==null?o.type==="L1"?u=o.lambda*Math.sign(c.weight):o.type==="L2"&&(u=o.lambda*c.weight):u=o*c.weight;let p=t*(l*this.mask-u);if(Number.isFinite(p)?Math.abs(p)>1e3&&(p=Math.sign(p)*1e3):(console.warn("self deltaWeight is not finite, clamping to 0",{node:this.index,connection:c,deltaWeight:p}),p=0),c.totalDeltaWeight+=p,Number.isFinite(c.totalDeltaWeight)||(console.warn("self totalDeltaWeight became NaN/Infinity, resetting to 0",{node:this.index,connection:c}),c.totalDeltaWeight=0),s){let h=c.totalDeltaWeight+n*c.previousDeltaWeight;Number.isFinite(h)?Math.abs(h)>1e3&&(h=Math.sign(h)*1e3):(console.warn("self currentDeltaWeight is not finite, clamping to 0",{node:this.index,connection:c,currentDeltaWeight:h}),h=0),n>0&&(c.weight-=n*c.previousDeltaWeight),c.weight+=h,Number.isFinite(c.weight)?Math.abs(c.weight)>1e6&&(c.weight=Math.sign(c.weight)*1e6):(console.warn("self weight update produced invalid value, resetting to 0",{node:this.index,connection:c}),c.weight=0),c.previousDeltaWeight=h,c.totalDeltaWeight=0}}let r=t*this.error.responsibility;if(Number.isFinite(r)?Math.abs(r)>1e3&&(r=Math.sign(r)*1e3):(console.warn("deltaBias is not finite, clamping to 0",{node:this.index,deltaBias:r}),r=0),this.totalDeltaBias+=r,Number.isFinite(this.totalDeltaBias)||(console.warn("totalDeltaBias became NaN/Infinity, resetting to 0",{node:this.index}),this.totalDeltaBias=0),s){let c=this.totalDeltaBias+n*this.previousDeltaBias;Number.isFinite(c)?Math.abs(c)>1e3&&(c=Math.sign(c)*1e3):(console.warn("currentDeltaBias is not finite, clamping to 0",{node:this.index,currentDeltaBias:c}),c=0),n>0&&(this.bias-=n*this.previousDeltaBias),this.bias+=c,Number.isFinite(this.bias)?Math.abs(this.bias)>1e6&&(this.bias=Math.sign(this.bias)*1e6):(console.warn("bias update produced invalid value, resetting to 0",{node:this.index}),this.bias=0),this.previousDeltaBias=c,this.totalDeltaBias=0}}toJSON(){return{index:this.index,bias:this.bias,type:this.type,squash:this.squash?this.squash.name:null,mask:this.mask}}static fromJSON(t){let n=new e(t.type);if(n.bias=t.bias,n.mask=t.mask,t.squash){let s=q[t.squash];typeof s=="function"?n.squash=s:(console.warn(`fromJSON: Unknown or invalid squash function '${t.squash}' for node. Using identity.`),n.squash=q.identity)}return n}isConnectedTo(t){return this.connections.out.some(n=>n.to===t)}mutate(t){if(!t)throw new Error("Mutation method cannot be null or undefined.");if(!(t.name in W))throw new Error(`Unknown mutation method: ${t.name}`);switch(t){case W.MOD_ACTIVATION:if(!t.allowed||t.allowed.length===0){console.warn("MOD_ACTIVATION mutation called without allowed functions specified.");return}let n=t.allowed,s=n.indexOf(this.squash),o=s;n.length>1&&(o=(s+Math.floor(Math.random()*(n.length-1))+1)%n.length),this.squash=n[o];break;case W.MOD_BIAS:let i=t.min??-1,a=t.max??1,r=Math.random()*(a-i)+i;this.bias+=r;break;case W.REINIT_WEIGHT:let c=t.min??-1,l=t.max??1;for(let u of this.connections.in)u.weight=Math.random()*(l-c)+c;for(let u of this.connections.out)u.weight=Math.random()*(l-c)+c;for(let u of this.connections.self)u.weight=Math.random()*(l-c)+c;break;case W.BATCH_NORM:this.batchNorm=!0;break;default:throw new Error(`Unsupported mutation method: ${t.name}`)}}connect(t,n){let s=[];if(!t)throw new Error("Cannot connect to an undefined target.");if("bias"in t){let o=t;if(o===this){if(this.connections.self.length===0){let i=dt.acquire(this,this,n??1);this.connections.self.push(i),s.push(i)}}else{let i=dt.acquire(this,o,n);o.connections.in.push(i),this.connections.out.push(i),s.push(i)}}else if("nodes"in t&&Array.isArray(t.nodes))for(let o of t.nodes){let i=dt.acquire(this,o,n);o.connections.in.push(i),this.connections.out.push(i),s.push(i)}else throw new Error("Invalid target type for connection. Must be a Node or a group { nodes: Node[] }.");return s}disconnect(t,n=!1){if(this===t){this.connections.self=[];return}this.connections.out=this.connections.out.filter(s=>s.to===t?(t.connections.in=t.connections.in.filter(o=>o!==s),s.gater&&s.gater.ungate(s),!1):!0),n&&t.disconnect(this,!1)}gate(t){Array.isArray(t)||(t=[t]);for(let n of t){if(!n||!n.from||!n.to){console.warn("Attempted to gate an invalid or incomplete connection.");continue}if(n.gater===this){console.warn("Node is already gating this connection.");continue}if(n.gater!==null){console.warn("Connection is already gated by another node. Ungate first.");continue}this.connections.gated.push(n),n.gater=this}}ungate(t){Array.isArray(t)||(t=[t]);for(let n of t){if(!n)continue;let s=this.connections.gated.indexOf(n);s!==-1&&(this.connections.gated.splice(s,1),n.gater=null,n.gain=1)}}clear(){for(let t of this.connections.in)t.eligibility=0,t.xtrace={nodes:[],values:[]};for(let t of this.connections.self)t.eligibility=0,t.xtrace={nodes:[],values:[]};for(let t of this.connections.gated)t.gain=0;this.error={responsibility:0,projected:0,gated:0},this.old=this.state=this.activation=0}isProjectingTo(t){return t===this&&this.connections.self.length>0?!0:this.connections.out.some(n=>n.to===t)}isProjectedBy(t){return t===this&&this.connections.self.length>0?!0:this.connections.in.some(n=>n.from===t)}applyBatchUpdates(t){return this.applyBatchUpdatesWithOptimizer({type:"sgd",momentum:t})}applyBatchUpdatesWithOptimizer(t){let n=t.type||"sgd",s=n==="lookahead"?t.baseType||"sgd":n,o=t.momentum??0,i=t.beta1??.9,a=t.beta2??.999,r=t.eps??1e-8,c=t.weightDecay??0,l=t.lrScale??1,u=Math.max(1,Math.floor(t.t??1));n==="lookahead"&&(this._la_k=this._la_k||t.la_k||5,this._la_alpha=this._la_alpha||t.la_alpha||.5,this._la_step=(this._la_step||0)+1,this._la_shadowBias||(this._la_shadowBias=this.bias));let p=h=>{let d=h.totalDeltaWeight||0;switch(Number.isFinite(d)||(d=0),s){case"rmsprop":{h.gradientAccumulator=(h.gradientAccumulator??0)*.9+.1*(d*d);let f=d/(Math.sqrt(h.gradientAccumulator)+r);this._safeUpdateWeight(h,f*l);break}case"adagrad":{h.gradientAccumulator=(h.gradientAccumulator??0)+d*d;let f=d/(Math.sqrt(h.gradientAccumulator)+r);this._safeUpdateWeight(h,f*l);break}case"adam":case"adamw":case"amsgrad":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(d*d),s==="amsgrad"&&(h.maxSecondMoment=Math.max(h.maxSecondMoment??0,h.secondMoment??0));let f=s==="amsgrad"?h.maxSecondMoment:h.secondMoment,m=h.firstMoment/(1-Math.pow(i,u)),b=f/(1-Math.pow(a,u)),g=m/(Math.sqrt(b)+r)*l;s==="adamw"&&c!==0&&(g-=c*(h.weight||0)),this._safeUpdateWeight(h,g);break}case"adamax":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d,h.infinityNorm=Math.max((h.infinityNorm??0)*a,Math.abs(d));let m=h.firstMoment/(1-Math.pow(i,u))/(h.infinityNorm||1e-12)*l;this._safeUpdateWeight(h,m);break}case"nadam":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(d*d);let f=h.firstMoment/(1-Math.pow(i,u)),m=h.secondMoment/(1-Math.pow(a,u)),b=f*i+(1-i)*d/(1-Math.pow(i,u));this._safeUpdateWeight(h,b/(Math.sqrt(m)+r)*l);break}case"radam":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(d*d);let f=h.firstMoment/(1-Math.pow(i,u)),m=h.secondMoment/(1-Math.pow(a,u)),b=2/(1-a)-1,g=b-2*u*Math.pow(a,u)/(1-Math.pow(a,u));if(g>4){let y=Math.sqrt((g-4)*(g-2)*b/((b-4)*(b-2)*g));this._safeUpdateWeight(h,y*f/(Math.sqrt(m)+r)*l)}else this._safeUpdateWeight(h,f*l);break}case"lion":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d,h.secondMomentum=(h.secondMomentum??0)*a+(1-a)*d;let f=Math.sign((h.firstMoment||0)+(h.secondMomentum||0));this._safeUpdateWeight(h,-f*l);break}case"adabelief":{h.firstMoment=(h.firstMoment??0)*i+(1-i)*d;let f=d-h.firstMoment;h.secondMoment=(h.secondMoment??0)*a+(1-a)*(f*f);let m=h.firstMoment/(1-Math.pow(i,u)),b=h.secondMoment/(1-Math.pow(a,u));this._safeUpdateWeight(h,m/(Math.sqrt(b)+r+1e-12)*l);break}default:{let f=d+o*(h.previousDeltaWeight||0);Number.isFinite(f)||(f=0),Math.abs(f)>1e3&&(f=Math.sign(f)*1e3),this._safeUpdateWeight(h,f*l),h.previousDeltaWeight=f}}s==="adamw"&&c!==0&&this._safeUpdateWeight(h,-c*(h.weight||0)*l),h.totalDeltaWeight=0};for(let h of this.connections.in)p(h);for(let h of this.connections.self)p(h);if(this.type!=="input"&&this.type!=="constant"){let h=this.totalDeltaBias||0;if(Number.isFinite(h)||(h=0),["adam","adamw","amsgrad","adamax","nadam","radam","lion","adabelief"].includes(s)){this.opt_mB=(this.opt_mB??0)*i+(1-i)*h,s==="lion"&&(this.opt_mB2=(this.opt_mB2??0)*a+(1-a)*h),this.opt_vB=(this.opt_vB??0)*a+(1-a)*(s==="adabelief"?Math.pow(h-this.opt_mB,2):h*h),s==="amsgrad"&&(this.opt_vhatB=Math.max(this.opt_vhatB??0,this.opt_vB??0));let d=s==="amsgrad"?this.opt_vhatB:this.opt_vB,f=this.opt_mB/(1-Math.pow(i,u)),m=d/(1-Math.pow(a,u)),b;if(s==="adamax")this.opt_uB=Math.max((this.opt_uB??0)*a,Math.abs(h)),b=f/(this.opt_uB||1e-12)*l;else if(s==="nadam")b=(f*i+(1-i)*h/(1-Math.pow(i,u)))/(Math.sqrt(m)+r)*l;else if(s==="radam"){let y=2/(1-a)-1,A=y-2*u*Math.pow(a,u)/(1-Math.pow(a,u));A>4?b=Math.sqrt((A-4)*(A-2)*y/((y-4)*(y-2)*A))*f/(Math.sqrt(m)+r)*l:b=f*l}else s==="lion"?b=-Math.sign(this.opt_mB+this.opt_mB2)*l:s==="adabelief"?b=f/(Math.sqrt(m)+r+1e-12)*l:b=f/(Math.sqrt(m)+r)*l;s==="adamw"&&c!==0&&(b-=c*(this.bias||0)*l);let g=this.bias+b;Number.isFinite(g)||(g=0),Math.abs(g)>1e6&&(g=Math.sign(g)*1e6),this.bias=g}else{let d=h+o*(this.previousDeltaBias||0);Number.isFinite(d)||(d=0),Math.abs(d)>1e3&&(d=Math.sign(d)*1e3);let f=this.bias+d*l;Number.isFinite(f)||(f=0),Math.abs(f)>1e6&&(f=Math.sign(f)*1e6),this.bias=f,this.previousDeltaBias=d}this.totalDeltaBias=0}else this.previousDeltaBias=0,this.totalDeltaBias=0;if(n==="lookahead"){let h=this._la_k||5,d=this._la_alpha||.5;if(this._la_step%h===0){this._la_shadowBias=(1-d)*this._la_shadowBias+d*this.bias,this.bias=this._la_shadowBias;let f=m=>{m.lookaheadShadowWeight||(m.lookaheadShadowWeight=m.weight),m.lookaheadShadowWeight=(1-d)*m.lookaheadShadowWeight+d*m.weight,m.weight=m.lookaheadShadowWeight};for(let m of this.connections.in)f(m);for(let m of this.connections.self)f(m)}}}_safeUpdateWeight(t,n){let s=t.weight+n;Number.isFinite(s)||(s=0),Math.abs(s)>1e6&&(s=Math.sign(s)*1e6),t.weight=s}}});function Bo(e,t,n=Math.random){t&&(e.type=t);let s=e.type;e.bias=s==="input"?0:n()*.2-.1,e.activation=0,e.state=0,e.old=0,e.mask=1,e.previousDeltaBias=0,e.totalDeltaBias=0,e.derivative=void 0,e.connections.in.length=0,e.connections.out.length=0,e.connections.gated.length=0,e.connections.self.length=0,e.error={responsibility:0,projected:0,gated:0},e.geneId=dn++}function xe(e={}){let{type:t="hidden",activationFn:n,rng:s}=e,o;return Xt.length?(o=Xt.pop(),Ho++,Bo(o,t,s),n&&(o.squash=n)):(o=new Q(t,n,s),o.geneId=dn++,Go++),o}function oe(e){e.connections.in.length=0,e.connections.out.length=0,e.connections.gated.length=0,e.connections.self.length=0,e.error={responsibility:0,projected:0,gated:0},Xt.push(e),Xt.length>pn&&(pn=Xt.length)}var Xt,pn,dn,Ho,Go,_e=H(()=>{"use strict";lt();Xt=[],pn=0,dn=1,Ho=0,Go=0});var Me={};ht(Me,{TestWorker:()=>ie,default:()=>Wo});var fn,ie,Wo,Ie=H(()=>{"use strict";fn=zt("child_process"),ie=class{worker;constructor(t,n){let s=null;try{s=zt("path")}catch{}let o=s?s.join(__dirname,"/worker"):"./worker";this.worker=(0,fn.fork)(o),this.worker.send({set:t,cost:n.name})}async evaluate(t){let n=t.serialize(),s={activations:n[0],states:n[1],conns:n[2]};return new Promise((o,i)=>{let a=u=>{l(),o(u)},r=u=>{l(),i(u)},c=(u,p)=>{l(),i(new Error(`worker exited${u!=null?` with code ${u}`:p?` with signal ${p}`:""}`))},l=()=>{this.worker.off("message",a),this.worker.off("error",r),this.worker.off("exit",c)};this.worker.once("message",a),this.worker.once("error",r),this.worker.once("exit",c),this.worker.send(s)})}terminate(){this.worker.kill()}},Wo=ie});var Ce={};ht(Ce,{TestWorker:()=>Ee});var Ee,Te=H(()=>{"use strict";Jt();Ee=class e{worker;url;constructor(t,n){let s=new Blob([e._createBlobString(n)]);this.url=window.URL.createObjectURL(s),this.worker=new Worker(this.url);let o={set:new Float64Array(t).buffer};this.worker.postMessage(o,[o.set])}evaluate(t){return new Promise((n,s)=>{let o=t.serialize(),i={activations:new Float64Array(o[0]).buffer,states:new Float64Array(o[1]).buffer,conns:new Float64Array(o[2]).buffer};this.worker.onmessage=function(a){let r=new Float64Array(a.data.buffer)[0];n(r)},this.worker.postMessage(i,[i.activations,i.states,i.conns])})}terminate(){this.worker.terminate(),window.URL.revokeObjectURL(this.url)}static _createBlobString(t){return`
      const F = [${mt.activations.toString()}];
      const cost = ${t.toString()};
      const multi = {
        deserializeDataSet: ${mt.deserializeDataSet.toString()},
        testSerializedSet: ${mt.testSerializedSet.toString()},
        activateSerializedNetwork: ${mt.activateSerializedNetwork.toString()}
      };

      let set;

      this.onmessage = function (e) {
        if (typeof e.data.set === 'undefined') {
          const A = new Float64Array(e.data.activations);
          const S = new Float64Array(e.data.states);
          const data = new Float64Array(e.data.conns);

          const error = multi.testSerializedSet(set, cost, A, S, data, F);

          const answer = { buffer: new Float64Array([error]).buffer };
          postMessage(answer, [answer.buffer]);
        } else {
          set = multi.deserializeDataSet(new Float64Array(e.data.set));
        }
      };`}}});var ae,mn=H(()=>{"use strict";ae=class{static async getNodeTestWorker(){return(await Promise.resolve().then(()=>(Ie(),Me))).TestWorker}static async getBrowserTestWorker(){return(await Promise.resolve().then(()=>(Te(),Ce))).TestWorker}}});var mt,Jt=H(()=>{"use strict";mn();pt();mt=class e{static workers=ae;static activations=[t=>1/(1+Math.exp(-t)),t=>Math.tanh(t),t=>t,t=>t>0?1:0,t=>t>0?t:0,t=>t/(1+Math.abs(t)),t=>Math.sin(t),t=>Math.exp(-Math.pow(t,2)),t=>(Math.sqrt(Math.pow(t,2)+1)-1)/2+t,t=>t>0?1:-1,t=>2/(1+Math.exp(-t))-1,t=>Math.max(-1,Math.min(1,t)),t=>Math.abs(t),t=>1-t,t=>{let n=1.6732632423543772;return(t>0?t:n*Math.exp(t)-n)*1.0507009873554805},t=>Math.log(1+Math.exp(t))];static serializeDataSet(t){let n=[t[0].input.length,t[0].output.length];for(let s=0;s<t.length;s++){for(let o=0;o<n[0];o++)n.push(t[s].input[o]);for(let o=0;o<n[1];o++)n.push(t[s].output[o])}return n}static activateSerializedNetwork(t,n,s,o,i){for(let r=0;r<o[0];r++)n[r]=t[r];for(let r=2;r<o.length;r++){let c=o[r++],l=o[r++],u=o[r++],p=o[r++],h=o[r++];for(s[c]=(h===-1?1:n[h])*p*s[c]+l;o[r]!==-2;)s[c]+=n[o[r++]]*o[r++]*(o[r++]===-1?1:n[o[r-1]]);n[c]=i[u](s[c])}let a=[];for(let r=n.length-o[1];r<n.length;r++)a.push(n[r]);return a}static deserializeDataSet(t){let n=[],s=t[0]+t[1];for(let o=0;o<(t.length-2)/s;o++){let i=[];for(let r=2+o*s;r<2+o*s+t[0];r++)i.push(t[r]);let a=[];for(let r=2+o*s+t[0];r<2+o*s+s;r++)a.push(t[r]);n.push({input:i,output:a})}return n}static logistic(t){return 1/(1+Math.exp(-t))}static tanh(t){return Math.tanh(t)}static identity(t){return t}static step(t){return t>0?1:0}static relu(t){return t>0?t:0}static softsign(t){return t/(1+Math.abs(t))}static sinusoid(t){return Math.sin(t)}static gaussian(t){return Math.exp(-Math.pow(t,2))}static bentIdentity(t){return(Math.sqrt(Math.pow(t,2)+1)-1)/2+t}static bipolar(t){return t>0?1:-1}static bipolarSigmoid(t){return 2/(1+Math.exp(-t))-1}static hardTanh(t){return Math.max(-1,Math.min(1,t))}static absolute(t){return Math.abs(t)}static inverse(t){return 1-t}static selu(t){let n=1.6732632423543772;return(t>0?t:n*Math.exp(t)-n)*1.0507009873554805}static softplus(t){return Math.log(1+Math.exp(t))}static testSerializedSet(t,n,s,o,i,a){let r=0;for(let c=0;c<t.length;c++){let l=e.activateSerializedNetwork(t[c].input,s,o,i,a);r+=n(t[c].output,l)}return r/t.length}static async getBrowserTestWorker(){let{TestWorker:t}=await Promise.resolve().then(()=>(Te(),Ce));return t}static async getNodeTestWorker(){let{TestWorker:t}=await Promise.resolve().then(()=>(Ie(),Me));return t}}});var Oe,yt,Kt=H(()=>{"use strict";At();Oe=class{buckets=new Map;created=0;reused=0;maxPerBucket=Number.POSITIVE_INFINITY;acquire(t){let n=this.buckets.get(t);if(n&&n.length>0){this.reused++;let s=n.pop();return s.fill(0),s}return this.created++,j.float32Mode?new Float32Array(t):new Array(t).fill(0)}release(t){let n=t.length>>>0;this.buckets.has(n)||this.buckets.set(n,[]);let s=this.buckets.get(n);s.length<this.maxPerBucket&&s.push(t)}clear(){this.buckets.clear(),this.created=0,this.reused=0}stats(){return{created:this.created,reused:this.reused,bucketCount:this.buckets.size}}setMaxPerBucket(t){typeof t=="number"&&t>=0&&(this.maxPerBucket=t)}prewarm(t,n){let s=Math.max(0,Math.floor(n));this.buckets.has(t)||this.buckets.set(t,[]);let o=this.buckets.get(t);for(let i=0;i<s&&o.length<this.maxPerBucket;i++){let a=j.float32Mode?new Float32Array(t):new Array(t).fill(0);o.push(a),this.created++}}bucketSize(t){return this.buckets.get(t)?.length??0}},yt=new Oe});var yn=No((lr,Uo)=>{Uo.exports={name:"@reicek/neataptic-ts",version:"0.1.12",description:"Architecture-free neural network library with genetic algorithm implementations",main:"./dist/neataptic.js",module:"./dist/neataptic.js",types:"./dist/neataptic.d.ts",type:"module",scripts:{test:"jest --config=jest.config.mjs --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts --verbose",pretest:"npm run build","test:bench":"jest --no-cache --runInBand --verbose --testPathPattern=benchmark","bench:asciiMaze":"node -r ts-node/register test/benchmarks/asciiMaze.micro.bench.ts","test:silent":"jest --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts --silent",deploy:"npm run build && npm run test:dist && npm publish",build:"npm run build:webpack && npm run build:ts","build:ts":"tsc","build:webpack":"webpack --config webpack.config.js","build:ascii-maze":"npx esbuild test/examples/asciiMaze/browser-entry.ts --bundle --outfile=docs/assets/ascii-maze.bundle.js --platform=browser --format=iife --minify --sourcemap --external:fs --external:child_process --external:path","start:ts":"ts-node src/neataptic.ts","test:e2e":"cross-env FORCE_COLOR=true jest e2e.test.ts --no-cache --runInBand","test:e2e:logs":"npx jest e2e.test.ts --verbose --runInBand --no-cache","test:dist":"npm run build:ts && jest --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts","docs:build-scripts":"tsc -p tsconfig.docs.json && node scripts/write-dist-docs-pkg.mjs","docs:folders":"npm run docs:build-scripts && node ./dist-docs/scripts/generate-docs.js","docs:html":"npm run docs:build-scripts && node ./dist-docs/scripts/render-docs-html.js","docs:examples":"node scripts/copy-examples.mjs",prettier:"npm run prettier:tests && npm run prettier:src","prettier:tests":"npx prettier --write test/**/*.ts","prettier:src":"npx prettier --write src/**/*.ts",docs:"npm run build:ascii-maze && npm run docs:examples && npm run docs:build-scripts && node ./dist-docs/scripts/generate-docs.js && node ./dist-docs/scripts/render-docs-html.js","onnx:export":"node scripts/export-onnx.mjs"},exports:{".":{types:"./dist/neataptic.d.ts",import:"./dist/neataptic.js"}},devDependencies:{"@types/chai":"^5.2.2","@types/fs-extra":"^11.0.4","@types/jest":"^30.0.0","@types/node":"^24.3.0","@types/seedrandom":"^3.0.8","@types/webpack":"^5.28.5","@types/webpack-dev-server":"^4.7.2",chai:"^6.0.1","copy-webpack-plugin":"^13.0.1","cross-env":"^10.0.0",esbuild:"^0.25.9","fast-glob":"^3.3.3","fs-extra":"^11.3.1",husky:"^9.1.7",jest:"^30.0.5","jest-environment-jsdom":"^30.0.5","jsdoc-to-markdown":"^9.1.2",marked:"^16.2.0",mkdocs:"^0.0.1",puppeteer:"^24.17.0","ts-jest":"^29.4.1","ts-loader":"^9.5.2","ts-morph":"^26.0.0","ts-node":"^10.9.2",typescript:"^5.9.2","undici-types":"^7.15.0",webpack:"^5.101.3","webpack-cli":"^6.0.1"},repository:{type:"git",url:"https://github.com/reicek/NeatapticTS.git"},keywords:["neural network","machine learning","genetic algorithm","mutation","neat"],author:{name:"Cesar Anton",email:"reicek@gmail.com"},license:"MIT",publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},bugs:{url:"https://github.com/reicek/NeatapticTS/issues",email:"reicek@gmail.com"},homepage:"https://reicek.github.io/NeatapticTS/",engines:{node:">=22.0.0"},prettier:{singleQuote:!0},dependencies:{seedrandom:"^3.0.5",undici:"^7.15.0"}}});function zo(e){let t=new Set;e.nodes.forEach(n=>n.connections?.out.forEach(s=>t.add(s))),e.connections=Array.from(t)}function Zt(e){let t=(e?.name||"").toUpperCase();return t.includes("TANH")?"Tanh":t.includes("LOGISTIC")||t.includes("SIGMOID")?"Sigmoid":t.includes("RELU")?"Relu":(e&&console.warn(`Unsupported activation function ${e.name} for ONNX export, defaulting to Identity.`),"Identity")}function qo(e){let t=e.nodes.filter(r=>r.type==="input"),n=e.nodes.filter(r=>r.type==="output"),s=e.nodes.filter(r=>r.type==="hidden");if(s.length===0)return[t,n];let o=[...s],i=t,a=[];for(;o.length;){let r=o.filter(c=>c.connections.in.every(l=>i.includes(l.from)));if(!r.length)throw new Error("Invalid network structure for ONNX export: cannot resolve layered ordering.");a.push(i),i=r,o=o.filter(c=>!r.includes(c))}return a.push(i),a.push(n),a}function Vo(e,t,n){for(let s=1;s<e.length;s++){let o=e[s-1],i=e[s],a=new Set(i.map(r=>r.squash&&r.squash.name));if(a.size>1&&!n.allowMixedActivations)throw new Error(`ONNX export error: Mixed activation functions detected in layer ${s}. (enable allowMixedActivations to decompose layer)`);a.size>1&&n.allowMixedActivations&&console.warn(`Warning: Mixed activations in layer ${s}; exporting per-neuron Gemm + Activation (+Concat) baseline.`);for(let r of i)for(let c of o)if(!r.connections.in.some(u=>u.from===c)&&!n.allowPartialConnectivity)throw new Error(`ONNX export error: Missing connection from node ${c.index} to node ${r.index} in layer ${s}. (enable allowPartialConnectivity)`)}}function Yo(e,t,n={}){let{includeMetadata:s=!1,opset:o=18,batchDimension:i=!1,legacyNodeOrdering:a=!1,producerName:r="neataptic-ts",producerVersion:c,docString:l}=n,u=t[0],p=t[t.length-1],h=i?[{dim_param:"N"},{dim_value:u.length}]:[{dim_value:u.length}],d=i?[{dim_param:"N"},{dim_value:p.length}]:[{dim_value:p.length}],f={graph:{inputs:[{name:"input",type:{tensor_type:{elem_type:1,shape:{dim:h}}}}],outputs:[{name:"output",type:{tensor_type:{elem_type:1,shape:{dim:d}}}}],initializer:[],node:[]}};if(s){let y=(()=>{try{return yn().version}catch{return"0.0.0"}})();f.ir_version=9,f.opset_import=[{version:o,domain:""}],f.producer_name=r,f.producer_version=c||y,f.doc_string=l||"Exported from NeatapticTS ONNX exporter (phases 1-2 baseline)"}let m="input",b=[];if(n.allowRecurrent&&n.recurrentSingleStep)for(let y=1;y<t.length-1;y++){let A=t[y];if(A.some(N=>N.connections.self.length>0)){b.push(y);let N=y===1?"hidden_prev":`hidden_prev_l${y}`;f.graph.inputs.push({name:N,type:{tensor_type:{elem_type:1,shape:{dim:i?[{dim_param:"N"},{dim_value:A.length}]:[{dim_value:A.length}]}}}})}}let g=[];for(let y=1;y<t.length;y++){let A=t[y-1],N=t[y],v=y===t.length-1;v||g.push(N.length);let w=n.conv2dMappings?.find(_=>_.layerIndex===y);if(w){let _=w.inHeight*w.inWidth*w.inChannels,I=A.length,L=w.outChannels*w.outHeight*w.outWidth,$=N.length,k=[w.padTop||0,w.padLeft||0,w.padBottom||0,w.padRight||0];if(!(_===I&&L===$))console.warn(`Conv2D mapping for layer ${y} skipped: dimension mismatch (expected prev=${_} got ${I}; expected this=${L} got ${$}).`);else{let M=[],T=[];for(let V=0;V<w.outChannels;V++){let rt=V*w.outHeight*w.outWidth,it=N[rt];T.push(it.bias);for(let G=0;G<w.inChannels;G++)for(let X=0;X<w.kernelHeight;X++)for(let Z=0;Z<w.kernelWidth;Z++){let at=G*(w.inHeight*w.inWidth)+X*w.inWidth+Z,et=A[at],J=it.connections.in.find(ot=>ot.from===et);M.push(J?J.weight:0)}}let D=`ConvW${y-1}`,E=`ConvB${y-1}`;f.graph.initializer.push({name:D,data_type:1,dims:[w.outChannels,w.inChannels,w.kernelHeight,w.kernelWidth],float_data:M}),f.graph.initializer.push({name:E,data_type:1,dims:[w.outChannels],float_data:T});let R=`Conv_${y}`;f.graph.node.push({op_type:"Conv",input:[m,D,E],output:[R],name:`conv_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:[w.kernelHeight,w.kernelWidth]},{name:"strides",type:"INTS",ints:[w.strideHeight,w.strideWidth]},{name:"pads",type:"INTS",ints:k}]});let O=w.activation||Zt(N[0].squash),P=`Layer_${y}`;f.graph.node.push({op_type:O,input:[R],output:[P],name:`act_conv_l${y}`}),m=P;let C=n.pool2dMappings?.find(V=>V.afterLayerIndex===y);if(C){let V=[C.kernelHeight,C.kernelWidth],rt=[C.strideHeight,C.strideWidth],it=[C.padTop||0,C.padLeft||0,C.padBottom||0,C.padRight||0],G=`Pool_${y}`;if(f.graph.node.push({op_type:C.type,input:[m],output:[G],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:V},{name:"strides",type:"INTS",ints:rt},{name:"pads",type:"INTS",ints:it}]}),m=G,n.flattenAfterPooling){let at=`PoolFlat_${y}`;f.graph.node.push({op_type:"Flatten",input:[m],output:[at],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),m=at,f.metadata_props=f.metadata_props||[];let et=f.metadata_props.find(J=>J.key==="flatten_layers");if(et)try{let J=JSON.parse(et.value);Array.isArray(J)&&!J.includes(y)&&(J.push(y),et.value=JSON.stringify(J))}catch{et.value=JSON.stringify([y])}else f.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}f.metadata_props=f.metadata_props||[];let X=f.metadata_props.find(at=>at.key==="pool2d_layers");if(X)try{let at=JSON.parse(X.value);Array.isArray(at)&&!at.includes(y)&&(at.push(y),X.value=JSON.stringify(at))}catch{X.value=JSON.stringify([y])}else f.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let Z=f.metadata_props.find(at=>at.key==="pool2d_specs");if(Z)try{let at=JSON.parse(Z.value);Array.isArray(at)&&(at.push({...C}),Z.value=JSON.stringify(at))}catch{Z.value=JSON.stringify([C])}else f.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([C])})}f.metadata_props=f.metadata_props||[];let B=f.metadata_props.find(V=>V.key==="conv2d_layers");if(B)try{let V=JSON.parse(B.value);Array.isArray(V)&&!V.includes(y)&&(V.push(y),B.value=JSON.stringify(V))}catch{B.value=JSON.stringify([y])}else f.metadata_props.push({key:"conv2d_layers",value:JSON.stringify([y])});let Y=f.metadata_props.find(V=>V.key==="conv2d_specs");if(Y)try{let V=JSON.parse(Y.value);Array.isArray(V)&&(V.push({...w}),Y.value=JSON.stringify(V))}catch{Y.value=JSON.stringify([w])}else f.metadata_props.push({key:"conv2d_specs",value:JSON.stringify([w])});continue}}let x=n.allowMixedActivations&&new Set(N.map(_=>_.squash&&_.squash.name)).size>1;if(b.includes(y)&&!v){if(x)throw new Error(`Recurrent export does not yet support mixed activations in hidden layer ${y}.`);let _=[],I=new Array(N.length).fill(0);for(let T=0;T<N.length;T++){let D=N[T];I[T]=D.bias;for(let E=0;E<A.length;E++){let R=A[E],O=D.connections.in.find(P=>P.from===R);_.push(O?O.weight:0)}}let L=`W${y-1}`,$=`B${y-1}`;f.graph.initializer.push({name:L,data_type:1,dims:[N.length,A.length],float_data:_}),f.graph.initializer.push({name:$,data_type:1,dims:[N.length],float_data:I});let k=[];for(let T=0;T<N.length;T++)for(let D=0;D<N.length;D++)if(T===D){let E=N[T].connections.self[0];k.push(E?E.weight:0)}else k.push(0);let F=`R${y-1}`;f.graph.initializer.push({name:F,data_type:1,dims:[N.length,N.length],float_data:k}),f.graph.node.push({op_type:"Gemm",input:[m,L,$],output:[`Gemm_in_${y}`],name:`gemm_in_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]});let M=y===1?"hidden_prev":`hidden_prev_l${y}`;f.graph.node.push({op_type:"Gemm",input:[M,F],output:[`Gemm_rec_${y}`],name:`gemm_rec_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),f.graph.node.push({op_type:"Add",input:[`Gemm_in_${y}`,`Gemm_rec_${y}`],output:[`RecurrentSum_${y}`],name:`add_recurrent_l${y}`}),f.graph.node.push({op_type:Zt(N[0].squash),input:[`RecurrentSum_${y}`],output:[`Layer_${y}`],name:`act_l${y}`}),m=`Layer_${y}`}else if(x){let _=[];N.forEach(($,k)=>{let F=[];for(let R=0;R<A.length;R++){let O=A[R],P=$.connections.in.find(C=>C.from===O);F.push(P?P.weight:0)}let M=`W${y-1}_n${k}`,T=`B${y-1}_n${k}`,D=`Gemm_${y}_n${k}`,E=`Layer_${y}_n${k}`;f.graph.initializer.push({name:M,data_type:1,dims:[1,A.length],float_data:F}),f.graph.initializer.push({name:T,data_type:1,dims:[1],float_data:[$.bias]}),f.graph.node.push({op_type:"Gemm",input:[m,M,T],output:[D],name:`gemm_l${y}_n${k}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),f.graph.node.push({op_type:Zt($.squash),input:[D],output:[E],name:`act_l${y}_n${k}`}),_.push(E)});let I=`Layer_${y}`;f.graph.node.push({op_type:"Concat",input:_,output:[I],name:`concat_l${y}`,attributes:[{name:"axis",type:"INT",i:i?1:0}]}),m=I;let L=n.pool2dMappings?.find($=>$.afterLayerIndex===y);if(L){let $=[L.kernelHeight,L.kernelWidth],k=[L.strideHeight,L.strideWidth],F=[L.padTop||0,L.padLeft||0,L.padBottom||0,L.padRight||0],M=`Pool_${y}`;if(f.graph.node.push({op_type:L.type,input:[m],output:[M],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:$},{name:"strides",type:"INTS",ints:k},{name:"pads",type:"INTS",ints:F}]}),m=M,n.flattenAfterPooling){let E=`PoolFlat_${y}`;f.graph.node.push({op_type:"Flatten",input:[m],output:[E],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),m=E,f.metadata_props=f.metadata_props||[];let R=f.metadata_props.find(O=>O.key==="flatten_layers");if(R)try{let O=JSON.parse(R.value);Array.isArray(O)&&!O.includes(y)&&(O.push(y),R.value=JSON.stringify(O))}catch{R.value=JSON.stringify([y])}else f.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}f.metadata_props=f.metadata_props||[];let T=f.metadata_props.find(E=>E.key==="pool2d_layers");if(T)try{let E=JSON.parse(T.value);Array.isArray(E)&&!E.includes(y)&&(E.push(y),T.value=JSON.stringify(E))}catch{T.value=JSON.stringify([y])}else f.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let D=f.metadata_props.find(E=>E.key==="pool2d_specs");if(D)try{let E=JSON.parse(D.value);Array.isArray(E)&&(E.push({...L}),D.value=JSON.stringify(E))}catch{D.value=JSON.stringify([L])}else f.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([L])})}}else{let _=[],I=new Array(N.length).fill(0);for(let T=0;T<N.length;T++){let D=N[T];I[T]=D.bias;for(let E=0;E<A.length;E++){let R=A[E],O=D.connections.in.find(P=>P.from===R);_.push(O?O.weight:0)}}let L=`W${y-1}`,$=`B${y-1}`,k=`Gemm_${y}`,F=`Layer_${y}`;f.graph.initializer.push({name:L,data_type:1,dims:[N.length,A.length],float_data:_}),f.graph.initializer.push({name:$,data_type:1,dims:[N.length],float_data:I}),a?(f.graph.node.push({op_type:Zt(N[0].squash),input:[k],output:[F],name:`act_l${y}`}),f.graph.node.push({op_type:"Gemm",input:[m,L,$],output:[k],name:`gemm_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]})):(f.graph.node.push({op_type:"Gemm",input:[m,L,$],output:[k],name:`gemm_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),f.graph.node.push({op_type:Zt(N[0].squash),input:[k],output:[F],name:`act_l${y}`})),m=F;let M=n.pool2dMappings?.find(T=>T.afterLayerIndex===y);if(M){let T=[M.kernelHeight,M.kernelWidth],D=[M.strideHeight,M.strideWidth],E=[M.padTop||0,M.padLeft||0,M.padBottom||0,M.padRight||0],R=`Pool_${y}`;if(f.graph.node.push({op_type:M.type,input:[m],output:[R],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:T},{name:"strides",type:"INTS",ints:D},{name:"pads",type:"INTS",ints:E}]}),m=R,n.flattenAfterPooling){let C=`PoolFlat_${y}`;f.graph.node.push({op_type:"Flatten",input:[m],output:[C],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),m=C,f.metadata_props=f.metadata_props||[];let B=f.metadata_props.find(Y=>Y.key==="flatten_layers");if(B)try{let Y=JSON.parse(B.value);Array.isArray(Y)&&!Y.includes(y)&&(Y.push(y),B.value=JSON.stringify(Y))}catch{B.value=JSON.stringify([y])}else f.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}f.metadata_props=f.metadata_props||[];let O=f.metadata_props.find(C=>C.key==="pool2d_layers");if(O)try{let C=JSON.parse(O.value);Array.isArray(C)&&!C.includes(y)&&(C.push(y),O.value=JSON.stringify(C))}catch{O.value=JSON.stringify([y])}else f.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let P=f.metadata_props.find(C=>C.key==="pool2d_specs");if(P)try{let C=JSON.parse(P.value);Array.isArray(C)&&(C.push({...M}),P.value=JSON.stringify(C))}catch{P.value=JSON.stringify([M])}else f.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([M])})}}}if(n.allowRecurrent)for(let y=1;y<t.length-1;y++){let A=t[y],N=A.length;if(f.metadata_props||(f.metadata_props=[]),N>=8&&N<10&&f.metadata_props.push({key:"rnn_pattern_fallback",value:JSON.stringify({layer:y,reason:"size_between_gru_lstm_thresholds"})}),N>=10&&N%5===0){let v=N/5,w=t[y-1],x=A.slice(0,v),_=A.slice(v,v*2),I=A.slice(v*2,v*3),L=A.slice(v*3,v*4),$=A.slice(v*4,v*5),k=[x,_,I,L],F=k.length,M=w.length,T=[],D=[],E=[];for(let O=0;O<F;O++){let P=k[O];for(let C=0;C<v;C++){let B=P[C];for(let Y=0;Y<M;Y++){let V=w[Y],rt=B.connections.in.find(it=>it.from===V);T.push(rt?rt.weight:0)}for(let Y=0;Y<v;Y++)if(P===I&&Y===C){let V=B.connections.self[0];D.push(V?V.weight:0)}else D.push(0);E.push(B.bias)}}f.graph.initializer.push({name:`LSTM_W${y-1}`,data_type:1,dims:[F*v,M],float_data:T}),f.graph.initializer.push({name:`LSTM_R${y-1}`,data_type:1,dims:[F*v,v],float_data:D}),f.graph.initializer.push({name:`LSTM_B${y-1}`,data_type:1,dims:[F*v],float_data:E}),f.graph.node.push({op_type:"LSTM",input:[m,`LSTM_W${y-1}`,`LSTM_R${y-1}`,`LSTM_B${y-1}`],output:[`Layer_${y}_lstm_hidden`],name:`lstm_l${y}`,attributes:[{name:"hidden_size",type:"INT",i:v},{name:"layout",type:"INT",i:0}]}),f.metadata_props=f.metadata_props||[];let R=f.metadata_props.findIndex(O=>O.key==="lstm_emitted_layers");if(R>=0)try{let O=JSON.parse(f.metadata_props[R].value);Array.isArray(O)&&!O.includes(y)&&(O.push(y),f.metadata_props[R].value=JSON.stringify(O))}catch{f.metadata_props[R].value=JSON.stringify([y])}else f.metadata_props.push({key:"lstm_emitted_layers",value:JSON.stringify([y])})}if(N>=8&&N%4===0){let v=N/4,w=t[y-1],x=A.slice(0,v),_=A.slice(v,v*2),I=A.slice(v*2,v*3),L=A.slice(v*3,v*4),$=[x,_,I],k=$.length,F=w.length,M=[],T=[],D=[];for(let O=0;O<k;O++){let P=$[O];for(let C=0;C<v;C++){let B=P[C];for(let Y=0;Y<F;Y++){let V=w[Y],rt=B.connections.in.find(it=>it.from===V);M.push(rt?rt.weight:0)}for(let Y=0;Y<v;Y++)if(P===I&&Y===C){let V=B.connections.self[0];T.push(V?V.weight:0)}else T.push(0);D.push(B.bias)}}f.graph.initializer.push({name:`GRU_W${y-1}`,data_type:1,dims:[k*v,F],float_data:M}),f.graph.initializer.push({name:`GRU_R${y-1}`,data_type:1,dims:[k*v,v],float_data:T}),f.graph.initializer.push({name:`GRU_B${y-1}`,data_type:1,dims:[k*v],float_data:D});let E=y===1?"input":`Layer_${y-1}`;f.graph.node.push({op_type:"GRU",input:[E,`GRU_W${y-1}`,`GRU_R${y-1}`,`GRU_B${y-1}`],output:[`Layer_${y}_gru_hidden`],name:`gru_l${y}`,attributes:[{name:"hidden_size",type:"INT",i:v},{name:"layout",type:"INT",i:0}]}),f.metadata_props=f.metadata_props||[];let R=f.metadata_props.findIndex(O=>O.key==="gru_emitted_layers");if(R>=0)try{let O=JSON.parse(f.metadata_props[R].value);Array.isArray(O)&&!O.includes(y)&&(O.push(y),f.metadata_props[R].value=JSON.stringify(O))}catch{f.metadata_props[R].value=JSON.stringify([y])}else f.metadata_props.push({key:"gru_emitted_layers",value:JSON.stringify([y])})}}if(s&&(f.metadata_props=f.metadata_props||[],f.metadata_props.push({key:"layer_sizes",value:JSON.stringify(g)}),b.length&&f.metadata_props.push({key:"recurrent_single_step",value:JSON.stringify(b)}),n.validateConvSharing&&n.conv2dMappings&&n.conv2dMappings.length)){let y=[],A=[];for(let N of n.conv2dMappings){let v=N.layerIndex,w=t[v-1],x=t[v];if(!x||!w)continue;let _=[],I=!0;for(let $=0;$<N.outChannels;$++){let k=$*(N.outHeight*N.outWidth),F=x[k],M=[];for(let T=0;T<N.inChannels;T++)for(let D=0;D<N.kernelHeight;D++)for(let E=0;E<N.kernelWidth;E++){let R=T*(N.inHeight*N.inWidth)+D*N.inWidth+E,O=w[R],P=F.connections.in.find(C=>C.from===O);M.push(P?P.weight:0)}_.push(M)}let L=1e-9;for(let $=0;$<N.outChannels&&I;$++)for(let k=0;k<N.outHeight&&I;k++)for(let F=0;F<N.outWidth&&I;F++){let M=$*(N.outHeight*N.outWidth)+k*N.outWidth+F,T=x[M];if(!T)continue;let D=0;for(let E=0;E<N.inChannels&&I;E++){let R=k*N.strideHeight-(N.padTop||0),O=F*N.strideWidth-(N.padLeft||0);for(let P=0;P<N.kernelHeight&&I;P++)for(let C=0;C<N.kernelWidth&&I;C++){let B=R+P,Y=O+C;if(B<0||B>=N.inHeight||Y<0||Y>=N.inWidth){D++;continue}let V=E*(N.inHeight*N.inWidth)+B*N.inWidth+Y,rt=w[V],it=T.connections.in.find(X=>X.from===rt),G=it?it.weight:0;Math.abs(G-_[$][D])>L&&(I=!1),D++}}if(!I)break}I?y.push(v):(A.push(v),console.warn(`Conv2D weight sharing mismatch detected in layer ${v}`))}y.length&&f.metadata_props.push({key:"conv2d_sharing_verified",value:JSON.stringify(y)}),A.length&&f.metadata_props.push({key:"conv2d_sharing_mismatch",value:JSON.stringify(A)})}return f}function gn(e,t={}){if(zo(e),e.nodes.forEach((i,a)=>i.index=a),!e.connections||e.connections.length===0)throw new Error("ONNX export currently only supports simple MLPs");let n=qo(e),s=[];if(t.allowRecurrent)try{for(let i=1;i<n.length-1;i++){let a=n[i],r=a.length;if(r>=10&&r%5===0){let c=r/5;a.slice(c*2,c*3).every(p=>p.connections.self.length===1)&&s.push({layerIndex:i,unitSize:c})}}}catch{}Vo(n,e,t);let o=Yo(e,n,t);if(t.includeMetadata){let i=[],a=[];for(let r=1;r<n.length-1;r++){let c=n[r-1].length,l=n[r].length,u=Math.sqrt(c);if(Math.abs(u-Math.round(u))>1e-9)continue;let p=Math.round(u);for(let h of[3,2]){if(h>=p)continue;let d=p-h+1;if(d*d===l){if(t.conv2dMappings?.some(m=>m.layerIndex===r))break;a.push(r),i.push({layerIndex:r,inHeight:p,inWidth:p,inChannels:1,kernelHeight:h,kernelWidth:h,strideHeight:1,strideWidth:1,outHeight:d,outWidth:d,outChannels:1,note:"heuristic_inferred_no_export_applied"});break}}}a.length&&(o.metadata_props=o.metadata_props||[],o.metadata_props.push({key:"conv2d_inferred_layers",value:JSON.stringify(a)}),o.metadata_props.push({key:"conv2d_inferred_specs",value:JSON.stringify(i)}))}return s.length&&(o.metadata_props=o.metadata_props||[],o.metadata_props.push({key:"lstm_groups_stub",value:JSON.stringify(s)})),o}var Re=H(()=>{"use strict";ft();Nt()});var bn=H(()=>{"use strict";Re();Re()});function Sn(e){if(!e.nodes.some(d=>d.type==="output"))throw new Error("Cannot create standalone function: network has no output nodes.");let t={},n=[],s={},o=0,i=[],a=[],r=[],c={logistic:"function logistic(x){ return 1 / (1 + Math.exp(-x)); }",tanh:"function tanh(x){ return Math.tanh(x); }",relu:"function relu(x){ return x > 0 ? x : 0; }",identity:"function identity(x){ return x; }",step:"function step(x){ return x > 0 ? 1 : 0; }",softsign:"function softsign(x){ return x / (1 + Math.abs(x)); }",sinusoid:"function sinusoid(x){ return Math.sin(x); }",gaussian:"function gaussian(x){ return Math.exp(-Math.pow(x, 2)); }",bentIdentity:"function bentIdentity(x){ return (Math.sqrt(Math.pow(x, 2) + 1) - 1) / 2 + x; }",bipolar:"function bipolar(x){ return x > 0 ? 1 : -1; }",bipolarSigmoid:"function bipolarSigmoid(x){ return 2 / (1 + Math.exp(-x)) - 1; }",hardTanh:"function hardTanh(x){ return Math.max(-1, Math.min(1, x)); }",absolute:"function absolute(x){ return Math.abs(x); }",inverse:"function inverse(x){ return 1 - x; }",selu:"function selu(x){ var a=1.6732632423543772,s=1.0507009873554805; var fx=x>0?x:a*Math.exp(x)-a; return fx*s; }",softplus:"function softplus(x){ if(x>30)return x; if(x<-30)return Math.exp(x); return Math.max(0,x)+Math.log(1+Math.exp(-Math.abs(x))); }",swish:"function swish(x){ var s=1/(1+Math.exp(-x)); return x*s; }",gelu:"function gelu(x){ var cdf=0.5*(1.0+Math.tanh(Math.sqrt(2.0/Math.PI)*(x+0.044715*Math.pow(x,3)))); return x*cdf; }",mish:"function mish(x){ var sp_x; if(x>30){sp_x=x;}else if(x<-30){sp_x=Math.exp(x);}else{sp_x=Math.log(1+Math.exp(x));} var tanh_sp_x=Math.tanh(sp_x); return x*tanh_sp_x; }"};e.nodes.forEach((d,f)=>{d.index=f,i.push(d.activation),a.push(d.state)}),r.push("for(var i = 0; i < input.length; i++) A[i] = input[i];");for(let d=e.input;d<e.nodes.length;d++){let f=e.nodes[d],m=f.squash,b=m.name||`anonymous_squash_${d}`;if(!(b in t)){let v;c[b]?(v=c[b],v.startsWith(`function ${b}`)||(v=`function ${b}${v.substring(v.indexOf("("))}`),v=An(v)):(v=m.toString(),v=An(v),v.startsWith("function")?v=`function ${b}${v.substring(v.indexOf("("))}`:v.includes("=>")?v=`function ${b}${v.substring(v.indexOf("("))}`:v=`function ${b}(x){ return x; }`),t[b]=v,n.push(v),s[b]=o++}let g=s[b],y=[];for(let v of f.connections.in){if(typeof v.from.index>"u")continue;let w=`A[${v.from.index}] * ${v.weight}`;v.gater&&typeof v.gater.index<"u"&&(w+=` * A[${v.gater.index}]`),y.push(w)}if(f.connections.self.length>0){let v=f.connections.self[0],w=`S[${d}] * ${v.weight}`;v.gater&&typeof v.gater.index<"u"&&(w+=` * A[${v.gater.index}]`),y.push(w)}let A=y.length>0?y.join(" + "):"0";r.push(`S[${d}] = ${A} + ${f.bias};`);let N=typeof f.mask=="number"&&f.mask!==1?f.mask:1;r.push(`A[${d}] = F[${g}](S[${d}])${N!==1?` * ${N}`:""};`)}let l=[];for(let d=e.nodes.length-e.output;d<e.nodes.length;d++)typeof e.nodes[d]?.index<"u"&&l.push(e.nodes[d].index);r.push(`return [${l.map(d=>`A[${d}]`).join(",")}];`);let u=Object.entries(s).sort(([,d],[,f])=>d-f).map(([d])=>d).join(","),p=e._activationPrecision==="f32"?"Float32Array":"Float64Array",h="";return h+=`(function(){
`,h+=`${n.join(`
`)}
`,h+=`var F = [${u}];
`,h+=`var A = new ${p}([${i.join(",")}]);
`,h+=`var S = new ${p}([${a.join(",")}]);
`,h+=`function activate(input){
`,h+=`if (!input || input.length !== ${e.input}) { throw new Error('Invalid input size. Expected ${e.input}, got ' + (input ? input.length : 'undefined')); }
`,h+=r.join(`
`),h+=`}
`,h+=`return activate;
})();`,h}var An,Nn=H(()=>{"use strict";An=e=>(e=e.replace(/\/\*\s*istanbul\s+ignore\s+[\s\S]*?\*\//g,""),e=e.replace(/cov_[\w$]+\(\)\.(s|f|b)\[\d+\](\[\d+\])?\+\+/g,""),e=e.replace(/cov_[\w$]+\(\)/g,""),e=e.replace(/^\s*\/\/ # sourceMappingURL=.*\s*$/gm,""),e=e.replace(/\(\s*,\s*/g,"( "),e=e.replace(/\s*,\s*\)/g," )"),e=e.trim(),e=e.replace(/^\s*;\s*$/gm,""),e=e.replace(/;{2,}/g,";"),e=e.replace(/^\s*[,;]?\s*$/gm,""),e)});function vn(){let e=this;if(!e._enforceAcyclic){e._topoOrder=null,e._topoDirty=!1;return}let t=new Map;this.nodes.forEach(o=>t.set(o,0));for(let o of this.connections)o.from!==o.to&&t.set(o.to,(t.get(o.to)||0)+1);let n=[];this.nodes.forEach(o=>{(o.type==="input"||(t.get(o)||0)===0)&&n.push(o)});let s=[];for(;n.length;){let o=n.shift();s.push(o);for(let i of o.connections.out){if(i.to===o)continue;let a=(t.get(i.to)||0)-1;t.set(i.to,a),a===0&&n.push(i.to)}}e._topoOrder=s.length===this.nodes.length?s:this.nodes.slice(),e._topoDirty=!1}function wn(e,t){if(e===t)return!0;let n=new Set,s=[e];for(;s.length;){let o=s.pop();if(o===t)return!0;if(!n.has(o)){n.add(o);for(let i of o.connections.out)i.to!==o&&s.push(i.to)}}return!1}var xn=H(()=>{"use strict"});function Xo(){let e=j.slabPoolMaxPerKey;return e===void 0?4:e<0?0:e|0}function Mn(e,t,n){return e+":"+t+":"+n}function Bt(e,t,n,s){if(!j.enableSlabArrayPooling)return Le.fresh++,new t(n);let o=Mn(e,s,n),i=_n[o];return i&&i.length?(Le.pooled++,(Pe[o]||={created:0,reused:0,maxRetained:0}).reused++,i.pop()):(Le.fresh++,(Pe[o]||={created:0,reused:0,maxRetained:0}).created++,new t(n))}function Mt(e,t,n){if(!j.enableSlabArrayPooling)return;let s=Mn(e,t,n.length),o=_n[s]||=[];o.length<Xo()&&o.push(n);let i=Pe[s]||={created:0,reused:0,maxRetained:0};o.length>i.maxRetained&&(i.maxRetained=o.length)}function re(e=!1){let t=this;if(!e&&!t._slabDirty)return;t._nodeIndexDirty&&En.call(this);let n=this.connections.length,s=t._connCapacity||0,o=typeof window>"u"?1.75:1.25;if(s<n){for(s=s===0?Math.ceil(n*o):s;s<n;)s=Math.ceil(s*o);t._connWeights&&Mt("w",t._useFloat32Weights?4:8,t._connWeights),t._connFrom&&Mt("f",4,t._connFrom),t._connTo&&Mt("t",4,t._connTo),t._connFlags&&Mt("fl",1,t._connFlags),t._connGain&&Mt("g",t._useFloat32Weights?4:8,t._connGain),t._connPlastic&&Mt("p",t._useFloat32Weights?4:8,t._connPlastic),t._connWeights=Bt("w",t._useFloat32Weights?Float32Array:Float64Array,s,t._useFloat32Weights?4:8),t._connFrom=Bt("f",Uint32Array,s,4),t._connTo=Bt("t",Uint32Array,s,4),t._connFlags=Bt("fl",Uint8Array,s,1),t._connGain=null,t._connPlastic=null,t._connCapacity=s}else s=t._connCapacity;let a=t._connWeights,r=t._connFrom,c=t._connTo,l=t._connFlags,u=t._connGain,p=!1,h=t._connPlastic,d=!1;for(let f=0;f<n;f++){let m=this.connections[f];a[f]=m.weight,r[f]=m.from.index>>>0,c[f]=m.to.index>>>0,l[f]=m._flags&255;let b=m.gain;if(b!==1){if(!u){u=Bt("g",t._useFloat32Weights?Float32Array:Float64Array,s,t._useFloat32Weights?4:8),t._connGain=u;for(let g=0;g<f;g++)u[g]=1}u[f]=b,p=!0}else u&&(u[f]=1);m._flags&8&&(d=!0)}if(!p&&u&&(Mt("g",t._useFloat32Weights?4:8,u),t._connGain=null),d&&!h){h=Bt("p",t._useFloat32Weights?Float32Array:Float64Array,s,t._useFloat32Weights?4:8),t._connPlastic=h;for(let f=0;f<n;f++){let m=this.connections[f];h[f]=m.plasticityRate||0}}else!d&&h&&(Mt("p",t._useFloat32Weights?4:8,h),t._connPlastic=null);t._connCount=n,t._slabDirty=!1,t._adjDirty=!0,t._slabVersion=(t._slabVersion||0)+1}function In(){re.call(this);let e=this,t=e._connGain||null;if(!t){let n=e._connCapacity||e._connWeights&&e._connWeights.length||0;t=e._useFloat32Weights?new Float32Array(n):new Float64Array(n);for(let s=0;s<(e._connCount||0);s++)t[s]=1}return{weights:e._connWeights,from:e._connFrom,to:e._connTo,flags:e._connFlags,gain:t,plastic:e._connPlastic||null,version:e._slabVersion||0,used:e._connCount||0,capacity:e._connCapacity||e._connWeights&&e._connWeights.length||0}}function En(){let e=this;for(let t=0;t<this.nodes.length;t++)this.nodes[t].index=t;e._nodeIndexDirty=!1}function Jo(){let e=this;if(!e._connFrom||!e._connTo)return;let t=this.nodes.length,n=e._connCount??e._connFrom.length,s=new Uint32Array(t);for(let c=0;c<n;c++)s[e._connFrom[c]]++;let o=new Uint32Array(t+1),i=0;for(let c=0;c<t;c++)o[c]=i,i+=s[c];o[t]=i;let a=new Uint32Array(n),r=o.slice();for(let c=0;c<n;c++){let l=e._connFrom[c];a[r[l]++]=c}e._outStart=o,e._outOrder=a,e._adjDirty=!1}function Ko(e){let t=this;return!e&&t._enforceAcyclic&&!t._topoDirty&&this.gates.length===0&&this.selfconns.length===0&&this.dropout===0&&t._weightNoiseStd===0&&t._weightNoisePerHidden.length===0&&t._stochasticDepth.length===0}function Cn(e){let t=this;if(re.call(this),t._adjDirty&&Jo.call(this),this.gates&&this.gates.length>0)return this.activate(e,!1);if(!t._connWeights||!t._connFrom||!t._connTo||!t._outStart||!t._outOrder)return this.activate(e,!1);t._topoDirty&&this._computeTopoOrder(),t._nodeIndexDirty&&En.call(this);let n=t._topoOrder||this.nodes,s=this.nodes.length,o=t._activationPrecision==="f32";(!t._fastA||t._fastA.length!==s||o&&!(t._fastA instanceof Float32Array)||!o&&!(t._fastA instanceof Float64Array))&&(t._fastA=o?new Float32Array(s):new Float64Array(s)),(!t._fastS||t._fastS.length!==s||o&&!(t._fastS instanceof Float32Array)||!o&&!(t._fastS instanceof Float64Array))&&(t._fastS=o?new Float32Array(s):new Float64Array(s));let i=t._fastA,a=t._fastS;a.fill(0);for(let f=0;f<this.input;f++)i[f]=e[f],this.nodes[f].activation=e[f],this.nodes[f].state=0;let r=t._connWeights,c=t._connTo,l=t._outOrder,u=t._outStart;for(let f=0;f<n.length;f++){let m=n[f],b=m.index>>>0;if(b>=this.input){let N=a[b]+m.bias,v=m.squash(N);m.state=a[b],m.activation=v,i[b]=v}let g=u[b],y=u[b+1],A=i[b];for(let N=g;N<y;N++){let v=l[N],w=r[v],x=t._connGain;x&&(w*=x[v]),a[c[v]]+=A*w}}let p=s-this.output,h=yt.acquire(this.output);for(let f=0;f<this.output;f++)h[f]=i[p+f];let d=Array.from(h);return yt.release(h),d}function Tn(e){return Ko.call(this,e)}var _n,Pe,Le,On=H(()=>{"use strict";Kt();At();_n=Object.create(null),Pe=Object.create(null);Le={fresh:0,pooled:0}});function Rn(e,t){let n=[...e];return t==="snip"?n.sort((s,o)=>{let i=Math.abs(s.totalDeltaWeight)||Math.abs(s.previousDeltaWeight)||0,a=Math.abs(o.totalDeltaWeight)||Math.abs(o.previousDeltaWeight)||0,r=i?Math.abs(s.weight)*i:Math.abs(s.weight),c=a?Math.abs(o.weight)*a:Math.abs(o.weight);return r-c}):n.sort((s,o)=>Math.abs(s.weight)-Math.abs(o.weight)),n}function Zo(e,t,n){let s=e,o=0;for(;e.connections.length<t&&o<n;){o++;let i=e.nodes[Math.floor(s._rand()*e.nodes.length)],a=e.nodes[Math.floor(s._rand()*e.nodes.length)];!i||!a||i===a||e.connections.some(r=>r.from===i&&r.to===a)||s._enforceAcyclic&&e.nodes.indexOf(i)>e.nodes.indexOf(a)||e.connect(i,a)}}function Ln(e){let t=this._pruningConfig;if(!t||e<t.start||e>t.end||t.lastPruneIter!=null&&e===t.lastPruneIter||(e-t.start)%(t.frequency||1)!==0)return;let n=this._initialConnectionCount;if(!n)return;let s=(e-t.start)/Math.max(1,t.end-t.start),o=t.targetSparsity*Math.min(1,Math.max(0,s)),i=Math.max(1,Math.floor(n*(1-o))),a=this.connections.length-i;if(a<=0){t.lastPruneIter=e;return}let c=Rn(this.connections,t.method||"magnitude").slice(0,a);if(c.forEach(l=>this.disconnect(l.from,l.to)),t.regrowFraction&&t.regrowFraction>0){let l=Math.floor(c.length*t.regrowFraction);Zo(this,i,l*10)}t.lastPruneIter=e,this._topoDirty=!0}function Pn(e,t="magnitude"){if(e<=0)return;e>=1&&(e=.999);let n=this;n._evoInitialConnCount||(n._evoInitialConnCount=this.connections.length);let s=n._evoInitialConnCount,o=Math.max(1,Math.floor(s*(1-e))),i=this.connections.length-o;if(i<=0)return;Rn(this.connections,t).slice(0,i).forEach(c=>this.disconnect(c.from,c.to)),n._topoDirty=!0}function kn(){let e=this._initialConnectionCount;return e?1-this.connections.length/e:0}var Fn=H(()=>{"use strict";lt();Nt()});function Dn(e,t){if(!this.nodes.includes(e))throw new Error("Gating node must be part of the network to gate a connection!");if(t.gater){j.warnings&&console.warn("Connection is already gated. Skipping.");return}e.gate(t),this.gates.push(t)}function $n(e){let t=this.gates.indexOf(e);if(t===-1){j.warnings&&console.warn("Attempted to ungate a connection not in the gates list.");return}this.gates.splice(t,1),e.gater?.ungate(e)}var Hn=H(()=>{"use strict";lt();Nt();Vt();At()});function Gn(e){this._rngState=e>>>0,this._rand=()=>{this._rngState=this._rngState+1831565813>>>0;let t=Math.imul(this._rngState^this._rngState>>>15,1|this._rngState);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}function Bn(){return{step:this._trainingStep,state:this._rngState}}function Wn(e){this._rand=e,this._rngState=void 0}function jn(){return this._rngState}function Un(e){typeof e=="number"&&(this._rngState=e>>>0)}var zn=H(()=>{"use strict"});function Qo(e){try{return globalThis.structuredClone?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e))}catch{return JSON.parse(JSON.stringify(e))}}function qn(){let e=this._lastStats;return e?Qo(e):null}var Vn=H(()=>{"use strict"});function Yn(e){let t=this,n=this.nodes.indexOf(e);if(n===-1)throw new Error("Node not in network");if(e.type==="input"||e.type==="output")throw new Error("Cannot remove input or output node from the network.");this.gates=this.gates.filter(a=>a.gater===e?(a.gater=null,!1):!0);let s=e.connections.in.slice(),o=e.connections.out.slice();s.forEach(a=>this.disconnect(a.from,a.to)),o.forEach(a=>this.disconnect(a.from,a.to)),e.connections.self.slice().forEach(()=>this.disconnect(e,e));let i=this.nodes.splice(n,1)[0];j.enableNodePooling&&i&&oe(i),s.forEach(a=>{o.forEach(r=>{if(!a.from||!r.to||a.from===r.to)return;this.connections.some(l=>l.from===a.from&&l.to===r.to)||this.connect(a.from,r.to)})}),t._topoDirty=!0,t._nodeIndexDirty=!0,t._slabDirty=!0,t._adjDirty=!0}var Xn=H(()=>{"use strict";_e();At()});function Jn(e,t,n){if(this._enforceAcyclic&&this.nodes.indexOf(e)>this.nodes.indexOf(t))return[];let s=e.connect(t,n);for(let o of s)if(e!==t)this.connections.push(o);else{if(this._enforceAcyclic)continue;this.selfconns.push(o)}return s.length&&(this._topoDirty=!0,this._slabDirty=!0),s}function Kn(e,t){let n=e===t?this.selfconns:this.connections;for(let s=0;s<n.length;s++){let o=n[s];if(o.from===e&&o.to===t){o.gater&&this.ungate(o),n.splice(s,1);break}}e.disconnect(t),this._topoDirty=!0,this._slabDirty=!0}var Zn=H(()=>{"use strict";lt();Nt()});function Qn(){this.nodes.forEach((a,r)=>a.index=r);let e=this.nodes.map(a=>a.activation),t=this.nodes.map(a=>a.state),n=this.nodes.map(a=>a.squash.name),s=this.connections.concat(this.selfconns).map(a=>({from:a.from.index,to:a.to.index,weight:a.weight,gater:a.gater?a.gater.index:null})),o=this.input,i=this.output;return[e,t,n,s,o,i]}function ts(e,t,n){let[s,o,i,a,r,c]=e,l=typeof t=="number"?t:r||0,u=typeof n=="number"?n:c||0,p=new(pt(),K(kt)).default(l,u);return p.nodes=[],p.connections=[],p.selfconns=[],p.gates=[],s.forEach((h,d)=>{let f;d<l?f="input":d>=s.length-u?f="output":f="hidden";let m=new Q(f);m.activation=h,m.state=o[d];let b=i[d];q[b]||console.warn(`Unknown squash function '${String(b)}' encountered during deserialize. Falling back to identity.`),m.squash=q[b]||q.identity,m.index=d,p.nodes.push(m)}),a.forEach(h=>{if(h.from<p.nodes.length&&h.to<p.nodes.length){let d=p.nodes[h.from],f=p.nodes[h.to],m=p.connect(d,f,h.weight)[0];m&&h.gater!=null&&(h.gater<p.nodes.length?p.gate(p.nodes[h.gater],m):console.warn("Invalid gater index encountered during deserialize; skipping gater assignment."))}else console.warn("Invalid connection indices encountered during deserialize; skipping connection.")}),p}function es(){let e={formatVersion:2,input:this.input,output:this.output,dropout:this.dropout,nodes:[],connections:[]};return this.nodes.forEach((t,n)=>{if(t.index=n,e.nodes.push({type:t.type,bias:t.bias,squash:t.squash.name,index:n,geneId:t.geneId}),t.connections.self.length>0){let s=t.connections.self[0];e.connections.push({from:n,to:n,weight:s.weight,gater:s.gater?s.gater.index:null,enabled:s.enabled!==!1})}}),this.connections.forEach(t=>{typeof t.from.index!="number"||typeof t.to.index!="number"||e.connections.push({from:t.from.index,to:t.to.index,weight:t.weight,gater:t.gater?t.gater.index:null,enabled:t.enabled!==!1})}),e}function ns(e){if(!e||typeof e!="object")throw new Error("Invalid JSON for network.");e.formatVersion!==2&&console.warn("fromJSONImpl: Unknown formatVersion, attempting import.");let t=new(pt(),K(kt)).default(e.input,e.output);return t.dropout=e.dropout||0,t.nodes=[],t.connections=[],t.selfconns=[],t.gates=[],e.nodes.forEach((n,s)=>{let o=new Q(n.type);o.bias=n.bias,o.squash=q[n.squash]||q.identity,o.index=s,typeof n.geneId=="number"&&(o.geneId=n.geneId),t.nodes.push(o)}),e.connections.forEach(n=>{if(typeof n.from!="number"||typeof n.to!="number")return;let s=t.nodes[n.from],o=t.nodes[n.to],i=t.connect(s,o,n.weight)[0];i&&n.gater!=null&&typeof n.gater=="number"&&t.nodes[n.gater]&&t.gate(t.nodes[n.gater],i),i&&typeof n.enabled<"u"&&(i.enabled=n.enabled)}),t}var ss=H(()=>{"use strict";lt();Nt();ft()});function os(e,t,n=!1){if(e.input!==t.input||e.output!==t.output)throw new Error("Parent networks must have the same input and output sizes for crossover.");let s=new(pt(),K(kt)).default(e.input,e.output);s.connections=[],s.nodes=[],s.selfconns=[],s.gates=[];let o=e.score||0,i=t.score||0,a=e.nodes.length,r=t.nodes.length,c;if(n||o===i){let m=Math.max(a,r),b=Math.min(a,r);c=Math.floor(Math.random()*(m-b+1)+b)}else c=o>i?a:r;let l=e.output;e.nodes.forEach((m,b)=>m.index=b),t.nodes.forEach((m,b)=>m.index=b);for(let m=0;m<c;m++){let b,g=m<a?e.nodes[m]:void 0,y=m<r?t.nodes[m]:void 0;if(m<e.input)b=g;else if(m>=c-l){let A=a-(c-m),N=r-(c-m),v=A>=e.input&&A<a?e.nodes[A]:void 0,w=N>=t.input&&N<r?t.nodes[N]:void 0;v&&w?b=(e._rand||Math.random)()>=.5?v:w:b=v||w}else g&&y?b=(e._rand||Math.random)()>=.5?g:y:g&&(o>=i||n)?b=g:y&&(i>=o||n)&&(b=y);if(b){let A=new Q(b.type);A.bias=b.bias,A.squash=b.squash,s.nodes.push(A)}}s.nodes.forEach((m,b)=>m.index=b);let u={},p={};e.connections.concat(e.selfconns).forEach(m=>{typeof m.from.index=="number"&&typeof m.to.index=="number"&&(u[dt.innovationID(m.from.index,m.to.index)]={weight:m.weight,from:m.from.index,to:m.to.index,gater:m.gater?m.gater.index:-1,enabled:m.enabled!==!1})}),t.connections.concat(t.selfconns).forEach(m=>{typeof m.from.index=="number"&&typeof m.to.index=="number"&&(p[dt.innovationID(m.from.index,m.to.index)]={weight:m.weight,from:m.from.index,to:m.to.index,gater:m.gater?m.gater.index:-1,enabled:m.enabled!==!1})});let h=[];Object.keys(u).forEach(m=>{let b=u[m];if(p[m]){let g=p[m],y=(e._rand||Math.random)()>=.5?b:g;if(b.enabled===!1||g.enabled===!1){let A=e._reenableProb??t._reenableProb??.25;y.enabled=Math.random()<A}h.push(y),delete p[m]}else if(o>=i||n){if(b.enabled===!1){let g=e._reenableProb??.25;b.enabled=Math.random()<g}h.push(b)}}),(i>=o||n)&&Object.keys(p).forEach(m=>{let b=p[m];if(b.enabled===!1){let g=t._reenableProb??.25;b.enabled=Math.random()<g}h.push(b)});let f=s.nodes.length;return h.forEach(m=>{if(m.from<f&&m.to<f){let b=s.nodes[m.from],g=s.nodes[m.to];if(m.from>=m.to)return;if(!b.isProjectingTo(g)){let y=s.connect(b,g)[0];y&&(y.weight=m.weight,y.enabled=m.enabled!==!1,m.gater!==-1&&m.gater<f&&s.gate(s.nodes[m.gater],y))}}}),s}var is=H(()=>{"use strict";lt();Nt()});var ce={};ht(ce,{activateBatch:()=>ni,activateRaw:()=>ei,noTraceActivate:()=>ti});function ti(e){let t=this;if(t._enforceAcyclic&&t._topoDirty&&this._computeTopoOrder(),!Array.isArray(e)||e.length!==this.input)throw new Error(`Input size mismatch: expected ${this.input}, got ${e?e.length:"undefined"}`);if(this._canUseFastSlab(!1))try{return this._fastSlabActivate(e)}catch{}let n=yt.acquire(this.output),s=0;this.nodes.forEach((i,a)=>{i.type==="input"?i.noTraceActivate(e[a]):i.type==="output"?n[s++]=i.noTraceActivate():i.noTraceActivate()});let o=Array.from(n);return yt.release(n),o}function ei(e,t=!1,n=1e3){return this._reuseActivationArrays?this.activate(e,t,n):this.activate(e,t,n)}function ni(e,t=!1){if(!Array.isArray(e))throw new Error("inputs must be an array of input arrays");let n=new Array(e.length);for(let s=0;s<e.length;s++){let o=e[s];if(!Array.isArray(o)||o.length!==this.input)throw new Error(`Input[${s}] size mismatch: expected ${this.input}, got ${o?o.length:"undefined"}`);n[s]=this.activate(o,t)}return n}var le=H(()=>{"use strict";Kt()});var st,ue=H(()=>{"use strict";lt();Wt();At();ft();st=class e{nodes;connections;constructor(t){this.nodes=[],this.connections={in:[],out:[],self:[]};for(let n=0;n<t;n++)this.nodes.push(new Q)}activate(t){let n=[];if(t!==void 0&&t.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let s=0;s<this.nodes.length;s++){let o=t===void 0?this.nodes[s].activate():this.nodes[s].activate(t[s]);n.push(o)}return n}propagate(t,n,s){if(s!==void 0&&s.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let o=this.nodes.length-1;o>=0;o--)s===void 0?this.nodes[o].propagate(t,n,!0,0):this.nodes[o].propagate(t,n,!0,0,s[o])}connect(t,n,s){let o=[],i,a;if(t instanceof e){if(n===void 0&&(this!==t?(j.warnings&&console.warn("No group connection specified, using ALL_TO_ALL by default."),n=tt.ALL_TO_ALL):(j.warnings&&console.warn("Connecting group to itself, using ONE_TO_ONE by default."),n=tt.ONE_TO_ONE)),n===tt.ALL_TO_ALL||n===tt.ALL_TO_ELSE)for(i=0;i<this.nodes.length;i++)for(a=0;a<t.nodes.length;a++){if(n===tt.ALL_TO_ELSE&&this.nodes[i]===t.nodes[a])continue;let r=this.nodes[i].connect(t.nodes[a],s);this.connections.out.push(r[0]),t.connections.in.push(r[0]),o.push(r[0])}else if(n===tt.ONE_TO_ONE){if(this.nodes.length!==t.nodes.length)throw new Error("Cannot create ONE_TO_ONE connection: source and target groups must have the same size.");for(i=0;i<this.nodes.length;i++){let r=this.nodes[i].connect(t.nodes[i],s);this===t?this.connections.self.push(r[0]):(this.connections.out.push(r[0]),t.connections.in.push(r[0])),o.push(r[0])}}}else if(t instanceof It)o=t.input(this,n,s);else if(t instanceof Q)for(i=0;i<this.nodes.length;i++){let r=this.nodes[i].connect(t,s);this.connections.out.push(r[0]),o.push(r[0])}return o}gate(t,n){if(n===void 0)throw new Error("Please specify a gating method: Gating.INPUT, Gating.OUTPUT, or Gating.SELF");Array.isArray(t)||(t=[t]);let s=[],o=[],i,a;for(i=0;i<t.length;i++){let r=t[i];s.includes(r.from)||s.push(r.from),o.includes(r.to)||o.push(r.to)}switch(n){case St.INPUT:for(let r=0;r<t.length;r++){let c=t[r];this.nodes[r%this.nodes.length].gate(c)}break;case St.OUTPUT:for(i=0;i<s.length;i++){let r=s[i],c=this.nodes[i%this.nodes.length];for(a=0;a<r.connections.out.length;a++){let l=r.connections.out[a];t.includes(l)&&c.gate(l)}}break;case St.SELF:for(i=0;i<s.length;i++){let r=s[i],c=this.nodes[i%this.nodes.length],l=Array.isArray(r.connections.self)?r.connections.self[0]:r.connections.self;t.includes(l)&&c.gate(l)}break}}set(t){for(let n=0;n<this.nodes.length;n++)t.bias!==void 0&&(this.nodes[n].bias=t.bias),this.nodes[n].squash=t.squash||this.nodes[n].squash,this.nodes[n].type=t.type||this.nodes[n].type}disconnect(t,n=!1){let s,o,i;if(t instanceof e)for(s=0;s<this.nodes.length;s++)for(o=0;o<t.nodes.length;o++){for(this.nodes[s].disconnect(t.nodes[o],n),i=this.connections.out.length-1;i>=0;i--){let a=this.connections.out[i];if(a.from===this.nodes[s]&&a.to===t.nodes[o]){this.connections.out.splice(i,1);break}}if(n){for(i=this.connections.in.length-1;i>=0;i--){let a=this.connections.in[i];if(a.from===t.nodes[o]&&a.to===this.nodes[s]){this.connections.in.splice(i,1);break}}for(i=t.connections.out.length-1;i>=0;i--){let a=t.connections.out[i];if(a.from===t.nodes[o]&&a.to===this.nodes[s]){t.connections.out.splice(i,1);break}}for(i=t.connections.in.length-1;i>=0;i--){let a=t.connections.in[i];if(a.from===this.nodes[s]&&a.to===t.nodes[o]){t.connections.in.splice(i,1);break}}}}else if(t instanceof Q)for(s=0;s<this.nodes.length;s++){for(this.nodes[s].disconnect(t,n),o=this.connections.out.length-1;o>=0;o--){let a=this.connections.out[o];if(a.from===this.nodes[s]&&a.to===t){this.connections.out.splice(o,1);break}}if(n)for(o=this.connections.in.length-1;o>=0;o--){let a=this.connections.in[o];if(a.from===t&&a.to===this.nodes[s]){this.connections.in.splice(o,1);break}}}}clear(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clear()}toJSON(){return{size:this.nodes.length,nodeIndices:this.nodes.map(t=>t.index),connections:{in:this.connections.in.length,out:this.connections.out.length,self:this.connections.self.length}}}}});var ke={};ht(ke,{default:()=>It});var It,Wt=H(()=>{"use strict";lt();ue();ft();Kt();It=class e{nodes;connections;output;dropout=0;constructor(){this.output=null,this.nodes=[],this.connections={in:[],out:[],self:[]}}activate(t,n=!1){let s=yt.acquire(this.nodes.length);if(t!==void 0&&t.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");let o=1;n&&this.dropout>0?(o=Math.random()>=this.dropout?1:0,this.nodes.forEach(a=>{a.mask=o})):this.nodes.forEach(a=>{a.mask=1});for(let a=0;a<this.nodes.length;a++){let r;t===void 0?r=this.nodes[a].activate():r=this.nodes[a].activate(t[a]),s[a]=r}let i=Array.from(s);return yt.release(s),i}propagate(t,n,s){if(s!==void 0&&s.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let o=this.nodes.length-1;o>=0;o--)s===void 0?this.nodes[o].propagate(t,n,!0,0):this.nodes[o].propagate(t,n,!0,0,s[o])}connect(t,n,s){if(!this.output)throw new Error("Layer output is not defined. Cannot connect from this layer.");let o=[];return t instanceof e?o=t.input(this,n,s):(t instanceof st||t instanceof Q)&&(o=this.output.connect(t,n,s)),o}gate(t,n){if(!this.output)throw new Error("Layer output is not defined. Cannot gate from this layer.");this.output.gate(t,n)}set(t){for(let n=0;n<this.nodes.length;n++){let s=this.nodes[n];s instanceof Q?(t.bias!==void 0&&(s.bias=t.bias),s.squash=t.squash||s.squash,s.type=t.type||s.type):this.isGroup(s)&&s.set(t)}}disconnect(t,n){n=n||!1;let s,o,i;if(t instanceof st)for(s=0;s<this.nodes.length;s++)for(o=0;o<t.nodes.length;o++){for(this.nodes[s].disconnect(t.nodes[o],n),i=this.connections.out.length-1;i>=0;i--){let a=this.connections.out[i];if(a.from===this.nodes[s]&&a.to===t.nodes[o]){this.connections.out.splice(i,1);break}}if(n)for(i=this.connections.in.length-1;i>=0;i--){let a=this.connections.in[i];if(a.from===t.nodes[o]&&a.to===this.nodes[s]){this.connections.in.splice(i,1);break}}}else if(t instanceof Q)for(s=0;s<this.nodes.length;s++){for(this.nodes[s].disconnect(t,n),o=this.connections.out.length-1;o>=0;o--){let a=this.connections.out[o];if(a.from===this.nodes[s]&&a.to===t){this.connections.out.splice(o,1);break}}if(n)for(i=this.connections.in.length-1;i>=0;i--){let a=this.connections.in[i];if(a.from===t&&a.to===this.nodes[s]){this.connections.in.splice(i,1);break}}}}clear(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clear()}input(t,n,s){if(t instanceof e&&(t=t.output),n=n||tt.ALL_TO_ALL,!this.output)throw new Error("Layer output (acting as input target) is not defined.");return t.connect(this.output,n,s)}static dense(t){let n=new e,s=new st(t);return n.nodes.push(...s.nodes),n.output=s,n.input=(o,i,a)=>(o instanceof e&&(o=o.output),i=i||tt.ALL_TO_ALL,o.connect(s,i,a)),n}static lstm(t){let n=new e,s=new st(t),o=new st(t),i=new st(t),a=new st(t),r=new st(t);s.set({bias:1}),o.set({bias:1}),a.set({bias:1}),i.set({bias:0}),r.set({bias:0}),i.connect(s,tt.ALL_TO_ALL),i.connect(o,tt.ALL_TO_ALL),i.connect(a,tt.ALL_TO_ALL),i.connect(i,tt.ONE_TO_ONE);let c=i.connect(r,tt.ALL_TO_ALL);return a.gate(c,St.OUTPUT),i.nodes.forEach((l,u)=>{let p=l.connections.self.find(h=>h.to===l&&h.from===l);p?(p.gater=o.nodes[u],o.nodes[u].connections.gated.includes(p)||o.nodes[u].connections.gated.push(p)):console.warn(`LSTM Warning: No self-connection found for memory cell node ${u}`)}),n.nodes=[...s.nodes,...o.nodes,...i.nodes,...a.nodes,...r.nodes],n.output=r,n.input=(l,u,p)=>{l instanceof e&&(l=l.output),u=u||tt.ALL_TO_ALL;let h=[],d=l.connect(i,u,p);return h=h.concat(d),h=h.concat(l.connect(s,u,p)),h=h.concat(l.connect(a,u,p)),h=h.concat(l.connect(o,u,p)),s.gate(d,St.INPUT),h},n}static gru(t){let n=new e,s=new st(t),o=new st(t),i=new st(t),a=new st(t),r=new st(t),c=new st(t);c.set({bias:0,squash:q.identity,type:"variant"}),a.set({squash:q.tanh}),o.set({bias:0,squash:q.inverse,type:"variant"}),s.set({bias:1}),i.set({bias:0}),c.connect(s,tt.ALL_TO_ALL),c.connect(i,tt.ALL_TO_ALL),s.connect(o,tt.ONE_TO_ONE,1);let l=c.connect(a,tt.ALL_TO_ALL);i.gate(l,St.OUTPUT);let u=c.connect(r,tt.ALL_TO_ALL),p=a.connect(r,tt.ALL_TO_ALL);return s.gate(u,St.OUTPUT),o.gate(p,St.OUTPUT),r.connect(c,tt.ONE_TO_ONE,1),n.nodes=[...s.nodes,...o.nodes,...i.nodes,...a.nodes,...r.nodes,...c.nodes],n.output=r,n.input=(h,d,f)=>{h instanceof e&&(h=h.output),d=d||tt.ALL_TO_ALL;let m=[];return m=m.concat(h.connect(s,d,f)),m=m.concat(h.connect(i,d,f)),m=m.concat(h.connect(a,d,f)),m},n}static memory(t,n){let s=new e,o=null;for(let a=0;a<n;a++){let r=new st(t);r.set({squash:q.identity,bias:0,type:"variant"}),o?.connect(r,tt.ONE_TO_ONE,1),s.nodes.push(r),o=r}s.nodes.reverse();let i=new st(0);for(let a of s.nodes)this.prototype.isGroup(a)?i.nodes=i.nodes.concat(a.nodes):console.warn("Unexpected Node type found directly in Memory layer nodes list during output group creation.");return s.output=i,s.input=(a,r,c)=>{a instanceof e&&(a=a.output),r=r||tt.ALL_TO_ALL;let l=s.nodes[s.nodes.length-1];if(!this.prototype.isGroup(l))throw new Error("Memory layer input block is not a Group.");if(a.nodes.length!==l.nodes.length)throw new Error(`Previous layer size (${a.nodes.length}) must be same as memory size (${l.nodes.length})`);return a.connect(l,tt.ONE_TO_ONE,1)},s}static batchNorm(t){let n=e.dense(t);n.batchNorm=!0;let s=n.activate.bind(n);return n.activate=function(o,i=!1){let a=s(o,i),r=a.reduce((u,p)=>u+p,0)/a.length,c=a.reduce((u,p)=>u+(p-r)**2,0)/a.length,l=(Pt(),K(Ne)).NORM_EPSILON;return a.map(u=>(u-r)/Math.sqrt(c+l))},n}static layerNorm(t){let n=e.dense(t);n.layerNorm=!0;let s=n.activate.bind(n);return n.activate=function(o,i=!1){let a=s(o,i),r=a.reduce((u,p)=>u+p,0)/a.length,c=a.reduce((u,p)=>u+(p-r)**2,0)/a.length,l=(Pt(),K(Ne)).NORM_EPSILON;return a.map(u=>(u-r)/Math.sqrt(c+l))},n}static conv1d(t,n,s=1,o=0){let i=new e;return i.nodes=Array.from({length:t},()=>new Q),i.output=new st(t),i.conv1d={kernelSize:n,stride:s,padding:o},i.activate=function(a){return a?a.slice(0,t):this.nodes.map(r=>r.activate())},i}static attention(t,n=1){let s=new e;return s.nodes=Array.from({length:t},()=>new Q),s.output=new st(t),s.attention={heads:n},s.activate=function(o){if(!o)return this.nodes.map(a=>a.activate());let i=o.reduce((a,r)=>a+r,0)/o.length;return Array(t).fill(i)},s}isGroup(t){return!!t&&typeof t.set=="function"&&Array.isArray(t.nodes)}}});var as={};ht(as,{mutateImpl:()=>oi});function oi(e){if(e==null)throw new Error("No (correct) mutate method given!");let t;if(typeof e=="string"?t=e:t=e?.name??e?.type??e?.identity,!t){for(let s in Gt)if(e===Gt[s]){t=s;break}}let n=t?si[t]:void 0;if(!n){j.warnings&&console.warn("[mutate] Unknown mutation method ignored:",t);return}n.call(this,e),this._topoDirty=!0}function ii(){let e=this;if(e._enforceAcyclic&&(e._topoDirty=!0),j.deterministicChainMode){let c=this.nodes.find(A=>A.type==="input"),l=this.nodes.find(A=>A.type==="output");if(!c||!l)return;e._detChain||(this.connections.some(A=>A.from===c&&A.to===l)||this.connect(c,l),e._detChain=[c]);let u=e._detChain,p=u[u.length-1],h=this.connections.find(A=>A.from===p&&A.to===l);h||(h=this.connect(p,l)[0]);let d=h.gater;this.disconnect(h.from,h.to);let f=new Q("hidden",void 0,e._rand);f.mutate(Gt.MOD_ACTIVATION);let m=this.nodes.indexOf(l),b=Math.min(m,this.nodes.length-this.output);this.nodes.splice(b,0,f),e._nodeIndexDirty=!0;let g=this.connect(p,f)[0],y=this.connect(f,l)[0];u.push(f),e._preferredChainEdge=y,d&&this.gate(d,e._rand()>=.5?g:y);for(let A=0;A<u.length;A++){let N=u[A],v=A+1<u.length?u[A+1]:l,w=N.connections.out.find(x=>x.to===v);if(w){for(let x of N.connections.out.slice())if(x!==w)try{this.disconnect(x.from,x.to)}catch{}}}return}if(this.connections.length===0){let c=this.nodes.find(u=>u.type==="input"),l=this.nodes.find(u=>u.type==="output");if(c&&l)this.connect(c,l);else return}let t=this.connections[Math.floor(e._rand()*this.connections.length)];if(!t)return;let n=t.gater;this.disconnect(t.from,t.to);let s=new Q("hidden",void 0,e._rand);s.mutate(Gt.MOD_ACTIVATION);let o=this.nodes.indexOf(t.to),i=Math.min(o,this.nodes.length-this.output);this.nodes.splice(i,0,s),e._nodeIndexDirty=!0;let a=this.connect(t.from,s)[0],r=this.connect(s,t.to)[0];e._preferredChainEdge=r,n&&this.gate(n,e._rand()>=.5?a:r)}function ai(){let e=this.nodes.filter(o=>o.type==="hidden");if(e.length===0){j.warnings&&console.warn("No hidden nodes left to remove!");return}let n=e[Math.floor(this._rand()*e.length)];this.remove(n);let s=this.connections[0];s&&(s.weight+=1e-4)}function ri(){let e=this;e._enforceAcyclic&&(e._topoDirty=!0);let t=[];for(let s=0;s<this.nodes.length-this.output;s++){let o=this.nodes[s];for(let i=Math.max(s+1,this.input);i<this.nodes.length;i++){let a=this.nodes[i];o.isProjectingTo(a)||t.push([o,a])}}if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.connect(n[0],n[1])}function ci(){let e=this,t=this.connections.filter(s=>{let o=s.from.connections.out.length>1,i=s.to.connections.in.length>1,a=this.nodes.filter(c=>c.type===s.to.type&&Math.abs(this.nodes.indexOf(c)-this.nodes.indexOf(s.to))<Math.max(this.input,this.output)),r=!1;return a.length>0&&this.connections.filter(l=>l.from===s.from&&a.includes(l.to)).length<=1&&(r=!0),o&&i&&this.nodes.indexOf(s.to)>this.nodes.indexOf(s.from)&&!r});if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.disconnect(n.from,n.to)}function li(e){let t=this.connections.concat(this.selfconns);if(t.length===0)return;let n=t[Math.floor(this._rand()*t.length)],s=this._rand()*(e.max-e.min)+e.min;n.weight+=s}function ui(e){if(this.nodes.length<=this.input)return;let t=Math.floor(this._rand()*(this.nodes.length-this.input)+this.input);this.nodes[t].mutate(e)}function hi(e){let t=e.mutateOutput??!0,n=this.nodes.length-this.input-(t?0:this.output);if(n<=0){j.warnings&&console.warn("No nodes available for activation function mutation based on config.");return}let s=Math.floor(this._rand()*n+this.input);this.nodes[s].mutate(e)}function pi(){let e=this;if(e._enforceAcyclic)return;let t=this.nodes.filter((s,o)=>o>=this.input&&s.connections.self.length===0);if(t.length===0){j.warnings&&console.warn("All eligible nodes already have self-connections.");return}let n=t[Math.floor(e._rand()*t.length)];this.connect(n,n)}function di(){if(this.selfconns.length===0){j.warnings&&console.warn("No self-connections exist to remove.");return}let e=this.selfconns[Math.floor(this._rand()*this.selfconns.length)];this.disconnect(e.from,e.to)}function fi(){let e=this,n=this.connections.concat(this.selfconns).filter(a=>a.gater===null);if(n.length===0||this.nodes.length<=this.input){j.warnings&&console.warn("All connections are already gated.");return}let s=Math.floor(e._rand()*(this.nodes.length-this.input)+this.input),o=this.nodes[s],i=n[Math.floor(e._rand()*n.length)];this.gate(o,i)}function mi(){if(this.gates.length===0){j.warnings&&console.warn("No gated connections to ungate.");return}let e=Math.floor(this._rand()*this.gates.length),t=this.gates[e];this.ungate(t)}function yi(){let e=this;if(e._enforceAcyclic)return;let t=[];for(let s=this.input;s<this.nodes.length;s++){let o=this.nodes[s];for(let i=this.input;i<s;i++){let a=this.nodes[i];o.isProjectingTo(a)||t.push([o,a])}}if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.connect(n[0],n[1])}function gi(){let e=this.connections.filter(n=>n.from.connections.out.length>1&&n.to.connections.in.length>1&&this.nodes.indexOf(n.from)>this.nodes.indexOf(n.to));if(e.length===0)return;let t=e[Math.floor(this._rand()*e.length)];this.disconnect(t.from,t.to)}function bi(e){let t=this,n=e.mutateOutput??!0,s=this.nodes.length-this.input-(n?0:this.output);if(s<2)return;let o=Math.floor(t._rand()*s+this.input),i=Math.floor(t._rand()*s+this.input);for(;o===i;)i=Math.floor(t._rand()*s+this.input);let a=this.nodes[o],r=this.nodes[i],c=a.bias,l=a.squash;a.bias=r.bias,a.squash=r.squash,r.bias=c,r.squash=l}function Ai(){if(this._enforceAcyclic||this.connections.length===0)return;let t=this.connections[Math.floor(Math.random()*this.connections.length)],n=t.gater;this.disconnect(t.from,t.to);let o=(Wt(),K(ke)).default.lstm(1);o.nodes.forEach(i=>{i.type="hidden",this.nodes.push(i)}),this.connect(t.from,o.nodes[0]),this.connect(o.output.nodes[0],t.to),n&&this.gate(n,this.connections[this.connections.length-1])}function Si(){if(this._enforceAcyclic||this.connections.length===0)return;let t=this.connections[Math.floor(Math.random()*this.connections.length)],n=t.gater;this.disconnect(t.from,t.to);let o=(Wt(),K(ke)).default.gru(1);o.nodes.forEach(i=>{i.type="hidden",this.nodes.push(i)}),this.connect(t.from,o.nodes[0]),this.connect(o.output.nodes[0],t.to),n&&this.gate(n,this.connections[this.connections.length-1])}function Ni(e){if(this.nodes.length<=this.input)return;let t=this,n=Math.floor(t._rand()*(this.nodes.length-this.input)+this.input),s=this.nodes[n],o=e?.min??-1,i=e?.max??1,a=()=>t._rand()*(i-o)+o;for(let r of s.connections.in)r.weight=a();for(let r of s.connections.out)r.weight=a();for(let r of s.connections.self)r.weight=a()}function vi(){let e=this.nodes.filter(s=>s.type==="hidden");if(!e.length)return;let n=e[Math.floor(this._rand()*e.length)];n._batchNorm=!0}var si,rs=H(()=>{"use strict";lt();Vt();At();si={ADD_NODE:ii,SUB_NODE:ai,ADD_CONN:ri,SUB_CONN:ci,MOD_WEIGHT:li,MOD_BIAS:ui,MOD_ACTIVATION:hi,ADD_SELF_CONN:pi,SUB_SELF_CONN:di,ADD_GATE:fi,SUB_GATE:mi,ADD_BACK_CONN:yi,SUB_BACK_CONN:gi,SWAP_NODES:bi,ADD_LSTM_NODE:Ai,ADD_GRU_NODE:Si,REINIT_WEIGHT:Ni,BATCH_NORM:vi}});var Fe={};ht(Fe,{__trainingInternals:()=>_i,applyGradientClippingImpl:()=>cs,trainImpl:()=>Ri,trainSetImpl:()=>ls});function wi(e,t,n,s){if(n.window<=1&&n.type!=="ema"&&n.type!=="adaptive-ema")return e;let o=n.type;if(o==="median"){let i=[...t].sort((r,c)=>r-c),a=Math.floor(i.length/2);return i.length%2?i[a]:(i[a-1]+i[a])/2}if(o==="ema")return s.emaValue==null?s.emaValue=e:s.emaValue=s.emaValue+n.emaAlpha*(e-s.emaValue),s.emaValue;if(o==="adaptive-ema"){let i=t.reduce((u,p)=>u+p,0)/t.length,a=t.reduce((u,p)=>u+(p-i)*(p-i),0)/t.length,r=n.emaAlpha||2/(n.window+1),c=a/Math.max(i*i,1e-8),l=Math.min(.95,Math.max(r,r*(1+2*c)));return s.adaptiveBaseEmaValue==null?(s.adaptiveBaseEmaValue=e,s.adaptiveEmaValue=e):(s.adaptiveBaseEmaValue=s.adaptiveBaseEmaValue+r*(e-s.adaptiveBaseEmaValue),s.adaptiveEmaValue=s.adaptiveEmaValue+l*(e-s.adaptiveEmaValue)),Math.min(s.adaptiveEmaValue,s.adaptiveBaseEmaValue)}if(o==="gaussian"){let i=n.window/3||1,a=0,r=0,c=t.length;for(let l=0;l<c;l++){let u=Math.exp(-.5*Math.pow((l-(c-1))/i,2));a+=u,r+=u*t[l]}return r/(a||1)}if(o==="trimmed"){let i=Math.min(.49,Math.max(0,n.trimmedRatio||.1)),a=[...t].sort((l,u)=>l-u),r=Math.floor(a.length*i),c=a.slice(r,a.length-r);return c.reduce((l,u)=>l+u,0)/(c.length||1)}if(o==="wma"){let i=0,a=0;for(let r=0;r<t.length;r++){let c=r+1;i+=c,a+=c*t[r]}return a/(i||1)}return t.reduce((i,a)=>i+a,0)/t.length}function xi(e,t,n,s){if(n.window<=1&&n.type!=="ema")return e;if(n.type==="median"){let o=[...t].sort((a,r)=>a-r),i=Math.floor(o.length/2);return o.length%2?o[i]:(o[i-1]+o[i])/2}return n.type==="ema"?(s.plateauEmaValue==null?s.plateauEmaValue=e:s.plateauEmaValue=s.plateauEmaValue+n.emaAlpha*(e-s.plateauEmaValue),s.plateauEmaValue):t.reduce((o,i)=>o+i,0)/t.length}function Mi(e,t){if(!t._mixedPrecision.enabled)return!1;if(t._forceNextOverflow)return t._forceNextOverflow=!1,!0;let n=!1;return e.nodes.forEach(s=>{s._fp32Bias!==void 0&&(Number.isFinite(s.bias)||(n=!0))}),n}function Ii(e){e.nodes.forEach(t=>{t.connections.in.forEach(n=>{n.totalDeltaWeight=0}),t.connections.self.forEach(n=>{n.totalDeltaWeight=0}),typeof t.totalDeltaBias=="number"&&(t.totalDeltaBias=0),t.previousDeltaBias=0})}function Ei(e,t){t<=1||e.nodes.forEach(n=>{n.connections.in.forEach(s=>{typeof s.totalDeltaWeight=="number"&&(s.totalDeltaWeight/=t)}),n.connections.self.forEach(s=>{typeof s.totalDeltaWeight=="number"&&(s.totalDeltaWeight/=t)}),typeof n.totalDeltaBias=="number"&&(n.totalDeltaBias/=t)})}function Ci(e,t,n,s,o){let i=0;return e.nodes.forEach(a=>{a.type!=="input"&&(a.applyBatchUpdatesWithOptimizer({type:t.type,baseType:t.baseType,beta1:t.beta1,beta2:t.beta2,eps:t.eps,weightDecay:t.weightDecay,momentum:t.momentum??s,lrScale:n,t:o._optimizerStep,la_k:t.la_k,la_alpha:t.la_alpha}),a.connections.in.forEach(r=>{typeof r.previousDeltaWeight=="number"&&(i+=r.previousDeltaWeight*r.previousDeltaWeight)}),a.connections.self.forEach(r=>{typeof r.previousDeltaWeight=="number"&&(i+=r.previousDeltaWeight*r.previousDeltaWeight)}))}),Math.sqrt(i)}function Ti(e){e._mixedPrecisionState.goodSteps++;let t=e._mpIncreaseEvery||200;e._mixedPrecisionState.goodSteps>=t&&e._mixedPrecision.lossScale<e._mixedPrecisionState.maxLossScale&&(e._mixedPrecision.lossScale*=2,e._mixedPrecisionState.goodSteps=0,e._mixedPrecisionState.scaleUpEvents=(e._mixedPrecisionState.scaleUpEvents||0)+1)}function Oi(e){e._mixedPrecisionState.badSteps++,e._mixedPrecisionState.goodSteps=0,e._mixedPrecision.lossScale=Math.max(e._mixedPrecisionState.minLossScale,Math.floor(e._mixedPrecision.lossScale/2)||1),e._mixedPrecisionState.overflowCount=(e._mixedPrecisionState.overflowCount||0)+1,e._mixedPrecisionState.scaleDownEvents=(e._mixedPrecisionState.scaleDownEvents||0)+1,e._lastOverflowStep=e._optimizerStep}function cs(e,t){let n=e,o=(()=>{let r=[];if(t.mode.startsWith("layerwise"))if(e.layers&&e.layers.length>0)for(let c=0;c<e.layers.length;c++){let l=e.layers[c];if(!l||!l.nodes)continue;let u=[];l.nodes.forEach(p=>{!p||p.type==="input"||(p.connections.in.forEach(h=>{typeof h.totalDeltaWeight=="number"&&u.push(h.totalDeltaWeight)}),p.connections.self.forEach(h=>{typeof h.totalDeltaWeight=="number"&&u.push(h.totalDeltaWeight)}),typeof p.totalDeltaBias=="number"&&u.push(p.totalDeltaBias))}),u.length&&r.push(u)}else e.nodes.forEach(c=>{if(c.type==="input")return;let l=[];c.connections.in.forEach(u=>{typeof u.totalDeltaWeight=="number"&&l.push(u.totalDeltaWeight)}),c.connections.self.forEach(u=>{typeof u.totalDeltaWeight=="number"&&l.push(u.totalDeltaWeight)}),typeof c.totalDeltaBias=="number"&&l.push(c.totalDeltaBias),l.length&&r.push(l)});else{let c=[];e.nodes.forEach(l=>{l.connections.in.forEach(u=>{typeof u.totalDeltaWeight=="number"&&c.push(u.totalDeltaWeight)}),l.connections.self.forEach(u=>{typeof u.totalDeltaWeight=="number"&&c.push(u.totalDeltaWeight)}),typeof l.totalDeltaBias=="number"&&c.push(l.totalDeltaBias)}),c.length&&r.push(c)}return r})();n._lastGradClipGroupCount=o.length;let i=(r,c)=>{if(!r.length)return 0;let l=[...r].sort((p,h)=>Math.abs(p)-Math.abs(h)),u=Math.min(l.length-1,Math.max(0,Math.floor(c/100*l.length-1)));return Math.abs(l[u])},a=r=>{let c=0;e.nodes.forEach(l=>{if(t.mode.startsWith("layerwise")&&l.type==="input")return;let u=t.mode.startsWith("layerwise")?o[c++]:o[0];l.connections.in.forEach(p=>{typeof p.totalDeltaWeight=="number"&&(p.totalDeltaWeight=r(p.totalDeltaWeight,u))}),l.connections.self.forEach(p=>{typeof p.totalDeltaWeight=="number"&&(p.totalDeltaWeight=r(p.totalDeltaWeight,u))}),typeof l.totalDeltaBias=="number"&&(l.totalDeltaBias=r(l.totalDeltaBias,u))})};if(t.mode==="norm"||t.mode==="layerwiseNorm"){let r=t.maxNorm||1;o.forEach(c=>{let l=Math.sqrt(c.reduce((u,p)=>u+p*p,0));if(l>r&&l>0){let u=r/l;a((p,h)=>h===c?p*u:p)}})}else if(t.mode==="percentile"||t.mode==="layerwisePercentile"){let r=t.percentile||99;o.forEach(c=>{let l=i(c,r);l<=0||a((u,p)=>p===c&&Math.abs(u)>l?l*Math.sign(u):u)})}}function ls(e,t,n,s,o,i,a,r,c){let l=e,u=0,p=0;l._gradAccumMicroBatches=0;let h=0,d=e.nodes.filter(m=>m.type==="output"),f;typeof r=="function"?f=r:r&&typeof r.fn=="function"?f=r.fn:r&&typeof r.calculate=="function"?f=r.calculate:f=()=>0;for(let m=0;m<t.length;m++){let b=t[m],g=b.input,y=b.output;if(g.length!==e.input||y.length!==e.output){j.warnings&&console.warn(`Data point ${m} has incorrect dimensions (input: ${g.length}/${e.input}, output: ${y.length}/${e.output}), skipping.`);continue}try{let A=e.activate(g,!0);if(c&&c.type&&c.type!=="sgd"){for(let N=0;N<d.length;N++)d[N].propagate(o,i,!1,a,y[N]);for(let N=e.nodes.length-1;N>=0;N--){let v=e.nodes[N];v.type==="output"||v.type==="input"||v.propagate(o,i,!1,a)}}else{for(let N=0;N<d.length;N++)d[N].propagate(o,i,!0,a,y[N]);for(let N=e.nodes.length-1;N>=0;N--){let v=e.nodes[N];v.type==="output"||v.type==="input"||v.propagate(o,i,!0,a)}}u+=f(y,A),p++,h++}catch(A){j.warnings&&console.warn(`Error processing data point ${m} (input: ${JSON.stringify(g)}): ${A.message}. Skipping.`)}p>0&&((m+1)%n===0||m===t.length-1)&&c&&c.type&&c.type!=="sgd"&&(l._gradAccumMicroBatches++,(l._gradAccumMicroBatches%s===0||m===t.length-1)&&(l._optimizerStep=(l._optimizerStep||0)+1,Mi(e,l)?(Ii(e),l._mixedPrecision.enabled&&Oi(l),l._lastGradNorm=0):(l._currentGradClip&&cs(e,l._currentGradClip),s>1&&l._accumulationReduction==="average"&&Ei(e,s),l._lastGradNorm=Ci(e,c,o,i,l),l._mixedPrecision.enabled&&Ti(l))),p=0)}return l._lastGradNorm==null&&(l._lastGradNorm=0),h>0?u/h:0}function Ri(e,t,n){let s=e;if(!t||t.length===0||t[0].input.length!==e.input||t[0].output.length!==e.output)throw new Error("Dataset is invalid or dimensions do not match network input/output size!");if(n=n||{},typeof n.iterations>"u"&&typeof n.error>"u")throw j.warnings&&console.warn("Missing `iterations` or `error` option."),new Error("Missing `iterations` or `error` option. Training requires a stopping condition.");j.warnings&&(typeof n.rate>"u"&&(console.warn("Missing `rate` option"),console.warn("Missing `rate` option, using default learning rate 0.3.")),typeof n.iterations>"u"&&console.warn("Missing `iterations` option. Training will run potentially indefinitely until `error` threshold is met."));let o=n.error??-1/0,i=n.cost||vt.mse;if(typeof i!="function"&&!(typeof i=="object"&&(typeof i.fn=="function"||typeof i.calculate=="function")))throw new Error("Invalid cost function provided to Network.train.");let a=n.rate??.3,r=n.dropout||0;if(r<0||r>=1)throw new Error("dropout must be in [0,1)");let c=n.momentum||0,l=n.batchSize||1;if(l>t.length)throw new Error("Batch size cannot be larger than the dataset length.");let u=n.accumulationSteps||1;if(s._accumulationReduction=n.accumulationReduction==="sum"?"sum":"average",u<1||!Number.isFinite(u))throw new Error("accumulationSteps must be >=1");if(n.gradientClip){let G=n.gradientClip;G.mode?s._currentGradClip={mode:G.mode,maxNorm:G.maxNorm,percentile:G.percentile}:typeof G.maxNorm=="number"?s._currentGradClip={mode:"norm",maxNorm:G.maxNorm}:typeof G.percentile=="number"&&(s._currentGradClip={mode:"percentile",percentile:G.percentile}),s._gradClipSeparateBias=!!G.separateBias}else s._currentGradClip=void 0,s._gradClipSeparateBias=!1;if(n.mixedPrecision){let G=n.mixedPrecision===!0?{lossScale:1024}:n.mixedPrecision;s._mixedPrecision.enabled=!0,s._mixedPrecision.lossScale=G.lossScale||1024;let X=G.dynamic||{};s._mixedPrecisionState.minLossScale=X.minScale||1,s._mixedPrecisionState.maxLossScale=X.maxScale||65536,s._mpIncreaseEvery=X.increaseEvery||X.stableStepsForIncrease||200,e.connections.forEach(Z=>{Z._fp32Weight=Z.weight}),e.nodes.forEach(Z=>{Z.type!=="input"&&(Z._fp32Bias=Z.bias)})}else s._mixedPrecision.enabled=!1,s._mixedPrecision.lossScale=1,s._mpIncreaseEvery=200;let p=new Set(["sgd","rmsprop","adagrad","adam","adamw","amsgrad","adamax","nadam","radam","lion","adabelief","lookahead"]),h;if(typeof n.optimizer<"u"){if(typeof n.optimizer=="string")h={type:n.optimizer.toLowerCase()};else if(typeof n.optimizer=="object"&&n.optimizer!==null)h={...n.optimizer},typeof h.type=="string"&&(h.type=h.type.toLowerCase());else throw new Error("Invalid optimizer option; must be string or object");if(!p.has(h.type))throw new Error(`Unknown optimizer type: ${h.type}`);if(h.type==="lookahead"){if(h.baseType||(h.baseType="adam"),h.baseType==="lookahead")throw new Error("Nested lookahead (baseType lookahead) is not supported");if(!p.has(h.baseType))throw new Error(`Unknown baseType for lookahead: ${h.baseType}`);h.la_k=h.la_k||5,h.la_alpha=h.la_alpha??.5}}let d=n.iterations??Number.MAX_SAFE_INTEGER,f=Date.now(),m=1/0,b=Math.max(1,n.movingAverageWindow||1),g=n.movingAverageType||"sma",y=(()=>{if(g==="ema")return n.emaAlpha&&n.emaAlpha>0&&n.emaAlpha<=1?n.emaAlpha:2/(b+1)})(),A=Math.max(1,n.plateauMovingAverageWindow||b),N=n.plateauMovingAverageType||g,v=(()=>{if(N==="ema")return n.plateauEmaAlpha&&n.plateauEmaAlpha>0&&n.plateauEmaAlpha<=1?n.plateauEmaAlpha:2/(A+1)})(),w=n.earlyStopPatience,x=n.earlyStopMinDelta||0,_=1/0,I=0,L=b,$=new Array(L),k=0,F=0,M=G=>{if(L===1){$[0]=G,k=1,F=0;return}$[F]=G,F=(F+1)%L,k<L&&k++},T=()=>{if(k===0)return[];if(k<L)return $.slice(0,k);let G=new Array(k),X=F;for(let Z=0;Z<k;Z++)G[Z]=$[(X+Z)%L];return G},D,E,R,O=A,P=new Array(O),C=0,B=0,Y=G=>{if(O===1){P[0]=G,C=1,B=0;return}P[B]=G,B=(B+1)%O,C<O&&C++},V=()=>{if(C===0)return[];if(C<O)return P.slice(0,C);let G=new Array(C),X=B;for(let Z=0;Z<C;Z++)G[Z]=P[(X+Z)%O];return G},rt;e.dropout=r;let it=0;for(let G=1;G<=d;G++){e._maybePrune&&e._maybePrune((s._globalEpoch||0)+G);let X=ls(e,t,l,u,a,c,{},i,h);it=G,M(X);let Z=X;if(b>1||g==="ema"||g==="adaptive-ema"){let et=T();if(g==="median"){let J=[...et].sort((ut,gt)=>ut-gt),ot=Math.floor(J.length/2);Z=J.length%2?J[ot]:(J[ot-1]+J[ot])/2}else if(g==="ema")D==null?D=X:D=D+y*(X-D),Z=D;else if(g==="adaptive-ema"){let J=et.reduce((bt,Et)=>bt+Et,0)/et.length,ot=et.reduce((bt,Et)=>bt+(Et-J)*(Et-J),0)/et.length,ut=y||2/(b+1),gt=ot/Math.max(J*J,1e-8),wt=Math.min(.95,Math.max(ut,ut*(1+2*gt)));E==null?(E=X,R=X):(E=E+ut*(X-E),R=R+wt*(X-R)),Z=Math.min(R,E)}else if(g==="gaussian"){let J=et,ot=J.length,ut=b/3||1,gt=0,wt=0;for(let bt=0;bt<ot;bt++){let Et=Math.exp(-.5*Math.pow((bt-(ot-1))/ut,2));gt+=Et,wt+=Et*J[bt]}Z=wt/(gt||1)}else if(g==="trimmed"){let J=Math.min(.49,Math.max(0,n.trimmedRatio||.1)),ot=[...et].sort((wt,bt)=>wt-bt),ut=Math.floor(ot.length*J),gt=ot.slice(ut,ot.length-ut);Z=gt.reduce((wt,bt)=>wt+bt,0)/(gt.length||1)}else if(g==="wma"){let J=0,ot=0;for(let ut=0;ut<et.length;ut++){let gt=ut+1;J+=gt,ot+=gt*et[ut]}Z=ot/(J||1)}else Z=et.reduce((J,ot)=>J+ot,0)/et.length}m=Z,Y(X);let at=X;if(A>1||N==="ema")if(N==="median"){let et=[...V()].sort((ot,ut)=>ot-ut),J=Math.floor(et.length/2);at=et.length%2?et[J]:(et[J-1]+et[J])/2}else if(N==="ema")rt==null?rt=X:rt=rt+v*(X-rt),at=rt;else{let et=V();at=et.reduce((J,ot)=>J+ot,0)/et.length}if(typeof n.metricsHook=="function")try{n.metricsHook({iteration:G,error:m,plateauError:at,gradNorm:s._lastGradNorm??0})}catch{}if(n.checkpoint&&typeof n.checkpoint.save=="function"){if(n.checkpoint.last)try{n.checkpoint.save({type:"last",iteration:G,error:m,network:e.toJSON()})}catch{}if(n.checkpoint.best&&(m<e._checkpointBestError||e._checkpointBestError==null)){e._checkpointBestError=m;try{n.checkpoint.save({type:"best",iteration:G,error:m,network:e.toJSON()})}catch{}}}if(n.schedule&&n.schedule.iterations&&G%n.schedule.iterations===0)try{n.schedule.function({error:m,iteration:G})}catch{}if(m<_-x?(_=m,I=0):w&&I++,w&&I>=w||m<=o)break}return e.nodes.forEach(G=>{G.type==="hidden"&&(G.mask=1)}),e.dropout=0,s._globalEpoch=(s._globalEpoch||0)+it,{error:m,iterations:it,time:Date.now()-f}}var _i,De=H(()=>{"use strict";ft();At();_i={computeMonitoredError:wi,computePlateauMetric:xi}});var ps={};ht(ps,{evolveNetwork:()=>Pi});function $e(e,t){let n=e.nodes.length,s=e.connections.length,o=e.gates.length,i=us.get(e);if(i&&i.nodes===n&&i.conns===s&&i.gates===o)return i.value*t;let a=n-e.input-e.output+s+o;return us.set(e,{nodes:n,conns:s,gates:o,value:a}),a*t}function hs(e,t,n,s){return o=>{let i=0;for(let a=0;a<n;a++)try{i-=o.test(e,t).error}catch(r){return j.warnings&&console.warn(`Genome evaluation failed: ${r&&r.message||r}. Penalizing with -Infinity fitness.`),-1/0}return i-=$e(o,s),i=isNaN(i)?-1/0:i,i/n}}async function Li(e,t,n,s,o,i){let a=mt.serializeDataSet(e),r=[],c=null;try{let u=typeof process<"u"&&!!process.versions?.node;u&&mt.workers?.getNodeTestWorker?c=await mt.workers.getNodeTestWorker():!u&&mt.workers?.getBrowserTestWorker&&(c=await mt.workers.getBrowserTestWorker())}catch(u){j.warnings&&console.warn("Failed to load worker class; falling back to single-thread path:",u?.message||u)}if(!c)return{fitnessFunction:hs(e,t,n,s),threads:1};for(let u=0;u<o;u++)try{r.push(new c(a,{name:t.name||t.toString?.()||"cost"}))}catch(p){j.warnings&&console.warn("Worker spawn failed",p)}let l=u=>new Promise(p=>{if(!r.length){p();return}let h=u.slice(),d=r.length,f=m=>{if(!h.length){--d===0&&p();return}let b=h.shift();m.evaluate(b).then(g=>{typeof b<"u"&&typeof g=="number"&&(b.score=-g-$e(b,s),b.score=isNaN(g)?-1/0:b.score),f(m)}).catch(()=>f(m))};r.forEach(m=>f(m))});return i.fitnessPopulation=!0,i._workerTerminators=()=>{r.forEach(u=>{try{u.terminate&&u.terminate()}catch{}})},{fitnessFunction:l,threads:o}}async function Pi(e,t){if(!e||e.length===0||e[0].input.length!==this.input||e[0].output.length!==this.output)throw new Error("Dataset is invalid or dimensions do not match network input/output size!");t=t||{};let n=t.error??.05,s=t.growth??1e-4,o=t.cost||vt.mse,i=t.amount||1,a=t.log||0,r=t.schedule,c=t.clear||!1,l=typeof t.threads>"u"?1:t.threads,u=Date.now(),p={targetError:n,growth:s,cost:o,amount:i,log:a,schedule:r,clear:c,threads:l};if(typeof t.iterations>"u"&&typeof t.error>"u")throw new Error("At least one stopping condition (`iterations` or `error`) must be specified for evolution.");typeof t.error>"u"?n=-1:typeof t.iterations>"u"&&(t.iterations=0);let h;if(l===1)h=hs(e,o,i,s);else{let v=await Li(e,o,i,s,l,t);h=v.fitnessFunction,l=v.threads}t.network=this,t.populationSize!=null&&t.popsize==null&&(t.popsize=t.populationSize),typeof t.speciation>"u"&&(t.speciation=!1);let{default:d}=await Promise.resolve().then(()=>(He(),fs)),f=new d(this.input,this.output,h,t);if(typeof t.iterations=="number"&&t.iterations===0&&f._warnIfNoBestGenome)try{f._warnIfNoBestGenome()}catch{}t.popsize&&t.popsize<=10&&(f.options.mutationRate=f.options.mutationRate??.5,f.options.mutationAmount=f.options.mutationAmount??1);let m=1/0,b=-1/0,g,y=0,A=5,N=typeof t.iterations=="number";for(;(n===-1||m>n)&&(!N||f.generation<t.iterations);){let v=await f.evolve(),w=v.score??-1/0;if(m=-(w-$e(v,s))||1/0,w>b&&(b=w,g=v),!isFinite(m)||isNaN(m)){if(++y>=A)break}else y=0;if(r&&f.generation%r.iterations===0)try{r.function({fitness:b,error:m,iteration:f.generation})}catch{}}if(typeof g<"u")this.nodes=g.nodes,this.connections=g.connections,this.selfconns=g.selfconns,this.gates=g.gates,c&&this.clear();else if(f._warnIfNoBestGenome)try{f._warnIfNoBestGenome()}catch{}try{t._workerTerminators&&t._workerTerminators()}catch{}return{error:m,iterations:f.generation,time:Date.now()-u}}var us,ds=H(()=>{"use strict";pt();ft();At();Jt();us=new WeakMap});var kt={};ht(kt,{default:()=>ct});var ct,pt=H(()=>{"use strict";lt();_e();Nt();Jt();ft();Vt();At();Kt();bn();Nn();xn();On();Fn();Hn();zn();Vn();Xn();Zn();ss();is();ct=class e{input;output;score;nodes;connections;gates;selfconns;dropout=0;_dropConnectProb=0;_lastGradNorm;_optimizerStep=0;_weightNoiseStd=0;_weightNoisePerHidden=[];_weightNoiseSchedule;_stochasticDepth=[];_wnOrig;_trainingStep=0;_rand=Math.random;_rngState;_lastStats=null;_stochasticDepthSchedule;_mixedPrecision={enabled:!1,lossScale:1};_mixedPrecisionState={goodSteps:0,badSteps:0,minLossScale:1,maxLossScale:65536,overflowCount:0,scaleUpEvents:0,scaleDownEvents:0};_gradAccumMicroBatches=0;_currentGradClip;_lastRawGradNorm=0;_accumulationReduction="average";_gradClipSeparateBias=!1;_lastGradClipGroupCount=0;_lastOverflowStep=-1;_forceNextOverflow=!1;_pruningConfig;_initialConnectionCount;_enforceAcyclic=!1;_topoOrder=null;_topoDirty=!0;_globalEpoch=0;layers;_evoInitialConnCount;_activationPrecision="f64";_reuseActivationArrays=!1;_returnTypedActivations=!1;_activationPool;_connWeights;_connFrom;_connTo;_slabDirty=!0;_useFloat32Weights=!0;_nodeIndexDirty=!0;_outStart;_outOrder;_adjDirty=!0;_fastA;_fastS;_preferredChainEdge;_canUseFastSlab(t){return Tn.call(this,t)}_fastSlabActivate(t){return Cn.call(this,t)}rebuildConnectionSlab(t=!1){return re.call(this,t)}getConnectionSlab(){return In.call(this)}fastSlabActivate(t){return this._fastSlabActivate(t)}constructor(t,n,s){if(typeof t>"u"||typeof n>"u")throw new Error("No input or output size given");this.input=t,this.output=n,this.nodes=[],this.connections=[],this.gates=[],this.selfconns=[],this.dropout=0,this._enforceAcyclic=s?.enforceAcyclic||!1,s?.activationPrecision?this._activationPrecision=s.activationPrecision:j.float32Mode&&(this._activationPrecision="f32"),s?.reuseActivationArrays&&(this._reuseActivationArrays=!0),s?.returnTypedActivations&&(this._returnTypedActivations=!0);try{typeof j.poolMaxPerBucket=="number"&&yt.setMaxPerBucket(j.poolMaxPerBucket);let i=typeof j.poolPrewarmCount=="number"?j.poolPrewarmCount:2;yt.prewarm(this.output,i)}catch{}s?.seed!==void 0&&this.setSeed(s.seed);for(let i=0;i<this.input+this.output;i++){let a=i<this.input?"input":"output";j.enableNodePooling?this.nodes.push(xe({type:a,rng:this._rand})):this.nodes.push(new Q(a,void 0,this._rand))}for(let i=0;i<this.input;i++)for(let a=this.input;a<this.input+this.output;a++){let r=this._rand()*this.input*Math.sqrt(2/this.input);this.connect(this.nodes[i],this.nodes[a],r)}let o=s?.minHidden||0;if(o>0)for(;this.nodes.length<this.input+this.output+o;)this.addNodeBetween()}addNodeBetween(){if(this.connections.length===0)return;let t=Math.floor(this._rand()*this.connections.length),n=this.connections[t];if(!n)return;this.disconnect(n.from,n.to);let s=j.enableNodePooling?xe({type:"hidden",rng:this._rand}):new Q("hidden",void 0,this._rand);this.nodes.push(s),this.connect(n.from,s,n.weight),this.connect(s,n.to,1),this._topoDirty=!0,this._nodeIndexDirty=!0}enableDropConnect(t){if(t<0||t>=1)throw new Error("DropConnect probability must be in [0,1)");this._dropConnectProb=t}disableDropConnect(){this._dropConnectProb=0}setEnforceAcyclic(t){this._enforceAcyclic=!!t}_computeTopoOrder(){return vn.call(this)}_hasPath(t,n){return wn.call(this,t,n)}configurePruning(t){let{start:n,end:s,targetSparsity:o}=t;if(n<0||s<n)throw new Error("Invalid pruning schedule window");if(o<=0||o>=1)throw new Error("targetSparsity must be in (0,1)");this._pruningConfig={start:n,end:s,targetSparsity:o,regrowFraction:t.regrowFraction??0,frequency:t.frequency??1,method:t.method||"magnitude",lastPruneIter:void 0},this._initialConnectionCount=this.connections.length}getCurrentSparsity(){return kn.call(this)}_maybePrune(t){return Ln.call(this,t)}pruneToSparsity(t,n="magnitude"){return Pn.call(this,t,n)}enableWeightNoise(t){if(typeof t=="number"){if(t<0)throw new Error("Weight noise stdDev must be >= 0");this._weightNoiseStd=t,this._weightNoisePerHidden=[]}else if(t&&Array.isArray(t.perHiddenLayer)){if(!this.layers||this.layers.length<3)throw new Error("Per-hidden-layer weight noise requires a layered network with at least one hidden layer");let n=this.layers.length-2;if(t.perHiddenLayer.length!==n)throw new Error(`Expected ${n} std dev entries (one per hidden layer), got ${t.perHiddenLayer.length}`);if(t.perHiddenLayer.some(s=>s<0))throw new Error("Weight noise std devs must be >= 0");this._weightNoiseStd=0,this._weightNoisePerHidden=t.perHiddenLayer.slice()}else throw new Error("Invalid weight noise configuration")}disableWeightNoise(){this._weightNoiseStd=0,this._weightNoisePerHidden=[]}setWeightNoiseSchedule(t){this._weightNoiseSchedule=t}clearWeightNoiseSchedule(){this._weightNoiseSchedule=void 0}setRandom(t){this._rand=t}setSeed(t){Gn.call(this,t)}testForceOverflow(){this._forceNextOverflow=!0}get trainingStep(){return this._trainingStep}get lastSkippedLayers(){return this._lastSkippedLayers||[]}snapshotRNG(){return Bn.call(this)}restoreRNG(t){Wn.call(this,t)}getRNGState(){return jn.call(this)}setRNGState(t){Un.call(this,t)}setStochasticDepthSchedule(t){this._stochasticDepthSchedule=t}clearStochasticDepthSchedule(){this._stochasticDepthSchedule=void 0}getRegularizationStats(){return qn.call(this)}setStochasticDepth(t){if(!Array.isArray(t))throw new Error("survival must be an array");if(t.some(s=>s<=0||s>1))throw new Error("Stochastic depth survival probs must be in (0,1]");if(!this.layers||this.layers.length===0)throw new Error("Stochastic depth requires layer-based network");let n=Math.max(0,this.layers.length-2);if(t.length!==n)throw new Error(`Expected ${n} survival probabilities for hidden layers, got ${t.length}`);this._stochasticDepth=t.slice()}disableStochasticDepth(){this._stochasticDepth=[]}clone(){return e.fromJSON(this.toJSON())}resetDropoutMasks(){if(this.layers&&this.layers.length>0){for(let t of this.layers)if(typeof t.nodes<"u")for(let n of t.nodes)typeof n.mask<"u"&&(n.mask=1)}else for(let t of this.nodes)typeof t.mask<"u"&&(t.mask=1)}standalone(){return Sn(this)}activate(t,n=!1,s=1e3){if(this._enforceAcyclic&&this._topoDirty&&this._computeTopoOrder(),!Array.isArray(t)||t.length!==this.input)throw new Error(`Input size mismatch: expected ${this.input}, got ${t?t.length:"undefined"}`);if(this._canUseFastSlab(n))try{return this._fastSlabActivate(t)}catch{}let o=yt.acquire(this.output);if(!this.nodes||this.nodes.length===0)throw new Error("Network structure is corrupted or empty. No nodes found.");let i=o;this._lastSkippedLayers=[];let a={droppedHiddenNodes:0,totalHiddenNodes:0,droppedConnections:0,totalConnections:this.connections.length,skippedLayers:[],weightNoise:{count:0,sumAbs:0,maxAbs:0,meanAbs:0}},r=!1,c=this._weightNoiseStd;if(n&&(this._weightNoiseSchedule&&(c=this._weightNoiseSchedule(this._trainingStep)),c>0||this._weightNoisePerHidden.length>0))for(let u of this.connections){if(u._origWeightNoise!=null)continue;u._origWeightNoise=u.weight;let p=c;if(this._weightNoisePerHidden.length>0&&this.layers){let h=-1;for(let d=0;d<this.layers.length;d++)if(this.layers[d].nodes.includes(u.from)){h=d;break}if(h>0&&h<this.layers.length){let d=h-1;d>=0&&d<this._weightNoisePerHidden.length&&(p=this._weightNoisePerHidden[d])}}if(p>0){let h=p*e._gaussianRand(this._rand);u.weight+=h,u._wnLast=h,r=!0}else u._wnLast=0}if(n&&this._stochasticDepthSchedule&&this._stochasticDepth.length>0){let u=this._stochasticDepthSchedule(this._trainingStep,this._stochasticDepth.slice());Array.isArray(u)&&u.length===this._stochasticDepth.length&&!u.some(p=>p<=0||p>1)&&(this._stochasticDepth=u.slice())}if(this.layers&&this.layers.length>0&&this._stochasticDepth.length>0){let u;for(let p=0;p<this.layers.length;p++){let h=this.layers[p],d=p>0&&p<this.layers.length-1,f=!1;if(n&&d){let b=p-1;if(b<this._stochasticDepth.length){let g=this._stochasticDepth[b];if(f=this._rand()>=g,f&&(!u||u.length!==h.nodes.length)&&(f=!1),!f){let y=p===0?h.activate(t,n):h.activate(void 0,n);u=g<1?y.map(A=>A*(1/g)):y;continue}}}if(f){this._lastSkippedLayers.push(p),a.skippedLayers.push(p);continue}u=p===0?h.activate(t,n):h.activate(void 0,n)}if(u)for(let p=0;p<u.length&&p<this.output;p++)i[p]=u[p]}else if(this.layers&&this.layers.length>0){let u;for(let p=0;p<this.layers.length;p++){let h=this.layers[p],d=p>0&&p<this.layers.length-1,f=p===0?h.activate(t,!1):h.activate(void 0,!1);if(d&&n&&this.dropout>0){let m=0;for(let b of h.nodes)b.mask=this._rand()<this.dropout?0:1,a.totalHiddenNodes++,b.mask===0&&a.droppedHiddenNodes++,b.mask===0&&(b.activation=0,m++);if(m===h.nodes.length&&h.nodes.length>0){let b=Math.floor(this._rand()*h.nodes.length);h.nodes[b].mask=1,h.nodes[b].activation=f[b]}}else if(d)for(let m of h.nodes)m.mask=1;u=f}if(u)if(this._reuseActivationArrays)for(let p=0;p<u.length&&p<this.output;p++)i[p]=u[p];else for(let p=0;p<u.length&&p<this.output;p++)i[p]=u[p]}else{let u=this.nodes.filter(d=>d.type==="hidden"),p=0;if(n&&this.dropout>0){for(let d of u)d.mask=this._rand()<this.dropout?0:1,a.totalHiddenNodes++,d.mask===0&&(p++,a.droppedHiddenNodes++);if(p===u.length&&u.length>0){let d=Math.floor(this._rand()*u.length);u[d].mask=1}}else for(let d of u)d.mask=1;if(n&&this._weightNoiseStd>0){this._wnOrig||(this._wnOrig=new Array(this.connections.length));for(let d=0;d<this.connections.length;d++){let f=this.connections[d];if(f._origWeightNoise!=null)continue;f._origWeightNoise=f.weight;let m=this._weightNoiseStd*e._gaussianRand(this._rand);f.weight+=m}}let h=0;if(this.nodes.forEach((d,f)=>{if(d.type==="input")d.activate(t[f]);else if(d.type==="output"){let m=d.activate();i[h++]=m}else d.activate()}),n&&this._dropConnectProb>0)for(let d of this.connections){let f=this._rand()<this._dropConnectProb?0:1;f===0&&a.droppedConnections++,d.dcMask=f,f===0?(d._origWeight==null&&(d._origWeight=d.weight),d.weight=0):d._origWeight!=null&&(d.weight=d._origWeight,delete d._origWeight)}else for(let d of this.connections)d._origWeight!=null&&(d.weight=d._origWeight,delete d._origWeight),d.dcMask=1;if(n&&r)for(let d of this.connections)d._origWeightNoise!=null&&(d.weight=d._origWeightNoise,delete d._origWeightNoise)}n&&this._trainingStep++,a.weightNoise.count>0&&(a.weightNoise.meanAbs=a.weightNoise.sumAbs/a.weightNoise.count),this._lastStats=a;let l=Array.from(i);return yt.release(i),l}static _gaussianRand(t=Math.random){let n=0,s=0;for(;n===0;)n=t();for(;s===0;)s=t();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*s)}noTraceActivate(t){let{noTraceActivate:n}=(le(),K(ce));return n.call(this,t)}activateRaw(t,n=!1,s=1e3){let{activateRaw:o}=(le(),K(ce));return o.call(this,t,n,s)}activateBatch(t,n=!1){let{activateBatch:s}=(le(),K(ce));return s.call(this,t,n)}propagate(t,n,s,o,i=0,a){if(!o||o.length!==this.output)throw new Error("Output target length should match network output length");let r=o.length;for(let c=this.nodes.length-1;c>=this.nodes.length-this.output;c--)a?this.nodes[c].propagate(t,n,s,i,o[--r],a):this.nodes[c].propagate(t,n,s,i,o[--r]);for(let c=this.nodes.length-this.output-1;c>=this.input;c--)this.nodes[c].propagate(t,n,s,i)}clear(){this.nodes.forEach(t=>t.clear())}mutate(t){let{mutateImpl:n}=(rs(),K(as));return n.call(this,t)}connect(t,n,s){return Jn.call(this,t,n,s)}gate(t,n){return Dn.call(this,t,n)}remove(t){let n=Yn.call(this,t);if(j.enableNodePooling)try{oe(t)}catch{}return n}disconnect(t,n){return Kn.call(this,t,n)}ungate(t){return $n.call(this,t)}_applyGradientClipping(t){let{applyGradientClippingImpl:n}=(De(),K(Fe));n(this,t)}train(t,n){let{trainImpl:s}=(De(),K(Fe));return s(this,t,n)}getRawGradientNorm(){return this._lastRawGradNorm}getLossScale(){return this._mixedPrecision.lossScale}getLastGradClipGroupCount(){return this._lastGradClipGroupCount}getTrainingStats(){return{gradNorm:this._lastGradNorm??0,gradNormRaw:this._lastRawGradNorm,lossScale:this._mixedPrecision.lossScale,optimizerStep:this._optimizerStep,mp:{good:this._mixedPrecisionState.goodSteps,bad:this._mixedPrecisionState.badSteps,overflowCount:this._mixedPrecisionState.overflowCount||0,scaleUps:this._mixedPrecisionState.scaleUpEvents||0,scaleDowns:this._mixedPrecisionState.scaleDownEvents||0,lastOverflowStep:this._lastOverflowStep}}}static adjustRateForAccumulation(t,n,s){return s==="sum"&&n>1?t/n:t}async evolve(t,n){let{evolveNetwork:s}=await Promise.resolve().then(()=>(ds(),ps));return s.call(this,t,n)}test(t,n){if(!Array.isArray(t)||t.length===0)throw new Error("Test set is empty or not an array.");for(let r of t){if(!Array.isArray(r.input)||r.input.length!==this.input)throw new Error(`Test sample input size mismatch: expected ${this.input}, got ${r.input?r.input.length:"undefined"}`);if(!Array.isArray(r.output)||r.output.length!==this.output)throw new Error(`Test sample output size mismatch: expected ${this.output}, got ${r.output?r.output.length:"undefined"}`)}let s=0,o=n||vt.mse,i=Date.now();this.nodes.forEach(r=>{r.type==="hidden"&&(r.mask=1)});let a=this.dropout;return this.dropout>0&&(this.dropout=0),t.forEach(r=>{let c=this.noTraceActivate(r.input);s+=o(r.output,c)}),this.dropout=a,{error:s/t.length,time:Date.now()-i}}serialize(){return Qn.call(this)}static deserialize(t,n,s){return ts(t,n,s)}toJSON(){return es.call(this)}static fromJSON(t){return ns(t)}static crossOver(t,n,s=!1){return os(t,n,s)}set(t){this.nodes.forEach(n=>{typeof t.bias<"u"&&(n.bias=t.bias),typeof t.squash<"u"&&(n.squash=t.squash)})}toONNX(){return gn(this)}static createMLP(t,n,s){let o=Array.from({length:t},()=>new Q("input")),i=n.map(u=>Array.from({length:u},()=>new Q("hidden"))),a=Array.from({length:s},()=>new Q("output")),r=[...o,...i.flat(),...a],c=new e(t,s);c.nodes=r;let l=o;for(let u of i){for(let p of u)for(let h of l)h.connect(p);l=u}for(let u of a)for(let p of l)p.connect(u);return c.connections=c.nodes.flatMap(u=>u.connections.out),c._topoDirty=!0,c}static rebuildConnections(t){let n=new Set;t.nodes.forEach(s=>{s.connections.out.forEach(o=>{n.add(o)})}),t.connections=Array.from(n)}}});function ms(){let e=(ft(),K(nt));for(let t of this.population){this.options.adaptiveMutation?.enabled&&t._mutRate===void 0&&(t._mutRate=this.options.mutationRate!==void 0?this.options.mutationRate:this.options.adaptiveMutation.initialRate??(this.options.mutationRate||.7),this.options.adaptiveMutation.adaptAmount&&(t._mutAmount=this.options.mutationAmount||1));let n=this.options.mutationRate!==void 0?this.options.mutationRate:this.options.adaptiveMutation?.enabled?t._mutRate:this.options.mutationRate||.7,s=this.options.adaptiveMutation?.enabled&&this.options.adaptiveMutation.adaptAmount?t._mutAmount??(this.options.mutationAmount||1):this.options.mutationAmount||1;if(this._getRNG()()<=n)for(let o=0;o<s;o++){let i=this.selectMutationMethod(t,!1);if(Array.isArray(i)){let a=i;i=a[Math.floor(this._getRNG()()*a.length)]}if(i&&i.name){let a=t.nodes.length,r=t.connections.length;if(i===e.mutation.ADD_NODE){this._mutateAddNodeReuse(t);try{t.mutate(e.mutation.MOD_WEIGHT)}catch{}this._invalidateGenomeCaches(t)}else if(i===e.mutation.ADD_CONN){this._mutateAddConnReuse(t);try{t.mutate(e.mutation.MOD_WEIGHT)}catch{}this._invalidateGenomeCaches(t)}else t.mutate(i),(i===e.mutation.ADD_GATE||i===e.mutation.SUB_NODE||i===e.mutation.SUB_CONN||i===e.mutation.ADD_SELF_CONN||i===e.mutation.ADD_BACK_CONN)&&this._invalidateGenomeCaches(t);if(this._getRNG()()<.5&&this._mutateAddConnReuse(t),this.options.operatorAdaptation?.enabled){let c=this._operatorStats.get(i.name)||{success:0,attempts:0};c.attempts++;let l=t.nodes.length,u=t.connections.length;(l>a||u>r)&&c.success++,this._operatorStats.set(i.name,c)}}}}}function ys(e){if(e.connections.length===0){let l=e.nodes.find(p=>p.type==="input"),u=e.nodes.find(p=>p.type==="output");if(l&&u)try{e.connect(l,u,1)}catch{}}let t=e.connections.filter(l=>l.enabled!==!1);if(!t.length)return;let n=t[Math.floor(this._getRNG()()*t.length)],s=n.from.geneId,o=n.to.geneId,i=s+"->"+o,a=n.weight;e.disconnect(n.from,n.to);let r=this._nodeSplitInnovations.get(i),c=(lt(),K(se)).default;if(r){let l=new c("hidden");l.geneId=r.newNodeGeneId;let u=e.nodes.indexOf(n.to),p=Math.min(u,e.nodes.length-e.output);e.nodes.splice(p,0,l);let h=e.connect(n.from,l,1)[0],d=e.connect(l,n.to,a)[0];h&&(h.innovation=r.inInnov),d&&(d.innovation=r.outInnov)}else{let l=new c("hidden"),u=e.connect(n.from,l,1)[0],p=e.connect(l,n.to,a)[0];u&&(u.innovation=this._nextGlobalInnovation++),p&&(p.innovation=this._nextGlobalInnovation++),r={newNodeGeneId:l.geneId,inInnov:u?.innovation,outInnov:p?.innovation},this._nodeSplitInnovations.set(i,r);let h=e.nodes.indexOf(n.to),d=Math.min(h,e.nodes.length-e.output);e.nodes.splice(d,0,l)}}function gs(e){let t=[];for(let h=0;h<e.nodes.length-e.output;h++){let d=e.nodes[h];for(let f=Math.max(h+1,e.input);f<e.nodes.length;f++){let m=e.nodes[f];d.isProjectingTo(m)||t.push([d,m])}}if(!t.length)return;let n=t.filter(h=>{let d=h[0].geneId,f=h[1].geneId,m=d<f?d+"::"+f:f+"::"+d;return this._connInnovations.has(m)}),s=n.length?[]:t.filter(h=>h[0].type==="hidden"&&h[1].type==="hidden"),o=n.length?n:s.length?s:t,i=o.length===1?o[0]:o[Math.floor(this._getRNG()()*o.length)],a=i[0],r=i[1],c=a.geneId,l=r.geneId,u=c<l?c+"::"+l:l+"::"+c;if(e._enforceAcyclic&&(()=>{let d=[r],f=new Set;for(;d.length;){let m=d.pop();if(m===a)return!0;if(!f.has(m)){f.add(m);for(let b of m.connections.out)d.push(b.to)}}return!1})())return;let p=e.connect(a,r)[0];if(p)if(this._connInnovations.has(u))p.innovation=this._connInnovations.get(u);else{let h=this._nextGlobalInnovation++;p.innovation=h,this._connInnovations.set(u,h);let d=c+"::"+l,f=l+"::"+c;this._connInnovations.set(d,h),this._connInnovations.set(f,h)}}function bs(e,t){let n=this.options.maxNodes||1/0,s=Math.min(this.getMinimumHiddenSize(t),n-e.nodes.filter(l=>l.type!=="hidden").length),o=e.nodes.filter(l=>l.type==="input"),i=e.nodes.filter(l=>l.type==="output"),a=e.nodes.filter(l=>l.type==="hidden");if(o.length===0||i.length===0){try{console.warn("Network is missing input or output nodes \u2014 skipping minHidden enforcement")}catch{}return}let r=a.length;for(let l=r;l<s&&e.nodes.length<n;l++){let u=(lt(),K(se)).default,p=new u("hidden");e.nodes.push(p),a.push(p)}for(let l of a){if(l.connections.in.length===0){let u=o.concat(a.filter(p=>p!==l));if(u.length>0){let p=this._getRNG(),h=u[Math.floor(p()*u.length)];try{e.connect(h,l)}catch{}}}if(l.connections.out.length===0){let u=i.concat(a.filter(p=>p!==l));if(u.length>0){let p=this._getRNG(),h=u[Math.floor(p()*u.length)];try{e.connect(l,h)}catch{}}}}(pt(),K(kt)).default.rebuildConnections(e)}function As(e){let t=e.nodes.filter(a=>a.type==="input"),n=e.nodes.filter(a=>a.type==="output"),s=e.nodes.filter(a=>a.type==="hidden"),o=a=>a.connections&&a.connections.out&&a.connections.out.length>0,i=a=>a.connections&&a.connections.in&&a.connections.in.length>0;for(let a of t)if(!o(a)){let r=s.length>0?s:n;if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(a,l)}catch{}}}for(let a of n)if(!i(a)){let r=s.length>0?s:t;if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(l,a)}catch{}}}for(let a of s){if(!i(a)){let r=t.concat(s.filter(c=>c!==a));if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(l,a)}catch{}}}if(!o(a)){let r=n.concat(s.filter(c=>c!==a));if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(a,l)}catch{}}}}}function Ss(e,t=!0){let n=(ft(),K(nt)),s=this.options.mutation===n.mutation.FFW,o=Array.isArray(this.options.mutation)&&this.options.mutation.length===1&&this.options.mutation[0]===n.mutation.FFW;if((s||o)&&t)return n.mutation.FFW;if(s)return n.mutation.FFW[Math.floor(this._getRNG()()*n.mutation.FFW.length)];if(o)return n.mutation.FFW[Math.floor(this._getRNG()()*n.mutation.FFW.length)];let i=this.options.mutation;if(t&&Array.isArray(i)&&i.length===n.mutation.FFW.length&&i.every((r,c)=>r&&r.name===n.mutation.FFW[c].name))return n.mutation.FFW;if(i.length===1&&Array.isArray(i[0])&&i[0].length&&(i=i[0]),this.options.phasedComplexity?.enabled&&this._phase){if(i=i.filter(r=>!!r),this._phase==="simplify"){let r=i.filter(c=>c&&c.name&&c.name.startsWith&&c.name.startsWith("SUB_"));r.length&&(i=[...i,...r])}else if(this._phase==="complexify"){let r=i.filter(c=>c&&c.name&&c.name.startsWith&&c.name.startsWith("ADD_"));r.length&&(i=[...i,...r])}}if(this.options.operatorAdaptation?.enabled){let r=this.options.operatorAdaptation.boost??2,c=this._operatorStats,l=[];for(let u of i){l.push(u);let p=c.get(u.name);if(p&&p.attempts>5){let h=p.success/p.attempts;if(h>.55)for(let d=0;d<Math.min(r,Math.floor(h*r));d++)l.push(u)}}i=l}let a=i[Math.floor(this._getRNG()()*i.length)];if(a===n.mutation.ADD_GATE&&e.gates.length>=(this.options.maxGates||1/0)||a===n.mutation.ADD_NODE&&e.nodes.length>=(this.options.maxNodes||1/0)||a===n.mutation.ADD_CONN&&e.connections.length>=(this.options.maxConns||1/0))return null;if(this.options.operatorBandit?.enabled){let r=this.options.operatorBandit.c??1.4,c=this.options.operatorBandit.minAttempts??5,l=this._operatorStats;for(let d of i)l.has(d.name)||l.set(d.name,{success:0,attempts:0});let u=Array.from(l.values()).reduce((d,f)=>d+f.attempts,0)+1e-9,p=a,h=-1/0;for(let d of i){let f=l.get(d.name),m=f.attempts>0?f.success/f.attempts:0,b=f.attempts<c?1/0:r*Math.sqrt(Math.log(u)/(f.attempts+1e-9)),g=m+b;g>h&&(h=g,p=d)}a=p}return a===n.mutation.ADD_GATE&&e.gates.length>=(this.options.maxGates||1/0)||!this.options.allowRecurrent&&(a===n.mutation.ADD_BACK_CONN||a===n.mutation.ADD_SELF_CONN)?null:a}var Ns=H(()=>{"use strict";Pt()});function vs(e){let t=this._getObjectives(),n=e.map(u=>t.map(p=>{try{return p.accessor(u)}catch{return 0}})),s=(u,p)=>{let h=!1;for(let d=0;d<u.length;d++)if((t[d].direction||"max")==="max"){if(u[d]<p[d])return!1;u[d]>p[d]&&(h=!0)}else{if(u[d]>p[d])return!1;u[d]<p[d]&&(h=!0)}return h},o=[],i=new Array(e.length).fill(0),a=e.map(()=>[]),r=[];for(let u=0;u<e.length;u++){for(let p=0;p<e.length;p++)u!==p&&(s(n[u],n[p])?a[u].push(p):s(n[p],n[u])&&i[u]++);i[u]===0&&r.push(u)}let c=r,l=0;for(;c.length;){let u=[];for(let p of c){e[p]._moRank=l;for(let h of a[p])i[h]--,i[h]===0&&u.push(h)}if(o.push(c.map(p=>e[p])),c=u,l++,l>50)break}for(let u of o)if(u.length!==0){for(let p of u)p._moCrowd=0;for(let p=0;p<t.length;p++){let h=u.slice().sort((b,g)=>{let y=t[p].accessor(b),A=t[p].accessor(g);return y-A});h[0]._moCrowd=1/0,h[h.length-1]._moCrowd=1/0;let d=t[p].accessor(h[0]),m=t[p].accessor(h[h.length-1])-d||1;for(let b=1;b<h.length-1;b++){let g=t[p].accessor(h[b-1]),y=t[p].accessor(h[b+1]);h[b]._moCrowd+=(y-g)/m}}}return this.options.multiObjective?.enabled&&(this._paretoArchive.push({generation:this.generation,fronts:o.slice(0,3).map(u=>u.map(p=>p._id))}),this._paretoArchive.length>100&&this._paretoArchive.shift()),o}var Ge=H(()=>{"use strict"});var Ft={};ht(Ft,{applyAdaptiveMutation:()=>Hi,applyAncestorUniqAdaptive:()=>$i,applyComplexityBudget:()=>ki,applyMinimalCriterionAdaptive:()=>Di,applyOperatorAdaptation:()=>Gi,applyPhasedComplexity:()=>Fi});function ki(){if(!this.options.complexityBudget?.enabled)return;let e=this.options.complexityBudget;if(e.mode==="adaptive"){this._cbHistory||(this._cbHistory=[]),this._cbHistory.push(this.population[0]?.score||0);let t=e.improvementWindow??10;this._cbHistory.length>t&&this._cbHistory.shift();let n=this._cbHistory,s=n.length>1?n[n.length-1]-n[0]:0,o=0;if(n.length>2){let p=n.length,h=0,d=0,f=0,m=0;for(let g=0;g<p;g++)h+=g,d+=n[g],f+=g*n[g],m+=g*g;let b=p*m-h*h||1;o=(p*f-h*d)/b}this._cbMaxNodes===void 0&&(this._cbMaxNodes=e.maxNodesStart??this.input+this.output+2);let i=e.increaseFactor??1.1,a=e.stagnationFactor??.95,r=Math.min(2,Math.max(-2,o/(Math.abs(n[0])+1e-9))),c=i+.05*Math.max(0,r),l=a-.03*Math.max(0,-r),u=this._noveltyArchive.length>5?1:.9;if(s>0||o>0?this._cbMaxNodes=Math.min(e.maxNodesEnd??this._cbMaxNodes*4,Math.floor(this._cbMaxNodes*c*u)):n.length===t&&(this._cbMaxNodes=Math.max(e.minNodes??this.input+this.output+2,Math.floor(this._cbMaxNodes*l))),e.minNodes!==void 0)this._cbMaxNodes=Math.max(e.minNodes,this._cbMaxNodes);else{let p=this.input+this.output+2;this._cbMaxNodes<p&&(this._cbMaxNodes=p)}this.options.maxNodes=this._cbMaxNodes,e.maxConnsStart&&(this._cbMaxConns===void 0&&(this._cbMaxConns=e.maxConnsStart),s>0||o>0?this._cbMaxConns=Math.min(e.maxConnsEnd??this._cbMaxConns*4,Math.floor(this._cbMaxConns*c*u)):n.length===t&&(this._cbMaxConns=Math.max(e.maxConnsStart,Math.floor(this._cbMaxConns*l))),this.options.maxConns=this._cbMaxConns)}else{let t=e.maxNodesStart??this.input+this.output+2,n=e.maxNodesEnd??t*4,s=e.horizon??100,o=Math.min(1,this.generation/s);this.options.maxNodes=Math.floor(t+(n-t)*o)}}function Fi(){if(!this.options.phasedComplexity?.enabled)return;let e=this.options.phasedComplexity.phaseLength??10;this._phase||(this._phase=this.options.phasedComplexity.initialPhase??"complexify",this._phaseStartGeneration=this.generation),this.generation-this._phaseStartGeneration>=e&&(this._phase=this._phase==="complexify"?"simplify":"complexify",this._phaseStartGeneration=this.generation)}function Di(){if(!this.options.minimalCriterionAdaptive?.enabled)return;let e=this.options.minimalCriterionAdaptive;this._mcThreshold===void 0&&(this._mcThreshold=e.initialThreshold??0);let t=this.population.map(a=>a.score||0),n=t.filter(a=>a>=this._mcThreshold).length,s=t.length?n/t.length:0,o=e.targetAcceptance??.5,i=e.adjustRate??.1;s>o*1.05?this._mcThreshold*=1+i:s<o*.95&&(this._mcThreshold*=1-i);for(let a of this.population)(a.score||0)<this._mcThreshold&&(a.score=0)}function $i(){if(!this.options.ancestorUniqAdaptive?.enabled)return;let e=this.options.ancestorUniqAdaptive,t=e.cooldown??5;if(this.generation-this._lastAncestorUniqAdjustGen<t)return;let n=this._telemetry[this._telemetry.length-1]?.lineage,s=n?n.ancestorUniq:void 0;if(typeof s!="number")return;let o=e.lowThreshold??.25,i=e.highThreshold??.55,a=e.adjust??.01;if(e.mode==="epsilon"&&this.options.multiObjective?.adaptiveEpsilon?.enabled)s<o?(this.options.multiObjective.dominanceEpsilon=(this.options.multiObjective.dominanceEpsilon||0)+a,this._lastAncestorUniqAdjustGen=this.generation):s>i&&(this.options.multiObjective.dominanceEpsilon=Math.max(0,(this.options.multiObjective.dominanceEpsilon||0)-a),this._lastAncestorUniqAdjustGen=this.generation);else if(e.mode==="lineagePressure"){this.options.lineagePressure||(this.options.lineagePressure={enabled:!0,mode:"spread",strength:.01});let r=this.options.lineagePressure;s<o?(r.strength=(r.strength||.01)*1.15,r.mode="spread",this._lastAncestorUniqAdjustGen=this.generation):s>i&&(r.strength=(r.strength||.01)*.9,this._lastAncestorUniqAdjustGen=this.generation)}}function Hi(){if(!this.options.adaptiveMutation?.enabled)return;let e=this.options.adaptiveMutation,t=e.adaptEvery??1;if(!(t<=1||this.generation%t===0))return;let n=this.population.filter(h=>typeof h.score=="number");n.sort((h,d)=>(h.score||0)-(d.score||0));let s=Math.floor(n.length/2),o=n.slice(s),i=n.slice(0,s),a=(e.sigma??.05)*1.5,r=e.minRate??.01,c=e.maxRate??1,l=e.strategy||"twoTier",u=!1,p=!1;for(let h=0;h<this.population.length;h++){let d=this.population[h];if(d._mutRate===void 0)continue;let f=d._mutRate,m=this._getRNG()()*2-1;if(m*=a,l==="twoTier")o.length===0||i.length===0?m=h%2===0?Math.abs(m):-Math.abs(m):o.includes(d)?m=-Math.abs(m):i.includes(d)&&(m=Math.abs(m));else if(l==="exploreLow")m=i.includes(d)?Math.abs(m*1.5):-Math.abs(m*.5);else if(l==="anneal"){let b=Math.min(1,this.generation/(50+this.population.length));m*=1-b}if(f+=m,f<r&&(f=r),f>c&&(f=c),f>(this.options.adaptiveMutation.initialRate??.5)&&(u=!0),f<(this.options.adaptiveMutation.initialRate??.5)&&(p=!0),d._mutRate=f,e.adaptAmount){let b=e.amountSigma??.25,g=(this._getRNG()()*2-1)*b;l==="twoTier"&&(o.length===0||i.length===0?g=h%2===0?Math.abs(g):-Math.abs(g):g=i.includes(d)?Math.abs(g):-Math.abs(g));let y=d._mutAmount??(this.options.mutationAmount||1);y+=g,y=Math.round(y);let A=e.minAmount??1,N=e.maxAmount??10;y<A&&(y=A),y>N&&(y=N),d._mutAmount=y}}if(l==="twoTier"&&!(u&&p)){let h=this.options.adaptiveMutation.initialRate??.5,d=Math.floor(this.population.length/2);for(let f=0;f<this.population.length;f++){let m=this.population[f];m._mutRate!==void 0&&(f<d?m._mutRate=Math.min(m._mutRate+a,1):m._mutRate=Math.max(m._mutRate-a,.01))}}}function Gi(){if(!this.options.operatorAdaptation?.enabled)return;let e=this.options.operatorAdaptation.decay??.9;for(let[t,n]of this._operatorStats.entries())n.success*=e,n.attempts*=e,this._operatorStats.set(t,n)}var Dt=H(()=>{"use strict";Pt()});var Be={};ht(Be,{buildAnc:()=>ws,computeAncestorUniqueness:()=>Wi});function ws(e){let t=new Set;if(!Array.isArray(e._parents))return t;let n=[];for(let s of e._parents)n.push({id:s,depth:1,genomeRef:this.population.find(o=>o._id===s)});for(;n.length;){let s=n.shift();if(!(s.depth>4)&&(s.id!=null&&t.add(s.id),s.genomeRef&&Array.isArray(s.genomeRef._parents)))for(let o of s.genomeRef._parents)n.push({id:o,depth:s.depth+1,genomeRef:this.population.find(i=>i._id===o)})}return t}function Wi(){let e=ws.bind(this),t=0,n=0,s=Math.min(Bi,this.population.length*(this.population.length-1)/2);for(let i=0;i<s&&!(this.population.length<2);i++){let a=Math.floor(this._getRNG()()*this.population.length),r=Math.floor(this._getRNG()()*this.population.length);r===a&&(r=(r+1)%this.population.length);let c=e(this.population[a]),l=e(this.population[r]);if(c.size===0&&l.size===0)continue;let u=0;for(let d of c)l.has(d)&&u++;let p=c.size+l.size-u||1,h=1-u/p;n+=h,t++}return t?+(n/t).toFixed(3):0}var Bi,We=H(()=>{"use strict";Bi=30});var _s={};ht(_s,{applyTelemetrySelect:()=>xs,buildTelemetryEntry:()=>qi,computeDiversityStats:()=>Ui,recordTelemetryEntry:()=>zi,structuralEntropy:()=>ji});function xs(e){if(!this._telemetrySelect||!this._telemetrySelect.size)return e;let t=this._telemetrySelect,n={gen:e.gen,best:e.best,species:e.species};for(let s of Object.keys(e))s in n||t.has(s)||delete e[s];return Object.assign(e,n)}function ji(e){let t=e;if(t._entropyGen===this.generation&&typeof t._entropyVal=="number")return t._entropyVal;let n={};for(let a of e.nodes)n[a.geneId]=0;for(let a of e.connections)if(a.enabled){let r=a.from.geneId,c=a.to.geneId;n[r]!==void 0&&n[r]++,n[c]!==void 0&&n[c]++}let s={},o=e.nodes.length||1;for(let a in n){let r=n[a];s[r]=(s[r]||0)+1}let i=0;for(let a in s){let r=s[a]/o;r>0&&(i-=r*Math.log(r+1e-9))}return t._entropyGen=this.generation,t._entropyVal=i,i}function Ui(){if(!this.options.diversityMetrics?.enabled)return;if(this.options.fastMode&&!this._fastModeTuned){let g=this.options.diversityMetrics;g&&(g.pairSample==null&&(g.pairSample=20),g.graphletSample==null&&(g.graphletSample=30)),this.options.novelty?.enabled&&this.options.novelty.k==null&&(this.options.novelty.k=5),this._fastModeTuned=!0}let e=this.options.diversityMetrics.pairSample??40,t=this.options.diversityMetrics.graphletSample??60,n=this.population,s=n.length,o=0,i=0,a=0;for(let g=0;g<e&&!(s<2);g++){let y=Math.floor(this._getRNG()()*s),A=Math.floor(this._getRNG()()*s);A===y&&(A=(A+1)%s);let N=this._compatibilityDistance(n[y],n[A]);o+=N,i+=N*N,a++}let r=a?o/a:0,c=a?Math.max(0,i/a-r*r):0,l=n.map(g=>this._structuralEntropy(g)),u=l.reduce((g,y)=>g+y,0)/(l.length||1),p=l.length?l.reduce((g,y)=>g+(y-u)*(y-u),0)/l.length:0,h=[0,0,0,0];for(let g=0;g<t;g++){let y=n[Math.floor(this._getRNG()()*s)];if(!y)break;if(y.nodes.length<3)continue;let A=new Set;for(;A.size<3;)A.add(Math.floor(this._getRNG()()*y.nodes.length));let N=Array.from(A).map(w=>y.nodes[w]),v=0;for(let w of y.connections)w.enabled&&N.includes(w.from)&&N.includes(w.to)&&v++;v>3&&(v=3),h[v]++}let d=h.reduce((g,y)=>g+y,0)||1,f=0;for(let g=0;g<h.length;g++){let y=h[g]/d;y>0&&(f-=y*Math.log(y))}let m=0,b=0;if(this._lineageEnabled&&s>0){let g=n.map(N=>N._depth??0);m=g.reduce((N,v)=>N+v,0)/s;let y=0,A=0;for(let N=0;N<Math.min(e,s*(s-1)/2)&&!(s<2);N++){let v=Math.floor(this._getRNG()()*s),w=Math.floor(this._getRNG()()*s);w===v&&(w=(w+1)%s),y+=Math.abs(g[v]-g[w]),A++}b=A?y/A:0}this._diversityStats={meanCompat:r,varCompat:c,meanEntropy:u,varEntropy:p,graphletEntropy:f,lineageMeanDepth:m,lineageMeanPairDist:b}}function zi(e){try{xs.call(this,e)}catch{}this._telemetry||(this._telemetry=[]),this._telemetry.push(e);try{this.options.telemetryStream?.enabled&&this.options.telemetryStream.onEntry&&this.options.telemetryStream.onEntry(e)}catch{}this._telemetry.length>500&&this._telemetry.shift()}function qi(e){let t=this.generation,n=0;if(this.options.multiObjective?.enabled){let i=this.options.multiObjective.complexityMetric||"connections",a=this.population.map(h=>h.score||0),r=Math.min(...a),c=Math.max(...a),l=[];for(let h=0;h<5;h++){let d=this.population.filter(f=>(f._moRank??0)===h).length;if(!d)break;l.push(d)}for(let h of this.population){if((h._moRank??0)!==0)continue;let f=c>r?((h.score||0)-r)/(c-r):0,m=i==="nodes"?h.nodes.length:h.connections.length;n+=f*(1/(m+1))}let u=Array.from(this._operatorStats.entries()).map(([h,d])=>({op:h,succ:d.success,att:d.attempts})),p={gen:t,best:e.score,species:this._species.length,hyper:n,fronts:l,diversity:this._diversityStats,ops:u};if(p.objImportance||(p.objImportance={}),this._lastObjImportance&&(p.objImportance=this._lastObjImportance),this._objectiveAges?.size&&(p.objAges=Array.from(this._objectiveAges.entries()).reduce((h,d)=>(h[d[0]]=d[1],h),{})),this._pendingObjectiveAdds?.length||this._pendingObjectiveRemoves?.length){p.objEvents=[];for(let h of this._pendingObjectiveAdds)p.objEvents.push({type:"add",key:h});for(let h of this._pendingObjectiveRemoves)p.objEvents.push({type:"remove",key:h});this._objectiveEvents.push(...p.objEvents.map(h=>({gen:t,type:h.type,key:h.key}))),this._pendingObjectiveAdds=[],this._pendingObjectiveRemoves=[]}this._lastOffspringAlloc&&(p.speciesAlloc=this._lastOffspringAlloc.slice());try{p.objectives=this._getObjectives().map(h=>h.key)}catch{}if(this.options.rngState&&this._rngState!==void 0&&(p.rng=this._rngState),this._lineageEnabled){let h=this.population[0],d=this.population.map(b=>b._depth??0);this._lastMeanDepth=d.reduce((b,g)=>b+g,0)/(d.length||1);let{computeAncestorUniqueness:f}=(We(),K(Be)),m=f.call(this);p.lineage={parents:Array.isArray(h._parents)?h._parents.slice():[],depthBest:h._depth??0,meanDepth:+this._lastMeanDepth.toFixed(2),inbreeding:this._prevInbreedingCount,ancestorUniq:m}}if(this.options.telemetry?.hypervolume&&this.options.multiObjective?.enabled&&(p.hv=+n.toFixed(4)),this.options.telemetry?.complexity){let h=this.population.map(w=>w.nodes.length),d=this.population.map(w=>w.connections.length),f=h.reduce((w,x)=>w+x,0)/(h.length||1),m=d.reduce((w,x)=>w+x,0)/(d.length||1),b=h.length?Math.max(...h):0,g=d.length?Math.max(...d):0,y=this.population.map(w=>{let x=0,_=0;for(let I of w.connections)I.enabled===!1?_++:x++;return x+_?x/(x+_):0}),A=y.reduce((w,x)=>w+x,0)/(y.length||1),N=this._lastMeanNodes!==void 0?f-this._lastMeanNodes:0,v=this._lastMeanConns!==void 0?m-this._lastMeanConns:0;this._lastMeanNodes=f,this._lastMeanConns=m,p.complexity={meanNodes:+f.toFixed(2),meanConns:+m.toFixed(2),maxNodes:b,maxConns:g,meanEnabledRatio:+A.toFixed(3),growthNodes:+N.toFixed(2),growthConns:+v.toFixed(2),budgetMaxNodes:this.options.maxNodes,budgetMaxConns:this.options.maxConns}}return this.options.telemetry?.performance&&(p.perf={evalMs:this._lastEvalDuration,evolveMs:this._lastEvolveDuration}),p}let s=Array.from(this._operatorStats.entries()).map(([i,a])=>({op:i,succ:a.success,att:a.attempts})),o={gen:t,best:e.score,species:this._species.length,hyper:n,diversity:this._diversityStats,ops:s,objImportance:{}};if(this._lastObjImportance&&(o.objImportance=this._lastObjImportance),this._objectiveAges?.size&&(o.objAges=Array.from(this._objectiveAges.entries()).reduce((i,a)=>(i[a[0]]=a[1],i),{})),this._pendingObjectiveAdds?.length||this._pendingObjectiveRemoves?.length){o.objEvents=[];for(let i of this._pendingObjectiveAdds)o.objEvents.push({type:"add",key:i});for(let i of this._pendingObjectiveRemoves)o.objEvents.push({type:"remove",key:i});this._objectiveEvents.push(...o.objEvents.map(i=>({gen:t,type:i.type,key:i.key}))),this._pendingObjectiveAdds=[],this._pendingObjectiveRemoves=[]}this._lastOffspringAlloc&&(o.speciesAlloc=this._lastOffspringAlloc.slice());try{o.objectives=this._getObjectives().map(i=>i.key)}catch{}if(this.options.rngState&&this._rngState!==void 0&&(o.rng=this._rngState),this._lineageEnabled){let i=this.population[0],a=this.population.map(h=>h._depth??0);this._lastMeanDepth=a.reduce((h,d)=>h+d,0)/(a.length||1);let{buildAnc:r}=(We(),K(Be)),c=0,l=0,u=Math.min(30,this.population.length*(this.population.length-1)/2);for(let h=0;h<u&&!(this.population.length<2);h++){let d=Math.floor(this._getRNG()()*this.population.length),f=Math.floor(this._getRNG()()*this.population.length);f===d&&(f=(f+1)%this.population.length);let m=r.call(this,this.population[d]),b=r.call(this,this.population[f]);if(m.size===0&&b.size===0)continue;let g=0;for(let N of m)b.has(N)&&g++;let y=m.size+b.size-g||1,A=1-g/y;l+=A,c++}let p=c?+(l/c).toFixed(3):0;o.lineage={parents:Array.isArray(i._parents)?i._parents.slice():[],depthBest:i._depth??0,meanDepth:+this._lastMeanDepth.toFixed(2),inbreeding:this._prevInbreedingCount,ancestorUniq:p}}if(this.options.telemetry?.hypervolume&&this.options.multiObjective?.enabled&&(o.hv=+n.toFixed(4)),this.options.telemetry?.complexity){let i=this.population.map(m=>m.nodes.length),a=this.population.map(m=>m.connections.length),r=i.reduce((m,b)=>m+b,0)/(i.length||1),c=a.reduce((m,b)=>m+b,0)/(a.length||1),l=i.length?Math.max(...i):0,u=a.length?Math.max(...a):0,p=this.population.map(m=>{let b=0,g=0;for(let y of m.connections)y.enabled===!1?g++:b++;return b+g?b/(b+g):0}),h=p.reduce((m,b)=>m+b,0)/(p.length||1),d=this._lastMeanNodes!==void 0?r-this._lastMeanNodes:0,f=this._lastMeanConns!==void 0?c-this._lastMeanConns:0;this._lastMeanNodes=r,this._lastMeanConns=c,o.complexity={meanNodes:+r.toFixed(2),meanConns:+c.toFixed(2),maxNodes:l,maxConns:u,meanEnabledRatio:+h.toFixed(3),growthNodes:+d.toFixed(2),growthConns:+f.toFixed(2),budgetMaxNodes:this.options.maxNodes,budgetMaxConns:this.options.maxConns}}return this.options.telemetry?.performance&&(o.perf={evalMs:this._lastEvalDuration,evolveMs:this._lastEvolveDuration}),o}var Ms=H(()=>{"use strict";Pt()});var Qt={};ht(Qt,{applyAdaptivePruning:()=>Yi,applyEvolutionPruning:()=>Vi});function Vi(){let e=this.options.evolutionPruning;if(!e||this.generation<(e.startGeneration||0))return;let t=e.interval||1;if((this.generation-e.startGeneration)%t!==0)return;let n=e.rampGenerations||0,s=1;n>0&&(s=Math.min(1,Math.max(0,(this.generation-e.startGeneration)/n)));let o=(e.targetSparsity||0)*s;for(let i of this.population)i&&typeof i.pruneToSparsity=="function"&&i.pruneToSparsity(o,e.method||"magnitude")}function Yi(){if(!this.options.adaptivePruning?.enabled)return;let e=this.options.adaptivePruning;this._adaptivePruneLevel===void 0&&(this._adaptivePruneLevel=0);let t=e.metric||"connections",n=this.population.reduce((p,h)=>p+h.nodes.length,0)/(this.population.length||1),s=this.population.reduce((p,h)=>p+h.connections.length,0)/(this.population.length||1),o=t==="nodes"?n:s;this._adaptivePruneBaseline===void 0&&(this._adaptivePruneBaseline=o);let i=this._adaptivePruneBaseline,a=e.targetSparsity??.5,r=i*(1-a),c=e.tolerance??.05,l=e.adjustRate??.02,u=(o-r)/(i||1);if(Math.abs(u)>c){this._adaptivePruneLevel=Math.max(0,Math.min(a,this._adaptivePruneLevel+l*(u>0?1:-1)));for(let p of this.population)typeof p.pruneToSparsity=="function"&&p.pruneToSparsity(this._adaptivePruneLevel,"magnitude")}}var te=H(()=>{"use strict"});async function Is(){let e=typeof performance<"u"&&performance.now?performance.now():Date.now();this.population[this.population.length-1].score===void 0&&await this.evaluate(),this._objectivesList=void 0;try{(Dt(),K(Ft)).applyComplexityBudget.call(this)}catch{}try{(Dt(),K(Ft)).applyPhasedComplexity.call(this)}catch{}this.sort();try{let l=this.population[0]?.score;typeof l=="number"&&(this._bestScoreLastGen===void 0||l>this._bestScoreLastGen)&&(this._bestScoreLastGen=l,this._lastGlobalImproveGeneration=this.generation)}catch{}try{(Dt(),K(Ft)).applyMinimalCriterionAdaptive.call(this)}catch{}try{this._computeDiversityStats&&this._computeDiversityStats()}catch{}if(this.options.multiObjective?.enabled){let l=this.population,u=vs.call(this,l),p=this._getObjectives(),h=new Array(l.length).fill(0),d=p.map(m=>l.map(b=>m.accessor(b)));for(let m of u){let b=m.map(g=>this.population.indexOf(g));if(b.length<3){b.forEach(g=>h[g]=1/0);continue}for(let g=0;g<p.length;g++){let y=[...b].sort((v,w)=>d[g][v]-d[g][w]);h[y[0]]=1/0,h[y[y.length-1]]=1/0;let A=d[g][y[0]],N=d[g][y[y.length-1]];for(let v=1;v<y.length-1;v++){let w=d[g][y[v-1]],x=d[g][y[v+1]],_=N-A||1;h[y[v]]+=(x-w)/_}}}let f=new Map;for(let m=0;m<l.length;m++)f.set(l[m],m);this.population.sort((m,b)=>{let g=m._moRank??0,y=b._moRank??0;if(g!==y)return g-y;let A=f.get(m),N=f.get(b);return h[N]-h[A]});for(let m=0;m<l.length;m++)l[m]._moCrowd=h[m];if(u.length){let m=u[0],b=m.map(g=>({id:g._id??-1,score:g.score||0,nodes:g.nodes.length,connections:g.connections.length}));if(this._paretoArchive.push({gen:this.generation,size:m.length,genomes:b}),this._paretoArchive.length>200&&this._paretoArchive.shift(),p.length){let g=m.map(y=>({id:y._id??-1,values:p.map(A=>A.accessor(y))}));this._paretoObjectivesArchive.push({gen:this.generation,vectors:g}),this._paretoObjectivesArchive.length>200&&this._paretoObjectivesArchive.shift()}}if(this.options.multiObjective?.adaptiveEpsilon?.enabled&&u.length){let m=this.options.multiObjective.adaptiveEpsilon,b=m.targetFront??Math.max(3,Math.floor(Math.sqrt(this.population.length))),g=m.adjust??.002,y=m.min??0,A=m.max??.5,N=m.cooldown??2;if(this.generation-this._lastEpsilonAdjustGen>=N){let v=u[0].length,w=this.options.multiObjective.dominanceEpsilon||0;v>b*1.2?w=Math.min(A,w+g):v<b*.8&&(w=Math.max(y,w-g)),this.options.multiObjective.dominanceEpsilon=w,this._lastEpsilonAdjustGen=this.generation}}if(this.options.multiObjective?.pruneInactive?.enabled){let m=this.options.multiObjective.pruneInactive,b=m.window??5,g=m.rangeEps??1e-6,y=new Set(["fitness","complexity",...m.protect||[]]),A=this._getObjectives(),N={};for(let w of A){let x=1/0,_=-1/0;for(let I of this.population){let L=w.accessor(I);L<x&&(x=L),L>_&&(_=L)}N[w.key]={min:x,max:_}}let v=[];for(let w of A){if(y.has(w.key))continue;let x=N[w.key];if(x.max-x.min<g){let I=(this._objectiveStale.get(w.key)||0)+1;this._objectiveStale.set(w.key,I),I>=b&&v.push(w.key)}else this._objectiveStale.set(w.key,0)}v.length&&this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=this.options.multiObjective.objectives.filter(w=>!v.includes(w.key)),this._objectivesList=void 0)}}try{(Dt(),K(Ft)).applyAncestorUniqAdaptive.call(this)}catch{}if(this.options.speciation){try{this._speciate()}catch{}try{this._applyFitnessSharing()}catch{}try{let l=this.options;if(l.autoCompatTuning?.enabled){let u=l.autoCompatTuning.target??l.targetSpecies??Math.max(2,Math.round(Math.sqrt(this.population.length))),p=this._species.length||1,h=u-p,d=l.autoCompatTuning.adjustRate??.01,f=l.autoCompatTuning.minCoeff??.1,m=l.autoCompatTuning.maxCoeff??5,b=1-d*Math.sign(h);h===0&&(b=1+(this._getRNG()()-.5)*d*.5),l.excessCoeff=Math.min(m,Math.max(f,l.excessCoeff*b)),l.disjointCoeff=Math.min(m,Math.max(f,l.disjointCoeff*b))}}catch{}this.sort();try{this.options.speciesAllocation?.extendedHistory||(!this._speciesHistory||this._speciesHistory.length===0||this._speciesHistory[this._speciesHistory.length-1].generation!==this.generation)&&(this._speciesHistory.push({generation:this.generation,stats:this._species.map(l=>({id:l.id,size:l.members.length,best:l.bestScore,lastImproved:l.lastImproved}))}),this._speciesHistory.length>200&&this._speciesHistory.shift())}catch{}}let t=ct.fromJSON(this.population[0].toJSON());t.score=this.population[0].score,this._computeDiversityStats();try{let l=this._getObjectives().map(p=>p.key),u=this.options.multiObjective?.dynamic;if(this.options.multiObjective?.enabled)if(u?.enabled){let p=u.addComplexityAt??1/0,h=u.addEntropyAt??1/0;if(this.generation+1>=p&&!l.includes("complexity")&&(this.registerObjective("complexity","min",d=>d.connections.length),this._pendingObjectiveAdds.push("complexity")),this.generation+1>=h&&!l.includes("entropy")&&(this.registerObjective("entropy","max",d=>this._structuralEntropy(d)),this._pendingObjectiveAdds.push("entropy")),l.includes("entropy")&&u.dropEntropyOnStagnation!=null){let d=u.dropEntropyOnStagnation;this.generation>=d&&!this._entropyDropped&&this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=this.options.multiObjective.objectives.filter(f=>f.key!=="entropy"),this._objectivesList=void 0,this._pendingObjectiveRemoves.push("entropy"),this._entropyDropped=this.generation)}else!l.includes("entropy")&&this._entropyDropped&&u.readdEntropyAfter!=null&&this.generation-this._entropyDropped>=u.readdEntropyAfter&&(this.registerObjective("entropy","max",d=>this._structuralEntropy(d)),this._pendingObjectiveAdds.push("entropy"),this._entropyDropped=void 0)}else this.options.multiObjective.autoEntropy&&this.generation>=3&&!l.includes("entropy")&&(this.registerObjective("entropy","max",h=>this._structuralEntropy(h)),this._pendingObjectiveAdds.push("entropy"));for(let p of l)this._objectiveAges.set(p,(this._objectiveAges.get(p)||0)+1);for(let p of this._pendingObjectiveAdds)this._objectiveAges.set(p,0)}catch{}try{let l=this.options.multiObjective;if(l?.enabled&&l.pruneInactive&&l.pruneInactive.enabled===!1){let u=this._getObjectives().map(p=>p.key);u.includes("fitness")&&u.length>1&&!this._fitnessSuppressedOnce&&(this._suppressFitnessObjective=!0,this._fitnessSuppressedOnce=!0,this._objectivesList=void 0)}}catch{}let n=null;try{let l=this._getObjectives();if(l.length){n={};let u=this.population;for(let p of l){let h=u.map(g=>p.accessor(g)),d=Math.min(...h),f=Math.max(...h),m=h.reduce((g,y)=>g+y,0)/h.length,b=h.reduce((g,y)=>g+(y-m)*(y-m),0)/(h.length||1);n[p.key]={range:f-d,var:b}}this._lastObjImportance=n}}catch{}this.options.telemetry?.enabled;{let l=(Ms(),K(_s)),u=l.buildTelemetryEntry.call(this,t);l.recordTelemetryEntry.call(this,u)}(t.score??-1/0)>this._bestGlobalScore&&(this._bestGlobalScore=t.score??-1/0,this._lastGlobalImproveGeneration=this.generation);let s=[],o=Math.max(0,Math.min(this.options.elitism||0,this.population.length));for(let l=0;l<o;l++){let u=this.population[l];u&&s.push(u)}let i=Math.max(0,this.options.popsize||0),a=Math.max(0,i-s.length),r=Math.max(0,Math.min(this.options.provenance||0,a));for(let l=0;l<r;l++)this.options.network?s.push(ct.fromJSON(this.options.network.toJSON())):s.push(new ct(this.input,this.output,{minHidden:this.options.minHidden}));if(this.options.speciation&&this._species.length>0){this._suppressTournamentError=!0;let l=i-s.length;if(l>0){let u=this.options.speciesAgeBonus||{},p=u.youngThreshold??5,h=u.youngMultiplier??1.3,d=u.oldThreshold??30,f=u.oldMultiplier??.7,m=this._species.map(x=>{let _=x.members.reduce((L,$)=>L+($.score||0),0),I=this.generation-x.lastImproved;return I<=p?_*h:I>=d?_*f:_}),b=m.reduce((x,_)=>x+_,0)||1,g=this.options.speciesAllocation?.minOffspring??1,y=this._species.map((x,_)=>m[_]/b*l),A=y.map(x=>Math.floor(x));for(let x=0;x<A.length;x++)A[x]<g&&l>=this._species.length*g&&(A[x]=g);let N=A.reduce((x,_)=>x+_,0),v=l-N,w=y.map((x,_)=>({i:_,frac:x-Math.floor(x)}));w.sort((x,_)=>_.frac-x.frac);for(let x of w){if(v<=0)break;A[x.i]++,v--}if(v<0){let x=A.map((_,I)=>({i:I,v:_})).sort((_,I)=>I.v-_.v);for(let _ of x){if(v===0)break;A[_.i]>g&&(A[_.i]--,v++)}}this._lastOffspringAlloc=this._species.map((x,_)=>({id:x.id,alloc:A[_]||0})),this._prevInbreedingCount=this._lastInbreedingCount,this._lastInbreedingCount=0,A.forEach((x,_)=>{if(x<=0)return;let I=this._species[_];this._sortSpeciesMembers(I);let L=I.members.slice(0,Math.max(1,Math.floor(I.members.length*(this.options.survivalThreshold||.5))));for(let $=0;$<x;$++){let k=L[Math.floor(this._getRNG()()*L.length)],F;if(this.options.crossSpeciesMatingProb&&this._species.length>1&&this._getRNG()()<(this.options.crossSpeciesMatingProb||0)){let T=_,D=0;for(;T===_&&D++<5;)T=Math.floor(this._getRNG()()*this._species.length);let E=this._species[T];this._sortSpeciesMembers(E);let R=E.members.slice(0,Math.max(1,Math.floor(E.members.length*(this.options.survivalThreshold||.5))));F=R[Math.floor(this._getRNG()()*R.length)]}else F=L[Math.floor(this._getRNG()()*L.length)];let M=ct.crossOver(k,F,this.options.equal||!1);if(M._reenableProb=this.options.reenableProb,M._id=this._nextGenomeId++,this._lineageEnabled){M._parents=[k._id,F._id];let T=k._depth??0,D=F._depth??0;M._depth=1+Math.max(T,D),k._id===F._id&&this._lastInbreedingCount++}s.push(M)}}),this._suppressTournamentError=!1}}else{this._suppressTournamentError=!0;let l=Math.max(0,i-s.length);for(let u=0;u<l;u++)s.push(this.getOffspring());this._suppressTournamentError=!1}for(let l of s)l&&(this.ensureMinHiddenNodes(l),this.ensureNoDeadEnds(l));this.population=s;try{(te(),K(Qt)).applyEvolutionPruning.call(this)}catch{}try{(te(),K(Qt)).applyAdaptivePruning.call(this)}catch{}this.mutate();try{(Dt(),K(Ft)).applyAdaptiveMutation.call(this)}catch{}if(this.population.forEach(l=>{l._compatCache&&delete l._compatCache}),this.population.forEach(l=>l.score=void 0),this.generation++,this.options.speciation&&this._updateSpeciesStagnation(),(this.options.globalStagnationGenerations||0)>0&&this.generation-this._lastGlobalImproveGeneration>(this.options.globalStagnationGenerations||0)){let u=Math.max(this.options.elitism||0,Math.floor(this.population.length*.8));for(let p=u;p<this.population.length;p++){let h=new ct(this.input,this.output,{minHidden:this.options.minHidden});h.score=void 0,h._reenableProb=this.options.reenableProb,h._id=this._nextGenomeId++,this._lineageEnabled&&(h._parents=[],h._depth=0);try{if(this.ensureMinHiddenNodes(h),this.ensureNoDeadEnds(h),h.nodes.filter(f=>f.type==="hidden").length===0){let f=(lt(),K(se)).default,m=new f("hidden");h.nodes.splice(h.nodes.length-h.output,0,m);let b=h.nodes.filter(y=>y.type==="input"),g=h.nodes.filter(y=>y.type==="output");if(b.length&&g.length){try{h.connect(b[0],m,1)}catch{}try{h.connect(m,g[0],1)}catch{}}}}catch{}this.population[p]=h}this._lastGlobalImproveGeneration=this.generation}if(this.options.reenableProb!==void 0){let l=0,u=0;for(let p of this.population)l+=p._reenableSuccess||0,u+=p._reenableAttempts||0,p._reenableSuccess=0,p._reenableAttempts=0;if(u>20){let d=l/u-.3;this.options.reenableProb=Math.min(.9,Math.max(.05,this.options.reenableProb-d*.1))}}try{(Dt(),K(Ft)).applyOperatorAdaptation.call(this)}catch{}let c=typeof performance<"u"&&performance.now?performance.now():Date.now();this._lastEvolveDuration=c-e;try{this._speciesHistory||(this._speciesHistory=[]),this.options.speciesAllocation?.extendedHistory||(this._speciesHistory.length===0||this._speciesHistory[this._speciesHistory.length-1].generation!==this.generation)&&(this._speciesHistory.push({generation:this.generation,stats:this._species.map(l=>({id:l.id,size:l.members.length,best:l.bestScore,lastImproved:l.lastImproved}))}),this._speciesHistory.length>200&&this._speciesHistory.shift())}catch{}return t}var Es=H(()=>{"use strict";pt();Ge()});async function Cs(){let e=this.options||{};if(e.fitnessPopulation)e.clear&&this.population.forEach(t=>t.clear&&t.clear()),await this.fitness(this.population);else for(let t of this.population){e.clear&&t.clear&&t.clear();let n=await this.fitness(t);t.score=n}try{let t=e.novelty;if(t?.enabled&&typeof t.descriptor=="function"){let n=Math.max(1,t.k||3),s=t.blendFactor??.3,o=this.population.map(a=>{try{return t.descriptor(a)||[]}catch{return[]}}),i=[];for(let a=0;a<o.length;a++){i[a]=[];for(let r=0;r<o.length;r++){if(a===r){i[a][r]=0;continue}let c=o[a],l=o[r],u=0,p=Math.min(c.length,l.length);for(let h=0;h<p;h++){let d=(c[h]||0)-(l[h]||0);u+=d*d}i[a][r]=Math.sqrt(u)}}for(let a=0;a<this.population.length;a++){let c=i[a].toSorted((p,h)=>p-h).slice(1,n+1),l=c.length?c.reduce((p,h)=>p+h,0)/c.length:0;this.population[a]._novelty=l,typeof this.population[a].score=="number"&&(this.population[a].score=(1-s)*this.population[a].score+s*l),this._noveltyArchive||(this._noveltyArchive=[]);let u=t.archiveAddThreshold??1/0;(t.archiveAddThreshold===0||l>u)&&this._noveltyArchive.length<200&&this._noveltyArchive.push({desc:o[a],novelty:l})}}}catch{}this._diversityStats||(this._diversityStats={});try{let t=e.entropySharingTuning;if(t?.enabled){let n=t.targetEntropyVar??.2,s=t.adjustRate??.1,o=t.minSigma??.1,i=t.maxSigma??10,a=this._diversityStats.varEntropy;if(typeof a=="number"){let r=this.options.sharingSigma??0;a<n*.9?r=Math.max(o,r*(1-s)):a>n*1.1&&(r=Math.min(i,r*(1+s))),this.options.sharingSigma=r}}}catch{}try{let t=e.entropyCompatTuning;if(t?.enabled){let n=this._diversityStats.meanEntropy,s=t.targetEntropy??.5,o=t.deadband??.05,i=t.adjustRate??.05,a=this.options.compatibilityThreshold??3;typeof n=="number"&&(n<s-o?a=Math.max(t.minThreshold??.5,a*(1-i)):n>s+o&&(a=Math.min(t.maxThreshold??10,a*(1+i))),this.options.compatibilityThreshold=a)}}catch{}try{this.options.speciation&&(this.options.targetSpecies||this.options.compatAdjust||this.options.speciesAllocation?.extendedHistory)&&this._speciate()}catch{}try{let t=this.options.autoDistanceCoeffTuning;if(t?.enabled&&this.options.speciation){let n=this.population.map(c=>c.connections.length),s=n.reduce((c,l)=>c+l,0)/(n.length||1),o=n.reduce((c,l)=>c+(l-s)*(l-s),0)/(n.length||1),i=t.adjustRate??.05,a=t.minCoeff??.05,r=t.maxCoeff??8;if(this._lastConnVar===void 0||this._lastConnVar===null){this._lastConnVar=o;try{this.options.excessCoeff=Math.min(r,(this.options.excessCoeff??1)*(1+i)),this.options.disjointCoeff=Math.min(r,(this.options.disjointCoeff??1)*(1+i))}catch{}}o<this._lastConnVar*.95?(this.options.excessCoeff=Math.min(r,this.options.excessCoeff*(1+i)),this.options.disjointCoeff=Math.min(r,this.options.disjointCoeff*(1+i))):o>this._lastConnVar*1.05&&(this.options.excessCoeff=Math.max(a,this.options.excessCoeff*(1-i)),this.options.disjointCoeff=Math.max(a,this.options.disjointCoeff*(1-i))),this._lastConnVar=o}}catch{}try{this.options.multiObjective?.enabled&&this.options.multiObjective.autoEntropy&&(this.options.multiObjective.dynamic?.enabled||this._getObjectives().map(n=>n.key).includes("entropy")||(this.registerObjective("entropy","max",n=>this._structuralEntropy(n)),this._pendingObjectiveAdds.push("entropy"),this._objectivesList=void 0))}catch{}}var Ts=H(()=>{"use strict"});function Os(e,t=1){let n=e.clone?e.clone():(pt(),K(kt)).default.fromJSON(e.toJSON());n.score=void 0,n._reenableProb=this.options.reenableProb,n._id=this._nextGenomeId++,n._parents=[e._id],n._depth=(e._depth??0)+1,this.ensureMinHiddenNodes(n),this.ensureNoDeadEnds(n);for(let s=0;s<t;s++)try{let o=this.selectMutationMethod(n,!1);if(Array.isArray(o)){let i=o;o=i[Math.floor(this._getRNG()()*i.length)]}o&&o.name&&n.mutate(o)}catch{}return this._invalidateGenomeCaches(n),n}function Rs(e,t){try{if(e.score=void 0,e._reenableProb=this.options.reenableProb,e._id=this._nextGenomeId++,e._parents=Array.isArray(t)?t.slice():[],e._depth=0,e._parents.length){let n=e._parents.map(s=>this.population.find(o=>o._id===s)).filter(Boolean).map(s=>s._depth??0);e._depth=n.length?Math.max(...n)+1:1}this.ensureMinHiddenNodes(e),this.ensureNoDeadEnds(e),this._invalidateGenomeCaches(e),this.population.push(e)}catch{this.population.push(e)}}function he(e){try{this.population=[];let t=this.options?.popsize||50;for(let n=0;n<t;n++){let s=e?ct.fromJSON(e.toJSON()):new ct(this.input,this.output,{minHidden:this.options?.minHidden});s.score=void 0;try{this.ensureNoDeadEnds(s)}catch{}s._reenableProb=this.options.reenableProb,s._id=this._nextGenomeId++,this._lineageEnabled&&(s._parents=[],s._depth=0),this.population.push(s)}}catch{}}var Ls=H(()=>{"use strict";pt()});function Ps(){if(this._objectivesList)return this._objectivesList;let e=[];if(this._suppressFitnessObjective||e.push({key:"fitness",direction:"max",accessor:t=>t.score||0}),this.options.multiObjective?.enabled&&Array.isArray(this.options.multiObjective.objectives))for(let t of this.options.multiObjective.objectives)!t||!t.key||typeof t.accessor!="function"||e.push(t);return this._objectivesList=e,e}function ks(e,t,n){this.options.multiObjective||(this.options.multiObjective={enabled:!0});let s=this.options.multiObjective;s.objectives||(s.objectives=[]),s.objectives=s.objectives.filter(o=>o.key!==e),s.objectives.push({key:e,direction:t,accessor:n}),this._objectivesList=void 0}function Fs(){this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=[]),this._objectivesList=void 0}var Ds=H(()=>{"use strict"});function je(e){let t=e.nodes.map(i=>i.connections.out.length),n=t.reduce((i,a)=>i+a,0)||1,s=t.map(i=>i/n).filter(i=>i>0),o=0;for(let i of s)o-=i*Math.log(i);return o}function jt(e){return e.length?e.reduce((t,n)=>t+n,0)/e.length:0}function $s(e){if(!e.length)return 0;let t=jt(e);return jt(e.map(n=>(n-t)*(n-t)))}function Hs(e,t){if(!e.length)return;let n=[];for(let g of e)typeof g._depth=="number"&&n.push(g._depth);let s=jt(n),o=0,i=0;for(let g=0;g<n.length&&g<30;g++)for(let y=g+1;y<n.length&&y<30;y++)o+=Math.abs(n[g]-n[y]),i++;let a=i?o/i:0,r=e.map(g=>g.nodes.length),c=e.map(g=>g.connections.length),l=jt(r),u=jt(c),p=$s(r),h=$s(c),d=0,f=0;for(let g=0;g<e.length&&g<25;g++)for(let y=g+1;y<e.length&&y<25;y++)d+=t._compatibilityDistance(e[g],e[y]),f++;let m=f?d/f:0,b=jt(e.map(g=>je(g)));return{lineageMeanDepth:s,lineageMeanPairDist:a,meanNodes:l,meanConns:u,nodeVar:p,connVar:h,meanCompat:m,graphletEntropy:b,population:e.length}}var Gs=H(()=>{"use strict";pt()});function Bs(e){let t=e.from?.index??0,n=e.to?.index??0;return t*1e5+n}function Ws(e,t){(!this._compatCacheGen||this._compatCacheGen!==this.generation)&&(this._compatCacheGen=this.generation,this._compatDistCache=new Map);let n=e._id<t._id?`${e._id}|${t._id}`:`${t._id}|${e._id}`,s=this._compatDistCache;if(s.has(n))return s.get(n);let o=A=>{if(!A._compatCache){let N=A.connections.map(v=>[v.innovation??this._fallbackInnov(v),v.weight]);N.sort((v,w)=>v[0]-w[0]),A._compatCache=N}return A._compatCache},i=o(e),a=o(t),r=0,c=0,l=0,u=0,p=0,h=0,d=i.length?i[i.length-1][0]:0,f=a.length?a[a.length-1][0]:0;for(;r<i.length&&c<a.length;){let[A,N]=i[r],[v,w]=a[c];A===v?(l++,h+=Math.abs(N-w),r++,c++):A<v?(A>f?p++:u++,r++):(v>d?p++:u++,c++)}r<i.length&&(p+=i.length-r),c<a.length&&(p+=a.length-c);let m=Math.max(1,Math.max(i.length,a.length)),b=l?h/l:0,g=this.options,y=g.excessCoeff*p/m+g.disjointCoeff*u/m+g.weightDiffCoeff*b;return s.set(n,y),y}var js=H(()=>{"use strict"});function Us(){this._prevSpeciesMembers.clear();for(let t of this._species){let n=new Set;for(let s of t.members)n.add(s._id);this._prevSpeciesMembers.set(t.id,n)}this._species.forEach(t=>t.members=[]);for(let t of this.population){let n=!1;for(let s of this._species)if(this._compatibilityDistance(t,s.representative)<(this.options.compatibilityThreshold||3)){s.members.push(t),n=!0;break}if(!n){let s=this._nextSpeciesId++;this._species.push({id:s,members:[t],representative:t,lastImproved:this.generation,bestScore:t.score||-1/0}),this._speciesCreated.set(s,this.generation)}}this._species=this._species.filter(t=>t.members.length>0),this._species.forEach(t=>{t.representative=t.members[0]});let e=this.options.speciesAgeProtection||{grace:3,oldPenalty:.5};for(let t of this._species){let n=this._speciesCreated.get(t.id)??this.generation;if(this.generation-n>=(e.grace??3)*10){let o=e.oldPenalty??.5;o<1&&t.members.forEach(i=>{typeof i.score=="number"&&(i.score*=o)})}}if(this.options.speciation&&(this.options.targetSpecies||0)>0){let t=this.options.targetSpecies,n=this._species.length,s=this.options.compatAdjust,i=2/(Math.max(1,s.smoothingWindow||1)+1);this._compatSpeciesEMA=this._compatSpeciesEMA===void 0?n:this._compatSpeciesEMA+i*(n-this._compatSpeciesEMA);let a=this._compatSpeciesEMA,r=t-a;this._compatIntegral=this._compatIntegral*(s.decay||.95)+r;let c=(s.kp||0)*r+(s.ki||0)*this._compatIntegral,l=(this.options.compatibilityThreshold||3)-c,u=s.minThreshold||.5,p=s.maxThreshold||10;l<u&&(l=u,this._compatIntegral=0),l>p&&(l=p,this._compatIntegral=0),this.options.compatibilityThreshold=l}if(this.options.autoCompatTuning?.enabled){let t=this.options.autoCompatTuning.target??this.options.targetSpecies??Math.max(2,Math.round(Math.sqrt(this.population.length))),n=this._species.length||1,s=t-n,o=this.options.autoCompatTuning.adjustRate??.01,i=this.options.autoCompatTuning.minCoeff??.1,a=this.options.autoCompatTuning.maxCoeff??5,c=1-o*Math.sign(s);s===0&&(c=1+(this._getRNG()()-.5)*o*.5),this.options.excessCoeff=Math.min(a,Math.max(i,this.options.excessCoeff*c)),this.options.disjointCoeff=Math.min(a,Math.max(i,this.options.disjointCoeff*c))}if(this.options.speciesAllocation?.extendedHistory){let t=this._species.map(n=>{let s=n.members.map(M=>({nodes:M.nodes.length,conns:M.connections.length,score:M.score||0,nov:M._novelty||0,ent:this._structuralEntropy(M)})),o=M=>M.length?M.reduce((T,D)=>T+D,0)/M.length:0,i=0,a=0;for(let M=0;M<n.members.length&&M<10;M++)for(let T=M+1;T<n.members.length&&T<10;T++)i+=this._compatibilityDistance(n.members[M],n.members[T]),a++;let r=a?i/a:0,c=this._speciesLastStats.get(n.id),l=o(s.map(M=>M.nodes)),u=o(s.map(M=>M.conns)),p=c?l-c.meanNodes:0,h=c?u-c.meanConns:0,d=c?n.bestScore-c.best:0,f=this._speciesCreated.get(n.id)??this.generation,m=this.generation-f,b=0,g=this._prevSpeciesMembers.get(n.id);if(g&&n.members.length){let M=0;for(let T of n.members)g.has(T._id)||M++;b=M/n.members.length}let y=M=>{if(!M.length)return 0;let T=o(M);return o(M.map(D=>(D-T)*(D-T)))},A=y(s.map(M=>M.nodes)),N=y(s.map(M=>M.conns)),v=0,w=0,x=-1/0,_=1/0,I=0,L=0;for(let M of n.members)for(let T of M.connections){let D=T.innovation??this._fallbackInnov(T);v+=D,w++,D>x&&(x=D),D<_&&(_=D),T.enabled===!1?L++:I++}let $=w?v/w:0,k=isFinite(x)&&isFinite(_)&&x>_?x-_:0,F=I+L>0?I/(I+L):0;return{id:n.id,size:n.members.length,best:n.bestScore,lastImproved:n.lastImproved,age:m,meanNodes:l,meanConns:u,meanScore:o(s.map(M=>M.score)),meanNovelty:o(s.map(M=>M.nov)),meanCompat:r,meanEntropy:o(s.map(M=>M.ent)),varNodes:A,varConns:N,deltaMeanNodes:p,deltaMeanConns:h,deltaBestScore:d,turnoverRate:b,meanInnovation:$,innovationRange:k,enabledRatio:F}});for(let n of t)this._speciesLastStats.set(n.id,{meanNodes:n.meanNodes,meanConns:n.meanConns,best:n.best});this._speciesHistory.push({generation:this.generation,stats:t})}else this._speciesHistory.push({generation:this.generation,stats:this._species.map(t=>({id:t.id,size:t.members.length,best:t.bestScore,lastImproved:t.lastImproved}))});this._speciesHistory.length>200&&this._speciesHistory.shift()}function zs(){let e=this.options.sharingSigma||0;e>0?this._species.forEach(t=>{let n=t.members;for(let s=0;s<n.length;s++){let o=n[s];if(typeof o.score!="number")continue;let i=0;for(let a=0;a<n.length;a++){let r=n[a],c=s===a?0:this._compatibilityDistance(o,r);if(c<e){let l=c/e;i+=1-l*l}}i<=0&&(i=1),o.score=o.score/i}}):this._species.forEach(t=>{let n=t.members.length;t.members.forEach(s=>{typeof s.score=="number"&&(s.score=s.score/n)})})}function qs(e){e.members.sort((t,n)=>(n.score||0)-(t.score||0))}function Vs(){let e=this.options.stagnationGenerations||15;this._species.forEach(n=>{this._sortSpeciesMembers(n);let s=n.members[0];(s.score||-1/0)>n.bestScore&&(n.bestScore=s.score||-1/0,n.lastImproved=this.generation)});let t=this._species.filter(n=>this.generation-n.lastImproved<=e);t.length&&(this._species=t)}var Ys=H(()=>{"use strict"});function Xs(){return this._species.map(t=>({id:t.id,size:t.members.length,bestScore:t.bestScore,lastImproved:t.lastImproved}))}function Js(){let e=this._speciesHistory;if(this.options?.speciesAllocation?.extendedHistory)for(let t of e)for(let n of t.stats){if("innovationRange"in n&&"enabledRatio"in n)continue;let s=this._species.find(o=>o.id===n.id);if(s&&s.members&&s.members.length){let o=-1/0,i=1/0,a=0,r=0;for(let c of s.members)for(let l of c.connections){let u=l.innovation??this._fallbackInnov?.(l)??0;u>o&&(o=u),u<i&&(i=u),l.enabled===!1?r++:a++}n.innovationRange=isFinite(o)&&isFinite(i)&&o>i?o-i:0,n.enabledRatio=a+r?a/(a+r):0}}return e}var Ks=H(()=>{"use strict"});function Zs(){return this._telemetry.map(e=>JSON.stringify(e)).join(`
`)}function Qs(e=500){let t=Array.isArray(this._telemetry)?this._telemetry.slice(-e):[];if(!t.length)return"";let n=Xi(t),s=Ji(n),o=[s.join(",")];for(let i of t)o.push(Ki(i,s));return o.join(`
`)}function Xi(e){let t=new Set,n=new Set,s=new Set,o=new Set,i=new Set,a=!1,r=!1,c=!1,l=!1,u=!1,p=!1;for(let h of e)Object.keys(h).forEach(d=>{d!=="complexity"&&d!=="perf"&&d!=="ops"&&d!==Ye&&t.add(d)}),Array.isArray(h.fronts)&&t.add(Ye),h.complexity&&Object.keys(h.complexity).forEach(d=>n.add(d)),h.perf&&Object.keys(h.perf).forEach(d=>s.add(d)),h.lineage&&Object.keys(h.lineage).forEach(d=>o.add(d)),h.diversity&&("lineageMeanDepth"in h.diversity&&i.add("lineageMeanDepth"),"lineageMeanPairDist"in h.diversity&&i.add("lineageMeanPairDist")),"rng"in h&&t.add("rng"),Array.isArray(h.ops)&&h.ops.length&&(a=!0),Array.isArray(h.objectives)&&(r=!0),h.objAges&&(c=!0),Array.isArray(h.speciesAlloc)&&(l=!0),Array.isArray(h.objEvents)&&h.objEvents.length&&(u=!0),h.objImportance&&(p=!0);return{baseKeys:t,complexityKeys:n,perfKeys:s,lineageKeys:o,diversityLineageKeys:i,includeOps:a,includeObjectives:r,includeObjAges:c,includeSpeciesAlloc:l,includeObjEvents:u,includeObjImportance:p}}function Ji(e){let t=[...e.baseKeys,...[...e.complexityKeys].map(n=>`${Ue}${n}`),...[...e.perfKeys].map(n=>`${ze}${n}`),...[...e.lineageKeys].map(n=>`${qe}${n}`),...[...e.diversityLineageKeys].map(n=>`${Ve}${n}`)];return e.includeOps&&t.push(to),e.includeObjectives&&t.push(eo),e.includeObjAges&&t.push(no),e.includeSpeciesAlloc&&t.push(so),e.includeObjEvents&&t.push(oo),e.includeObjImportance&&t.push(io),t}function Ki(e,t){let n=[];for(let s of t)switch(!0){case s.startsWith(Ue):{let o=s.slice(Ue.length);n.push(e.complexity&&o in e.complexity?JSON.stringify(e.complexity[o]):"");break}case s.startsWith(ze):{let o=s.slice(ze.length);n.push(e.perf&&o in e.perf?JSON.stringify(e.perf[o]):"");break}case s.startsWith(qe):{let o=s.slice(qe.length);n.push(e.lineage&&o in e.lineage?JSON.stringify(e.lineage[o]):"");break}case s.startsWith(Ve):{let o=s.slice(Ve.length);n.push(e.diversity&&o in e.diversity?JSON.stringify(e.diversity[o]):"");break}case s===Ye:{n.push(Array.isArray(e.fronts)?JSON.stringify(e.fronts):"");break}case s===to:{n.push(Array.isArray(e.ops)?JSON.stringify(e.ops):"");break}case s===eo:{n.push(Array.isArray(e.objectives)?JSON.stringify(e.objectives):"");break}case s===no:{n.push(e.objAges?JSON.stringify(e.objAges):"");break}case s===so:{n.push(Array.isArray(e.speciesAlloc)?JSON.stringify(e.speciesAlloc):"");break}case s===oo:{n.push(Array.isArray(e.objEvents)?JSON.stringify(e.objEvents):"");break}case s===io:{n.push(e.objImportance?JSON.stringify(e.objImportance):"");break}default:{n.push(JSON.stringify(e[s]));break}}return n.join(",")}function ao(e=200){if(Array.isArray(this._speciesHistory)||(this._speciesHistory=[]),!this._speciesHistory.length&&Array.isArray(this._species)&&this._species.length){let o=this._species.map(i=>({id:i.id??-1,size:Array.isArray(i.members)?i.members.length:0,best:i.bestScore??0,lastImproved:i.lastImproved??0}));this._speciesHistory.push({generation:this.generation||0,stats:o})}let t=this._speciesHistory.slice(-e);if(!t.length)return"generation,id,size,best,lastImproved";let n=new Set(["generation"]);for(let o of t)for(let i of o.stats)Object.keys(i).forEach(a=>n.add(a));let s=Array.from(n);return Qi(t,s)}function Qi(e,t){let n=[t.join(",")];for(let s of e)for(let o of s.stats){let i=[];for(let a of t){if(a===Zi){i.push(JSON.stringify(s.generation));continue}i.push(JSON.stringify(o[a]))}n.push(i.join(","))}return n.join(`
`)}var Ue,ze,qe,Ve,Ye,to,eo,no,so,oo,io,Zi,ro=H(()=>{"use strict";Ue="complexity.",ze="perf.",qe="lineage.",Ve="diversity.",Ye="fronts",to="ops",eo="objectives",no="objAges",so="speciesAlloc",oo="objEvents",io="objImportance";Zi="generation"});function co(){this.population.sort((e,t)=>(t.score??0)-(e.score??0))}function lo(){let e=this.options.selection,t=e?.name,n=this._getRNG.bind(this),s=this.population;switch(t){case"POWER":s[0]?.score!==void 0&&s[1]?.score!==void 0&&s[0].score<s[1].score&&this.sort();let o=Math.floor(Math.pow(n()(),e.power||1)*s.length);return s[o];case"FITNESS_PROPORTIONATE":let i=0,a=0;s.forEach(h=>{a=Math.min(a,h.score??0),i+=h.score??0});let r=Math.abs(a);i+=r*s.length;let c=n()()*i,l=0;for(let h of s)if(l+=(h.score??0)+r,c<l)return h;return s[Math.floor(n()()*s.length)];case"TOURNAMENT":if((e.size||2)>s.length){if(!this._suppressTournamentError)throw new Error("Tournament size must be less than population size.");return s[Math.floor(n()()*s.length)]}let u=e.size||2,p=[];for(let h=0;h<u;h++)p.push(s[Math.floor(n()()*s.length)]);p.sort((h,d)=>(d.score??0)-(h.score??0));for(let h=0;h<p.length;h++)if(n()()<(e.probability??.5)||h===p.length-1)return p[h];break;default:return s[0]}return s[0]}function uo(){let e=this.population;return e[e.length-1].score===void 0&&this.evaluate(),e[1]&&(e[0].score??0)<(e[1].score??0)&&this.sort(),e[0]}function ho(){let e=this.population;return e[e.length-1].score===void 0&&this.evaluate(),e.reduce((n,s)=>n+(s.score??0),0)/e.length}var po=H(()=>{"use strict"});var fo={};ht(fo,{exportPopulation:()=>Xe,exportState:()=>Ke,fromJSONImpl:()=>tn,importPopulation:()=>Je,importStateImpl:()=>Ze,toJSONImpl:()=>Qe});function Xe(){return this.population.map(e=>e.toJSON())}function Je(e){let t=(pt(),K(kt)).default;this.population=e.map(n=>t.fromJSON(n)),this.options.popsize=this.population.length}function Ke(){let{toJSONImpl:e,exportPopulation:t}=(en(),K(fo));return{neat:e.call(this),population:t.call(this)}}function Ze(e,t){if(!e||typeof e!="object")throw new Error("Invalid state bundle");let n=this.fromJSON(e.neat,t);return Array.isArray(e.population)&&n.import(e.population),n}function Qe(){return{input:this.input,output:this.output,generation:this.generation,options:this.options,nodeSplitInnovations:Array.from(this._nodeSplitInnovations.entries()),connInnovations:Array.from(this._connInnovations.entries()),nextGlobalInnovation:this._nextGlobalInnovation}}function tn(e,t){let n=this,s=new n(e.input,e.output,t,e.options||{});return s.generation=e.generation||0,Array.isArray(e.nodeSplitInnovations)&&(s._nodeSplitInnovations=new Map(e.nodeSplitInnovations)),Array.isArray(e.connInnovations)&&(s._connInnovations=new Map(e.connInnovations)),typeof e.nextGlobalInnovation=="number"&&(s._nextGlobalInnovation=e.nextGlobalInnovation),s}var en=H(()=>{"use strict"});var fs={};ht(fs,{default:()=>$t});var $t,He=H(()=>{"use strict";pt();ft();we();lt();Ns();Es();Ts();Ls();Ds();Gs();Ge();js();Ys();Ks();ro();po();en();$t=class e{input;output;fitness;options;population=[];generation=0;_rngState;_rng;_species=[];_operatorStats=new Map;_nodeSplitInnovations=new Map;_connInnovations=new Map;_nextGlobalInnovation=1;_nextGenomeId=1;_lineageEnabled=!1;_lastInbreedingCount=0;_prevInbreedingCount=0;_phase;_telemetry=[];_prevSpeciesMembers=new Map;_speciesLastStats=new Map;_speciesHistory=[];_paretoArchive=[];_paretoObjectivesArchive=[];_noveltyArchive=[];_objectiveStale=new Map;_objectiveAges=new Map;_objectiveEvents=[];_pendingObjectiveAdds=[];_pendingObjectiveRemoves=[];_lastOffspringAlloc;_adaptivePruneLevel;_lastEvalDuration;_lastEvolveDuration;_diversityStats;_objectivesList;_lastGlobalImproveGeneration=0;_bestScoreLastGen;_speciesCreated=new Map;_compatSpeciesEMA;_compatIntegral=0;_lastEpsilonAdjustGen=-1/0;_lastAncestorUniqAdjustGen=-1/0;_mcThreshold;_getRNG(){if(!this._rng){let t=this.options?.rng;if(typeof t=="function")this._rng=t;else{if(this._rngState===void 0){let n=(Date.now()^(this.population.length+1)*2654435761)>>>0;n===0&&(n=439041101),this._rngState=n>>>0}this._rng=()=>{let n=this._rngState>>>0;return n^=n<<13,n>>>=0,n^=n>>17,n>>>=0,n^=n<<5,n>>>=0,this._rngState=n>>>0,(n>>>0)/4294967295}}}return this._rng}ensureMinHiddenNodes(t,n){return bs.call(this,t,n)}constructor(t,n,s,o={}){this.input=t??0,this.output=n??0,this.fitness=s??(a=>0),this.options=o||{};let i=this.options;i.popsize===void 0&&(i.popsize=50),i.elitism===void 0&&(i.elitism=0),i.provenance===void 0&&(i.provenance=0),i.mutationRate===void 0&&(i.mutationRate=.7),i.mutationAmount===void 0&&(i.mutationAmount=1),i.fitnessPopulation===void 0&&(i.fitnessPopulation=!1),i.clear===void 0&&(i.clear=!1),i.equal===void 0&&(i.equal=!1),i.compatibilityThreshold===void 0&&(i.compatibilityThreshold=3),i.maxNodes===void 0&&(i.maxNodes=1/0),i.maxConns===void 0&&(i.maxConns=1/0),i.maxGates===void 0&&(i.maxGates=1/0),i.excessCoeff===void 0&&(i.excessCoeff=1),i.disjointCoeff===void 0&&(i.disjointCoeff=1),i.weightDiffCoeff===void 0&&(i.weightDiffCoeff=.5),i.mutation===void 0&&(i.mutation=W.ALL?W.ALL.slice():W.FFW?[W.FFW]:[]),i.selection===void 0&&(i.selection=_t&&_t.TOURNAMENT||_t?.TOURNAMENT||_t.FITNESS_PROPORTIONATE),i.crossover===void 0&&(i.crossover=Yt?Yt.SINGLE_POINT:void 0),i.novelty===void 0&&(i.novelty={enabled:!1}),i.diversityMetrics===void 0&&(i.diversityMetrics={enabled:!0}),i.fastMode&&i.diversityMetrics&&(i.diversityMetrics.pairSample==null&&(i.diversityMetrics.pairSample=20),i.diversityMetrics.graphletSample==null&&(i.diversityMetrics.graphletSample=30),i.novelty?.enabled&&i.novelty.k==null&&(i.novelty.k=5)),this._noveltyArchive=[],i.speciation===void 0&&(i.speciation=!1),i.multiObjective&&i.multiObjective.enabled&&!Array.isArray(i.multiObjective.objectives)&&(i.multiObjective.objectives=[]),this.population=this.population||[];try{this.options.network!==void 0?this.createPool(this.options.network):this.options.popsize&&this.createPool(null)}catch{}(this.options.lineage?.enabled||this.options.provenance>0)&&(this._lineageEnabled=!0),this.options.lineageTracking===!0&&(this._lineageEnabled=!0),o.lineagePressure?.enabled&&this._lineageEnabled!==!0&&(this._lineageEnabled=!0)}async evolve(){return Is.call(this)}async evaluate(){return Cs.call(this)}createPool(t){try{if(he&&typeof he=="function")return he.call(this,t)}catch{}this.population=[];let n=this.options.popsize||50;for(let s=0;s<n;s++){let o=t?ct.fromJSON(t.toJSON()):new ct(this.input,this.output,{minHidden:this.options.minHidden});o.score=void 0;try{this.ensureNoDeadEnds(o)}catch{}o._reenableProb=this.options.reenableProb,o._id=this._nextGenomeId++,this._lineageEnabled&&(o._parents=[],o._depth=0),this.population.push(o)}}snapshotRNGState(){return this._rngState}restoreRNGState(t){this._rngState=t,this._rng=void 0}importRNGState(t){this._rngState=t,this._rng=void 0}exportRNGState(){return this._rngState}getOffspring(){let t,n;try{t=this.getParent()}catch{t=this.population[0]}try{n=this.getParent()}catch{n=this.population[Math.floor(this._getRNG()()*this.population.length)]||this.population[0]}let s=ct.crossOver(t,n,this.options.equal||!1);if(s._reenableProb=this.options.reenableProb,s._id=this._nextGenomeId++,this._lineageEnabled){s._parents=[t._id,n._id];let o=t._depth??0,i=n._depth??0;s._depth=1+Math.max(o,i),t._id===n._id&&this._lastInbreedingCount++}return this.ensureMinHiddenNodes(s),this.ensureNoDeadEnds(s),s}_warnIfNoBestGenome(){try{console.warn("Evolution completed without finding a valid best genome (no fitness improvements recorded).")}catch{}}spawnFromParent(t,n=1){return Os.call(this,t,n)}addGenome(t,n){return Rs.call(this,t,n)}selectMutationMethod(t,n=!0){try{return Ss.call(this,t,n)}catch{return null}}ensureNoDeadEnds(t){try{return As.call(this,t)}catch{return}}getMinimumHiddenSize(t){let n=this.options;if(typeof n.minHidden=="number")return n.minHidden;let s=t??n.minHiddenMultiplier;return typeof s=="number"&&isFinite(s)?Math.max(0,Math.round(s*(this.input+this.output))):0}sampleRandom(t){let n=this._getRNG(),s=[];for(let o=0;o<t;o++)s.push(n());return s}_getObjectives(){return Ps.call(this)}getObjectiveKeys(){return this._getObjectives().map(t=>t.key)}_invalidateGenomeCaches(t){!t||typeof t!="object"||(delete t._compatCache,delete t._outputCache,delete t._traceCache)}_computeDiversityStats(){this._diversityStats=Hs(this.population,this)}_structuralEntropy(t){return je(t)}mutate(){return ms.call(this)}_mutateAddNodeReuse(t){return ys.call(this,t)}_mutateAddConnReuse(t){return gs.call(this,t)}_fallbackInnov(t){return Bs.call(this,t)}_compatibilityDistance(t,n){return Ws.call(this,t,n)}_speciate(){return Us.call(this)}_applyFitnessSharing(){return zs.call(this)}_sortSpeciesMembers(t){return qs.call(this,t)}_updateSpeciesStagnation(){return Vs.call(this)}getSpeciesStats(){return Xs.call(this)}getSpeciesHistory(){return Js.call(this)}getNoveltyArchiveSize(){return this._noveltyArchive?this._noveltyArchive.length:0}getMultiObjectiveMetrics(){return this.population.map(t=>({rank:t._moRank??0,crowding:t._moCrowd??0,score:t.score||0,nodes:t.nodes.length,connections:t.connections.length}))}getOperatorStats(){return Array.from(this._operatorStats.entries()).map(([t,n])=>({name:t,success:n.success,attempts:n.attempts}))}applyEvolutionPruning(){try{(te(),K(Qt)).applyEvolutionPruning.call(this)}catch{}}applyAdaptivePruning(){try{(te(),K(Qt)).applyAdaptivePruning.call(this)}catch{}}getTelemetry(){return this._telemetry}exportTelemetryJSONL(){return Zs.call(this)}exportTelemetryCSV(t=500){return Qs.call(this,t)}clearTelemetry(){this._telemetry=[]}getObjectives(){return this._getObjectives().map(t=>({key:t.key,direction:t.direction}))}getObjectiveEvents(){return this._objectiveEvents.slice()}getLineageSnapshot(t=20){return this.population.slice(0,t).map(n=>({id:n._id??-1,parents:Array.isArray(n._parents)?n._parents.slice():[]}))}exportSpeciesHistoryCSV(t=200){return ao.call(this,t)}getParetoFronts(t=3){if(!this.options.multiObjective?.enabled)return[[...this.population]];let n=[];for(let s=0;s<t;s++){let o=this.population.filter(i=>(i._moRank??0)===s);if(!o.length)break;n.push(o)}return n}getDiversityStats(){return this._diversityStats}registerObjective(t,n,s){return ks.call(this,t,n,s)}clearObjectives(){return Fs.call(this)}getParetoArchive(t=50){return this._paretoArchive.slice(-t)}exportParetoFrontJSONL(t=100){return this._paretoObjectivesArchive.slice(-t).map(s=>JSON.stringify(s)).join(`
`)}getPerformanceStats(){return{lastEvalMs:this._lastEvalDuration,lastEvolveMs:this._lastEvolveDuration}}exportSpeciesHistoryJSONL(t=200){return this._speciesHistory.slice(-t).map(s=>JSON.stringify(s)).join(`
`)}resetNoveltyArchive(){this._noveltyArchive=[]}clearParetoArchive(){this._paretoArchive=[]}sort(){return co.call(this)}getParent(){return lo.call(this)}getFittest(){return uo.call(this)}getAverage(){return ho.call(this)}export(){return Xe.call(this)}import(t){return Je.call(this,t)}exportState(){return Ke.call(this)}static importState(t,n){return Ze.call(e,t,n)}toJSON(){return Qe.call(this)}static fromJSON(t,n){return tn.call(e,t,n)}}});var ee=class e{static#n=60;static#t=10;static deprecatedTriesKey="tries";static#e(t){return t??(typeof document<"u"?document.getElementById("ascii-maze-output"):null)}static createTerminalClearer(t){let n=this.#e(t);return()=>{n&&(n.innerHTML="")}}static async evolveUntilSolved(t,n=e.#n,s=e.#t){let o=0,i={success:!1,progress:0};for(;o<s;){o++;let{finalResult:a}=await t();if(i=a,a.success||a.progress>=n)return{finalResult:a,attemptCount:o,tries:o}}return{finalResult:i,attemptCount:o,tries:o}}};var z=class e{static#n=new Set(["#","\u2550","\u2551","\u2554","\u2557","\u255A","\u255D","\u2560","\u2563","\u2566","\u2569","\u256C"]);static#t=[[0,-1],[1,0],[0,1],[-1,0]];static#e=new Int32Array(0);static#s(t){if(e.#e.length<t){let n=e.#e.length||1;for(;n<t;)n<<=1;e.#e=new Int32Array(n)}return e.#e}static posKey(t){let[n,s]=t;return`${n},${s}`}static tail(t,n){if(!Array.isArray(t)||n<=0)return[];let s=t.length,o=Math.max(0,s-n),i=s-o,a=new Array(i),r=0;for(let c=o;c<s;c++)a[r++]=t[c];return a}static safeLast(t){if(!(!Array.isArray(t)||t.length===0))return t.at?t.at(-1):t[t.length-1]}static pushHistory(t,n,s){if(!Array.isArray(t))return[n];t.push(n);let o=t.length-s;return o>0&&(o===1?t.shift():t.splice(0,o)),t}static encodeMaze(t){let n=e.#n,s=new Map([[".",0],["E",1],["S",2]]);return t.map((o,i)=>{let a=o.length,r=new Array(a);for(let c=0;c<a;c++){let l=o[c];if(n.has(l)){r[c]=-1;continue}r[c]=s.get(l)??0}return r})}static findPosition(t,n){let s=t.length;for(let o=0;o<s;o++){let i=t[o];if(!i)continue;let a=i.indexOf(n);if(a!==-1)return[a,o]}throw new Error(`Character ${n} not found in maze`)}static bfsDistance(t,n,s){let[o,i]=n,[a,r]=s,c=t.length,l=t[0].length;if(i<0||i>=c||o<0||o>=l||r<0||r>=c||a<0||a>=l||t[i][o]===-1||t[r][a]===-1)return 1/0;if(o===a&&i===r)return 0;let u=c*l,p=new Int8Array(u);for(let N=0,v=0;N<c;N++){let w=t[N];for(let x=0;x<l;x++,v++)p[v]=w[x]===-1?-1:0}let h=new Int32Array(u);for(let N=0;N<u;N++)h[N]=-1;let d=i*l+o,f=r*l+a;h[d]=0;let m=e.#s(u),b=0,g=0;m[g++]=d;let y=-l,A=l;for(;b<g;){let N=m[b++],v=h[N];if(N===f)return v;let w=N/l|0,x=N-w*l;for(let _=0;_<4;_++){let I;switch(_){case 0:if(w===0)continue;I=N+y;break;case 1:if(x+1>=l)continue;I=N+1;break;case 2:if(w+1>=c)continue;I=N+A;break;default:if(x===0)continue;I=N-1}if(p[I]!==-1&&h[I]===-1){let L=v+1;if(h[I]=L,I===f)return L;m[g++]=I}}}return 1/0}static calculateProgress(t,n,s,o){let i=e.bfsDistance(t,s,o);if(i===0)return 100;let a=e.bfsDistance(t,n,o);return Math.min(100,Math.max(0,Math.round((i-a)/i*100)))}static calculateProgressFromDistanceMap(t,n,s){let[o,i]=s,[a,r]=n,c=t[i]?.[o],l=t[r]?.[a];if(c==null||l==null||!isFinite(c)||c<=0)return 0;let u=(c-l)/c*100;return Math.min(100,Math.max(0,Math.round(u)))}static buildDistanceMap(t,n){let{width:s,height:o,distances:i,WALL_VALUE:a,UNREACHABLE_VALUE:r}=e.buildDistanceMapFlat(t,n),c=Array.from({length:o},()=>new Array(s));for(let l=0,u=0;l<o;l++){let p=c[l];for(let h=0;h<s;h++,u++){let d=i[u];p[h]=d===a||d===r?1/0:d}}return c}static buildDistanceMapFlat(t,n){let s=t.length,o=t[0].length,i=-2,a=-1,r=o*s,c=new Int32Array(r);for(let g=0;g<r;g++)c[g]=a;let[l,u]=n;if(u<0||u>=s||l<0||l>=o||t[u][l]===-1){for(let g=0,y=0;g<s;g++){let A=t[g];for(let N=0;N<o;N++,y++)A[N]===-1&&(c[y]=i)}return{width:o,height:s,distances:c,WALL_VALUE:i,UNREACHABLE_VALUE:a}}for(let g=0,y=0;g<s;g++){let A=t[g];for(let N=0;N<o;N++,y++)A[N]===-1&&(c[y]=i)}let p=u*o+l;c[p]=0;let h=new Int32Array(r),d=0,f=0;h[f++]=p;let m=-o,b=o;for(;d<f;){let g=h[d++],y=c[g],A=g/o|0,N=g-A*o;for(let v=0;v<4;v++){let w;switch(v){case 0:if(A===0)continue;w=g+m;break;case 1:if(N+1>=o)continue;w=g+1;break;case 2:if(A+1>=s)continue;w=g+b;break;default:if(N===0)continue;w=g-1}c[w]===a&&(c[w]=y+1,h[f++]=w)}}return{width:o,height:s,distances:c,WALL_VALUE:i,UNREACHABLE_VALUE:a}}};var on=Object.freeze({205:"#ff6ac1",93:"#b48bf2",154:"#a6d189",51:"#00bcd4",226:"#ffd166",214:"#ff9f43",196:"#ff3b30",46:"#00e676",123:"#6ec6ff",177:"#caa6ff",80:"#00bfa5",121:"#9bdc8a",203:"#ff6b9f",99:"#6b62d6",44:"#00a9e0",220:"#ffd54f",250:"#ececec",45:"#00aaff",201:"#ff4fc4",231:"#ffffff",218:"#ffc6d3",217:"#ffcdb5",117:"#6fb3ff",118:"#6ee07a",48:"#00a300",57:"#2f78ff",33:"#1e90ff",87:"#00d7ff",159:"#cfeeff",208:"#ff8a00",197:"#ff5ea6",234:"#0e1114",23:"#123044",17:"#000b16",16:"#000000",39:"#0078ff"}),wo="700",xo=0,_o=1,Mo=22,Io=38,Eo=48,Co=39,To=49,Oo=/[&<>]/,Ro=Object.freeze(["#000000","#800000","#008000","#808000","#000080","#800080","#008080","#c0c0c0"]),Lo=Object.freeze(["#808080","#ff0000","#00ff00","#ffff00","#0000ff","#ff00ff","#00ffff","#ffffff"]);function an(e){return Oo.test(e)?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}function Po(e){let t=e??(typeof document<"u"?document.getElementById("ascii-maze-output"):null);if(!t)return null;let n=t.querySelector("pre");return n||(n=document.createElement("pre"),n.style.fontFamily="monospace",n.style.whiteSpace="pre",n.style.margin="0",n.style.padding="4px",n.style.fontSize="10px",t.appendChild(n)),n}var be=class e{static#n=/\x1b\[([0-9;]*)m/g;static#t="<br/>";static#e=[];static#s=32;static#o=new Map;#i="";#l="";#p=0;#a;#f;#y;#m=!1;#h="";#d=[];constructor(){}static#M(t){let n=this.#e.pop()??new e;return n.#c(t),n}static#w(t){this.#e.length<this.#s&&this.#e.push(t)}static convert(t){let n=this.#M(t);try{return n.#x(),n.#l}finally{this.#w(n)}}#c(t){this.#i=t,this.#l="",this.#p=0,this.#S(),e.#n.lastIndex=0}#x(){let t;for(;(t=e.#n.exec(this.#i))!==null;)this.#A(t.index),this.#g(t[1]),this.#p=e.#n.lastIndex;this.#A(this.#i.length)}#A(t){if(this.#p>=t)return;let n=this.#i.substring(this.#p,t);if(!n)return;if(!n.includes(`
`)){let o=an(n);this.#l+=this.#_(o);return}let s=0;for(let o=0;o<=n.length;o++){let i=o===n.length,a=!i&&n.charCodeAt(o)===10;if(a||i){if(o>s){let r=n.substring(s,o);this.#l+=this.#_(an(r))}a&&(this.#l+=e.#t),s=o+1}}}#g(t){if(t===""){this.#S();return}let n="",s=0;for(let o=0;o<t.length;o++){let i=t[o];i===";"?n&&(this.#d[s++]=parseInt(n,10),n=""):n+=i}n&&(this.#d[s++]=parseInt(n,10)),this.#E(s),this.#P()}#E(t){for(let n=0;n<t;n++){let s=this.#d[n];switch(!0){case s===xo:{this.#S();break}case s===_o:{this.#y=wo,this.#m=!0;break}case s===Mo:{this.#y=void 0,this.#m=!!(this.#a||this.#f||this.#y);break}case(s===Io&&this.#d[n+1]===5):{let o=this.#d[n+2];if(o!=null){let i=on[o];i&&(this.#a=i,this.#m=!0)}n+=2;break}case(s===Eo&&this.#d[n+1]===5):{let o=this.#d[n+2];if(o!=null){let i=on[o];i&&(this.#f=i,this.#m=!0)}n+=2;break}case(s>=30&&s<=37):{this.#a=Ro[s-30],this.#m=!0;break}case(s>=90&&s<=97):{this.#a=Lo[s-90],this.#m=!0;break}case s===Co:{this.#a=void 0,this.#m=!!(this.#f||this.#y);break}case s===To:{this.#f=void 0,this.#m=!!(this.#a||this.#y);break}default:}}}#S(){this.#a=this.#f=this.#y=void 0,this.#m=!1,this.#h=""}#P(){if(!this.#m){this.#h="";return}let t=this.#a??"",n=this.#f??"",s=this.#y??"",o=`${t}|${n}|${s}`,i=e.#o.get(o);if(i){this.#h=i;return}let a=[];t&&a.push(`color: ${t}`),n&&a.push(`background: ${n}`),s&&a.push(`font-weight: ${s}`);let r=a.length?`<span style="${a.join(";")}">`:"";e.#o.set(o,r),this.#h=r}#_(t){return this.#h?`${this.#h}${t}</span>`:t}static formatWithNewlines(t){return this.convert(t)}};function Ae(e){return(...t)=>{let n=Po(e),s;if(t.length){let a=z.safeLast(t);a&&typeof a=="object"&&"prepend"in a&&(s=a,t.pop())}let o="";for(let a=0;a<t.length;a++){a&&(o+=" ");let r=t[a];o+=typeof r=="string"?r:JSON.stringify(r)}if(!n)return;let i=be.formatWithNewlines(o)+"<br/>";s&&s.prepend?(n.insertAdjacentHTML("afterbegin",i),n.scrollTop=0):(n.insertAdjacentHTML("beforeend",i),n.scrollTop=n.scrollHeight)}}var S={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",neonPink:"\x1B[38;5;205m",neonPurple:"\x1B[38;5;93m",neonLime:"\x1B[38;5;154m",neonAqua:"\x1B[38;5;51m",neonYellow:"\x1B[38;5;226m",neonOrange:"\x1B[38;5;214m",neonRed:"\x1B[38;5;196m",neonGreen:"\x1B[38;5;46m",neonSky:"\x1B[38;5;123m",neonViolet:"\x1B[38;5;177m",neonTurquoise:"\x1B[38;5;80m",neonMint:"\x1B[38;5;121m",neonCoral:"\x1B[38;5;203m",neonIndigo:"\x1B[38;5;99m",neonTeal:"\x1B[38;5;44m",neonGold:"\x1B[38;5;220m",neonSilver:"\x1B[38;5;250m",neonBlue:"\x1B[38;5;45m",neonMagenta:"\x1B[38;5;201m",neonCyan:"\x1B[38;5;87m",neonWhite:"\x1B[38;5;231m",neonRose:"\x1B[38;5;218m",neonPeach:"\x1B[38;5;217m",neonAzure:"\x1B[38;5;117m",neonChartreuse:"\x1B[38;5;118m",neonSpring:"\x1B[38;5;48m",neonAmber:"\x1B[38;5;214m",neonFuchsia:"\x1B[38;5;207m",blueCore:"\x1B[38;5;39m",cyanNeon:"\x1B[38;5;87m",blueNeon:"\x1B[38;5;45m",whiteNeon:"\x1B[38;5;159m",orangeNeon:"\x1B[38;5;208m",magentaNeon:"\x1B[38;5;201m",red:"\x1B[38;5;197m",green:"\x1B[38;5;118m",yellow:"\x1B[38;5;220m",blue:"\x1B[38;5;33m",cyan:"\x1B[38;5;51m",bgNeonPink:"\x1B[48;5;205m",bgNeonPurple:"\x1B[48;5;93m",bgNeonLime:"\x1B[48;5;154m",bgNeonAqua:"\x1B[48;5;51m",bgNeonYellow:"\x1B[48;5;226m",bgNeonOrange:"\x1B[48;5;214m",bgNeonRed:"\x1B[48;5;196m",bgNeonGreen:"\x1B[48;5;46m",bgNeonSky:"\x1B[48;5;123m",bgNeonViolet:"\x1B[48;5;177m",bgNeonTurquoise:"\x1B[48;5;80m",bgNeonMint:"\x1B[48;5;121m",bgNeonCoral:"\x1B[48;5;203m",bgNeonIndigo:"\x1B[48;5;99m",bgNeonTeal:"\x1B[48;5;44m",bgNeonGold:"\x1B[48;5;220m",bgNeonSilver:"\x1B[48;5;250m",bgNeonBlue:"\x1B[48;5;45m",bgNeonMagenta:"\x1B[48;5;201m",bgNeonCyan:"\x1B[48;5;87m",bgNeonWhite:"\x1B[48;5;231m",bgNeonRose:"\x1B[48;5;218m",bgNeonPeach:"\x1B[48;5;217m",bgNeonAzure:"\x1B[48;5;117m",bgNeonChartreuse:"\x1B[48;5;118m",bgNeonSpring:"\x1B[48;5;48m",bgNeonAmber:"\x1B[48;5;214m",bgNeonFuchsia:"\x1B[48;5;207m",bgBlueCore:"\x1B[48;5;39m",bgCyanNeon:"\x1B[48;5;87m",bgBlueNeon:"\x1B[48;5;45m",bgWhiteNeon:"\x1B[48;5;159m",bgOrangeNeon:"\x1B[48;5;208m",bgMagentaNeon:"\x1B[48;5;201m",bgRed:"\x1B[48;5;197m",bgGreen:"\x1B[48;5;118m",bgYellow:"\x1B[48;5;220m",bgBlue:"\x1B[48;5;33m",darkWallBg:"\x1B[48;5;17m",darkWallText:"\x1B[38;5;17m",floorBg:"\x1B[48;5;234m",floorText:"\x1B[38;5;234m",gridLineBg:"\x1B[48;5;23m",gridLineText:"\x1B[38;5;23m",bgBlack:"\x1B[48;5;16m",pureBlue:"\x1B[38;5;57;1m",pureOrange:"\x1B[38;5;214;1m",pureGreen:"\x1B[38;5;46;1m"};var U=class e{static#n="  \u2500\u2500\u25B6  ";static#t=e.#n.length;static#e=150;static#s=[{min:2,max:1/0,label:"v-high+"},{min:1,max:2,label:"high+"},{min:.5,max:1,label:"mid+"},{min:.1,max:.5,label:"low+"},{min:-.1,max:.1,label:"zero\xB1"},{min:-.5,max:-.1,label:"low-"},{min:-1,max:-.5,label:"mid-"},{min:-2,max:-1,label:"high-"},{min:-1/0,max:-2,label:"v-high-"}];static#o=new Int32Array(16);static#i=0;static#l=[];static#p=[];static pad(t,n,s=" ",o="center"){t=t??"";let i=t.replace(/\x1b\[[0-9;]*m/g,"").length;if(i>=n)return t;let a=n-i;if(o==="left")return t+s.repeat(a);if(o==="right")return s.repeat(a)+t;let r=Math.floor(a/2),c=a-r;return s.repeat(r)+t+s.repeat(c)}static#a(t){return typeof t.activation=="number"&&isFinite(t.activation)&&!isNaN(t.activation)?t.type==="output"?Math.max(0,Math.min(1,t.activation)):Math.max(-999,Math.min(999,t.activation)):0}static#f(t){return t>=2?S.bgOrangeNeon+S.bright:t>=1?S.orangeNeon:t>=.5?S.cyanNeon:t>=.1?S.neonGreen:t>=-.1?S.whiteNeon:t>=-.5?S.blue:t>=-1?S.blueCore:t>=-2?S.bgNeonAqua+S.bright:S.bgNeonViolet+S.neonSilver}static#y(t){if(typeof t!="number"||isNaN(t)||!isFinite(t))return" 0.000";let n=this.#f(t),s;return s=(t>=0?" ":"")+t.toFixed(6),n+s+S.reset}static#m(t,n,s,o){let i=e.#a(s),a=e.#y(i);return`${`${t}${n}${S.reset}`}${a}${o??""}`}static#h(t,n,s){if(n.length===0)return[];let o=[],i=t,a=[...n];for(;a.length>0;){let r=a.filter(c=>c.connections&&c.connections.in&&c.connections.in.length>0&&c.connections.in.every(l=>i.includes(l.from)));if(r.length===0){o.push(a);break}o.push(r),i=r,a=a.filter(c=>!r.includes(c))}return o}static#d(t){let n=t.map(i=>e.#a(i)),s=[],o=[];for(let i of e.#s){let a=t.filter((r,c)=>n[c]>=i.min&&n[c]<i.max);a.length>0&&(s.push(a),o.push(i.label))}return{groups:s,labels:o}}static#M(t,n=10){let s=n,o={},i=[],a=[];return t.forEach((r,c)=>{if(r.length<=s)i.push([...r]),a.push(r.length);else{let{avgNodes:l,count:u}=e.#w({layer:r,layerIndex:c,maxVisible:s,averageNodesStore:o});i.push(l),a.push(u)}}),{displayLayers:i,layerDisplayCounts:a,averageNodes:o}}static#w(t){let{layer:n,layerIndex:s,maxVisible:o,averageNodesStore:i}=t,{groups:a,labels:r}=e.#d(n),{finalGroups:c,finalLabels:l}=a.length>o?e.#x({groups:a,labels:r,maxVisible:o}):{finalGroups:a,finalLabels:r},u=c.map((p,h)=>e.#c({group:p,groupIndex:h,layerIndex:s,label:l[h],averageNodesStore:i}));return{avgNodes:u,count:u.length}}static#c(t){let{group:n,groupIndex:s,layerIndex:o,label:i,averageNodesStore:a}=t,r=`layer${o}-avg-${s}`,c=n.reduce((u,p)=>u+e.#a(p),0),l=n.length?c/n.length:0;return a[r]={avgValue:l,count:n.length},{id:-1*(o*1e3+s),uuid:r,type:"hidden",activation:l,isAverage:!0,avgCount:n.length,label:i}}static#x(t){let{groups:n,labels:s,maxVisible:o}=t,i=n.map((p,h)=>({group:p,label:s[h],size:p.length})),a=e.#g(i,(p,h)=>h.size-p.size),r=Math.max(0,o-1),c=a.slice(0,r),l=a.slice(r);l.length&&c.push(e.#A(l));let u=e.#g(c,e.#E);return{finalGroups:u.map(p=>p.group),finalLabels:u.map(p=>p.label)}}static#A(t){return t.reduce((n,s)=>(n.group.push(...s.group),n.size+=s.size,n),{group:[],label:"other\xB1",size:0})}static#g(t,n){let s=t;return typeof s.toSorted=="function"?s.toSorted(n):[...t].sort(n)}static#E(t,n){let s=t.label.includes("-"),o=n.label.includes("-");if(s!==o)return s?1:-1;let i=t.label.startsWith("v-high"),a=n.label.startsWith("v-high");if(i!==a)return i?-1:1;let r=t.label.includes("high"),c=n.label.includes("high");return r!==c?r?-1:1:0}static#S(t,n){let s=typeof t.index=="number"?t.index:n;return{id:s,uuid:String(s),type:t.type,activation:t.activation,bias:t.bias}}static#P(t){let n=[],s=[],o=[],i=t.nodes||[];for(let a=0;a<i.length;a++){let r=i[a],c=e.#S(r,a);switch(r.type){case"input":case"constant":n.push(c);break;case"hidden":s.push(c);break;case"output":o.push(c);break;default:break}}return{inputNodes:n,hiddenNodes:s,outputNodes:o,inputCountDetected:n.length}}static#_(t){if(e.#o.length<t){let n=e.#o.length;for(;n<t;)n*=2;e.#o=new Int32Array(n)}return e.#o}static#rt(t,n,s,o){let i=s.length,a=i>0?i+1:1,r=e.#_(a);r.fill(0,0,a),e.#i=a;let c=new Set(n.map(h=>Number(h.id))),l=new Set(o.map(h=>Number(h.id))),u=s.map(h=>new Set(h.map(d=>Number(d.id)))),p=t.connections??[];for(let h=0;h<p.length;h++){let d=p[h],f=Number(d.from?.index??-1),m=Number(d.to?.index??-1),b="other",g=-1;if(c.has(f))b="input";else for(let y=0;y<u.length;y++)if(u[y].has(f)){b="hidden",g=y;break}switch(b){case"input":{(u[0]&&u[0].has(m)||u.length===0&&l.has(m))&&r[0]++;break}case"hidden":{g===u.length-1?l.has(m)&&r[u.length]++:u[g+1].has(m)&&r[1+g]++;break}default:break}}return r}static#K(t,n,s,o){let i=n.length,{columnWidth:a}=e.#$(i),r=e.#p;r.length=0;let c=o??e.#_(1);switch(r.push(e.#k({prefix:`${S.blueCore}\u2551`,label:`${S.neonGreen}Input Layer [${t}]${S.reset}`,width:a-1})),r.push(e.#C(c[0]??0)),i){case 0:break;default:for(let[l,u]of n.entries())r.push(e.pad(`${S.cyanNeon}Hidden ${l+1} [${u.length}]${S.reset}`,a)),r.push(e.#C(c[l+1]??0));break}return r.push(e.pad(`${S.orangeNeon}Output Layer [${s}]${S.reset}`,a," ","center")+`${S.blueCore}\u2551${S.reset}`),r.join("")}static#k(t){let{prefix:n="",label:s,width:o}=t;return n+e.pad(s,o," ","center")}static#C(t){let n=`${S.blueNeon}${t} ${e.#n.trim()}${S.reset}`;return e.pad(n,e.#t)}static#Z(){return[`${S.blueCore}\u2551       ${e.pad(" ",140)} \u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad("Arrows indicate feed-forward flow.",140," ","left")} ${S.blueCore}\u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad(" ",140)} \u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad(`${S.whiteNeon}Legend:  ${S.neonGreen}\u25CF${S.reset}=Input                    ${S.cyanNeon}\u25A0${S.reset}=Hidden                    ${S.orangeNeon}\u25B2${S.reset}=Output`,140," ","left")} ${S.blueCore}\u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad(`${S.whiteNeon}Groups:  ${S.bgOrangeNeon}${S.bright}v-high+${S.reset}=Very high positive   ${S.orangeNeon}high+${S.reset}=High positive    ${S.cyanNeon}mid+${S.reset}=Medium positive    ${S.neonGreen}low+${S.reset}=Low positive`,140," ","left")} ${S.blueCore}\u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad(`${S.whiteNeon}         zero\xB1${S.reset}=Near zero`,140," ","left")} ${S.blueCore}\u2551${S.reset}`,`${S.blueCore}\u2551       ${e.pad(`         ${S.bgBlueCore}${S.bright}v-high-${S.reset}=Very high negative   ${S.blueNeon}${S.bright}high-${S.reset}=High negative    ${S.blueCore}mid-${S.reset}=Medium negative    ${S.blue}low-${S.reset}=Low negative`,140," ","left")} ${S.blueCore}\u2551${S.reset}`]}static#Q(t,n){let s=e.#ct(t),{maxRows:o,rows:i,inputDisplayNodes:a,outputDisplayNodes:r,numHiddenLayers:c,inputCount:l,outputCount:u,inputNodes:p,displayLayers:h,connectionCounts:d}=s;for(let f=0;f<o;f++){let m="";m+=e.#F({rowIndex:f,inputCount:l,columnWidth:n,inputDisplayNodes:a}),m+=e.#lt({rowIndex:f,inputCount:l,inputNodes:p,displayLayers:h,connectionCounts:d});for(let b=0;b<c;b++)m+=e.#ut({rowIndex:f,layerIndex:b,columnWidth:n,displayLayers:h}),m+=e.#D({rowIndex:f,layerIndex:b,numHiddenLayers:c,displayLayers:h,connectionCounts:d,outputCount:u});m+=e.#ht({rowIndex:f,outputCount:u,outputDisplayNodes:r,columnWidth:n}),i.push(m)}return i.slice()}static#ct(t){let{inputCount:n,outputCount:s,inputNodes:o,displayLayers:i,layerDisplayCounts:a,outputNodes:r,connectionCounts:c}=t,l=Math.max(n,...a,s),u=e.#l;u.length=0;let p=Array.from({length:n},(d,f)=>o[f]||{activation:0}),h=Array.from({length:s},(d,f)=>r[f]||{activation:0});return{maxRows:l,rows:u,inputDisplayNodes:p,outputDisplayNodes:h,numHiddenLayers:i.length,inputCount:n,outputCount:s,inputNodes:o,displayLayers:i,connectionCounts:c}}static#F(t){let{rowIndex:n,inputCount:s,columnWidth:o,inputDisplayNodes:i}=t;if(n>=s)return e.pad("",o);let a=["compass","openN","openE","openS","openW","progress"],r=i[n],c=n<6?a[n]:"",l=c?` ${S.whiteNeon}${c}${S.reset}`:"";return e.pad(`${S.blueCore}\u2551   ${e.#m(S.neonGreen,"\u25CF",r,l)}`,o," ","left")}static#lt(t){let{rowIndex:n,inputCount:s,inputNodes:o,displayLayers:i,connectionCounts:a}=t,r=i[0]?.length||0,c=Math.min(s,o.length),l=`${S.blueNeon}${e.#n}${S.reset}`;if(n===0&&c&&r){let u=Math.ceil((a[0]||0)/Math.max(1,c));return e.pad(`${S.blueNeon}${u} \u2500\u2500\u25B6${S.reset}`,e.#t)}if(n<s&&n<r&&c&&r){let u=Math.ceil((a[0]||0)/Math.max(3,c*2));return e.pad(`${S.blueNeon}${u} \u2500\u2500\u25B6${S.reset}`,e.#t)}return e.pad(l,e.#t)}static#ut(t){let{rowIndex:n,layerIndex:s,columnWidth:o,displayLayers:i}=t,a=i[s];if(n>=a.length)return e.pad(" ",o);let r=a[n];if(r.isAverage){let c=r.label?`${r.label} `:"",l=` ${S.dim}(${c}avg of ${r.avgCount})${S.reset}`;return e.pad(e.#m(S.cyanNeon,"\u25A0",r,l),o," ","left")}return e.pad(e.#m(S.cyanNeon,"\u25A0",r),o," ","left")}static#D(t){let{rowIndex:n,layerIndex:s,numHiddenLayers:o,displayLayers:i,connectionCounts:a,outputCount:r}=t,c=i[s],l=i[s+1],u=`${S.blueNeon}${e.#n}${S.reset}`,p=s===o-1,h=a??e.#_(o+1),d=f=>e.pad(`${S.blueNeon}${f} \u2500\u2500\u25B6${S.reset}`,e.#t);switch(p){case!1:{let f=h[s+1]??0;if(n===0){let m=c.length||1,b=Math.ceil(f/Math.max(3,m*2));return d(b)}if(n<c.length&&n<(l?.length??0)){let m=c.length||1,b=Math.max(1,Math.min(5,Math.ceil(f/Math.max(3,m))));return d(b)}return e.pad(u,e.#t)}case!0:{let f=h[o]??0;if(n===0){let m=c.length||1,b=Math.ceil(f/Math.max(3,m*2));return d(b)}if(n<c.length&&n<r){let m=c.length||1,b=Math.max(1,Math.min(5,Math.ceil(f/Math.max(5,m*2))));return d(b)}return e.pad(u,e.#t)}}}static#ht(t){let{rowIndex:n,outputCount:s,outputDisplayNodes:o,columnWidth:i}=t;if(n>=s)return e.pad("",i);let a=o[n];return e.pad(e.#m(S.orangeNeon,"\u25B2",a),i," ","left")+`${S.blueCore}\u2551${S.reset}`}static visualizeNetworkSummary(t){let n=e.#P(t),s=n.inputCountDetected||18,o=4,i=e.#h(n.inputNodes,n.hiddenNodes,n.outputNodes),a=e.#M(i),r=e.#rt(t,n.inputNodes,i,n.outputNodes),{columnWidth:c}=e.#$(i.length),l=e.#K(s,i,o,r),u=e.#Q({inputCount:s,outputCount:o,inputNodes:n.inputNodes,displayLayers:a.displayLayers,layerDisplayCounts:a.layerDisplayCounts,outputNodes:n.outputNodes,connectionCounts:r},c),p=e.#Z();return[l,...u,...p].join(`
`)}static#$(t){let n=2+t,s=n-1,o=e.#e-s*e.#t;return{columnWidth:Math.floor(o/n)}}};var Ct=class e{static#n=new Set(["#","\u2550","\u2551","\u2554","\u2557","\u255A","\u255D","\u2560","\u2563","\u2566","\u2569","\u256C"]);static get WALL_CHARS(){return e.#n}static#t(t){return z.safeLast(t)}static#e([t,n]){return`${t},${n}`}static#s=new Int8Array(0);static#o(t){if(e.#s.length<t){let n=e.#s.length||1;for(;n<t;)n<<=1;e.#s=new Int8Array(n)}return e.#s}static renderCell(t,n,s,o,i,a){let r=e.WALL_CHARS;return n===o&&s===i?t==="S"?`${S.bgBlack}${S.orangeNeon}S${S.reset}`:t==="E"?`${S.bgBlack}${S.orangeNeon}E${S.reset}`:`${S.bgBlack}${S.orangeNeon}A${S.reset}`:t==="S"?`${S.bgBlack}${S.orangeNeon}S${S.reset}`:t==="E"?`${S.bgBlack}${S.orangeNeon}E${S.reset}`:t==="."?a&&a.has(`${n},${s}`)?`${S.floorBg}${S.orangeNeon}\u2022${S.reset}`:`${S.floorBg}${S.gridLineText}.${S.reset}`:r.has(t)?`${S.bgBlack}${S.blueNeon}${t}${S.reset}`:t}static visualizeMaze(t,[n,s],o){let i;if(o){i=new Set;for(let a of o)i.add(e.#e(a))}return t.map((a,r)=>[...a].map((c,l)=>this.renderCell(c,l,r,n,s,i)).join("")).join(`
`)}static printMazeStats(t,n,s){let{result:o,generation:i}=t,a=o.success?S.cyanNeon:S.neonRed,r=z.findPosition(n,"S"),c=z.findPosition(n,"E"),l=z.bfsDistance(z.encodeMaze(n),r,c),u=148,p=7,h=1,d=u-p-h;if(s(`${S.blueCore}\u2551${U.pad(" ",u," ")}${S.blueCore}\u2551${S.reset}`),s(`${S.blueCore}\u2551${U.pad(" ",u," ")}${S.blueCore}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Success:${S.neonIndigo} ${a}${o.success?"YES":"NO"}`,d," ","left")}${" ".repeat(h)}${S.blueCore}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Generation:${S.neonIndigo} ${a}${i}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Fitness:${S.neonOrange} ${o.fitness.toFixed(2)}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Steps taken:${S.neonIndigo} ${o.steps}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Path length:${S.neonIndigo} ${o.path.length}${S.blueCore}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Optimal distance to exit:${S.neonYellow} ${l}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${U.pad(" ",u," ")}${S.blueCore}\u2551${S.reset}`),o.success){let f=o.path.length-1,m=Math.min(100,Math.round(l/f*100)).toFixed(1),b=(f/l*100-100).toFixed(1),g=new Set,y=0,A=0,N=null;for(let F=0;F<o.path.length;F++){let[M,T]=o.path[F],D=`${M},${T}`;if(g.has(D)?y++:g.add(D),F>0){let[E,R]=o.path[F-1],O=M-E,P=T-R,C="";switch(!0){case O>0:C="E";break;case O<0:C="W";break;case P>0:C="S";break;case P<0:C="N";break;default:C=""}N!==null&&C!==N&&A++,N=C}}let v=n[0].length,w=n.length,x=z.encodeMaze(n),_=v*w,I=e.#o(_),L=0;for(let F=0;F<w;F++){let M=x[F];for(let T=0;T<v;T++,L++)I[L]=M[T]===-1?0:1}let $=0;for(let F=0;F<_;F++)$+=I[F];let k=(g.size/$*100).toFixed(1);s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Path efficiency:      ${S.neonIndigo} ${l}/${f} (${m}%)`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Optimal steps:        ${S.neonIndigo} ${l}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Path overhead:        ${S.neonIndigo} ${b}% longer than optimal`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Direction changes:    ${S.neonIndigo} ${A}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Unique cells visited: ${S.neonIndigo} ${g.size} (${k}% of maze)`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Cells revisited:      ${S.neonIndigo} ${y} times`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Decisions per cell:   ${S.neonIndigo} ${(A/g.size).toFixed(2)}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonOrange}Agent successfully navigated the maze!`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`)}else{let f=e.#t(o.path)??r,m=z.calculateProgress(z.encodeMaze(n),f,r,c),b=new Set;for(let[g,y]of o.path)b.add(`${g},${y}`);s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Best progress toward exit:      ${S.neonIndigo} ${m}%`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Shortest possible steps:        ${S.neonIndigo} ${l}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Unique cells visited:           ${S.neonIndigo} ${b.size}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`),s(`${S.blueCore}\u2551${" ".repeat(p)}${U.pad(`${S.neonSilver}Agent trying to reach the exit. ${S.neonIndigo}`,d," ","left")}${" ".repeat(h)}\u2551${S.reset}`)}}static displayProgressBar(t,n=60){let s=Math.max(0,Math.min(100,Math.round(t))),o=Math.max(0,Math.min(n,Math.floor(n*s/100))),i=`${S.blueCore}|>|`,a=`${S.blueCore}|<|`,r=`${S.neonOrange}\u2550`,c=`${S.neonIndigo}:`,l=`${S.neonOrange}\u25B6`,u="";u+=i,o>0&&(o>1&&(u+=r.repeat(o-1)),u+=l);let p=n-o;p>0&&(u+=c.repeat(p)),u+=a;let h=S.cyanNeon;switch(!0){case s<30:h=S.neonYellow;break;case s<70:h=S.orangeNeon;break;default:h=S.cyanNeon}return`${h}${u}${S.reset} ${s}%`}static(t){if(t<60)return`${t.toFixed(1)}s`;if(t<3600){let o=Math.floor(t/60),i=t%60;return`${o}m ${i.toFixed(0)}s`}let n=Math.floor(t/3600),s=Math.floor(t%3600/60);return`${n}h ${s}m`}};var ne=class e{#n=[];#t=new Set;#e=null;#s=null;#o=null;#i=[];#l=[];#p=[];#a=[];#f=[];#y=[];#m=null;#h=null;#d=null;#M=null;#w=null;#c;#x;#A;static#g=500;static#E=148;static#S=7;static#P=1;static#_=28;static#rt=64;static#K=64;static#k=22;static#C=200;static#Z=Object.freeze(["\u2581","\u2582","\u2583","\u2584","\u2585","\u2586","\u2587","\u2588"]);static#Q=1e-9;static#ct=6;static#F=8;static#lt=5;static#ut=4;static#D="Path efficiency";static#ht="Path overhead";static#$="Unique cells visited";static#pt="Cells revisited";static#V="Steps";static#Y="Fitness";static#tt="Architecture";static#X="\u2550";static#Tt="\u2566\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2566";static#Ot="\u2569\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2569";static#b="\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550";static get FRAME_INNER_WIDTH(){return e.#E}static get LEFT_PADDING(){return e.#S}static get RIGHT_PADDING(){return e.#P}static get CONTENT_WIDTH(){return e.#E-e.#S-e.#P}static get STAT_LABEL_WIDTH(){return e.#_}static get HISTORY_MAX(){return e.#g}constructor(t,n,s){let o=()=>{};this.#x=typeof t=="function"?t:o,this.#c=typeof n=="function"?n:o,this.#A=typeof s=="function"?s:void 0}#r(){this.#c(`${S.blueCore}\u2551${U.pad(" ",e.FRAME_INNER_WIDTH," ")}${S.blueCore}\u2551${S.reset}`)}#O(t,n,s=S.neonSilver,o=S.cyanNeon,i=e.#_){let r=(t.endsWith(":")?t:`${t}:`).padEnd(i," "),c=typeof n=="number"?`${n}`:String(n),l=`${s}${r}${o} ${c}${S.reset}`,u=" ".repeat(e.LEFT_PADDING);return`${S.blueCore}\u2551${u}${U.pad(l,e.CONTENT_WIDTH," ","left")}${" ".repeat(e.RIGHT_PADDING)}${S.blueCore}\u2551${S.reset}`}#N(t,n=32){if(!Array.isArray(t)||!t.length||n<=0)return"";let s=z.tail(t,n),o=s.length;if(!o)return"";let i=0;for(let h=0;h<o;h++){let d=s[h];Number.isFinite(d)&&(s[i++]=d)}if(i===0)return"";let a=1/0,r=-1/0;for(let h=0;h<i;h++){let d=s[h];d<a&&(a=d),d>r&&(r=d)}let c=r-a;Math.abs(c)<e.#Q&&(c=e.#Q);let l=e.#Z,u=l.length-1,p="";for(let h=0;h<i;h++){let d=(s[h]-a)/c,f=Math.min(u,Math.max(0,Math.floor(d*u)));p+=l[f]}return p}#R(t){return t.join("")}#dt(t,n){if(!this.#A)return;let s=[];this.#B(s,t,n),this.#H(s,t.network),this.#ft(s,t),this.#Nt(s,t),this.#Lt(s)}redraw(t,n){this.#w=globalThis.performance?.now?.()??Date.now(),this.#Rt(),this.#e&&this.#Pt(t),this.#L(n),this.#r()}#et={scores:[],speciesSizes:[],operatorStats:[],mutationEntries:[]};#Rt(){this.#x(),this.#xt()}#L(t){let n=this.#s;if(!(!n&&!this.#e))try{let s=n?.complexity,o=n?.perf,i=n?.lineage,a=n?.diversity,r=Array.isArray(n?.fronts)?n.fronts:null,c=n?.objectives,l=n?.hyper,u=n?.mutationStats||n?.mutation?.stats,p=this.#e?.result?.fitness,h=this.#e?.result?.saturationFraction,d=this.#e?.result?.actionEntropy,f=this.#nt(t);f.mean==null&&typeof p=="number"&&(f.mean=+p.toFixed(2)),f.median==null&&typeof p=="number"&&(f.median=+p.toFixed(2)),f.speciesCount==null&&typeof n?.species=="number"&&(f.speciesCount=n.species);let m=e.#K,b={fitness:this.#N(this.#i,m)||null,nodes:this.#N(this.#l,m)||null,conns:this.#N(this.#p,m)||null,hyper:this.#N(this.#a,m)||null,progress:this.#N(this.#f,m)||null,species:this.#N(this.#y,m)||null},g=r?.[0]?.length||0,y=r?r.map(_=>_?.length||0):null,A=this.#St(()=>t?.getNoveltyArchiveSize?t.getNoveltyArchiveSize():null,null),N=this.#At(t),v=this.#st(u),w=this.#v(t),x=(()=>{if(typeof p!="number")return null;let _=this.#i.at(-2)??null;return _==null?null:+(p-_).toFixed(3)})();this.#m={generation:this.#e?.generation||0,bestFitness:typeof p=="number"?p:null,bestFitnessDelta:x,saturationFraction:typeof h=="number"?h:null,actionEntropy:typeof d=="number"?d:null,populationMean:f.mean,populationMedian:f.median,enabledConnRatio:f.enabledRatio,complexity:s||null,simplifyPhaseActive:!!(s&&(s.growthNodes<0||s.growthConns<0)),perf:o||null,lineage:i||null,diversity:a||null,speciesCount:f.speciesCount,topSpeciesSizes:w,objectives:c||null,paretoFrontSizes:y,firstFrontSize:g,hypervolume:typeof l=="number"?l:null,noveltyArchiveSize:A,operatorAcceptance:N,topMutations:v,mutationStats:u||null,trends:b,histories:{bestFitness:this.#W(this.#i),nodes:this.#W(this.#l),conns:this.#W(this.#p),hyper:this.#W(this.#a),progress:this.#W(this.#f),species:this.#W(this.#y)},timestamp:Date.now()}}catch{}}#nt(t){if(!t||!Array.isArray(t.population)||t.population.length===0)return{mean:null,median:null,speciesCount:null,enabledRatio:null};let{scores:n}=this.#et;n.length=0;let s=0,o=0;for(let l of t.population){typeof l?.score=="number"&&n.push(l.score);let u=l?.connections;if(Array.isArray(u))for(let p of u)o++,p?.enabled!==!1&&s++}let i=null,a=null;if(n.length){let l=0;for(let d=0;d<n.length;d++)l+=n[d];i=+(l/n.length).toFixed(2);let u=[...n].sort((d,f)=>d-f),p=Math.floor(u.length/2);a=+(u.length%2===0?(u[p-1]+u[p])/2:u[p]).toFixed(2)}let r=o?+(s/o).toFixed(2):null,c=Array.isArray(t.species)?t.species.length:null;return{mean:i,median:a,speciesCount:c,enabledRatio:r}}#At(t){if(typeof t?.getOperatorStats!="function")return null;let n;try{n=t.getOperatorStats()}catch{return null}if(!Array.isArray(n)||n.length===0)return null;let s=this.#et.operatorStats;s.length=0;for(let r of n)r&&typeof r.name=="string"&&typeof r.success=="number"&&typeof r.attempts=="number"&&s.push(r);if(!s.length)return null;let o=[...s].sort((r,c)=>{let l=r.success/Math.max(1,r.attempts),u=c.success/Math.max(1,c.attempts);return u!==l?u-l:0}),i=Math.min(e.#ct,o.length),a=[];for(let r=0;r<i;r++){let c=o[r],l=+(100*c.success/Math.max(1,c.attempts)).toFixed(2);a.push({name:c.name,acceptancePct:l})}return a.length?a:null}#st(t){if(!t||typeof t!="object")return null;let n=this.#et.mutationEntries;n.length=0;for(let i of Object.keys(t)){let a=t[i];typeof a=="number"&&Number.isFinite(a)&&n.push([i,a])}if(!n.length)return null;n.sort((i,a)=>a[1]-i[1]);let s=Math.min(e.#F,n.length),o=[];for(let i=0;i<s;i++){let[a,r]=n[i];o.push({name:a,count:r})}return o}#v(t){if(!Array.isArray(t?.species)||t.species.length===0)return null;let n=this.#et.speciesSizes;n.length=0;for(let i of t.species){let a=Array.isArray(i?.members)?i.members.length:0;n.push(a)}if(!n.length)return null;n.sort((i,a)=>a-i);let s=Math.min(e.#lt,n.length),o=[];for(let i=0;i<s;i++)o.push(n[i]);return o}#St(t,n){try{return t()}catch{return n}}#B(t,n,s){let o=e.FRAME_INNER_WIDTH;t.push(`${S.blueCore}\u2554${U.pad("\u2550".repeat(o),o,"\u2550")}\u2557${S.reset}`);let{result:i,generation:a}=n,r=i?.fitness,c=typeof r=="number"&&Number.isFinite(r)?r.toFixed(2):"n/a",l=` SOLVED #${Math.max(1,s)} (GEN ${a})  FITNESS ${c} `,u=Math.max(0,Math.floor((o-l.length)/2)),p=Math.max(0,o-l.length-u);t.push(`${S.blueCore}\u2551${" ".repeat(u)}${S.orangeNeon}${l}${S.blueCore}${" ".repeat(p)}\u2551${S.reset}`),t.push(`${S.blueCore}\u2551${U.pad(" ",o," ")}\u2551${S.reset}`)}#H(t,n){let s=e.#k,o=(r,c)=>this.#O(r,c,S.neonSilver,S.cyanNeon,s),i=(r,c)=>{c&&t.push(o(r,c))};if(n){let r="n/a";try{r=this.#T(n)}catch{r="n/a"}if(r!=="n/a"){let c=r.split(/\s*-\s*/).join(" <=> ");i(e.#tt,c)}}let a=e.#rt;i("Fitness trend",this.#N(this.#i,a)),i("Nodes trend",this.#N(this.#l,a)),i("Conns trend",this.#N(this.#p,a)),i("Hypervol trend",this.#N(this.#a,a)),i("Progress trend",this.#N(this.#f,a)),i("Species trend",this.#N(this.#y,a)),t.push(`${S.blueCore}\u2551${U.pad(" ",e.FRAME_INNER_WIDTH," ")}${S.blueCore}\u2551${S.reset}`)}#ft(t,n){let s=n.result.path,o=s?.at(-1)??[0,0],i=Ct.visualizeMaze(n.maze,o,s??[]),a=Array.isArray(i)?i:i.split(`
`),r=e.FRAME_INNER_WIDTH;for(let c of a){let l=U.pad(c,r," ");t.push(`${S.blueCore}\u2551${U.pad(l,r," ")}${S.blueCore}\u2551${S.reset}`)}}#Nt(t,n){let s=this.#vt(n.maze,n.result),o=e.#k,i=(a,r)=>this.#O(a,r,S.neonSilver,S.cyanNeon,o);t.push(i(e.#D,`${s.optimalLength}/${s.pathLength} (${s.efficiencyPct}%)`)),t.push(i(e.#ht,`${s.overheadPct}% longer than optimal`)),t.push(i(e.#$,`${s.uniqueCellsVisited}`)),t.push(i(e.#pt,`${s.revisitedCells} times`)),t.push(i(e.#V,`${s.totalSteps}`)),t.push(i(e.#Y,`${s.fitnessValue.toFixed(2)}`))}static#mt=null;#Lt(t){let n=e.FRAME_INNER_WIDTH;e.#mt===null&&(e.#mt=`${S.blueCore}\u255A${U.pad("\u2550".repeat(n),n,"\u2550")}\u255D${S.reset}`),t.push(e.#mt);try{this.#A(t.join(`
`),{prepend:!0}),t.length=0;return}catch{let s=this.#A??(()=>{});for(let o=0;o<t.length;o++)s(t[o]);t.length=0}}#vt(t,n){let s=z.findPosition(t,"S"),o=z.findPosition(t,"E"),i=z.bfsDistance(z.encodeMaze(t),s,o),a=typeof i=="number"?i:0,r=Math.max(0,n.path.length-1),c="0.0",l="0.0";r>0&&a>0&&(c=(Math.min(1,a/r)*100).toFixed(1),l=(r/a*100-100).toFixed(1));let u=new Set,p=0;for(let[h,d]of n.path){let f=`${h},${d}`;u.has(f)?p++:u.add(f)}return{optimalLength:a,pathLength:r,efficiencyPct:c,overheadPct:l,uniqueCellsVisited:u.size,revisitedCells:p,totalSteps:n.steps,fitnessValue:n.fitness}}#T(t){if(!t)return"n/a";let n=t.layers;if(Array.isArray(n)&&n.length>=2){let o=[];for(let i of n){let a=Array.isArray(i?.nodes)?i.nodes.length:Array.isArray(i)?i.length:0;o.push(a)}return o.join(" - ")}let s=t.nodes;if(Array.isArray(s)){let o=s.filter(h=>h.type==="input"),i=s.filter(h=>h.type==="output"),a=s.filter(h=>h.type==="hidden");if(!a.length)return typeof t.input=="number"&&typeof t.output=="number"?`${t.input} - ${t.output}`:`${o.length} - ${i.length}`;let r=new Set(o),c=a.slice(),l=[],u=a.length*e.#ut,p=0;for(;c.length&&p<u;){p++;let h=c.filter(d=>d.connections?.in?.every(f=>r.has(f.from)));if(!h.length){l.push(c.length);break}l.push(h.length);for(let d of h)r.add(d);c=c.filter(d=>!r.has(d))}return[`${o.length}`,...l.map(h=>`${h}`),`${i.length}`].join(" - ")}return typeof t.input=="number"&&typeof t.output=="number"?`${t.input} - ${t.output}`:"n/a"}update(t,n,s,o,i){if(this.#h==null&&(this.#h=Date.now(),this.#d=globalThis.performance?.now?.()??this.#h),this.#w=globalThis.performance?.now?.()??Date.now(),this.#M=o,this.#e={result:n,network:s,generation:o},n?.success){let r=this.#R(t);if(!this.#t.has(r)){this.#n.push({maze:t,result:n,network:s,generation:o}),this.#t.add(r);let c=this.#n.length;this.#dt({maze:t,result:n,network:s,generation:o},c)}}let a=i?.getTelemetry?.();if(Array.isArray(a)&&a.length){this.#s=z.safeLast(a);let r=this.#e?.result?.fitness;typeof r=="number"&&(this.#o=r,this.#i=z.pushHistory(this.#i,r,e.HISTORY_MAX));let c=this.#s?.complexity;c&&(typeof c.meanNodes=="number"&&(this.#l=z.pushHistory(this.#l,c.meanNodes,e.HISTORY_MAX)),typeof c.meanConns=="number"&&(this.#p=z.pushHistory(this.#p,c.meanConns,e.HISTORY_MAX)));let l=this.#s?.hyper;typeof l=="number"&&(this.#a=z.pushHistory(this.#a,l,e.HISTORY_MAX));let u=this.#e?.result?.progress;typeof u=="number"&&(this.#f=z.pushHistory(this.#f,u,e.HISTORY_MAX));let p=this.#s?.species;typeof p=="number"&&(this.#y=z.pushHistory(this.#y,p,e.HISTORY_MAX))}this.redraw(t,i);try{let r=this.#d!=null&&globalThis.performance?.now?globalThis.performance.now()-this.#d:this.#h?Date.now()-this.#h:0,c=r>0?o/(r/1e3):0,l={type:"asciiMaze:telemetry",generation:o,bestFitness:this.#o,progress:this.#e?.result?.progress??null,speciesCount:this.#y.at(-1)??null,gensPerSec:+c.toFixed(3),timestamp:Date.now(),details:this.#m||null};if(typeof window<"u"){try{window.dispatchEvent(new CustomEvent("asciiMazeTelemetry",{detail:l}))}catch{}try{window.parent&&window.parent!==window&&window.parent.postMessage(l,"*")}catch{}window.asciiMazeLastTelemetry=l}try{this._telemetryHook&&this._telemetryHook(l)}catch{}}catch{}}getLastTelemetry(){let t=this.#d!=null&&typeof performance<"u"?performance.now()-this.#d:this.#h?Date.now()-this.#h:0,n=this.#M??0,s=t>0?n/(t/1e3):0;return{generation:n,bestFitness:this.#o,progress:this.#e?.result?.progress??null,speciesCount:z.safeLast(this.#y)??null,gensPerSec:+s.toFixed(3),timestamp:this.#wt(),details:this.#m||null}}#wt(){return this.#w==null?Date.now():this.#d!=null&&typeof globalThis.performance?.now=="function"&&this.#h!=null?this.#h+(this.#w-this.#d):this.#w}#xt(){let t=e.FRAME_INNER_WIDTH;this.#c(`${S.blueCore}\u2554${U.pad(e.#X,t,e.#X)}\u2557${S.reset}`),this.#c(`${S.blueCore}\u255A${U.pad(e.#Tt,t,e.#X)}\u255D${S.reset}`);let s="\u2551 ASCII maze \u2551".length,o=t-s,i=Math.max(0,Math.ceil(o/2))+1,a=Math.max(0,o-i),r=`\u2551 ${S.neonYellow}ASCII maze${S.blueCore} \u2551`,c=`${S.blueCore}${" ".repeat(i)}${r}${" ".repeat(a)}${S.reset}`;this.#c(c),this.#c(`${S.blueCore}\u2554${U.pad(e.#Ot,t,e.#X)}\u2557${S.reset}`)}#Pt(t){let n=this.#e.generation,s=e.#b;this.#c(`${S.blueCore}\u2560${U.pad(s,e.FRAME_INNER_WIDTH,"\u2550")}${S.blueCore}\u2563${S.reset}`),this.#c(`${S.blueCore}\u2551${U.pad(`${S.orangeNeon}EVOLVING (GEN ${n})`,e.FRAME_INNER_WIDTH," ")}${S.blueCore}\u2551${S.reset}`),this.#c(`${S.blueCore}\u2560${U.pad(s,e.FRAME_INNER_WIDTH,"\u2550")}${S.blueCore}\u2563${S.reset}`),this.#r(),this.#u(),this.#I(t),this.#_t(t),this.#kt()}#u(){this.#r(),this.#c(U.visualizeNetworkSummary(this.#e.network)),this.#r()}#I(t){let n=this.#e.result.path,s=n?.at(-1)??[0,0],o=Ct.visualizeMaze(t,s,n),i=Array.isArray(o)?o:o.split(`
`),a=e.FRAME_INNER_WIDTH;this.#r();for(let r of i){let c=U.pad(r,a," ");this.#c(`${S.blueCore}\u2551${c}${S.blueCore}\u2551${S.reset}`)}this.#r()}static#J=[];#_t(t){this.#r();let n=this.#e;if(!n){this.#r();return}let s=f=>{let m=e.#J.pop();return m&&m.length>=f?m.subarray(0,f):new Int32Array(f)},o=f=>{e.#J.length<8&&e.#J.push(f)},i=s(3),a=n.result?.fitness;i[0]=typeof a=="number"&&Number.isFinite(a)?Math.round(a*100):0;let r=Number(n.result?.steps??0);i[1]=Number.isFinite(r)?r:0;let c=Number(n.result?.progress??0);i[2]=Number.isFinite(c)?Math.round(c*100):0;let l=(i[0]/100).toFixed(2),u=`${i[1]}`,p=`${i[2]}%`,h=e.#k,d=(f,m)=>this.#O(f,m,S.neonSilver,S.cyanNeon,h);this.#c(d("Fitness",l)),this.#c(d("Steps",u)),this.#c(d("Progress",p)),Ct.printMazeStats(n,t,this.#c),o(i),this.#r()}#kt(){let t=()=>this.#c(`${S.blueCore}\u2551${U.pad(" ",e.FRAME_INNER_WIDTH," ")}${S.blueCore}\u2551${S.reset}`);t();let n=this.#e?.result?.progress??0,s=Number(n),o=Number.isFinite(s)?s:0,a=`Progress to exit: ${Ct.displayProgressBar(o)}`;this.#c(`${S.blueCore}\u2551${U.pad(" "+S.neonSilver+a+S.reset,e.FRAME_INNER_WIDTH," ")}${S.blueCore}\u2551${S.reset}`),t()}reset(){this.#n=[],this.#t.clear(),this.#e=null}#W(t){if(!Array.isArray(t)||!t.length)return[];let n=Math.max(0,t.length-e.#C);if(n===0)return t.slice();let s=t.length-n,o=new Array(s);for(let i=0;i<s;i++)o[i]=t[n+i];return o}};He();pt();lt();Wt();ue();Nt();lt();Wt();ue();pt();ft();Nt();ft();At();Jt();var pe=class e{static#n=[[0,-1,0],[1,0,1],[0,1,2],[-1,0,3]];static#t=4;static#e=.25;static#s=2;static#o=1e3;static#i=5e3;static#l=.001;static#p=2;static#a=4;static#f=.5;static#y=new Int32Array(e.#t);static#m=new Int32Array(e.#t);static#h=new Float32Array(e.#t);static#d=new Uint8Array(e.#t);static#M=new Float32Array(e.#t);static#w=new Float32Array(e.#t);static#c(){return[0,0,0,0,0,e.#f]}static#x(t,n,s){return Array.isArray(t)&&s>=0&&s<t.length&&Array.isArray(t[s])&&n>=0&&n<t[s].length}static#A(t,n,s){return e.#x(t,n,s)&&t[s][n]!==-1}static#g(t){return(t+e.#s)%e.#t}static buildInputs6(t,n,s,o,i,a,r){if(!Array.isArray(t)||t.length===0)return e.#c();let[c,l]=n;if(!Number.isFinite(c)||!Number.isFinite(l))return e.#c();if(!e.#x(t,c,l))return e.#c();let u=0,p=1,h=2,d=3,f=e.#t,m=e.#y,b=e.#m,g=e.#h,y=e.#d,A=e.#M,N=e.#n,v=o;g.fill(1/0),y.fill(0),A.fill(0);let w=Number.isFinite(v?.[l]?.[c])?v[l][c]:void 0,x=w!=null&&Number.isFinite(w),_=e.#w;_.fill(NaN);for(let E=0;E<f;E++){let R=N[E],O=R[0],P=R[1],C=R[2],B=c+O,Y=l+P;m[C]=B,b[C]=Y;let V=t[Y];if(!V||V[B]===-1){g[C]=1/0,y[C]=0,A[C]=0,_[C]=NaN;continue}let rt=v&&v[Y],it=rt?rt[B]:void 0;_[C]=Number.isFinite(it)?it:NaN;let G=it!=null&&Number.isFinite(it);if(y[C]=1,G&&x&&it<w){let X=1+it;X<=e.#o?(g[C]=X,A[C]=X>e.#i?e.#f:0):(g[C]=1/0,A[C]=e.#f)}else g[C]=1/0,A[C]=0}let I=1/0;for(let E=0;E<f;E++)y[E]&&Number.isFinite(g[E])&&g[E]<I&&(I=g[E]);if(I<1/0)for(let E=0;E<f;E++)y[E]&&Number.isFinite(g[E])&&(A[E]=g[E]===I?1:I/g[E]);let L=A[u],$=A[p],k=A[h],F=A[d];if(L===0&&$===0&&k===0&&F===0&&r!=null)switch(e.#g(r)){case u:e.#A(t,c,l-1)&&(L=e.#l);break;case p:e.#A(t,c+1,l)&&($=e.#l);break;case h:e.#A(t,c,l+1)&&(k=e.#l);break;case d:e.#A(t,c-1,l)&&(F=e.#l);break}let M=0;if(o){let E=1/0,R=!1;for(let O=0;O<f;O++){let P=_[O];if(Number.isFinite(P)){let C=P+1;C<E&&C<=e.#i&&(E=C,M=O,R=!0)}}if(!R){let O=s[0]-c,P=s[1]-l;M=Math.abs(O)>Math.abs(P)?O>0?1:3:P>0?2:0}}else{let E=s[0]-c,R=s[1]-l;M=Math.abs(E)>Math.abs(R)?E>0?1:3:R>0?2:0}let T=M*e.#e,D=e.#f;if(i!=null&&Number.isFinite(i)&&Number.isFinite(a)){let E=i-a,R=Math.max(-e.#p,Math.min(e.#p,E));D=e.#f+R/e.#a}return[T,L,$,k,F,D]}};var Ut=class e{static#n=3e3;static#t=6;static#e=.5;static#s=10;static#o=2;static#i=.2;static#l=10;static#p=1e3;static#a=10;static#f=.985;static#y=.01;static#m=.01;static#h=.25;static#d=.35;static#M=6;static#w=5;static#c=5;static#x=.5;static#A=10;static#g=12;static#E=6;static#S=3;static#P=4;static#_=5;static#rt=10;static#K=10;static#k=.01;static#C=.5;static#Z=4;static#Q=4;static#ct=8;static#F=12;static#lt=4;static#ut=2;static#D=5;static#ht=.35;static#$=.5;static#pt=.25;static#V=.3;static#Y=.05;static#tt=5;static#X=30;static#Tt=5;static#Ot=8;static#b=.05;static#r=.3;static#O=.7;static#N=.02;static#R=.5;static#dt=2;static#et=.4;static#Rt=.6;static#L=.05;static#nt=.15;static#At=.95;static#st=.55;static#v=.25;static#St=.03;static#B=.015;static#H=.05;static#ft=.2;static#Nt=.05;static#mt=.1;static#Lt=40;static#vt=2;static#T=4;static#wt=Math.log(e.#T);static#xt=new Float64Array(4);static#Pt=new Float64Array(4);static#u=new Int32Array(2);static#I=-1;static#J=1e-6;static#_t=.01;static#kt=.03;static#W=1;static#Xt=.5;static#Jt=1;static#Kt=1.2;static#Zt=80;static#Qt=.01;static#te=650;static#ee=.2;static#ne=5;static#se=150;static#oe=.3;static#ie=.5;static#ae=1.3;static#re=500;static#ce="output";static#yt=[[0,-1],[1,0],[0,1],[-1,0]];static#le=[2,3,0,1];static#Mt=null;static#Ft=null;static#ot=null;static#gt=null;static#Ht=0;static#Gt=0;static#It=0;static#it=0;static#Dt=new Float64Array(4);static#j=null;static#G=0;static#U=0;static#$t=void 0;static isValidMove(t,n,s){if(Array.isArray(n)){let[a,r]=n;return e.#u[0]=a|0,e.#u[1]=r|0,e.#Ut(t,e.#u[0],e.#u[1])}let o=n,i=s;return e.#u[0]=o|0,e.#u[1]=i|0,e.#Ut(t,e.#u[0],e.#u[1])}static#Et(){let t=e.#j;if(t==null||t.length===0)return Math.random();let n=t[0]+1831565813>>>0;t[0]=n;let s=n;return s=Math.imul(s^s>>>15,s|1)>>>0,s=(s^s+Math.imul(s^s>>>7,s|61))>>>0,((s^s>>>14)>>>0)/4294967296}static#ue(t,n){return Math.imul(n,e.#It)+t}static#he(t,n,s){let o=t*n;if(!this.#Mt||o>this.#Ht){let a=e.#Bt(o);this.#Mt=new Uint8Array(a),this.#Ft=new Uint16Array(a),this.#Ht=a}else this.#Mt.fill(0,0,o),this.#Ft.fill(0,0,o);let i=s+1;if(!this.#ot||i>this.#Gt){let a=e.#Bt(i);this.#ot=new Int32Array(a),this.#gt=new Int32Array(a),this.#Gt=a}this.#It=t,this.#it=n}static#Bt(t){let n=Math.max(1,Math.floor(t));if(n<=1)return 1;if(n<=4294967295){let o=n-1>>>0,a=32-Math.clz32(o),c=1<<Math.min(31,Math.max(0,a));return c>=n?c:c<<1}let s=1;for(;s<n;)s=s*2;return s}static#Wt(t){let n=Math.max(0,Math.floor(t));if(n===0)return[];let s=e.#ot,o=e.#gt,i=new Array(n);for(let a=0;a<n;a++){let r=s[a],c=o[a];i[a]=[r,c]}return i}static#ke(t){if(t===e.#I)return e.#I;let n=t|0,s=e.#T,o=n%s;o<0&&(o+=s);let i=s>>1;return(o+i)%s}static#jt(t,n){let s=e.#lt,o=Math.max(0,n|0),i=Math.min(t.length,o+s);if(o>=i)return 0;let a=e.#xt,r=0,c=0;for(let l=o;l<i;l++){let u=t[l]??0;a[c++]=u,r+=u}return r}static#pe(t,n,s,o){let i=t<e.#A,a=n>e.#g,r=n>e.#E,c=o>e.#S,l=0;switch(!0){case i:l=e.#ht;break;case a:l=e.#$;break;case r:l=e.#pt;break;case c:l=e.#V;break;default:break}return s<=e.#D&&(l=Math.min(l,e.#Y)),l}static#Ut(t,n,s){let o=t?.length??0,a=t?.[0]?.length??0,r=e.#It,c=e.#it,l=r>0&&c===o&&r===a?r:a,u=c>0&&r===a&&c===o?c:o;e.#u[0]=n|0,e.#u[1]=s|0;let p=e.#u[0],h=e.#u[1];if(h<0||h>=u||p<0||p>=l)return!1;let d=t[h];return d?d[p]!==-1:!1}static#z(t,[n,s],o){let i=n|0,a=s|0;if(o&&o[a]!==void 0&&Number.isFinite(o[a][i]))return o[a][i];let r=t?.length??0,l=t?.[0]?.length??0,u=e.#It,p=e.#it,h=u>0&&p===r&&u===l?u:l,d=p>0&&u===l&&p===r?p:r;return i<0||i>=h||a<0||a>=d,1/0}static moveAgent(t,n,s){if(s===e.#I)return[n[0],n[1]];let o=[n[0],n[1]];if(s>=0&&s<e.#T){let[i,a]=e.#yt[s];o[0]+=i,o[1]+=a}return e.isValidMove(t,o)?o:[n[0],n[1]]}static selectDirection(t){let n=e.#T;if(!Array.isArray(t)||t.length!==n)return{direction:e.#I,softmax:Array.from(e.#Dt),entropy:0,maxProb:0,secondProb:0};let s=e.#xt,o=e.#Pt,i=e.#Dt,a=0;for(let y=0;y<n;y++)a+=t[y];let r=a/n,c=0;for(let y=0;y<n;y++){let A=t[y]-r;s[y]=A,c+=A*A}c/=n;let l=Math.sqrt(c);(!Number.isFinite(l)||l<e.#J)&&(l=e.#J);let u=l<e.#_t?e.#W:l<e.#kt?e.#Xt:0,p=e.#Jt+e.#Kt*u,h=-1/0;for(let y=0;y<n;y++){let A=s[y];A>h&&(h=A)}let d=0;for(let y=0;y<n;y++){let A=Math.exp((s[y]-h)/p);o[y]=A,d+=A}d===0&&(d=1);let f=0,m=-1/0,b=0;for(let y=0;y<n;y++){let A=o[y]/d;i[y]=A,A>m?(b=m,m=A,f=y):A>b&&(b=A)}let g=0;for(let y=0;y<n;y++){let A=i[y];A>0&&(g+=-A*Math.log(A))}return g/=e.#wt,{direction:f,softmax:Array.from(i),entropy:g,maxProb:m,secondProb:b}}static simulateAgent(t,n,s,o,i,a=e.#n){let r=e.#de(n,s,i,a);for(;r.steps<a&&(r.steps++,e.#zt(r,n),e.#me(r,n,o,i),e.#ye(r,t,n,i),e.#ge(r,n,i),e.#be(r,n),e.#Ae(r,n),e.#Se(r,n,i),e.#Ne(r),!e.#Ce(r));)if(r.position[0]===o[0]&&r.position[1]===o[1])return e.#Te(r,a);return e.#Oe(r,n,s,o,i)}static#de(t,n,s,o){e.#G=0,e.#U=0,e.#$t=void 0;let i=t.length,a=t[0].length,r=Array.isArray(s)&&s.length===i;e.#he(a,i,o);let c=[n[0],n[1]];e.#ot[0]=c[0],e.#gt[0]=c[1];let l=e.#t;return{position:c,steps:0,pathLength:1,visitedUniqueCount:0,hasDistanceMap:r,distanceMap:s,minDistanceToExit:r?s[c[1]]?.[c[0]]??1/0:e.#z(t,c,s),progressReward:0,newCellExplorationBonus:0,invalidMovePenalty:0,prevAction:e.#I,stepsSinceImprovement:0,lastDistanceGlobal:e.#z(t,c,s),saturatedSteps:0,recentPositions:[],localAreaPenalty:0,directionCounts:[0,0,0,0],moveHistoryRing:new Int32Array(l),moveHistoryLength:0,moveHistoryHead:0,currentCellIndex:0,loopPenalty:0,memoryPenalty:0,revisitPenalty:0,visitsAtCurrent:0,distHere:1/0,vision:[],actionStats:null,direction:e.#I,moved:!1,prevDistance:1/0,earlyTerminate:!1}}static#fe(t,n){let s=t.moveHistoryRing,o=t.moveHistoryHead|0,i=t.moveHistoryLength,a=s.length;a!==0&&(s[o]=n,o=(o+1)%a,t.moveHistoryHead=o,i<a&&(t.moveHistoryLength=i+1))}static#bt(t,n){let s=n|0,o=t.moveHistoryLength|0;if(s<=0||s>o)return;let i=t.moveHistoryRing,a=i.length;if(a===0)return;let c=(t.moveHistoryHead|0)-s;return c=(c%a+a)%a,i[c]}static#zt(t,n){let s=e.#Mt,o=e.#Ft,i=e.#e,a=e.#ue(t.position[0],t.position[1]);t.currentCellIndex=a,s[a]||(s[a]=1,t.visitedUniqueCount++),o[a]=o[a]+1,e.#fe(t,a);let r=t.visitsAtCurrent=o[a];if(t.loopPenalty=0,t.moveHistoryLength>=e.#P){let c=e.#bt(t,1),l=e.#bt(t,2),u=e.#bt(t,3),p=e.#bt(t,4);c===u&&l!==void 0&&p!==void 0&&l===p&&(t.loopPenalty=-e.#s*i)}if(t.memoryPenalty=0,t.moveHistoryLength>1){for(let c=2;c<=t.moveHistoryLength;c++)if(e.#bt(t,c)===a){t.memoryPenalty=-e.#o*i;break}}t.revisitPenalty=0,r>1&&(t.revisitPenalty=-e.#i*(r-1)*i),r>e.#l&&(t.invalidMovePenalty-=e.#p*i,t.earlyTerminate=!0)}static#me(t,n,s,o){if(t.earlyTerminate)return;let i=t.position,a=i[0]|0,r=i[1]|0,c=t.hasDistanceMap,l=c?o[r]?.[a]??void 0:e.#z(n,i,o),u=pe.buildInputs6(n,i,s,o,e.#$t,l,t.prevAction);t.vision=Array.isArray(u)?u:Array.from(u),e.#$t=l,t.distHere=c?o[r]?.[a]??1/0:e.#z(n,i,o)}static#ye(t,n,s,o){if(!t.earlyTerminate)try{let i=n.activate(t.vision),a=(i&&i.length)|0,r=new Array(a);for(let l=0;l<a;l++)r[l]=i[l];n._lastStepOutputs=z.pushHistory(n._lastStepOutputs,r,e.#Zt);let c=e.selectDirection(i);t.actionStats=c,e.#Ee(t,i,n),t.direction=c.direction}catch(i){console.error("Error activating network:",i),t.direction=e.#I}}static#ge(t,n,s){if(t.earlyTerminate||t.distHere>e.#ut)return;let o=t.direction,i=1/0,a=e.#u;for(let r=0;r<e.#T;r++){let[c,l]=e.#yt[r],u=t.position[0]+c|0,p=t.position[1]+l|0;if(a[0]=u,a[1]=p,!e.isValidMove(n,u,p))continue;let h=e.#z(n,[u,p],s);h<i&&(i=h,o=r)}o!==void 0&&o!==t.direction&&(t.direction=o)}static#be(t,n){if(t.earlyTerminate)return;let s=e.#pe(t.steps,t.stepsSinceImprovement,t.distHere,e.#G);if(!(e.#Et()<s))return;let o=e.#T,i=t.prevAction,a=t.position[0]|0,r=t.position[1]|0,c=e.#u;for(let l=0;l<o;l++){let u=e.#Et()*o|0;if(u===i)continue;let[p,h]=e.#yt[u],d=a+p|0,f=r+h|0;if(c[0]=d,c[1]=f,e.isValidMove(n,d,f)){t.direction=u;break}}}static#Ae(t,n){if(t.earlyTerminate||(t.direction===e.#I?e.#U++:e.#U=0,e.#U<e.#tt))return;let s=e.#T,o=t.position[0]|0,i=t.position[1]|0,a=e.#u;for(let r=0;r<s;r++){let c=e.#Et()*s|0,[l,u]=e.#yt[c],p=o+l|0,h=i+u|0;if(a[0]=p,a[1]=h,e.isValidMove(n,p,h)){t.direction=c;break}}e.#U=0}static#Se(t,n,s){if(t.earlyTerminate)return;let o=e.#z(n,t.position,s);t.prevDistance=o,t.moved=!1;let i=t.direction;if(i>=0&&i<e.#T){let[l,u]=e.#yt[i],p=t.position[0]+l|0,h=t.position[1]+u|0,d=e.#u;d[0]=p,d[1]=h,e.isValidMove(n,p,h)&&(t.position[0]=p,t.position[1]=h,t.moved=!0)}let a=e.#e,r=e.#ot,c=e.#gt;if(t.moved){let l=t.pathLength|0;r[l]=t.position[0],c[l]=t.position[1],t.pathLength=l+1,z.pushHistory(t.recentPositions,[t.position[0],t.position[1]],e.#X),e.#ve(t,a);let u=t.hasDistanceMap?t.distanceMap?.[t.position[1]]?.[t.position[0]]??1/0:e.#z(n,t.position,t.distanceMap),p=o-u,h=p>0,d=!h&&u>o;e.#we(t,p,h,d,a),e.#xe(t,a),t.direction>=0&&t.directionCounts[t.direction]++,t.minDistanceToExit=Math.min(t.minDistanceToExit,u)}else t.invalidMovePenalty-=e.#a*a;e.#at(t,n,a)}static#Ne(t){if(t.earlyTerminate)return;let n=e.#e;e.#_e(t,n),t.moved&&(t.prevAction=t.direction),e.#Me(t,n),e.#Ie(t,n);let s=e.#u;s[0]=(t.loopPenalty||0)+(t.memoryPenalty||0)+(t.revisitPenalty||0),t.invalidMovePenalty+=s[0]}static#ve(t,n){let s=t.recentPositions;if(s.length!==e.#X)return;let o=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=Number.POSITIVE_INFINITY,r=Number.NEGATIVE_INFINITY;for(let u=0,p=s.length;u<p;u++){let h=s[u],d=h[0]|0,f=h[1]|0;d<o&&(o=d),d>i&&(i=d),f<a&&(a=f),f>r&&(r=f)}let c=e.#u;c[0]=o,c[1]=a,i-o+(r-a)<=e.#Tt&&t.stepsSinceImprovement>e.#Ot&&(t.localAreaPenalty-=e.#b*n)}static#we(t,n,s,o,i){let a=t.actionStats?.maxProb??(s?1:.5);if(s){let r=(e.#r+e.#O*a)*i;if(t.stepsSinceImprovement>0){let l=Math.min(t.stepsSinceImprovement*e.#N*i,e.#R*i);t.progressReward+=l}t.progressReward+=r,t.stepsSinceImprovement=0;let c=n*e.#dt*(e.#et+e.#Rt*a);t.progressReward+=c}else if(o){let r=(e.#L+e.#nt*a)*i;t.progressReward-=r,t.stepsSinceImprovement++}else t.stepsSinceImprovement++}static#xe(t,n){let s=t.visitsAtCurrent|0,o=e.#oe*n,i=e.#ie*n,a=e.#u;a[0]=s===1?o:-i,t.newCellExplorationBonus+=a[0]}static#at(t,n,s){let o=e.#u,i=t.position[0]|0,a=t.position[1]|0,r=t.hasDistanceMap?t.distanceMap?.[a]?.[i]??1/0:e.#z(n,t.position,t.distanceMap);o[0]=r;let c=t.lastDistanceGlobal??1/0;if(r<c){let l=t.stepsSinceImprovement|0;if(l>e.#K){let p=(l-e.#K)*e.#k*s,h=Math.min(p,e.#C*s);t.progressReward+=h}t.stepsSinceImprovement=0}t.lastDistanceGlobal=r}static#_e(t,n){if(t.earlyTerminate)return;let s=t.prevAction,o=t.direction,i=t.stepsSinceImprovement|0,a=e.#u,r=e.#Z;if(s===o&&i>r){let c=i-r,u=e.#H*c*n;a[0]=-u,t.invalidMovePenalty+=a[0]}if(s>=0&&o>=0&&i>0&&o===e.#le[s]){let c=e.#ft*n;a[1]=-c,t.invalidMovePenalty+=a[1]}}static#Me(t,n){if(t.earlyTerminate||!t.actionStats)return;let{entropy:s,maxProb:o,secondProb:i}=t.actionStats,a=e.#At,r=e.#st,c=e.#v,l=e.#jt(t.vision,e.#ct)>0,u=e.#jt(t.vision,e.#F)>0,p=l||u,h=e.#u;if(s>a){h[0]=-e.#St*n,t.invalidMovePenalty+=h[0];return}let d=(o??0)-(i??0);p&&s<r&&d>c&&(h[0]=e.#B*n,t.newCellExplorationBonus+=h[0])}static#Ie(t,n){let s=e.#G,o=e.#_;if(s<o)return;let i=e.#u,a=e.#Nt*n;i[0]=-a,t.invalidMovePenalty+=i[0];let r=e.#rt;if(r>0&&s%r===0){let c=e.#mt*n;i[1]=-c,t.invalidMovePenalty+=i[1]}}static#Ee(t,n,s){let o=e.#e,i=e.#u,a=t.actionStats;if(!a)return;let r=a.maxProb??0,c=a.secondProb??0,l=r>e.#f&&c<e.#y,u=e.#T,p=0;for(let A=0;A<n.length;A++)p+=n[A];let h=p/u,d=0;for(let A=0;A<n.length;A++){let N=n[A]-h;d+=N*N}let f=d/u,b=Math.sqrt(f)<e.#m,g=e.#G;if(l||b?(g++,t.saturatedSteps++):g>0&&g--,e.#G=g,l&&(i[0]=-e.#h*o,t.invalidMovePenalty+=i[0]),b&&(i[0]=-e.#d*o,t.invalidMovePenalty+=i[0]),e.#G>e.#M&&t.steps%e.#w===0)try{let A=s.nodes?.filter(N=>N.type===e.#ce);if(A&&A.length>0){let N=0;for(let _=0;_<A.length;_++)N+=A[_].bias;let v=N/A.length,w=e.#x,x=e.#c;for(let _=0;_<A.length;_++){let I=A[_],L=I.bias-v*w;I.bias=Math.max(-x,Math.min(x,L))}}}catch{}}static#Ce(t){if((t.stepsSinceImprovement|0)<=e.#Lt)return t.earlyTerminate;let s=e.#e,o=e.#u;try{if(typeof window>"u")return o[0]=-e.#vt*s,t.invalidMovePenalty+=o[0],!0}catch{return o[0]=-e.#vt*s,t.invalidMovePenalty+=o[0],!0}return t.earlyTerminate}static#qt(t){let n=t.reduce((i,a)=>i+(a|0),0)||1,s=e.#u;s[0]=0;let o=Math.log;for(let i=0,a=t.length;i<a;i++){let r=t[i]|0;if(r===0)continue;let c=r/n;s[0]-=c*o(c)}return s[0]/e.#wt}static#Te(t,n){let s=t.steps|0,o=(n|0)-s,i=e.#qt(t.directionCounts),r=e.#te+o*e.#ee+t.progressReward+t.newCellExplorationBonus+t.invalidMovePenalty+i*e.#ne,c=e.#Wt(t.pathLength),l=e.#u;l[0]=s?t.saturatedSteps/s:0;let u=l[0],p=Math.max(e.#se,r);return{success:!0,steps:s,path:c,fitness:p,progress:100,saturationFraction:u,actionEntropy:i}}static#Oe(t,n,s,o,i){let a=e.#ot,r=e.#gt,c=(t.pathLength|0)-1,l=[a[c]??0,r[c]??0],u=i?z.calculateProgressFromDistanceMap(i,l,s):z.calculateProgress(n,l,s,o),p=u/100,h=Math.pow(p,e.#ae)*e.#re,d=t.visitedUniqueCount*1,f=e.#qt(t.directionCounts),m=f*e.#Q,A=h+d+t.progressReward+t.newCellExplorationBonus+t.invalidMovePenalty+m+t.localAreaPenalty+0+0+e.#Et()*e.#Qt,N=A>=0?A:-Math.log1p(1-A),v=e.#Wt(t.pathLength),w=e.#u,x=t.steps|0;w[0]=x?t.saturatedSteps/x:0;let _=w[0];return{success:!1,steps:t.steps,path:v,fitness:N,progress:u,saturationFraction:_,actionEntropy:f}}};var de=class e{static#n=200;static#t=1.5;static#e=.5;static#s=5e3;static#o=8e3;static#i=80;static#l=new Uint16Array(0);static#p=0;static#a=0;static#f(t,n){if(!(t<=0||n<=0)){if(t===this.#p&&n===this.#a){this.#l.fill(0);return}this.#p=t,this.#a=n,this.#l=new Uint16Array(t*n)}}static evaluateNetworkFitness(t,n,s,o,i,a){let r=Ut.simulateAgent(t,n,s,o,i,a),c=0,l=n.length,u=n[0]?.length||0;e.#f(u,l);let p=e.#l,h=e.#p;for(let m=0;m<r.path.length;m++){let[b,g]=r.path[m],y=g*h+b;p[y]++}let d=l+u;for(let m=0;m<r.path.length;m++){let[b,g]=r.path[m],y=g*h+b;if(p[y]!==1)continue;let A=i?i[g]?.[b]??1/0:z.bfsDistance(n,[b,g],o),N=e.#t-e.#e*(A/d);c+=e.#n*N}p.fill(0);let f=r.fitness+c;if(r.success){f+=e.#s;let m=i?i[s[1]]?.[s[0]]??1/0:z.bfsDistance(n,s,o),b=(r.path.length-1)/m*100-100,g=Math.max(0,e.#o-b*e.#i);f+=g}return f}static defaultFitnessEvaluator(t,n){return e.evaluateNetworkFitness(t,n.encodedMaze,n.startPosition,n.exitPosition,n.distanceMap,n.agentSimConfig.maxSteps)}};var fe=class e{static#n=new Float64Array(4);static#t=[];static#e=new Float64Array(4);static#s=new Float64Array(4);static#o;static#i=new Float64Array(4);static#l;static#p;static#a=new Int32Array(4);static#f=new Int32Array(0);static#y=.7;static#m=2654435761;static#h=new Int32Array(64);static#d=new Int32Array(64);static#M=[];static#w=[];static#c=new Uint8Array(128);static#x=new Array(64);static#A=new Array(64);static#g=new Array(512);static#E;static#S=new Int32Array(128);static#P=new Array(0);static#_=new Array(0);static#rt=new Array(0);static#K={generation:0,bestFitness:0,simplifyMode:!1,plateauCounter:0,timestamp:0,telemetryTail:void 0,top:void 0};static#k=new Uint16Array(0);static#C=4;static#Z=1/Math.log(4);static#Q=1664525;static#ct=1013904223;static#F=4;static#lt=9;static#ut=1/8388608;static#D=512;static#ht=8192;static#$=!1;static#pt=(()=>{let t=e.#D,n=new Array(t);for(let s=0;s<t;s++)n[s]=new Float32Array(e.#C);return n})();static#V;static#Y;static#tt=0;static#X(t){let n=new Array(t);for(let s=0;s<t;s++)n[s]=new Float32Array(e.#C);return n}static#Tt(t){try{if(typeof SharedArrayBuffer>"u"||globalThis?.crossOriginIsolated!==!0||!Number.isInteger(t)||t<=0)return;let n=e.#C,s=t*n,o=Int32Array.BYTES_PER_ELEMENT,i=Float32Array.BYTES_PER_ELEMENT,a=new SharedArrayBuffer(o+s*i);e.#Y=new Int32Array(a,0,1),e.#V=new Float32Array(a,o,s),Atomics.store(e.#Y,0,0),e.#V.fill(0),e.#$=!0}catch{e.#$=!1,e.#V=void 0,e.#Y=void 0}}static#Ot(t){if(!Number.isFinite(t)||t<0)return;let n=128,s=e.#ht,o=e.#D,i=o,a=r=>r<=1?1:1<<Math.ceil(Math.log2(r));if(t>o*3/4&&o<s){let r=Math.min(t*2,s);i=Math.min(a(Math.ceil(r)),s)}else if(t<o/4&&o>n){let r=o;for(;r>n&&t*2<=r/2;)r>>=1;i=Math.max(r,n)}i!==o&&(e.#D=i,e.#tt=0,e.#pt=e.#X(i),e.#$&&e.#Tt(i))}static#b=new Int32Array(64);static#r=new Array(40);static#O=new Array(64);static#N=(Date.now()^2654435769)>>>0;static#R=(()=>{try{return typeof process<"u"&&process?.env?.ASCII_MAZE_PROFILE_DETAILS==="1"}catch{return!1}})();static#dt={telemetry:0,simplify:0,snapshot:0,prune:0};static#et=new Int32Array(64);static#Rt=63;static#L(){return e.#B()}static#nt(t,n){e.#R&&(e.#dt[t]=(e.#dt[t]||0)+n)}static#At=new Float64Array(e.#F);static#st=e.#F;static#v(){if(e.#st>=e.#F){let n=e.#N>>>0;for(let s=0;s<e.#F;s++)n=n*e.#Q+e.#ct>>>0,e.#At[s]=(n>>>e.#lt)*e.#ut;e.#N=n>>>0,e.#st=0}return e.#At[e.#st++]}static#St=!1;static#B(){return globalThis.performance?.now?.()??Date.now()}static setDeterministic(t){if(e.#St=!0,typeof t=="number"&&Number.isFinite(t)){let n=t>>>0||2654435769;e.#N=n>>>0,e.#st=e.#F}}static clearDeterministic(){e.#St=!1}static#H=!1;static#ft=!1;static#Nt=!1;static#mt=40;static#Lt=500;static#vt=.2;static#T=.3;static#wt=.1;static#xt=.2;static#Pt=20;static#u=10;static#I=.01;static#J=.001;static#_t=.2;static#kt=2;static#W=20;static#Xt=1e3;static#Jt=.5;static#Kt=.01;static#Zt=.005;static#Qt=[.3,.8];static#te=.5;static#ee=.25;static#ne=.5;static#se=.25;static#oe=.25;static#ie=.7;static#ae=.55;static#re=.25;static#ce=.05;static#yt=.01;static#le=5;static#Mt=.1;static#Ft=.2;static#ot="[ACTION_ENTROPY]";static#gt="[OUTPUT_BIAS]";static#Ht="[LOGITS]";static#Gt=.92;static#It=.02;static#it=.7;static#Dt=.9;static#j=.6;static#G=.55;static#U=.4;static#$t=.45;static#Et=.001;static#ue=.95;static#he=.05;static#Bt=.35;static#Wt=.1;static#ke=.05;static#jt=60;static#pe=8;static#Ut=.002;static#z=.1;static#de=4;static#fe=.35;static#bt=.97;static#zt=20;static#me=50;static#ye=6;static#ge=.6;static#be=.8;static#Ae=.4;static#Se=1.5;static#Ne=1.3;static#ve=1.2;static#we=24;static#xe=(()=>{let t=new Int8Array(9);return t.fill(-1),t[3]=0,t[7]=1,t[5]=2,t[1]=3,t})();static#at(t,n){if(!Array.isArray(t)||t.length===0)return 0;let s=t,o=n,i=0,a=e.#b;for(let r=0;r<s.length;r++){let c=s[r];if(!(!c||c.type!==o)){if(i>=a.length){let l=1<<Math.ceil(Math.log2(i+1)),u=new Int32Array(l);u.set(a),e.#b=u,a=u}a[i++]=r}}return i}static#_e(t){let n=t?.length||0;if(n===0)return{unique:0,pathLen:0,ratio:0};if(n<32){let o=e.#Me(t,n);return{unique:o,pathLen:n,ratio:o/n}}let s=e.#Ie(t,n);return{unique:s,pathLen:n,ratio:s/n}}static#Me(t,n){if(n===0)return 0;let s=e.#et,o=e.#Rt;s.fill(0);let i=0;for(let a=0;a<n;a++){let r=t[a],c=(r[0]&65535)<<16|r[1]&65535,l=Math.imul(c,e.#m)>>>0,u=c+1|0;for(;;){let p=l&o,h=s[p];if(h===0){s[p]=u,i++;break}if(h===u)break;l=l+1|0}}return i}static#Ie(t,n){let s=n<<1,o=e.#f;if(o.length===0||s>o.length*e.#y){let r=Math.ceil(s/e.#y),c=1<<Math.ceil(Math.log2(r));o=e.#f=new Int32Array(c)}else o.fill(0);let i=o.length-1,a=0;for(let r=0;r<n;r++){let c=t[r],l=(c[0]&65535)<<16|c[1]&65535,u=Math.imul(l,e.#m)>>>0,p=l+1|0;for(;;){let h=u&i,d=o[h];if(d===0){o[h]=p,a++;break}if(d===p)break;u=u+1|0}}return a}static#Ee(t,n=40){let s=Array.isArray(t?.population)?t.population:e.#t,o=s.length|0;if(o===0)return{speciesUniqueCount:0,simpson:0,wStd:0};let i=e.#h,a=e.#d;if(o>i.length){let g=1<<Math.ceil(Math.log2(o));e.#h=new Int32Array(g),e.#d=new Int32Array(g),i=e.#h,a=e.#d}else a.fill(0);let r=0,c=0;for(let g=0;g<o;g++){let y=s[g],A=(y&&y.species!=null?y.species:-1)|0,N=-1;for(let v=0;v<r;v++)if(i[v]===A){N=v;break}N===-1?(i[r]=A,a[r]=1,r++):a[N]++,c++}c===0&&(c=1);let l=0;for(let g=0;g<r;g++){let y=a[g]/c;l+=y*y}let u=1-l,p=n>0?Math.min(o,n|0):0,h=p?e.#Pn(s,p):0,d=0,f=0,m=0;for(let g=0;g<h;g++){let A=e.#r[g]?.connections??e.#t;for(let N=0;N<A.length;N++){let v=A[N];if(v&&v.enabled!==!1){let w=Number.isFinite(v.weight)?v.weight:0;m++;let x=w-d;d+=x/m,f+=x*(w-d)}}}let b=m?Math.sqrt(f/m):0;return{speciesUniqueCount:r,simpson:u,wStd:b}}static#Ce(t,n){if(!Array.isArray(t)||n<=0)return[];let s=Math.floor(n),o=t.length|0;if(o===0||s===0)return[];if(s>e.#A.length){let a=1<<Math.ceil(Math.log2(s));e.#A=new Array(a)}let i=e.#A;for(let a=0;a<s;a++)i[a]=t[e.#v()*o|0];return i.length=s,i}static#qt(t,n,s){if(!t||!Array.isArray(t.population)||t.population.length===0)return;let o=t.population,i=Number.isFinite(s)?Math.max(0,Math.min(1,s)):0;if(i!==0)for(let a=0;a<o.length;a++){let r=o[a];try{if(!r||!Array.isArray(r.connections))continue;e.#Ze(r,n??"",i)}catch{}}}static#Te(t){try{if(!t)return;let n=t.nodes??e.#t,s=t.connections??e.#t,o=e.#at(n,"output"),i=e.#at(n,"input"),a=e.#re,r=e.#ae;for(let u=0;u<4;u++){let p=u+1<i?e.#b[u+1]:-1,h=u<o?e.#b[u]:-1,d=p===-1?void 0:n[p],f=h===-1?void 0:n[h];if(!d||!f)continue;let m;for(let g=0,y=s.length;g<y;g++){let A=s[g];if(A.from===d&&A.to===f){m=A;break}}let b=e.#v()*a+r;m?m.weight=b:t.connect(d,f,b)}let c=i>0?e.#b[0]:-1,l=c===-1?void 0:n[c];if(!l)return;for(let u=0;u<o;u++){let p=n[e.#b[u]];if(!p)continue;let h;for(let f=0,m=s.length;f<m;f++){let b=s[f];if(b.from===l&&b.to===p){h=b;break}}let d=e.#ce+u*e.#yt;h?h.weight=d:t.connect(l,p,d)}}catch{}}static#Oe(t,n,s){let o=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,i=Number.isFinite(n)?Math.max(0,Math.floor(n)):0,a=Number.isFinite(s)?Math.max(0,Math.floor(s)):0;if(o<i)return 0;try{if(typeof window<"u")return 0}catch{}return a}static#He(t,n,s,o){let i=Number.isFinite(n)?Math.max(0,Math.floor(n)):0;if(i===0||!t||!Array.isArray(t.population)||t.population.length===0)return 0;try{if(typeof window<"u")return i}catch{}let a=e.#R,r=a?e.#L():0;if(e.#qt(t,s,o),a){let c=e.#L()-r||0;e.#nt("simplify",c)}return Math.max(0,i-1)}static#Ge(t,n,s,o,i,a,r){if(!t||!Array.isArray(t.population)||t.population.length===0||!Array.isArray(n)||n.length===0||!Number.isFinite(s)||s<=0)return 0;let c=a?e.#B():0,l=o&&o>0&&o<n.length?e.#Ce(n,o):n,u=0,p=0,h=t.population;for(let d of h)if(d)try{d.train(l,{iterations:s,error:e.#I,rate:e.#J,momentum:e.#_t,batchSize:e.#kt,allowRecurrent:!0,cost:nt.Cost.softmaxCrossEntropy}),e.#_n(d);try{let m=d.getTrainingStats?.()?.gradNorm;Number.isFinite(m)&&(u+=m,p++)}catch{}}catch{}if(p>0){let d=u/p;i(`[GRAD] gen=${r} meanGradNorm=${d.toFixed(4)} samples=${p}
`)}return a?e.#B()-c:0}static#Be(t,n,s,o,i){if(e.#ft)return;let a=e.#R,r=a?e.#L():0;try{e.#We(s,o,i),e.#je(n,o,i),e.#Ue(t,n,o,i),e.#ze(s,o,i),e.#qe(t,o,i)}catch{}a&&e.#nt("telemetry",e.#L()-r||0)}static#We(t,n,s){if(typeof s!="function")return;let o=t?.path;try{let i=e.#on(o),a=e.#ot,r=Number.isFinite(i?.entropyNorm)?i.entropyNorm.toFixed(3):"0.000",c=Number.isFinite(i?.uniqueMoves)?String(i.uniqueMoves):"0",l=Number.isFinite(i?.pathLen)?String(i.pathLen):"0";s(`${a} gen=${n} entropyNorm=${r} uniqueMoves=${c} pathLen=${l}
`)}catch{}}static#je(t,n,s){if(typeof s!="function")return;let o=t?.nodes??[];try{let i=e.#at(o,"output");if(i<=0)return;let a=e.#hn(o,i),r=e.#gt,c=Number.isFinite(a?.mean)?a.mean.toFixed(3):"0.000",l=Number.isFinite(a?.std)?a.std.toFixed(3):"0.000",u=String(a?.biasesStr??"");s(`${r} gen=${n} mean=${c} std=${l} biases=${u}
`)}catch{}}static#Ue(t,n,s,o){if(typeof o=="function")try{let i=n?._lastStepOutputs??e.#t;if(!i.length)return;let a=e.#Pe(i,e.#mt),r=e.#in(a);o(`${e.#Ht} gen=${s} means=${r.meansStr} stds=${r.stdsStr} kurt=${r.kurtStr} entMean=${Number.isFinite(r.entMean)?r.entMean.toFixed(3):"0.000"} stability=${Number.isFinite(r.stability)?r.stability.toFixed(3):"0.000"} steps=${a.length}
`),e._collapseStreak=e._collapseStreak||0;let c=r.stds||[],l=!0;for(let p=0;p<c.length;p++)if(!(c[p]<e.#Zt)){l=!1;break}l&&(r.entMean<e.#fe||r.stability>e.#bt)?e._collapseStreak++:e._collapseStreak=0,e._collapseStreak===e.#ye&&e.#Wn(t,s,o)}catch{}}static#ze(t,n,s){if(typeof s!="function")return;let o=t?.path,i=t?.progress,a=t?.saturationFraction;try{let r=e.#_e(o),c="[EXPLORE]",l=Number.isFinite(r?.unique)?String(r.unique):"0",u=Number.isFinite(r?.pathLen)?String(r.pathLen):"0",p=Number.isFinite(r?.ratio)?r.ratio.toFixed(3):"0.000",h=Number.isFinite(i)?i.toFixed(1):"0.0",d=Number.isFinite(a)?a.toFixed(3):"0.000";s(`${c} gen=${n} unique=${l} pathLen=${u} ratio=${p} progress=${h} satFrac=${d}
`)}catch{}}static#qe(t,n,s){if(typeof s=="function"&&!(!t||!Array.isArray(t.population)))try{let o=e.#Ee(t),i="[DIVERSITY]",a=Number.isFinite(o?.speciesUniqueCount)?String(o.speciesUniqueCount):"0",r=Number.isFinite(o?.simpson)?o.simpson.toFixed(3):"0.000",c=Number.isFinite(o?.wStd)?o.wStd.toFixed(3):"0.000";s(`${i} gen=${n} species=${a} simpson=${r} weightStd=${c}
`)}catch{}}static#Ve(t,n,s,o,i,a,r,c,l,u){if(!(!t||typeof t.writeFileSync!="function"||!n||typeof n.join!="function"||!s||!Number.isFinite(a)||a<=0)&&!(!Number.isFinite(i)||i%a!==0)&&!(!r||!Array.isArray(r.population)||r.population.length===0))try{let p=e.#R?e.#L():0,h=e.#K;h.generation=i,h.bestFitness=c,h.simplifyMode=!!l,h.plateauCounter=Number.isFinite(u)?u:0,h.timestamp=Date.now(),h.telemetryTail=e.#Ye(r,5);let d=r.population??e.#t,f=e.#$e(d)??e.#t,m=Math.max(0,Math.floor(Number.isFinite(o)?o:0)),b=Math.min(m,f.length),g=e.#rt;g.length<b&&(g.length=b);for(let A=0;A<b;A++){let N=g[A]??(g[A]={}),v=d[f[A]];N.idx=f[A],N.score=v?.score,N.nodes=v?.nodes?.length??0,N.connections=v?.connections?.length??0,N.json=typeof v?.toJSON=="function"?v.toJSON():void 0}g.length=b,h.top=g;let y=n.join(s,`snapshot_gen${i}.json`);t.writeFileSync(y,JSON.stringify(h)),e.#R&&e.#nt("snapshot",e.#L()-p||0)}catch{}}static#Ye(t,n=10){if(!t||typeof t.getTelemetry!="function")return;let s=Number.isFinite(n)?Math.max(0,Math.floor(n)):10;try{let o=t.getTelemetry?.();return Array.isArray(o)?e.#Pe(o,s):o}catch{return}}static#Xe(t){let n=t?.length||0;if(n<2)return 0;let s=0,o=0,i=-1,a=e.#C,r=a===4;for(let c=0;c<n;c++){let l=t[c];if(!l||l.length===0)continue;let u;if(r&&l.length>=4){let p=l[0];u=0;let h=l[1];h>p&&(p=h,u=1);let d=l[2];d>p&&(p=d,u=2),l[3]>p&&(u=3)}else{u=0;let p=l[0];for(let h=1;h<a&&h<l.length;h++){let d=l[h];d>p&&(p=d,u=h)}}i!==-1&&(o++,i===u&&s++),i=u}return o?s/o:0}static#Re(t,n){if(!t||!t.length)return 0;let s=Math.min(t.length,n.length);if(s<=1)return 0;if(s===4){let c=t[0]||0,l=t[1]||0,u=t[2]||0,p=t[3]||0,h=c;l>h&&(h=l),u>h&&(h=u),p>h&&(h=p);let d=Math.exp(c-h),f=Math.exp(l-h),m=Math.exp(u-h),b=Math.exp(p-h),g=d+f+m+b||1,y=d/g,A=f/g,N=m/g,v=b/g,w=0;return y>0&&(w+=-y*Math.log(y)),A>0&&(w+=-A*Math.log(A)),N>0&&(w+=-N*Math.log(N)),v>0&&(w+=-v*Math.log(v)),w*e.#Z}let o=-1/0;for(let c=0;c<s;c++){let l=t[c]||0;l>o&&(o=l)}let i=0;for(let c=0;c<s;c++){let l=Math.exp((t[c]||0)-o);n[c]=l,i+=l}i||(i=1);let a=0;for(let c=0;c<s;c++){let l=n[c]/i;l>0&&(a+=-l*Math.log(l))}let r=Math.log(s);return r>0?a/r:0}static#Le(t,n,s=3){if(!t)return"";let o=t.length>>>0;if(!Number.isFinite(n)||n<=0||o===0)return"";let i=n>o?o:n,a=s;if(Number.isFinite(a)||(a=0),a<0?a=0:a>20&&(a=20),i>e.#O.length){let u=1<<Math.ceil(Math.log2(i));e.#O=new Array(u)}let r=e.#O;for(let u=0;u<i;u++){let p=t[u]??0;r[u]=Number.isFinite(p)?p.toFixed(a):"NaN"}let c=r.length;r.length=i;let l=r.join(",");return r.length=c,l}static#Pe(t,n){if(!Array.isArray(t)||t.length===0||!Number.isFinite(n)||n<=0)return[];let s=Math.floor(n),o=s>=t.length?t.length:s;if(o===0)return[];if(o>e.#x.length){let r=1<<Math.ceil(Math.log2(o));e.#x=new Array(r)}let i=e.#x,a=t.length-o;for(let r=0;r<o;r++)i[r]=t[a+r];return i.length=o,i}static#Je(t,n,s){return z.pushHistory(t,n,s)}static#Ke(t){try{let n=t?.nodes??e.#t,s=n.length|0;if(s===0)return;let o=0;for(let l=0;l<s;l++){let u=n[l];u&&u.type==="output"&&(e.#b[o++]=l)}if(o===0)return;let i=0,a=0;for(let l=0;l<o;l++){let u=e.#b[l],p=Number(n[u].bias)||0,h=l+1,d=p-i;i+=d/h,a+=d*(p-i)}let r=o?Math.sqrt(a/o):0,c=e.#le;for(let l=0;l<o;l++){let u=e.#b[l],h=(Number(n[u].bias)||0)-i;h>c?h=c:h<-c&&(h=-c),n[u].bias=h}t._outputBiasStats={mean:i,std:r}}catch{}}static#Ze(t,n,s){try{if(!t||!Array.isArray(t.connections))return;let o=Number.isFinite(s)?s:0;if(o<=0)return;let i=t.connections,a=e.#Qe(i),r=a.length;if(r===0)return;let c=o>=1?1:o<0?0:o,l=Math.floor(r*c);if(c>0&&l===0&&(l=1),l<=0)return;a=e.#en(a,n),e.#sn(a,Math.min(l,a.length))}catch{}}static#Qe(t){if(!Array.isArray(t)||t.length===0)return[];let n=e.#M;n.length=0;for(let s=0;s<t.length;s++){let o=t[s];o&&o.enabled!==!1&&n.push(o)}return n}static#tn(t,n,s){if(!t||!t.connections||!Array.isArray(n)||n.length===0||!Number.isFinite(s)||s<=0)return[];let o=e.#b.length,i=Math.min(s|0,o,n.length);if(i<=0)return[];let a=e.#w;a.length=0;let r=t.connections.out??e.#t;for(let c=0;c<r.length;c++){let l=r[c];if(!(!l||l.enabled===!1))for(let u=0;u<i;u++){let p=e.#b[u],h=n[p];if(l.to===h){a.push(l);break}}}return a}static#en(t,n){if(!Array.isArray(t)||t.length===0)return t;if(n==="weakRecurrentPreferred"){let s=0;for(let o=0;o<t.length;o++){let i=t[o];if(i&&(i.from===i.to||i.gater)){if(o!==s){let a=t[s];t[s]=t[o],t[o]=a}s++}}return e.#Vt(t,0,s),e.#Vt(t,s,t.length),t}return e.#Vt(t,0,t.length),t}static#Vt(t,n,s){if(!Array.isArray(t)||t.length===0)return;let o=t.length,i=Number.isFinite(n)?n|0:0,a=Number.isFinite(s)?s|0:0;if(i<0&&(i=0),a>o&&(a=o),!(a-i<2))for(let r=i+1;r<a;r++){let c=t[r],l=Math.abs(c&&Number.isFinite(c.weight)?c.weight:0),u=r-1;for(;u>=i;){let p=t[u];if(Math.abs(p&&Number.isFinite(p.weight)?p.weight:0)<=l)break;t[u+1]=p,u--}t[u+1]=c}}static#nn=64;static#sn(t,n){if(!Array.isArray(t)||!t.length||!Number.isFinite(n)||n<=0)return;let s=t.length;n>=s&&(n=s);let o=e.#c;s>o.length?(e.#c=new Uint8Array(s),o=e.#c):o.fill(0,0,s);let i=0;for(let c=0;c<s;c++){let l=t[c];l&&l.enabled!==!1&&(c!==i&&(t[i]=l),i++)}if(i===0)return;if(n>=i&&(n=i),n>=i>>>1){i<=e.#nn?e.#Vt(t,0,i):t.slice(0,i).sort((l,u)=>Math.abs(l?.weight||0)-Math.abs(u?.weight||0)).forEach((l,u)=>{t[u]=l});let c=n;for(let l=0;l<c;l++){let u=t[l];u&&u.enabled!==!1&&(u.enabled=!1)}return}let a=n,r=i;for(;a>0&&r>0;){let c=0,l=Math.abs(t[0]&&Number.isFinite(t[0].weight)?t[0].weight:0);for(let h=1;h<r;h++){let d=t[h],f=Math.abs(d&&Number.isFinite(d.weight)?d.weight:0);f<l&&(l=f,c=h)}let u=t[c];u&&u.enabled!==!1&&(u.enabled=!1);let p=--r;t[c]=t[p],a--}}static#on(t){if(!Array.isArray(t)||t.length<2)return{entropyNorm:0,uniqueMoves:0,pathLen:t?.length|0};let n=e.#a??new Int32Array(4),s=n.length;for(let h=0;h<s;h++)n[h]=0;let o=0,i=e.#xe;for(let h=1;h<t.length;h++){let d=t[h],f=t[h-1];if(!d||!f)continue;let m=(Number.isFinite(d[0])?d[0]:0)-(Number.isFinite(f[0])?f[0]:0),b=(Number.isFinite(d[1])?d[1]:0)-(Number.isFinite(f[1])?f[1]:0);if(m<-1||m>1||b<-1||b>1)continue;let g=(m+1)*3+(b+1),y=i[g];Number.isFinite(y)&&y>=0&&y<s&&(n[y]=(n[y]|0)+1,o++)}if(o===0)return{entropyNorm:0,uniqueMoves:0,pathLen:t.length};let a=0,r=0,c=1/o,l=e.#Z??1/Math.log(4),u=Math.min(4,s);for(let h=0;h<u;h++){let d=n[h];if(d>0){let f=d*c;a+=-f*Math.log(f),r++}}return{entropyNorm:a*l,uniqueMoves:r,pathLen:t.length}}static#in(t){if(!Array.isArray(t)||t.length===0)return{meansStr:"",stdsStr:"",kurtStr:"",entMean:0,stability:0,steps:0,means:e.#e,stds:e.#s};let n=e.#H,s=Math.max(0,e.#C),o=t.length;e.#an(s,n);let i=0;n?(i=e.#rn(t,s),e.#un(s,o)):s===4?(i=e.#cn(t,o),e.#Fe(s,o)):(i=e.#ln(t,s),e.#Fe(s,o));let a=i/o,r=e.#Xe(t),c=e.#Le(e.#e,s,3),l=e.#Le(e.#s,s,3),u=n?"":e.#Le(e.#o,s,2);return{meansStr:c,stdsStr:l,kurtStr:u,entMean:a,stability:r,steps:o,means:e.#e,stds:e.#s}}static#an(t,n){let s=Number.isFinite(t)?Math.max(0,Math.floor(t)):0;if(s===0)return;(!e.#e||e.#e.length<s)&&(e.#e=new Float64Array(s)),(!e.#i||e.#i.length<s)&&(e.#i=new Float64Array(s)),(!e.#s||e.#s.length<s)&&(e.#s=new Float64Array(s));let o=e.#e,i=e.#i,a=e.#s;o.fill(0,0,s),i.fill(0,0,s),a.fill(0,0,s),n||((!e.#l||e.#l.length<s)&&(e.#l=new Float64Array(s)),(!e.#p||e.#p.length<s)&&(e.#p=new Float64Array(s)),(!e.#o||e.#o.length<s)&&(e.#o=new Float64Array(s)),e.#l.fill(0,0,s),e.#p.fill(0,0,s),e.#o.fill(0,0,s))}static#rn(t,n){let s=Array.isArray(t)?t.length:0;if(s===0||n<=0)return 0;let o=e.#e,i=e.#i,a=e.#s,r=0;for(let[l,u]of t.entries()){let p=u??e.#t,h=l+1;for(let d=0;d<n;d++){let f=p[d]??0,m=o[d],b=f-m,g=b/h,y=m+g;o[d]=y;let A=f-y;i[d]+=b*A}r+=e.#Re(p,e.#n)}let c=1/s;for(let l=0;l<n;l++){let u=i[l]*c;a[l]=u>0?Math.sqrt(u):0}return r}static#cn(t,n){if(!Array.isArray(t)||n===0)return 0;let s=0,o=0,i=0,a=0,r=0,c=0,l=0,u=0,p=0,h=0,d=0,f=0,m=0,b=0,g=0,y=0,A=0,N=e.#n;for(let k=0;k<n;k++){let F=t[k]??e.#t,M=F[0]??0,T=F[1]??0,D=F[2]??0,E=F[3]??0,R=k+1;{let O=M-s,P=O/R,C=P*P,B=O*P*(R-1);m+=B*C*(R*R-3*R+3)+6*C*r-4*P*p,p+=B*P*(R-2)-3*P*r,r+=B,s+=P}{let O=T-o,P=O/R,C=P*P,B=O*P*(R-1);b+=B*C*(R*R-3*R+3)+6*C*c-4*P*h,h+=B*P*(R-2)-3*P*c,c+=B,o+=P}{let O=D-i,P=O/R,C=P*P,B=O*P*(R-1);g+=B*C*(R*R-3*R+3)+6*C*l-4*P*d,d+=B*P*(R-2)-3*P*l,l+=B,i+=P}{let O=E-a,P=O/R,C=P*P,B=O*P*(R-1);y+=B*C*(R*R-3*R+3)+6*C*u-4*P*f,f+=B*P*(R-2)-3*P*u,u+=B,a+=P}A+=e.#Re(F,N)}let v=e.#e;v[0]=s,v[1]=o,v[2]=i,v[3]=a;let w=1/n,x=r*w,_=c*w,I=l*w,L=u*w,$=e.#s;if($[0]=x>0?Math.sqrt(x):0,$[1]=_>0?Math.sqrt(_):0,$[2]=I>0?Math.sqrt(I):0,$[3]=L>0?Math.sqrt(L):0,!e.#H){let k=e.#o;k[0]=x>1e-18?n*m/(r*r)-3:0,k[1]=_>1e-18?n*b/(c*c)-3:0,k[2]=I>1e-18?n*g/(l*l)-3:0,k[3]=L>1e-18?n*y/(u*u)-3:0}return A}static#ln(t,n){let s=Array.isArray(t)?t.length:0;if(s===0||n<=0)return 0;let o=e.#e??new Float64Array(n),i=e.#i??new Float64Array(n),a=e.#l??(e.#H?void 0:new Float64Array(n)),r=e.#p??(e.#H?void 0:new Float64Array(n)),c=e.#n??new Float64Array(Math.max(4,n)),l=0;for(let u=0;u<s;u++){let p=t[u]??e.#t,h=u+1,d=Math.min(n,o.length);for(let f=0;f<d;f++){let b=(Number.isFinite(p[f])?p[f]:0)-o[f],g=b/h,y=g*g,A=b*g*(h-1);if(!e.#H){let N=i[f],v=a?a[f]:0;r[f]+=A*y*(h*h-3*h+3)+6*y*N-4*g*v,a[f]+=A*g*(h-2)-3*g*N}i[f]+=A,o[f]+=g}l+=e.#Re(p,c)}return l}static#Fe(t,n){let s=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,o=Number.isFinite(n)&&n>0?Math.floor(n):0;if(s===0)return;let i=e.#i??new Float64Array(s),a=e.#p??new Float64Array(s);e.#s||(e.#s=new Float64Array(s));let r=e.#s;e.#o||(e.#o=new Float64Array(s));let c=e.#o,l=o>0?1/o:0,u=1e-18;for(let p=0;p<s;p++){let h=i[p]||0,d=l>0?h*l:0;if(r[p]=d>0?Math.sqrt(d):0,!e.#H){let f=a[p]||0,m=h*h;m>0&&d>u&&o>0?c[p]=o*f/m-3:c[p]=0}}}static#un(t,n){let s=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,o=Number.isFinite(n)&&n>0?Math.floor(n):0;if(s===0)return;let i=e.#i??new Float64Array(s);e.#s||(e.#s=new Float64Array(s));let a=e.#s,r=o>0?1/o:0;for(let c=0;c<s;c++){let l=r>0?i[c]*r:0;a[c]=l>0?Math.sqrt(l):0}}static#hn(t,n){if(!Array.isArray(t)||!Number.isFinite(n)||n<=0)return{mean:0,std:0,biasesStr:""};if(!e.#q||e.#q.length<n){let u=1<<Math.ceil(Math.log2(Math.max(1,n)));e.#q=new Float64Array(u)}let s=e.#q;for(let u=0;u<n;u++){let p=e.#b[u];s[u]=t[p]?.bias??0}let o=0,i=0;for(let u=0;u<n;u++){let p=s[u],h=u+1,d=p-o;o+=d/h,i+=d*(p-o)}let a=n>0?Math.sqrt(i/n):0;if(n>e.#O.length){let u=1<<Math.ceil(Math.log2(Math.max(1,n)));e.#O=new Array(u)}let r=e.#O;for(let u=0;u<n;u++)r[u]=s[u].toFixed(2);let c=r.length;r.length=n;let l=r.join(",");return r.length=c,{mean:o,std:a,biasesStr:l}}static#pn(t,n,s,o){let i=Number.isFinite(n)?Math.max(0,Math.floor(n)):0;if(i<=0)return;let{populationRef:a,sortedIdx:r,parentPoolSize:c}=e.#dn(t,i);if(!Array.isArray(a)||a.length===0||!Number.isFinite(c)||c===0)return;for(let u=0;u<i;u++){let p=Math.floor(e.#v()*c),h=a[r[p]];try{e.#yn(t,h)}catch{}}t.options||(t.options=t.options||{});let l=Array.isArray(t.population)?t.population.length:0;t.options.popsize=l;try{s?.(`[DYNAMIC_POP] Expanded population to ${l} at gen ${o}
`)}catch{}}static#dn(t,n){let s=Array.isArray(t?.population)?t.population:[];if(s.length===0)return{populationRef:s,sortedIdx:[],parentPoolSize:0};let o=e.#$e(s),i=Math.ceil(o.length*e.#se),a=Math.max(2,i),r=Math.min(a,o.length);return{populationRef:s,sortedIdx:o,parentPoolSize:r}}static#fn(){return 1+(e.#v()<e.#ne?1:0)}static#mn(t,n,s){let o=e.#An(n),i=o.length|0;if(i===0)return;if(e.#k.length<i){let l=1<<Math.ceil(Math.log2(i));e.#k=new Uint16Array(l)}let a=e.#k;for(let l=0;l<i;l++)a[l]=l;let r=Math.max(0,Math.floor(s||0)),c=Math.min(r,i);if(c!==0){if(c===1){let l=a[0],u=o[l];typeof t?.mutate=="function"&&t.mutate(u);return}if(c===2){let l=a[0],u=a[1];typeof t?.mutate=="function"&&(t.mutate(o[l]),t.mutate(o[u]));return}for(let l=0;l<c;l++){let u=i-l,p=e.#v()*u|0,h=l+p,d=a[l];a[l]=a[h],a[h]=d;let f=a[l],m=o[f];typeof t?.mutate=="function"&&t.mutate(m)}}}static#De(t,n,s){if(!(!t||!n))try{if(typeof t.addGenome=="function"){t.addGenome(n,[s]);return}if(Array.isArray(t.population)||(t.population=[]),typeof t._invalidateGenomeCaches=="function")try{t._invalidateGenomeCaches(n)}catch{}t.population.push(n);return}catch{try{t&&!Array.isArray(t.population)&&(t.population=[]),t?.population?.push(n)}catch{}}}static#yn(t,n){if(!t||!n)return;let s=e.#fn();if(typeof t.spawnFromParent=="function")try{let o=t.spawnFromParent(n,s);if(o){e.#De(t,o,n?._id);return}}catch{}try{let o=typeof n.clone=="function"?n.clone():n;try{e.#mn(o,t,s)}catch{}try{o.score=void 0}catch{}e.#De(t,o,n?._id)}catch{}}static#$e(t){let n=t.length|0;if(n===0)return[];let s=!1,o=e.#E;if(o&&o.length>=n)s=!0;else if(!o&&n>512){let c=1<<Math.ceil(Math.log2(n));e.#E=new Int32Array(c),s=!0}if(e.#g.length<n){let c=1<<Math.ceil(Math.log2(n));e.#g=new Array(c)}let i=s?e.#E:e.#g;for(let c=0;c<n;c++)i[c]=c;s||(e.#g.length=n);let a=e.#S;a.length<2&&(a=e.#S=new Int32Array(128));let r=0;for(a[r++]=0,a[r++]=n-1;r>0;){let c=a[--r],l=a[--r];if(l>=c)continue;if(c-l<=e.#we){e.#gn(i,l,c,t);continue}let u=l,p=c,h=e.#bn(i,l,c,t);for(;u<=p;){for(;;){let m=i[u];if((t[m]?.score??-1/0)<=h)break;u++}for(;;){let m=i[p];if((t[m]?.score??-1/0)>=h)break;p--}if(u<=p){let m=i[u];i[u]=i[p],i[p]=m,u++,p--}}let d=p-l,f=c-u;d>f?(l<p&&(r=e.#Yt(r,l,p),a=e.#S),u<c&&(r=e.#Yt(r,u,c),a=e.#S)):(u<c&&(r=e.#Yt(r,u,c),a=e.#S),l<p&&(r=e.#Yt(r,l,p),a=e.#S))}if(s){e.#g.length<n&&(e.#g=new Array(1<<Math.ceil(Math.log2(n))));let c=e.#g,l=e.#E;for(let u=0;u<n;u++)c[u]=l[u];return c.length=n,c}return e.#g.length=n,e.#g}static#gn(t,n,s,o){if(!t||n>=s)return;let i=o??e.#t,a=r=>i[r]?.score??Number.NEGATIVE_INFINITY;for(let r=n+1;r<=s;r++){let c=t[r],l=a(c),u=r-1;for(;u>=n&&a(t[u])<l;)t[u+1]=t[u],u--;t[u+1]=c}}static#bn(t,n,s,o){let i=n+s>>1,a=t[n],r=t[i],c=t[s],l=o??e.#t,u=l[a]?.score??Number.NEGATIVE_INFINITY,p=l[r]?.score??Number.NEGATIVE_INFINITY,h=l[c]?.score??Number.NEGATIVE_INFINITY;if(u>p){let d=u;u=p,p=d}if(p>h){let d=p;if(p=h,h=d,u>p){let f=u;u=p,p=f}}return p}static#Yt(t,n,s){let o=e.#S,i=t+2;if(i>o.length){let a=Math.max(o.length<<1,4);for(;a<i;)a<<=1;let r=new Int32Array(a);r.set(o),e.#S=o=r}return o[t++]=n|0,o[t++]=s|0,t}static#Ct=null;static#q=new Float64Array(0);static#An(t){try{if(!t)return e.#t;let n=t?.options?.mutation;if(n&&e.#Ct!==n)if(Array.isArray(n))e.#Ct=n;else if(n&&typeof n=="object"){let s=n.length;Number.isFinite(s)&&s>=0?e.#Ct=n:e.#Ct=Object.values(n)}else e.#Ct=e.#t;return e.#Ct??e.#t}catch{return e.#t}}static#Sn(t){try{if(!t)return;let n=Array.isArray(t.population)?t.population:e.#t;for(let s=0;s<n.length;s++){let o=n[s];if(!o)continue;let i=Array.isArray(o.nodes)?o.nodes:e.#t;for(let a=0;a<i.length;a++){let r=i[a];r&&r.type==="output"&&(r.squash=nt.Activation.identity)}}}catch{}}static#Nn(t){try{e._speciesHistory=e._speciesHistory??e.#t;let n=Array.isArray(t?.population)?t.population:e.#t,s=e.#h,o=e.#d;if(n.length>s.length){let u=1<<Math.ceil(Math.log2(n.length||1));e.#h=new Int32Array(u),e.#d=new Int32Array(u),s=e.#h,o=e.#d}let i=0;for(let u=0;u<n.length;u++){let p=n[u];if(!p||p.species==null)continue;let h=p.species|0,d=-1;for(let f=0;f<i;f++)if(s[f]===h){d=f;break}d===-1?(s[i]=h,o[i]=1,i++):o[d]++}let a=i||1;e._speciesHistory=e.#Je(e._speciesHistory,a,e.#me);let r=e._speciesHistory??e.#t,c=e.#Pe(r,e.#zt),l=c.length===e.#zt&&c.every(u=>u===1);if(l){let u=t;typeof u.mutationRate=="number"&&(u.mutationRate=Math.min(e.#ge,u.mutationRate*e.#Se)),typeof u.mutationAmount=="number"&&(u.mutationAmount=Math.min(e.#be,u.mutationAmount*e.#Ne)),u.config&&u.config.novelty&&(u.config.novelty.blendFactor=Math.min(e.#Ae,u.config.novelty.blendFactor*e.#ve))}return l}catch{return!1}}static#vn(t,n,s,o,i,a,r,c,l,u){try{if(!n||s<=0)return;let p=Array.isArray(t?.population)?t.population:e.#t,h=Number.isFinite(o)?Math.max(0,o|0):0;if(p.length>=h)return;let d=Number.isFinite(i)&&i>0?i|0:0,f=d>0?Math.min(1,(a|0)/d):0,m=Number.isFinite(r)&&r>0?Math.max(1,r|0):0;if(m===0||!((s|0)%m===0))return;let g=Number.isFinite(l)?l:0;if(f<g)return;let y=p.length|0,A=Number.isFinite(c)?Math.max(0,c):0,N=Math.floor(Math.max(1,y*A)),v=Math.max(0,h-y),w=Math.min(N,v);w>0&&e.#pn(t,w,u,s|0)}catch{}}static async#wn(t,n,s,o,i,a,r){let c=a,l=r;if(c?.update&&typeof c.update=="function")try{c.update(t,n,s,o,i)}catch{}if(typeof l=="function")try{await l()}catch{}}static async#xn(t,n,s,o,i,a,r){let c=a,l=c?.update,u=r;if(!(typeof l!="function"||!s||!n)){try{l.call(c,t,n,s,o,i)}catch{}if(typeof u=="function")try{await u()}catch{}}}static#_n(t){try{if(!t)return;let n=t.nodes??e.#t,s=e.#at(n,"output");if(s<=0)return;let o=e.#q;if(o.length<s){let u=o.length||1;for(;u<s;)u<<=1;o=e.#q=new Float64Array(u)}let i=0,a=0;for(let u=0;u<s;u++){let p=e.#b[u],h=n[p]?.bias??0;o[u]=h;let d=u+1,f=h-i;i+=f/d,a+=f*(h-i)}let r=s>0?Math.sqrt(a/s):0,c=e.#oe,l=e.#ie;for(let u=0;u<s;u++){let p=e.#b[u],h=o[u]-i;r<c&&(h*=l),n[p].bias=Math.max(-5,Math.min(5,h))}}catch{}}static#Mn(){let t=[],n=e.#Gt,s=e.#It,o=[[n,s,s,s],[s,n,s,s],[s,s,n,s],[s,s,s,n]],i=(r,c,l,u,p,h)=>[r,c,l,u,p,h],a=(r,c)=>t.push({input:r,output:o[c]});a(i(0,1,0,0,0,e.#it),0),a(i(.25,0,1,0,0,e.#it),1),a(i(.5,0,0,1,0,e.#it),2),a(i(.75,0,0,0,1,e.#it),3),a(i(0,1,0,0,0,e.#Dt),0),a(i(.25,0,1,0,0,e.#Dt),1),a(i(0,1,.6,0,0,e.#j),0),a(i(0,1,0,.6,0,e.#j),0),a(i(.25,.6,1,0,0,e.#j),1),a(i(.25,0,1,.6,0,e.#j),1),a(i(.5,0,.6,1,0,e.#j),2),a(i(.5,0,0,1,.6,e.#j),2),a(i(.75,0,0,.6,1,e.#j),3),a(i(.75,.6,0,0,1,e.#j),3),a(i(0,1,.8,.5,.4,e.#G),0),a(i(.25,.7,1,.6,.5,e.#G),1),a(i(.5,.6,.55,1,.65,e.#G),2),a(i(.75,.5,.45,.7,1,e.#G),3),a(i(0,1,.3,0,0,e.#U),0),a(i(.25,.5,1,.4,0,e.#U),1),a(i(.5,0,.3,1,.2,e.#U),2),a(i(.75,0,.5,.4,1,e.#U),3),a(i(0,0,0,e.#Et,0,e.#$t),2);for(let r=0;r<t.length;r++){let c=t[r];for(let l=1;l<=4;l++)c.input[l]===1&&e.#v()<e.#ee&&(c.input[l]=e.#ue+e.#v()*e.#he);e.#v()<e.#Bt&&(c.input[5]=Math.min(1,Math.max(0,c.input[5]+(e.#v()*e.#Wt-e.#ke))))}return t}static#In(t,n){if(!t)return;let s=t.population??e.#t;if(!(!Array.isArray(s)||s.length===0))for(let o=0;o<s.length;o++){let i=s[o];try{if(!i||typeof i.train!="function")continue;let a=Math.min(e.#jt,e.#pe+Math.floor((n?.length||0)/2));i.train(n,{iterations:a,error:e.#I,rate:e.#Ut,momentum:e.#z,batchSize:e.#de,allowRecurrent:!0,cost:nt.Cost.softmaxCrossEntropy});try{e.#Te(i)}catch{}try{e.#Ke(i)}catch{}}catch{}}}static#En(){let t=()=>new Promise(i=>globalThis.requestAnimationFrame?globalThis.requestAnimationFrame(()=>i()):setTimeout(()=>i(),0)),n=()=>new Promise(i=>typeof setImmediate=="function"?setImmediate(i):setTimeout(i,0)),s=()=>new Promise(i=>setTimeout(i,0)),o=typeof globalThis.requestAnimationFrame=="function"?t:typeof setImmediate=="function"?n:s;return async()=>{for(;;)if(await o(),!globalThis.asciiMazePaused)return}}static#Cn(t){let n=null,s=null;try{let o=globalThis.require??(typeof zt=="function"?zt:null);if(o)try{n=o("fs"),s=o("path")}catch{}}catch{}if(n&&typeof n.existsSync=="function"&&t)try{n.existsSync(t)||typeof n.mkdirSync=="function"&&n.mkdirSync(t,{recursive:!0})}catch{}return{fs:n,path:s}}static#Tn(t){let n=(()=>{try{return typeof process<"u"&&process&&process.stdout&&typeof process.stdout.write=="function"}catch{return!1}})(),s=(()=>{try{return t&&t.logFunction?t.logFunction.bind(t):null}catch{return null}})();return o=>{if(!(!o&&o!=="")){if(n)try{process.stdout.write(o);return}catch{}if(s)try{s(o);return}catch{}try{typeof console<"u"&&typeof console.log=="function"&&console.log(o.trim())}catch{}}}}static#On(t,n,s,o){let i=o??{},a=Number.isFinite(i.popSize)?i.popSize:e.#Lt,r=Array.isArray(i.mutation)?i.mutation:[nt.mutation.ADD_NODE,nt.mutation.SUB_NODE,nt.mutation.ADD_CONN,nt.mutation.SUB_CONN,nt.mutation.MOD_BIAS,nt.mutation.MOD_ACTIVATION,nt.mutation.MOD_CONNECTION,nt.mutation.ADD_LSTM_NODE],c=Math.max(1,Math.floor(a*e.#wt)),l=Math.max(1,Math.floor(a*e.#xt)),u=i.allowRecurrent!==!1,p=i.adaptiveMutation??{enabled:!0,strategy:"twoTier"},h=i.multiObjective??{enabled:!0,complexityMetric:"nodes",autoEntropy:!0},d=i.telemetry??{enabled:!0,performance:!0,complexity:!0,hypervolume:!0},f=i.lineageTracking===!0,m=i.novelty??{enabled:!0,blendFactor:.15},b=i.targetSpecies??e.#u,g=i.adaptiveTargetSpecies??{enabled:!0,entropyRange:e.#Qt,speciesRange:[6,14],smooth:e.#te};return new $t(t,n,s,{popsize:a,mutation:r,mutationRate:e.#vt,mutationAmount:e.#T,elitism:c,provenance:l,allowRecurrent:u,minHidden:e.#Pt,adaptiveMutation:p,multiObjective:h,telemetry:d,lineageTracking:f,novelty:m,targetSpecies:b,adaptiveTargetSpecies:g})}static#Rn(t,n,s,o){if(t)try{if(Array.isArray(n)&&n.length>0){let i=n.length,a=e.#P;(!Array.isArray(a)||a.length<i)&&(a=new Array(i),e.#P=a);for(let r=0;r<i;r++){let c=n[r];try{a[r]=c&&typeof c.clone=="function"?c.clone():c}catch{a[r]=c}}a.length=i,t.population=a}if(s){Array.isArray(t.population)||(t.population=[]);try{t.population[0]=typeof s.clone=="function"?s.clone():s}catch{}}try{t.options=t.options||{},t.options.popsize=Array.isArray(t.population)?t.population.length:o}catch{}}catch{try{t.options=t.options||{},t.options.popsize=Array.isArray(t.population)?t.population.length:o}catch{}}}static#Ln(t,n){try{let s=t?.cancellation;if(s&&typeof s.isCancelled=="function"&&s.isCancelled())return n&&(n.exitReason="cancelled"),"cancelled";if(t?.signal?.aborted)return n&&(n.exitReason="aborted"),"aborted"}catch{}}static#Pn(t,n){if(!Array.isArray(t)||n<=0)return 0;let s=Math.floor(n),o=t.length|0;if(o===0)return 0;let i=e.#r;if(Array.isArray(i)||(i=e.#r=[]),i.length<s){let u=i.length>0?i.length:1;for(;u<s;)u<<=1;let p=new Array(u);for(let h=0;h<i.length;h++)p[h]=i[h];e.#r=p,i=p}let a=Math.min(s,i.length),r=0,c=e.#v,l=a&-4;for(;r<l;)i[r++]=t[c()*o|0],i[r++]=t[c()*o|0],i[r++]=t[c()*o|0],i[r++]=t[c()*o|0];for(;r<a;)i[r++]=t[c()*o|0];return a}static#kn(t,n,s){if(!Array.isArray(t)||s<=0)return 0;let o=t.length|0,i=Math.max(0,n|0);if(i>=o)return 0;let a=o-i;if(a<=0)return 0;let r=Math.max(0,Math.floor(s));if(r===0)return 0;let c=Array.isArray(e.#r)?e.#r:e.#r=[];if(c.length<r){let f=c.length>0?c.length:1;for(;f<r;)f<<=1;let m=new Array(f);for(let b=0;b<c.length;b++)m[b]=c[b];e.#r=m,c=m}let l=Math.min(r,c.length),u=e.#v,p=i,h=l&-4,d=0;for(;d<h;)c[d++]=t[p+(u()*a|0)],c[d++]=t[p+(u()*a|0)],c[d++]=t[p+(u()*a|0)],c[d++]=t[p+(u()*a|0)];for(;d<l;)c[d++]=t[p+(u()*a|0)];return l}static async#Fn(t,n,s,o,i,a,r,c,l,u,p,h,d,f){let m=!!n,b=()=>e.#B(),g=m?b():0,y=null,A=0,N=0;try{y=await t?.evolve(),m&&(A=b()-g)}catch(v){try{a?.(`#runGeneration: evolve() threw: ${String(v)}`)}catch{}}try{e.#Sn(t)}catch(v){try{a?.(`#runGeneration: ensureOutputIdentity failed: ${String(v)}`)}catch{}}try{e.#Nn(t)}catch(v){try{a?.(`#runGeneration: handleSpeciesHistory failed: ${String(v)}`)}catch{}}try{e.#vn(t,!!c,r,l,u,p,h,d,f,a)}catch(v){try{a?.(`#runGeneration: maybeExpandPopulation failed: ${String(v)}`)}catch{}}try{Number.isFinite(s)&&s>0&&Array.isArray(o)&&o.length>0&&(N=e.#Ge(t,o,s,i,a,n,r))}catch(v){try{a?.(`#runGeneration: applyLamarckianTraining failed: ${String(v)}`)}catch{}}return{fittest:y,tEvolve:A,tLamarck:N}}static#Dn(t,n,s,o){if(!Number.isFinite(t))return{plateauCounter:s,lastBestFitnessForPlateau:n};let i=Number.isFinite(n)?n:-1/0,a=Number.isFinite(o)&&o>0?o:0,r=Number.isFinite(s)&&s>=0?Math.floor(s):0;return t>i+a?(n=t,r=0,{plateauCounter:r,lastBestFitnessForPlateau:n}):(r=Math.min(536870911,r+1),{plateauCounter:r,lastBestFitnessForPlateau:i})}static#$n(t,n,s,o,i,a,r,c){let l=Number.isFinite(n)&&n>=0?Math.floor(n):0,u=Number.isFinite(s)&&s>0?Math.floor(s):0,p=Number.isFinite(o)&&o>0?Math.floor(o):0,h=Number.isFinite(a)&&a>0?Math.floor(a):0,d=!!i;if(!d)try{let f=e.#Oe(l,u,p);Number.isFinite(f)&&f>0&&(d=!0,h=Math.floor(f),l=0)}catch{}if(d)try{h=e.#He(t,h,r,c),(!Number.isFinite(h)||h<=0)&&(d=!1,h=0)}catch{d=!1,h=0}return{simplifyMode:d,simplifyRemaining:h,plateauCounter:l}}static#Hn(t,n,s,o,i,a,r,c,l,u,p){let h=r?e.#B():0,d=Ut.simulateAgent(t,n,s,o,i,a);try{t._lastStepOutputs||(t._lastStepOutputs=e.#pt)}catch{}try{t._saturationFraction=d?.saturationFraction??0,t._actionEntropy=d?.actionEntropy??0}catch{}try{let m=d?.stepOutputs;if(Array.isArray(m)&&m.length>0){e.#Ot(m.length);let b=e.#$&&e.#V&&e.#Y,g=e.#C;if(b){let y=e.#V,A=e.#Y,N=e.#D-1;for(let v=0;v<m.length;v++){let w=m[v];if(!Array.isArray(w))continue;let _=(Atomics.load(A,0)&N)*g,I=Math.min(g,w.length);for(let L=0;L<I;L++)y[_+L]=w[L]??0;Atomics.store(A,0,Atomics.load(A,0)+1&2147483647)}}else{let y=e.#D-1;for(let A=0;A<m.length;A++){let N=m[A];if(!Array.isArray(N))continue;let v=e.#tt&y,w=e.#pt[v],x=Math.min(g,N.length);for(let _=0;_<x;_++)w[_]=N[_]??0;e.#tt=e.#tt+1&2147483647}}}}catch{}try{d?.saturationFraction&&d.saturationFraction>e.#Jt&&e.#Bn(t)}catch{}try{!e.#ft&&l>0&&u%l===0&&e.#Be(p,t,d,u,c)}catch{}let f=r?e.#B()-h:0;return{generationResult:d,simTime:f}}static async#Gn(t,n,s,o,i,a,r,c,l,u,p,h,d){let f=!!t,m=!u;if(t?.success&&t.progress>=(c??0)){try{a?.update?.(s,t,n,o,i)}catch{}try{await r?.()}catch{}if(l)try{if(typeof window<"u"){window.asciiMazePaused=!0;try{window.dispatchEvent(new CustomEvent("asciiMazeSolved",{detail:{maze:s,generations:o,progress:t?.progress}}))}catch{}}}catch{}return f&&(t.exitReason="solved"),"solved"}if(m&&isFinite(h)&&p>=h){try{a?.update?.(s,t,n,o,i)}catch{}try{await r?.()}catch{}return f&&(t.exitReason="stagnation"),"stagnation"}if(m&&isFinite(d)&&o>=d)return f&&(t.exitReason="maxGenerations"),"maxGenerations"}static#Bn(t){try{let n=e.#R?e.#L():0,s=t?.nodes??e.#t,o=e.#at(s,"output"),i=e.#at(s,"hidden"),a=e.#n,r=e.#b;for(let c=0;c<i;c++){let l=s[Number(e.#b[o+c])];if(!l)continue;let u=e.#tn(l,s,o)||[],p=u.length;if(p<2)continue;let h=p;if(!a||a.length<h){let g=1;for(;g<h;)g<<=1;a=new Float64Array(g),e.#n=a}let d=Math.min(p,a.length);for(let g=0;g<d;g++){let y=u[g];a[g]=Math.abs(y?.weight)||0}let f=0,m=0;for(let g=0;g<d;g++){let y=a[g],A=g+1,N=y-f;f+=N/A,m+=N*(y-f)}let b=d?m/d:0;if(f<.5&&b<e.#Kt){let g=Math.max(1,Math.floor(p/2));for(let y=0;y<p;y++)r[y]=0;for(let y=0;y<g;y++){let A=-1,N=1/0;for(let v=0;v<p;v++){if(r[v])continue;let w=u[v];if(!w||w.enabled===!1){r[v]=1;continue}let x=Math.abs(w.weight)||0;x<N&&(N=x,A=v)}if(A>=0)u[A].enabled=!1,r[A]=1;else break}for(let y=0;y<p;y++)r[y]=0}}e.#R&&e.#nt("prune",e.#L()-n||0)}catch{}}static#Wn(t,n,s){try{let o=t??null;if(!o)return;let i=Number.isFinite(o?.options?.elitism)?Math.max(0,Math.floor(o.options.elitism)):0,a=Array.isArray(o.population)?o.population:e.#t,r=i,c=Math.max(0,a.length-r);if(c===0)return;let u=Math.floor(c*.3)||1,p=e.#r;Array.isArray(p)||(p=e.#r=[]);let h=e.#kn(a,r,u);if(h<=0)return;let d=0,f=0;for(let m=0;m<h;m++){let b=p[m];if(b)try{let{connReset:g,biasReset:y}=e.#jn(b)||{connReset:0,biasReset:0};d+=Number(g)||0,f+=Number(y)||0}catch{}}try{s(`[ANTICOLLAPSE] gen=${n} reinitGenomes=${h} connReset=${d} biasReset=${f}
`)}catch{}}catch{}}static#jn(t){try{let n=Array.isArray(t?.nodes)?t.nodes:[],s=e.#r;Array.isArray(s)||(s=e.#r=[]);let o=n.length;if(s.length<o){let u=Math.max(1,s.length);for(;u<o;)u<<=1;s.length=u}let i=0;for(let u of n)u&&u.type==="output"&&(s[i++]=u);let a=0,r=Number(e.#Mt)||0;for(let u=0;u<i;u++){let p=s[u];p&&(p.bias=e.#v()*(2*r)-r,a++)}let c=0,l=Array.isArray(t?.connections)?t.connections:[];if(l.length>0&&i>0){let u=new Set;for(let h=0;h<i;h++){let d=s[h];d&&u.add(d)}let p=Number(e.#Ft)||0;for(let h of l)try{u.has(h?.to)&&(h.weight=e.#v()*(2*p)-p,c++)}catch{}}return{connReset:c,biasReset:a}}catch{return{connReset:0,biasReset:0}}}static#Un(t){try{let n=Array.isArray(t?.connections)?t.connections:[],s=n.length;if(s===0)return 0;let o=0;for(let a=0;a<s;a++){let r=n[a];r&&r.enabled!==!1&&(a!==o&&(n[o]=r),o++)}let i=s-o;return i>0&&(n.length=o),i}catch{return 0}}static#zn(t){try{let n=Array.isArray(t?.population)?t.population:[],s=n.length;if(s===0)return 0;let o=e.#r;if(Array.isArray(o)||(o=e.#r=[]),o.length<s){let a=Math.max(1,o.length);for(;a<s;)a<<=1;o.length=a}let i=0;for(let a=0;a<s;a++)try{let r=n[a],c=e.#Un(r)|0;o[a]=c,i+=c}catch{o[a]=0}return i}catch{return 0}}static#qn(t){try{let n=Array.isArray(t?.population)?t.population.length:0;if(!n)return;let s=8,a=(r=>1<<Math.ceil(Math.log2(Math.max(1,r))))(Math.max(8,n));try{let r=e.#g;Array.isArray(r)&&r.length>n*s&&(e.#g=new Array(a))}catch{}try{let r=e.#r;Array.isArray(r)||(r=e.#r=[]),r.length>n*s&&(r.length=a,e.#r=r)}catch{}try{let r=e.#n;if(r instanceof Float64Array&&r.length>n*s){let c=a,l=new Float64Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#n=l}}catch{}try{let r=e.#q;if(r instanceof Float64Array&&r.length>n*s){let c=a,l=new Float64Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#q=l}}catch{}try{let r=e.#b;if(r instanceof Int32Array&&r.length>n*s){let c=a,l=new Int32Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#b=l}}catch{}}catch{}}static async runMazeEvolution(t){let n=e.#Zn(t),{encodedMaze:s,startPosition:o,exitPosition:i,distanceMap:a,inputSize:r,outputSize:c,fitnessContext:l}=e.#Qn(n),u=e.#Yn(n,r,c,l);e.#ts(n.popSize,r,c);let p=e.#Mn();e.#Xn(u,p);let h=e.#Jn(n),d=typeof process<"u"&&typeof process.env<"u"&&process.env.ASCII_MAZE_PROFILE==="1",f=await e.#Kn(u,n,p,s,o,i,a,h,d),{bestNetwork:m,bestResult:b,completedGenerations:g,totalEvolveMs:y,totalLamarckMs:A,totalSimMs:N}=f;return d&&g>0&&e.#Vn(h.safeWrite,g,y,A,N),{bestNetwork:m,bestResult:b,neat:u,exitReason:b?.exitReason??"incomplete"}}static#Vn(t,n,s,o,i){try{let a=Number.isFinite(n)&&n>0?Math.floor(n):0;if(a===0)return;let r=e._PROFILE_SCRATCH_TA??(e._PROFILE_SCRATCH_TA=new Float64Array(4));r[0]=Number.isFinite(s)?s:0,r[1]=Number.isFinite(o)?o:0,r[2]=Number.isFinite(i)?i:0,r[0]=r[0]/a,r[1]=r[1]/a,r[2]=r[2]/a,r[3]=r[0]+r[1]+r[2];let c=r[0].toFixed(2),l=r[1].toFixed(2),u=r[2].toFixed(2),p=r[3].toFixed(2);if(t(`
[PROFILE] Generations=${a} avg(ms): evolve=${c} lamarck=${l} sim=${u} totalPerGen=${p}
`),e.#R){let h=e.#dt,d=a||1,f=Number.isFinite(h?.telemetry)?(h.telemetry/d).toFixed(2):"0.00",m=Number.isFinite(h?.simplify)?(h.simplify/d).toFixed(2):"0.00",b=Number.isFinite(h?.snapshot)?(h.snapshot/d).toFixed(2):"0.00",g=Number.isFinite(h?.prune)?(h.prune/d).toFixed(2):"0.00";t(`[PROFILE_DETAIL] avgTelemetry=${f} avgSimplify=${m} avgSnapshot=${b} avgPrune=${g}
`)}}catch{}}static#Yn(t,n,s,o){try{let i=r=>(t.fitnessEvaluator??de.defaultFitnessEvaluator)(r,o),a=e.#On(n,s,i,t.neatOptions);e.#Rn(a,t.initialPopulation??void 0,t.initialBestNetwork??void 0,Number.isFinite(t.popSize)?Math.max(0,Math.floor(t.popSize)):0);try{let r=Number.isFinite(t.popSize)?Math.max(0,Math.floor(t.popSize)):0;if(r>0){let c=e.#r;if(Array.isArray(c)&&c.length<r){let l=c.length||1;for(;l<r;)l<<=1;c.length=l}}}catch{}return a}catch{return null}}static#Xn(t,n){try{if(!(Array.isArray(n)&&n.length>0)||!t)return;let o=Number.isFinite(t?.options?.popSize)?Math.max(0,Math.floor(t.options.popSize)):Math.max(8,n.length),i=r=>1<<Math.ceil(Math.log2(Math.max(1,r))),a=i(Math.max(8,o));try{let r=e._SCRATCH_SAMPLE;Array.isArray(r)||(r=e._SCRATCH_SAMPLE=[]),r.length<a&&(r.length=a)}catch{}try{let r=e._SCRATCH_EXPS;if(!(r instanceof Float64Array)||r.length<16){let c=Math.max(16,i(Math.min(256,o)));r=e._SCRATCH_EXPS=new Float64Array(c)}}catch{}try{e.#In(t,n)}catch{}}catch{}}static#Jn(t){let n=e.#En(),{fs:s,path:o}=e.#Cn(t?.persistDir),i=e.#Tn(t?.reportingConfig?.dashboardManager);try{Array.isArray(e._SCRATCH_SAMPLE)||(e._SCRATCH_SAMPLE=[]),e._PROFILE_SCRATCH_TA instanceof Float64Array||(e._PROFILE_SCRATCH_TA=new Float64Array(4)),e._SCRATCH_EXPS instanceof Float64Array||(e._SCRATCH_EXPS=new Float64Array(64))}catch{}return{flushToFrame:n,fs:s,path:o,safeWrite:i}}static async#Kn(t,n,s,o,i,a,r,c,l){let{flushToFrame:u,fs:p,path:h,safeWrite:d}=c,f=n.initialBestNetwork,m=-1/0,b,g=0,y=0,A=0,N=!1,v=0,w=-1/0,x=0,_=e._PROFILE_SCRATCH_TA??(e._PROFILE_SCRATCH_TA=new Float64Array(4));for(_[0]=0,_[1]=0,_[2]=0;!e.#Ln(n,b);){let F=await e.#Fn(t,l,n.lamarckianIterations,s,n.lamarckianSampleSize,d,y,n.dynamicPopEnabled,n.dynamicPopMax,n.plateauGenerations,A,n.dynamicPopExpandInterval,n.dynamicPopExpandFactor,n.dynamicPopPlateauSlack),M=F.fittest;if(l&&(_[0]+=Number(F.tEvolve??0),_[1]+=Number(F.tLamarck??0)),!e.#Nt)try{M.train(s,{iterations:e.#Xt,error:e.#I,rate:e.#J,momentum:e.#_t,batchSize:e.#W,allowRecurrent:!0})}catch{}let T=M.score??0;y+=1,{plateauCounter:A,lastBestFitnessForPlateau:w}=e.#Dn(T,w,A,n.plateauImprovementThreshold),{simplifyMode:N,simplifyRemaining:v,plateauCounter:A}=e.#$n(t,A,n.plateauGenerations,n.simplifyDuration,N,v,n.simplifyStrategy,n.simplifyPruneFraction);let D=e.#Hn(M,o,i,a,r,n.agentSimConfig?.maxSteps,l,d,n.reportingConfig?.logEvery??10,y,t),E=D.generationResult;if(l&&(_[2]+=Number(D.simTime??0)),T>m){m=T,f=M,b=E,g=0;try{await e.#wn(n.mazeConfig.maze,E,M,y,t,n.reportingConfig?.dashboardManager,u)}catch{}}else if(g+=1,y%(n.reportingConfig?.logEvery??10)===0)try{await e.#xn(n.mazeConfig.maze,b,f,y,t,n.reportingConfig?.dashboardManager,u)}catch{}if(e.#Ve(p,h,n.persistDir,n.persistTopK,y,n.persistEvery,t,m,N,A),await e.#Gn(b,f,n.mazeConfig.maze,y,t,n.reportingConfig?.dashboardManager,u,n.minProgressToPass,n.autoPauseOnSolve,n.stopOnlyOnSolve,g,n.maxStagnantGenerations,n.maxGenerations))break;if(n.memoryCompactionInterval>0&&y-x>=n.memoryCompactionInterval){let O=e.#zn(t);O>0&&(e.#qn(t),d(`[COMPACT] gen=${y} removedDisabledConns=${O}
`)),x=y}if(n.reportingConfig?.paceEveryGeneration)try{await u()}catch{}}let I=Number(_[0]||0),L=Number(_[1]||0),$=Number(_[2]||0);return{bestNetwork:f,bestResult:b,neat:t,completedGenerations:y,totalEvolveMs:I,totalLamarckMs:L,totalSimMs:$}}static#Zn(t){let n=t?.mazeConfig,s=t?.agentSimConfig??{},o=t?.evolutionAlgorithmConfig??{},i=t?.reportingConfig??{},{allowRecurrent:a=!0,popSize:r=500,maxStagnantGenerations:c=500,minProgressToPass:l=95,maxGenerations:u=1/0,randomSeed:p,initialPopulation:h,initialBestNetwork:d,lamarckianIterations:f=10,lamarckianSampleSize:m,plateauGenerations:b=40,plateauImprovementThreshold:g=1e-6,simplifyDuration:y=30,simplifyPruneFraction:A=.05,simplifyStrategy:N="weakWeight",persistEvery:v=25,persistDir:w="./ascii_maze_snapshots",persistTopK:x=3,dynamicPopEnabled:_=!0,dynamicPopMax:I,dynamicPopExpandInterval:L=25,dynamicPopExpandFactor:$=.15,dynamicPopPlateauSlack:k=.6,stopOnlyOnSolve:F=!1,autoPauseOnSolve:M=!0,deterministic:T=!1,memoryCompactionInterval:D=50,telemetryReduceStats:E=!1,telemetryMinimal:R=!1,disableBaldwinianRefinement:O=!1}=o;(T||typeof p=="number")&&e.setDeterministic(typeof p=="number"?p:305419896),e.#H=!!E,e.#ft=!!R,e.#Nt=!!O;let P=typeof I=="number"?I:Math.max(r,120);return{mazeConfig:n,agentSimConfig:s,evolutionAlgorithmConfig:o,reportingConfig:i,fitnessEvaluator:t?.fitnessEvaluator,popSize:r,allowRecurrent:a,maxStagnantGenerations:c,minProgressToPass:l,maxGenerations:u,randomSeed:p,initialPopulation:h,initialBestNetwork:d,lamarckianIterations:f,lamarckianSampleSize:m,plateauGenerations:b,plateauImprovementThreshold:g,simplifyDuration:y,simplifyPruneFraction:A,simplifyStrategy:N,persistEvery:v,persistDir:w,persistTopK:x,dynamicPopEnabled:_,dynamicPopMax:P,dynamicPopExpandInterval:L,dynamicPopExpandFactor:$,dynamicPopPlateauSlack:k,stopOnlyOnSolve:F,autoPauseOnSolve:M,deterministic:T,memoryCompactionInterval:D,telemetryReduceStats:E,telemetryMinimal:R,disableBaldwinianRefinement:O,neatOptions:{popSize:r,allowRecurrent:a,adaptiveMutation:{enabled:!0,strategy:"twoTier"},multiObjective:{enabled:!0,complexityMetric:"nodes",autoEntropy:!0},telemetry:{enabled:!0,performance:!0,complexity:!0,hypervolume:!0},lineageTracking:!0,novelty:{enabled:!0,blendFactor:.15},targetSpecies:10,adaptiveTargetSpecies:{enabled:!0,entropyRange:[.3,.8],speciesRange:[6,14],smooth:.5}},maze:n?.maze}}static#Qn(t){let n=t?.maze??t?.mazeConfig?.maze,s=z.encodeMaze(n),o=z.findPosition(n,"S"),i=z.findPosition(n,"E"),a=z.buildDistanceMap(s,i),r=6,c=4,l={encodedMaze:s,startPosition:o,exitPosition:i,agentSimConfig:t?.agentSimConfig??{},distanceMap:a};try{let u=e;Array.isArray(u._SCRATCH_SAMPLE)||(u._SCRATCH_SAMPLE=new Array(32)),u._PROFILE_SCRATCH_TA||(u._PROFILE_SCRATCH_TA=new Float64Array(4))}catch{}return{encodedMaze:s,startPosition:o,exitPosition:i,distanceMap:a,inputSize:r,outputSize:c,fitnessContext:l}}static#ts(t,n,s){let o=i=>i<=1?1:2**Math.ceil(Math.log2(i));try{let i=Math.max(32,o(Math.max(1,t))),a=Math.max(1,n+s),r=Math.max(64,o(a));e.#r?e.#r.length<i&&(e.#r.length=i):e.#r=new Array(i);let c=(l,u)=>{if(l&&l.length>=u)return l;let p=Math.max(u,o(u)),h=new Float64Array(p);return l&&l.length>0&&h.set(l.subarray(0,Math.min(l.length,p))),h};e.#n=c(e.#n,r),e.#q=c(e.#q,r),e.#c||(e.#c=new Uint8Array(32)),e._PROFILE_SCRATCH_TA||(e._PROFILE_SCRATCH_TA=new Float64Array(4)),Array.isArray(e._SCRATCH_NODE_BUCKETS)||(e._SCRATCH_NODE_BUCKETS=[[],[],[]]),Array.isArray(e._SCRATCH_ACT_NAMES)||(e._SCRATCH_ACT_NAMES=[])}catch{}}static printNetworkStructure(t){try{console.log("Network Structure:");let{nodeList:n,inputNodes:s,hiddenNodes:o,outputNodes:i}=e.#es(t);console.log("Nodes:",n.length),console.log("  Input nodes:",s.length),console.log("  Hidden nodes:",o.length),console.log("  Output nodes:",i.length);let a=e.#os(t);console.log("Activation functions:",a);let r=Array.isArray(t?.connections)?t.connections:[];console.log("Connections:",r.length);let c=e.#is(r);console.log("Has recurrent/gated connections:",c)}catch{console.log("printNetworkStructure: failed to inspect network (partial data)")}}static#es(t){let n=e.#ns(t);return e.#ss(n)}static#ns(t){return Array.isArray(t?.nodes)?t.nodes:[]}static#ss(t){let n=Array.isArray(t)?t:[],s=e;s._SCRATCH_NODE_BUCKETS||(s._SCRATCH_NODE_BUCKETS=[[],[],[]]);let o=s._SCRATCH_NODE_BUCKETS,i=o[0],a=o[1],r=o[2];i.length=0,a.length=0,r.length=0;for(let c=0;c<n.length;c++){let l=n[c];if(!l)continue;let u=String(l.type??"hidden");u==="input"?i.push(l):u==="output"?r.push(l):a.push(l)}return{nodeList:n,inputNodes:i,hiddenNodes:a,outputNodes:r}}static#os(t){let n=Array.isArray(t?.nodes)?t.nodes:[],s=n.length;Array.isArray(e.#_)||(e.#_=[]);let o=e.#_,i=a=>{let r=1;for(;r<a;)r<<=1;return r};if(o.length<s){let a=i(Math.max(1,s));o.length=a}for(let a=0;a<s;a++){let c=n[a]?.squash;typeof c=="function"?o[a]=c.name&&c.name.length?c.name:"anonymous":o[a]=String(c??"unknown")}return o.length=s,o}static#is(t){if(!Array.isArray(t)||t.length===0)return!1;let n=t.length;if(n<128){for(let o=0;o<n;o++){let i=t[o];if(i&&(i.gater||i.from===i.to))return!0}return!1}try{let o=e.#as(n);if(!o){for(let i=0;i<n;i++){let a=t[i];if(a&&(a.gater||a.from===a.to))return!0}return!1}o.fill(0,0,n);for(let i=0;i<n;i++){let a=t[i];if(a){if(a.gater||a.from===a.to)return!0;o[i]=1}}return!1}catch{for(let o=0;o<n;o++){let i=t[o];if(i&&(i.gater||i.from===i.to))return!0}return!1}}static#as(t){try{let n=Math.max(0,Math.trunc(Number(t)||0));if(n===0)return new Int8Array(0);let s=e,o=s._SCRATCH_CONN_FLAGS;if(o instanceof Int8Array&&o.length>=n)return o;let i=1;for(;i<n;)i<<=1;let a=new Int8Array(i);if(o instanceof Int8Array&&o.length>0){let r=Math.min(o.length,a.length);a.set(o.subarray(0,r),0)}return s._SCRATCH_CONN_FLAGS=a,a}catch{return null}}};var me=class e{#n;#t;#e=[];#s=0;#o=0;#i={x:0,y:0,depth:0};static WALL=1;static PATH=0;static START=2;static EXIT=3;constructor(t,n){this.#n=t,this.#t=n,this.#l(),this.#p(),this.#f(),this.#y()}#l(){this.#n=Math.max(5,Math.floor(this.#n)),this.#t=Math.max(5,Math.floor(this.#t)),this.#n%2===0&&(this.#n-=1),this.#t%2===0&&(this.#t-=1)}#p(){this.#e=Array.from({length:this.#t},()=>Array.from({length:this.#n},()=>e.WALL));let t=n=>n%2===0?n-1:n;this.#s=t(Math.floor(this.#n/2)),this.#o=t(Math.floor(this.#t/2)),this.#e[this.#o][this.#s]=e.PATH,this.#i={x:this.#s,y:this.#o,depth:0}}#a(t,n){return t>=0&&n>=0&&t<this.#n&&n<this.#t}#f(){e._scratchBuffers||(e._scratchBuffers={capacity:0,stackX:new Int32Array(0),stackY:new Int32Array(0),stackDepth:new Int32Array(0)});let t=e._scratchBuffers,n=Math.max(1024,(this.#n*this.#t>>2)+1);t.capacity<n&&(t.capacity=n,t.stackX=new Int32Array(n),t.stackY=new Int32Array(n),t.stackDepth=new Int32Array(n));let s=0;t.stackX[s]=this.#s,t.stackY[s]=this.#o,t.stackDepth[s]=0,s++;let o=[{deltaX:0,deltaY:-2},{deltaX:2,deltaY:0},{deltaX:0,deltaY:2},{deltaX:-2,deltaY:0}],i=u=>{for(let p=u.length-1;p>0;p--){let h=Math.random()*(p+1)|0;if(p!==h){let d=u[p];u[p]=u[h],u[h]=d}}},a=new Int32Array(4),r=new Int32Array(4),c=new Int32Array(4),l=new Int32Array(4);for(;s>0;){let u=s-1,p=t.stackX[u],h=t.stackY[u],d=t.stackDepth[u];i(o);let f=0;for(let v=0;v<o.length;v++){let w=o[v],x=p+w.deltaX,_=h+w.deltaY;this.#a(x,_)&&(x<=0||_<=0||x>=this.#n-1||_>=this.#t-1||this.#e[_][x]===e.WALL&&(a[f]=x,r[f]=_,c[f]=p+w.deltaX/2,l[f]=h+w.deltaY/2,f++))}if(f===0){s--;continue}let m=0,b=a[m],g=r[m],y=c[m],A=l[m];this.#e[A][y]=e.PATH,this.#e[g][b]=e.PATH;let N=d+1;t.stackX[s]=b,t.stackY[s]=g,t.stackDepth[s]=N,s++,N>this.#i.depth&&(this.#i={x:b,y:g,depth:N})}}#y(){this.#e[this.#o][this.#s]=e.START,this.#h()}#m(){e._scratchBuffers||(e._scratchBuffers={capacity:0,stackX:new Int32Array(0),stackY:new Int32Array(0),stackDepth:new Int32Array(0),distancesFlat:new Int32Array(0),queueX:new Int32Array(0),queueY:new Int32Array(0)});let t=e._scratchBuffers;(!("distancesFlat"in t)||!t.distancesFlat)&&(t.distancesFlat=new Int32Array(0)),(!("queueX"in t)||!t.queueX)&&(t.queueX=new Int32Array(0)),(!("queueY"in t)||!t.queueY)&&(t.queueY=new Int32Array(0));let n=this.#n*this.#t;t.distancesFlat.length<n&&(t.distancesFlat=new Int32Array(n)),t.queueX.length<n&&(t.queueX=new Int32Array(n),t.queueY=new Int32Array(n));let s=t.distancesFlat;s.fill(-1);let o=0,i=0;for(t.queueX[o]=this.#s,t.queueY[o]=this.#o,s[this.#o*this.#n+this.#s]=0,o++;i<o;){let r=t.queueX[i],c=t.queueY[i];i++;let l=c*this.#n+r,u=s[l],p=r,h=c-1;if(this.#a(p,h)){let A=h*this.#n+p,N=this.#e[h][p];(N===e.PATH||N===e.START)&&s[A]===-1&&(s[A]=u+1,t.queueX[o]=p,t.queueY[o]=h,o++)}let d=r+1,f=c;if(this.#a(d,f)){let A=f*this.#n+d,N=this.#e[f][d];(N===e.PATH||N===e.START)&&s[A]===-1&&(s[A]=u+1,t.queueX[o]=d,t.queueY[o]=f,o++)}let m=r,b=c+1;if(this.#a(m,b)){let A=b*this.#n+m,N=this.#e[b][m];(N===e.PATH||N===e.START)&&s[A]===-1&&(s[A]=u+1,t.queueX[o]=m,t.queueY[o]=b,o++)}let g=r-1,y=c;if(this.#a(g,y)){let A=y*this.#n+g,N=this.#e[y][g];(N===e.PATH||N===e.START)&&s[A]===-1&&(s[A]=u+1,t.queueX[o]=g,t.queueY[o]=y,o++)}}let a=new Array(this.#t);for(let r=0;r<this.#t;r++){let c=r*this.#n,l=new Array(this.#n);for(let u=0;u<this.#n;u++)l[u]=s[c+u];a[r]=l}return a}#h(){let t=this.#m(),n=e._scratchBuffers,s=n&&n.distancesFlat?n.distancesFlat:null,o=-1,i=-1,a=-1,r=-1,c=-1,l=(u,p)=>s?s[p*this.#n+u]:t[p][u];for(let u=1;u<this.#t-1;u++)for(let p=1;p<this.#n-1;p++){let h=l(p,u);if(!(h<0)&&this.#e[u][p]!==e.START){if(u===1){let d=p,f=0;this.#e[f][d]===e.WALL&&h>o&&(o=h,i=p,a=u,r=d,c=f)}if(u===this.#t-2){let d=p,f=this.#t-1;this.#e[f][d]===e.WALL&&h>o&&(o=h,i=p,a=u,r=d,c=f)}if(p===1){let f=u;this.#e[f][0]===e.WALL&&h>o&&(o=h,i=p,a=u,r=0,c=f)}if(p===this.#n-2){let d=this.#n-1,f=u;this.#e[f][d]===e.WALL&&h>o&&(o=h,i=p,a=u,r=d,c=f)}}}if(o<0){this.#e[this.#i.y][this.#i.x]=e.EXIT;return}this.#e[a][i]===e.EXIT&&(this.#e[a][i]=e.PATH),this.#e[c][r]=e.EXIT}#d(t,n){e._scratchBuffers||(e._scratchBuffers={});let s=e._scratchBuffers;s.maskFlags||(s.maskFlags=new Int8Array(4));let o=(u,p)=>this.#a(u,p)&&![e.PATH,e.START,e.EXIT].includes(this.#e[p][u]),i=o(t,n-1),a=o(t+1,n),r=o(t,n+1),c=o(t-1,n);switch(s.maskFlags[0]=i?1:0,s.maskFlags[1]=a?1:0,s.maskFlags[2]=r?1:0,s.maskFlags[3]=c?1:0,(s.maskFlags[0]?1:0)|(s.maskFlags[1]?2:0)|(s.maskFlags[2]?4:0)|(s.maskFlags[3]?8:0)){case 5:case 1:case 4:return"\u2551";case 10:case 2:case 8:return"\u2550";case 3:return"\u255A";case 9:return"\u255D";case 6:return"\u2554";case 12:return"\u2557";case 14:return"\u2566";case 11:return"\u2569";case 7:return"\u2560";case 13:return"\u2563";case 15:return"\u256C";default:return"\u2588"}}#M(){let t=[];for(let n=0;n<this.#t;n++){let s="";for(let o=0;o<this.#n;o++){let i=this.#e[n][o];switch(!0){case i===e.PATH:s+=".";break;case i===e.START:s+="S";break;case i===e.EXIT:s+="E";break;case(n===0&&o===0):s+="\u2554";break;case(n===0&&o===this.#n-1):s+="\u2557";break;case(n===this.#t-1&&o===0):s+="\u255A";break;case(n===this.#t-1&&o===this.#n-1):s+="\u255D";break;case(n===0||n===this.#t-1):s+="\u2550";break;case(o===0||o===this.#n-1):s+="\u2551";break;default:s+=this.#d(o,n)}}t.push(s)}return t}generate(){return this.#M()}};pt();var ye=class e{static#n=new Float32Array(0);static#t=new Float32Array(0);static#e(t,n){if(t.length<n){let s=t.length||1;for(;s<n;)s<<=1;return new Float32Array(s)}return t}static refineWinnerWithBackprop(t){if(!t)throw new Error("A winner network must be provided for refinement.");let n=t.clone(),s=[{input:[0,1,0,0,0,.7],output:[1,0,0,0]},{input:[.25,0,1,0,0,.7],output:[0,1,0,0]},{input:[.5,0,0,1,0,.7],output:[0,0,1,0]},{input:[.75,0,0,0,1,.7],output:[0,0,0,1]}],o=.05,i=.01,a=100;for(let r=0;r<a;r++)for(let{input:c,output:l}of s){e.#n=e.#e(e.#n,c.length),e.#t=e.#e(e.#t,l.length);for(let u=0;u<c.length;u++)e.#n[u]=c[u];for(let u=0;u<l.length;u++)e.#t[u]=l[u];try{n.activate(e.#n)}catch(u){globalThis.DEBUG&&console.warn("Activation failed during refinement:",u)}e.#s(n,o,i,e.#t)}return n}static#s(t,n,s,o){try{return t.propagate(n,s,!0,Array.from(o)),!0}catch(i){return globalThis.DEBUG&&console.warn("Refinement propagate failed:",i),!1}}};var go="ascii-maze-output",ta=8,ea=120,na=20,mo=90,sa=50,oa=100,ia=1,aa=8,yo=40,ra=4,ca=600,la=20;function ua(e){return{agentMaxSteps:ca,popSize:la,maxStagnantGenerations:sa,maxGenerations:oa,lamarckianIterations:4,lamarckianSampleSize:12,mazeFactory:()=>new me(e,e).generate()}}var sn=class{#n=new Set;add(t){return this.#n.add(t),()=>this.#n.delete(t)}dispatch(t){let n=Array.from(this.#n);for(let s of n)try{s(t)}catch{}}};async function nn(e=go,t={}){let n=typeof e=="string"?document.getElementById(e):e,s=n?n.querySelector("#ascii-maze-archive"):null,o=n?n.querySelector("#ascii-maze-live"):null,i=ee.createTerminalClearer(o??void 0),a=Ae(o??void 0),r=Ae(s??void 0),c=new ne(i,a,r),l=new sn;c._telemetryHook=x=>l.dispatch(x);try{let x=n??document.getElementById("ascii-maze-output");if(x&&typeof ResizeObserver<"u"){let _=x.clientWidth;new ResizeObserver(L=>{for(let $ of L){let k=$.contentRect.width;if(Math.abs(k-_)>ta){_=k;try{c.redraw?.([],void 0)}catch{}}}}).observe(x)}else if(x){let _,I=()=>{typeof _=="number"&&clearTimeout(_),_=window.setTimeout(()=>{try{c.redraw?.([],void 0)}catch{}},ea)};window.addEventListener("resize",I)}}catch{}let u=!1,p=new AbortController,h=t.signal,d=x=>{if(!x)return p.signal;let _=x,I=p.signal;switch(!0){case!!_.aborted:return _;case typeof AbortSignal.any=="function":try{return AbortSignal.any([_,I])}catch{}default:{try{_.addEventListener("abort",()=>{try{p.abort()}catch{}},{once:!0})}catch{}try{_.onabort=()=>{try{p.abort()}catch{}}}catch{}try{queueMicrotask(()=>{if(_.aborted)try{p.abort()}catch{}})}catch{}}}return I},f,m=new Promise(x=>f=x),b=d(h),g=!0;if(b.aborted){u=!0,g=!1;try{f?.()}catch{}}try{b.addEventListener("abort",()=>{u=!0,g=!1;try{f?.()}catch{}},{once:!0})}catch{}let y=aa,A,N=x=>{try{typeof requestAnimationFrame=="function"?requestAnimationFrame(x):setTimeout(x,0)}catch{setTimeout(x,0)}},v=async()=>{if(u){g=!1,f?.();return}let x=ua(y),_=x.mazeFactory(),I=!1;try{let L=await fe.runMazeEvolution({mazeConfig:{maze:_},agentSimConfig:{maxSteps:x.agentMaxSteps},evolutionAlgorithmConfig:{allowRecurrent:!0,popSize:x.popSize,maxStagnantGenerations:x.maxStagnantGenerations,minProgressToPass:mo,maxGenerations:x.maxGenerations,autoPauseOnSolve:!1,stopOnlyOnSolve:!1,lamarckianIterations:x.lamarckianIterations,lamarckianSampleSize:x.lamarckianSampleSize,initialBestNetwork:A},reportingConfig:{dashboardManager:c,logEvery:ia,label:`browser-procedural-${y}x${y}`,paceEveryGeneration:!0},cancellation:{isCancelled:()=>u},signal:b}),$=L?.bestResult?.progress;try{let k=L?.bestNetwork;k&&(A=ye.refineWinnerWithBackprop(k)||k)}catch{}I=typeof $=="number"&&$>=mo;try{console.log("[asciiMaze] maze complete",y,"solved?",I,"progress",$)}catch{}}catch(L){console.error("Error while running procedural maze",y,L)}!u&&I&&y<yo?(y=Math.min(y+ra,yo),N(()=>v())):(g=!1,f?.())};return v(),{stop:()=>{u=!0;try{p.abort()}catch{}g=!1},isRunning:()=>g&&!u&&!b.aborted,done:Promise.resolve(m).catch(()=>{}),onTelemetry:x=>l.add(x),getTelemetry:()=>c.getLastTelemetry?.()}}if(typeof window<"u"&&window.document){let e=window;e.asciiMaze=e.asciiMaze||{},e.asciiMaze.start=nn,e.asciiMazeStart||(e.asciiMazeStart=t=>(console.warn("[asciiMaze] window.asciiMazeStart is deprecated; use import { start } ... or window.asciiMaze.start"),nn(t))),e.asciiMaze._autoStarted||(e.asciiMaze._autoStarted=!0,setTimeout(()=>{try{document.getElementById(go)&&nn()}catch{}},na))}})();
//# sourceMappingURL=ascii-maze.bundle.js.map
