"use strict";(()=>{var ye=Object.defineProperty;var gs=Object.getOwnPropertyDescriptor;var bs=Object.getOwnPropertyNames;var As=Object.prototype.hasOwnProperty;var zt=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,n)=>(typeof require<"u"?require:t)[n]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var H=(e,t)=>()=>(e&&(t=e(e=0)),t);var Ss=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports),ht=(e,t)=>{for(var n in t)ye(e,n,{get:t[n],enumerable:!0})},vs=(e,t,n,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of bs(t))!As.call(e,s)&&s!==n&&ye(e,s,{get:()=>t[s],enumerable:!(i=gs(t,s))||i.enumerable});return e};var Z=e=>vs(ye({},"__esModule",{value:!0}),e);var Tt,Ot,Ht,Rt,dt,vt=H(()=>{"use strict";lt();Tt=Symbol("connGain"),Ot=Symbol("connGater"),Ht=Symbol("connOptMoments"),Rt=Symbol("connPlasticRate"),dt=class e{from;to;weight;eligibility;previousDeltaWeight;totalDeltaWeight;xtrace;innovation;_flags;constructor(t,n,i){this.from=t,this.to=n,this.weight=i??Math.random()*.2-.1,this.eligibility=0,this.previousDeltaWeight=0,this.totalDeltaWeight=0,this.xtrace={nodes:[],values:[]},this._flags=3,this.innovation=e._nextInnovation++}toJSON(){let t={from:this.from.index??void 0,to:this.to.index??void 0,weight:this.weight,gain:this.gain,innovation:this.innovation,enabled:this.enabled};if(this._flags&4){let n=this[Ot];n&&typeof n.index<"u"&&(t.gater=n.index)}return t}static innovationID(t,n){return .5*(t+n)*(t+n+1)+n}static _nextInnovation=1;static resetInnovationCounter(t=1){e._nextInnovation=t}static _pool=[];static acquire(t,n,i){let s;return e._pool.length?(s=e._pool.pop(),s.from=t,s.to=n,s.weight=i??Math.random()*.2-.1,s[Tt]!==void 0&&delete s[Tt],s[Ot]!==void 0&&delete s[Ot],s._flags=3,s.eligibility=0,s.previousDeltaWeight=0,s.totalDeltaWeight=0,s.xtrace.nodes.length=0,s.xtrace.values.length=0,s[Ht]&&delete s[Ht],s.innovation=e._nextInnovation++):s=new e(t,n,i),s}static release(t){e._pool.push(t)}get enabled(){return(this._flags&1)!==0}set enabled(t){this._flags=t?this._flags|1:this._flags&-2}get dcMask(){return(this._flags&2)!==0?1:0}set dcMask(t){this._flags=t?this._flags|2:this._flags&-3}get hasGater(){return(this._flags&4)!==0}get plastic(){return(this._flags&8)!==0}set plastic(t){t?this._flags|=8:this._flags&=-9,!t&&this[Rt]!==void 0&&delete this[Rt]}get gain(){return this[Tt]===void 0?1:this[Tt]}set gain(t){t===1?this[Tt]!==void 0&&delete this[Tt]:this[Tt]=t}_ensureOptBag(){let t=this[Ht];return t||(t={},this[Ht]=t),t}_getOpt(t){let n=this[Ht];return n?n[t]:void 0}_setOpt(t,n){if(n===void 0){let i=this[Ht];i&&delete i[t]}else this._ensureOptBag()[t]=n}get firstMoment(){return this._getOpt("firstMoment")}set firstMoment(t){this._setOpt("firstMoment",t)}get secondMoment(){return this._getOpt("secondMoment")}set secondMoment(t){this._setOpt("secondMoment",t)}get gradientAccumulator(){return this._getOpt("gradientAccumulator")}set gradientAccumulator(t){this._setOpt("gradientAccumulator",t)}get maxSecondMoment(){return this._getOpt("maxSecondMoment")}set maxSecondMoment(t){this._setOpt("maxSecondMoment",t)}get infinityNorm(){return this._getOpt("infinityNorm")}set infinityNorm(t){this._setOpt("infinityNorm",t)}get secondMomentum(){return this._getOpt("secondMomentum")}set secondMomentum(t){this._setOpt("secondMomentum",t)}get lookaheadShadowWeight(){return this._getOpt("lookaheadShadowWeight")}set lookaheadShadowWeight(t){this._setOpt("lookaheadShadowWeight",t)}get gater(){return(this._flags&4)!==0?this[Ot]:null}set gater(t){t===null?(this._flags&4)!==0&&(this._flags&=-5,this[Ot]!==void 0&&delete this[Ot]):(this[Ot]=t,this._flags|=4)}get plasticityRate(){return this[Rt]===void 0?0:this[Rt]}set plasticityRate(t){t===void 0||t===0?(this[Rt]!==void 0&&delete this[Rt],this._flags&=-9):(this[Rt]=t,this._flags|=8)}get dropConnectActiveMask(){return this.dcMask}set dropConnectActiveMask(t){this.dcMask=t}}});var U,At=H(()=>{"use strict";U={warnings:!1,float32Mode:!1,deterministicChainMode:!1,enableGatingTraces:!0,enableNodePooling:!1,enableSlabArrayPooling:!1}});var Se={};ht(Se,{EPSILON:()=>xt,EXTRA_CONNECTION_PROBABILITY:()=>Ae,NORM_EPSILON:()=>ks,PROB_EPSILON:()=>Lt});var xt,Lt,ks,Ae,Pt=H(()=>{"use strict";xt=1e-9,Lt=1e-15,ks=1e-5,Ae=.5});var Nt,an=H(()=>{"use strict";Pt();Nt=class{static crossEntropy(t,n){let i=0,s=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let o=0;o<n.length;o++){let a=t[o],r=n[o],c=Math.max(s,Math.min(1-s,r));a===1?i-=Math.log(c):a===0?i-=Math.log(1-c):i-=a*Math.log(c)+(1-a)*Math.log(1-c)}return i/n.length}static softmaxCrossEntropy(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=n.length,s=0;for(let h of t)s+=h;let o=s>0?t.map(h=>h/s):t.slice(),a=Math.max(...n),r=n.map(h=>Math.exp(h-a)),c=r.reduce((h,m)=>h+m,0)||1,l=r.map(h=>h/c),u=0,p=1e-15;for(let h=0;h<i;h++){let m=Math.min(1-p,Math.max(p,l[h])),d=o[h];u-=d*Math.log(m)}return u}static mse(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0;return n.forEach((s,o)=>{i+=Math.pow(t[o]-s,2)}),i/n.length}static binary(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0;return n.forEach((s,o)=>{i+=Math.round(t[o])!==Math.round(s)?1:0}),i/n.length}static mae(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0;return n.forEach((s,o)=>{i+=Math.abs(t[o]-s)}),i/n.length}static mape(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0,s=1e-15;return n.forEach((o,a)=>{let r=t[a];i+=Math.abs((r-o)/Math.max(Math.abs(r),s))}),i/n.length}static msle(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0;return n.forEach((s,o)=>{let a=t[o],r=Math.log(Math.max(a,0)+1),c=Math.log(Math.max(s,0)+1);i+=Math.pow(r-c,2)}),i/n.length}static hinge(t,n){if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");let i=0;return n.forEach((s,o)=>{let a=t[o];i+=Math.max(0,1-a*s)}),i/n.length}static focalLoss(t,n,i=2,s=.25){let o=0,a=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let r=0;r<n.length;r++){let c=t[r],l=Math.max(a,Math.min(1-a,n[r])),u=c===1?l:1-l,p=c===1?s:1-s;o+=-p*Math.pow(1-u,i)*Math.log(u)}return o/n.length}static labelSmoothing(t,n,i=.1){let s=0,o=1e-15;if(t.length!==n.length)throw new Error("Target and output arrays must have the same length.");for(let a=0;a<n.length;a++){let r=t[a]*(1-i)+.5*i,c=Math.max(o,Math.min(1-o,n[a]));s-=r*Math.log(c)+(1-r)*Math.log(1-c)}return s/n.length}}});var qt,rn=H(()=>{"use strict";qt=class{static fixed(){return(n,i)=>n}static step(t=.9,n=100){return(s,o)=>Math.max(0,s*Math.pow(t,Math.floor(o/n)))}static exp(t=.999){return(i,s)=>i*Math.pow(t,s)}static inv(t=.001,n=2){return(s,o)=>s/(1+t*Math.pow(o,n))}static cosineAnnealing(t=1e3,n=0){return(s,o)=>{let a=o%t,r=.5*(1+Math.cos(a/t*Math.PI));return n+(s-n)*r}}static cosineAnnealingWarmRestarts(t=1e3,n=0,i=1){let s=t,o=0,a=s;return(r,c)=>{for(;c>=a;)o=a,s=Math.max(1,Math.round(s*i)),a=o+s;let l=c-o,u=.5*(1+Math.cos(l/s*Math.PI));return n+(r-n)*u}}static linearWarmupDecay(t,n,i=0){if(t<=0)throw new Error("totalSteps must be > 0");let s=Math.min(n??Math.max(1,Math.floor(t*.1)),t-1);return(o,a)=>{if(a<=s)return o*(a/Math.max(1,s));if(a>=t)return i;let r=t-s,c=(a-s)/r;return i+(o-i)*(1-c)}}static reduceOnPlateau(t){let{factor:n=.5,patience:i=10,minDelta:s=1e-4,cooldown:o=0,minRate:a=0,verbose:r=!1}=t||{},c,l,u=0,p=-1;return(h,m,d)=>{if(c===void 0&&(c=h),d!==void 0){if(l===void 0||d<l-s)l=d,u=m;else if(m-u>=i&&m>=p){let f=Math.max(a,c*n);f<c&&(c=f,p=m+o,u=m)}}return c}}}});var Ds,V,ve=H(()=>{"use strict";Ds={logistic:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n*(1-n):n},sigmoid:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n*(1-n):n},tanh:(e,t=!1)=>t?1-Math.pow(Math.tanh(e),2):Math.tanh(e),identity:(e,t=!1)=>t?1:e,step:(e,t=!1)=>t?0:e>0?1:0,relu:(e,t=!1)=>t?e>0?1:0:e>0?e:0,softsign:(e,t=!1)=>{let n=1+Math.abs(e);return t?1/Math.pow(n,2):e/n},sinusoid:(e,t=!1)=>t?Math.cos(e):Math.sin(e),gaussian:(e,t=!1)=>{let n=Math.exp(-Math.pow(e,2));return t?-2*e*n:n},bentIdentity:(e,t=!1)=>{let n=Math.sqrt(Math.pow(e,2)+1);return t?e/(2*n)+1:(n-1)/2+e},bipolar:(e,t=!1)=>t?0:e>0?1:-1,bipolarSigmoid:(e,t=!1)=>{let n=2/(1+Math.exp(-e))-1;return t?.5*(1+n)*(1-n):n},hardTanh:(e,t=!1)=>t?e>-1&&e<1?1:0:Math.max(-1,Math.min(1,e)),absolute:(e,t=!1)=>t?e<0?-1:1:Math.abs(e),inverse:(e,t=!1)=>t?-1:1-e,selu:(e,t=!1)=>{let n=1.6732632423543772,i=1.0507009873554805,s=e>0?e:n*Math.exp(e)-n;return t?e>0?i:(s+n)*i:s*i},softplus:(e,t=!1)=>{let n=1/(1+Math.exp(-e));return t?n:e>30?e:e<-30?Math.exp(e):Math.max(0,e)+Math.log(1+Math.exp(-Math.abs(e)))},swish:(e,t=!1)=>{let n=1/(1+Math.exp(-e));if(t){let i=e*n;return i+n*(1-i)}else return e*n},gelu:(e,t=!1)=>{let n=.5*(1+Math.tanh(Math.sqrt(2/Math.PI)*(e+.044715*Math.pow(e,3))));if(t){let i=Math.sqrt(2/Math.PI)*(1+.134145*e*e),s=Math.sqrt(2/Math.PI)*(e+.044715*Math.pow(e,3)),o=1/Math.cosh(s),a=o*o;return n+e*.5*i*a}else return e*n},mish:(e,t=!1)=>{let n;e>30?n=e:e<-30?n=Math.exp(e):n=Math.max(0,e)+Math.log(1+Math.exp(-Math.abs(e)));let i=Math.tanh(n);if(t){let s=1/(1+Math.exp(-e)),o=1/Math.cosh(n),a=o*o;return i+e*a*s}else return e*i}},V=Ds});var St,cn=H(()=>{"use strict";St={OUTPUT:{name:"OUTPUT"},INPUT:{name:"INPUT"},SELF:{name:"SELF"}}});var j,Gt,Vt=H(()=>{"use strict";ve();j={ADD_NODE:{name:"ADD_NODE"},SUB_NODE:{name:"SUB_NODE",keep_gates:!0},ADD_CONN:{name:"ADD_CONN"},SUB_CONN:{name:"SUB_CONN"},MOD_WEIGHT:{name:"MOD_WEIGHT",min:-1,max:1},MOD_BIAS:{name:"MOD_BIAS",min:-1,max:1},MOD_ACTIVATION:{name:"MOD_ACTIVATION",mutateOutput:!0,allowed:[V.logistic,V.tanh,V.relu,V.identity,V.step,V.softsign,V.sinusoid,V.gaussian,V.bentIdentity,V.bipolar,V.bipolarSigmoid,V.hardTanh,V.absolute,V.inverse,V.selu,V.softplus,V.swish,V.gelu,V.mish]},ADD_SELF_CONN:{name:"ADD_SELF_CONN"},SUB_SELF_CONN:{name:"SUB_SELF_CONN"},ADD_GATE:{name:"ADD_GATE"},SUB_GATE:{name:"SUB_GATE"},ADD_BACK_CONN:{name:"ADD_BACK_CONN"},SUB_BACK_CONN:{name:"SUB_BACK_CONN"},SWAP_NODES:{name:"SWAP_NODES",mutateOutput:!0},REINIT_WEIGHT:{name:"REINIT_WEIGHT",min:-1,max:1},BATCH_NORM:{name:"BATCH_NORM"},ADD_LSTM_NODE:{name:"ADD_LSTM_NODE"},ADD_GRU_NODE:{name:"ADD_GRU_NODE"},ALL:[],FFW:[]};j.ALL=[j.ADD_NODE,j.SUB_NODE,j.ADD_CONN,j.SUB_CONN,j.MOD_WEIGHT,j.MOD_BIAS,j.MOD_ACTIVATION,j.ADD_GATE,j.SUB_GATE,j.ADD_SELF_CONN,j.SUB_SELF_CONN,j.ADD_BACK_CONN,j.SUB_BACK_CONN,j.SWAP_NODES,j.REINIT_WEIGHT,j.BATCH_NORM,j.ADD_LSTM_NODE,j.ADD_GRU_NODE];j.FFW=[j.ADD_NODE,j.SUB_NODE,j.ADD_CONN,j.SUB_CONN,j.MOD_WEIGHT,j.MOD_BIAS,j.MOD_ACTIVATION,j.SWAP_NODES,j.REINIT_WEIGHT,j.BATCH_NORM];Gt=j});var wt,Ne=H(()=>{"use strict";wt={FITNESS_PROPORTIONATE:{name:"FITNESS_PROPORTIONATE"},POWER:{name:"POWER",power:4},TOURNAMENT:{name:"TOURNAMENT",size:5,probability:.5}}});var Yt,ln=H(()=>{"use strict";Yt={SINGLE_POINT:{name:"SINGLE_POINT",config:[.4]},TWO_POINT:{name:"TWO_POINT",config:[.4,.9]},UNIFORM:{name:"UNIFORM"},AVERAGE:{name:"AVERAGE"}}});var Fs,tt,un=H(()=>{"use strict";Fs=Object.freeze({ALL_TO_ALL:Object.freeze({name:"ALL_TO_ALL"}),ALL_TO_ELSE:Object.freeze({name:"ALL_TO_ELSE"}),ONE_TO_ONE:Object.freeze({name:"ONE_TO_ONE"})}),tt=Fs});var et={};ht(et,{Activation:()=>V,Cost:()=>Nt,Rate:()=>qt,crossover:()=>Yt,gating:()=>St,groupConnection:()=>tt,mutation:()=>j,selection:()=>wt});var mt=H(()=>{"use strict";an();rn();ve();cn();Vt();Ne();ln();un()});var ie={};ht(ie,{default:()=>Q});var Q,lt=H(()=>{"use strict";vt();At();mt();Q=class e{bias;squash;type;activation;state;old;mask;previousDeltaBias;totalDeltaBias;connections;error;derivative;index;isActivating;geneId;static _globalNodeIndex=0;static _nextGeneId=1;constructor(t="hidden",n,i=Math.random){this.bias=t==="input"?0:i()*.2-.1,this.squash=n||V.logistic||(s=>s),this.type=t,this.activation=0,this.state=0,this.old=0,this.mask=1,this.previousDeltaBias=0,this.totalDeltaBias=0,this.connections={in:[],out:[],gated:[],self:[]},this.error={responsibility:0,projected:0,gated:0},typeof this.index>"u"&&(this.index=e._globalNodeIndex++),this.geneId=e._nextGeneId++}setActivation(t){this.squash=t}activate(t){return this._activateCore(!0,t)}noTraceActivate(t){return this._activateCore(!1,t)}_activateCore(t,n){if(this.mask===0)return this.activation=0,0;if(typeof n<"u"){if(this.type==="input")return this.activation=n,this.activation;this.state=n,this.activation=this.squash(this.state)*this.mask,this.derivative=this.squash(this.state,!0);for(let s of this.connections.gated)s.gain=this.activation;if(t)for(let s of this.connections.in)s.eligibility=s.from.activation;return this.activation}this.old=this.state;let i=this.bias;if(this.connections.self.length)for(let s of this.connections.self)s.dcMask!==0&&(i+=s.gain*s.weight*this.old);if(this.connections.in.length)for(let s of this.connections.in)s.dcMask===0||s.enabled===!1||(i+=s.from.activation*s.weight*s.gain);if(this.state=i,typeof this.squash!="function"&&(U.warnings&&console.warn("Invalid activation function; using identity."),this.squash=V.identity),typeof this.mask!="number"&&(this.mask=1),this.activation=this.squash(this.state)*this.mask,this.derivative=this.squash(this.state,!0),this.connections.gated.length)for(let s of this.connections.gated)s.gain=this.activation;if(t)for(let s of this.connections.in)s.eligibility=s.from.activation;return this.activation}propagate(t,n,i,s=0,o){if(i&&n>0){for(let c of this.connections.in)c.weight+=n*c.previousDeltaWeight,c.eligibility+=1e-12;this.bias+=n*this.previousDeltaBias}let a=0;if(this.type==="output")this.error.responsibility=this.error.projected=o-this.activation;else{for(let c of this.connections.out)a+=c.to.error.responsibility*c.weight*c.gain;this.error.projected=this.derivative*a,a=0;for(let c of this.connections.gated){let l=c.to,u=l.connections.self.reduce((p,h)=>p+(h.gater===this?l.old:0),0);u+=c.weight*c.from.activation,a+=l.error.responsibility*u}this.error.gated=this.derivative*a,this.error.responsibility=this.error.projected+this.error.gated}if(this.type==="constant")return;for(let c of this.connections.in){if(c.dcMask===0){c.totalDeltaWeight+=0;continue}let l=this.error.projected*c.eligibility;for(let h=0;h<c.xtrace.nodes.length;h++){let m=c.xtrace.nodes[h],d=c.xtrace.values[h];l+=m.error.responsibility*d}let u=0;typeof s=="function"?u=s(c.weight):typeof s=="object"&&s!==null?s.type==="L1"?u=s.lambda*Math.sign(c.weight):s.type==="L2"&&(u=s.lambda*c.weight):u=s*c.weight;let p=t*(l*this.mask-u);if(Number.isFinite(p)?Math.abs(p)>1e3&&(p=Math.sign(p)*1e3):(console.warn("deltaWeight is not finite, clamping to 0",{node:this.index,connection:c,deltaWeight:p}),p=0),c.totalDeltaWeight+=p,Number.isFinite(c.totalDeltaWeight)||(console.warn("totalDeltaWeight became NaN/Infinity, resetting to 0",{node:this.index,connection:c}),c.totalDeltaWeight=0),i){let h=c.totalDeltaWeight+n*c.previousDeltaWeight;Number.isFinite(h)?Math.abs(h)>1e3&&(h=Math.sign(h)*1e3):(console.warn("currentDeltaWeight is not finite, clamping to 0",{node:this.index,connection:c,currentDeltaWeight:h}),h=0),n>0&&(c.weight-=n*c.previousDeltaWeight),c.weight+=h,Number.isFinite(c.weight)?Math.abs(c.weight)>1e6&&(c.weight=Math.sign(c.weight)*1e6):(console.warn(`Weight update produced invalid value: ${c.weight}. Resetting to 0.`,{node:this.index,connection:c}),c.weight=0),c.previousDeltaWeight=h,c.totalDeltaWeight=0}}for(let c of this.connections.self){if(c.dcMask===0){c.totalDeltaWeight+=0;continue}let l=this.error.projected*c.eligibility;for(let h=0;h<c.xtrace.nodes.length;h++){let m=c.xtrace.nodes[h],d=c.xtrace.values[h];l+=m.error.responsibility*d}let u=0;typeof s=="function"?u=s(c.weight):typeof s=="object"&&s!==null?s.type==="L1"?u=s.lambda*Math.sign(c.weight):s.type==="L2"&&(u=s.lambda*c.weight):u=s*c.weight;let p=t*(l*this.mask-u);if(Number.isFinite(p)?Math.abs(p)>1e3&&(p=Math.sign(p)*1e3):(console.warn("self deltaWeight is not finite, clamping to 0",{node:this.index,connection:c,deltaWeight:p}),p=0),c.totalDeltaWeight+=p,Number.isFinite(c.totalDeltaWeight)||(console.warn("self totalDeltaWeight became NaN/Infinity, resetting to 0",{node:this.index,connection:c}),c.totalDeltaWeight=0),i){let h=c.totalDeltaWeight+n*c.previousDeltaWeight;Number.isFinite(h)?Math.abs(h)>1e3&&(h=Math.sign(h)*1e3):(console.warn("self currentDeltaWeight is not finite, clamping to 0",{node:this.index,connection:c,currentDeltaWeight:h}),h=0),n>0&&(c.weight-=n*c.previousDeltaWeight),c.weight+=h,Number.isFinite(c.weight)?Math.abs(c.weight)>1e6&&(c.weight=Math.sign(c.weight)*1e6):(console.warn("self weight update produced invalid value, resetting to 0",{node:this.index,connection:c}),c.weight=0),c.previousDeltaWeight=h,c.totalDeltaWeight=0}}let r=t*this.error.responsibility;if(Number.isFinite(r)?Math.abs(r)>1e3&&(r=Math.sign(r)*1e3):(console.warn("deltaBias is not finite, clamping to 0",{node:this.index,deltaBias:r}),r=0),this.totalDeltaBias+=r,Number.isFinite(this.totalDeltaBias)||(console.warn("totalDeltaBias became NaN/Infinity, resetting to 0",{node:this.index}),this.totalDeltaBias=0),i){let c=this.totalDeltaBias+n*this.previousDeltaBias;Number.isFinite(c)?Math.abs(c)>1e3&&(c=Math.sign(c)*1e3):(console.warn("currentDeltaBias is not finite, clamping to 0",{node:this.index,currentDeltaBias:c}),c=0),n>0&&(this.bias-=n*this.previousDeltaBias),this.bias+=c,Number.isFinite(this.bias)?Math.abs(this.bias)>1e6&&(this.bias=Math.sign(this.bias)*1e6):(console.warn("bias update produced invalid value, resetting to 0",{node:this.index}),this.bias=0),this.previousDeltaBias=c,this.totalDeltaBias=0}}toJSON(){return{index:this.index,bias:this.bias,type:this.type,squash:this.squash?this.squash.name:null,mask:this.mask}}static fromJSON(t){let n=new e(t.type);if(n.bias=t.bias,n.mask=t.mask,t.squash){let i=V[t.squash];typeof i=="function"?n.squash=i:(console.warn(`fromJSON: Unknown or invalid squash function '${t.squash}' for node. Using identity.`),n.squash=V.identity)}return n}isConnectedTo(t){return this.connections.out.some(n=>n.to===t)}mutate(t){if(!t)throw new Error("Mutation method cannot be null or undefined.");if(!(t.name in j))throw new Error(`Unknown mutation method: ${t.name}`);switch(t){case j.MOD_ACTIVATION:if(!t.allowed||t.allowed.length===0){console.warn("MOD_ACTIVATION mutation called without allowed functions specified.");return}let n=t.allowed,i=n.indexOf(this.squash),s=i;n.length>1&&(s=(i+Math.floor(Math.random()*(n.length-1))+1)%n.length),this.squash=n[s];break;case j.MOD_BIAS:let o=t.min??-1,a=t.max??1,r=Math.random()*(a-o)+o;this.bias+=r;break;case j.REINIT_WEIGHT:let c=t.min??-1,l=t.max??1;for(let u of this.connections.in)u.weight=Math.random()*(l-c)+c;for(let u of this.connections.out)u.weight=Math.random()*(l-c)+c;for(let u of this.connections.self)u.weight=Math.random()*(l-c)+c;break;case j.BATCH_NORM:this.batchNorm=!0;break;default:throw new Error(`Unsupported mutation method: ${t.name}`)}}connect(t,n){let i=[];if(!t)throw new Error("Cannot connect to an undefined target.");if("bias"in t){let s=t;if(s===this){if(this.connections.self.length===0){let o=dt.acquire(this,this,n??1);this.connections.self.push(o),i.push(o)}}else{let o=dt.acquire(this,s,n);s.connections.in.push(o),this.connections.out.push(o),i.push(o)}}else if("nodes"in t&&Array.isArray(t.nodes))for(let s of t.nodes){let o=dt.acquire(this,s,n);s.connections.in.push(o),this.connections.out.push(o),i.push(o)}else throw new Error("Invalid target type for connection. Must be a Node or a group { nodes: Node[] }.");return i}disconnect(t,n=!1){if(this===t){this.connections.self=[];return}this.connections.out=this.connections.out.filter(i=>i.to===t?(t.connections.in=t.connections.in.filter(s=>s!==i),i.gater&&i.gater.ungate(i),!1):!0),n&&t.disconnect(this,!1)}gate(t){Array.isArray(t)||(t=[t]);for(let n of t){if(!n||!n.from||!n.to){console.warn("Attempted to gate an invalid or incomplete connection.");continue}if(n.gater===this){console.warn("Node is already gating this connection.");continue}if(n.gater!==null){console.warn("Connection is already gated by another node. Ungate first.");continue}this.connections.gated.push(n),n.gater=this}}ungate(t){Array.isArray(t)||(t=[t]);for(let n of t){if(!n)continue;let i=this.connections.gated.indexOf(n);i!==-1&&(this.connections.gated.splice(i,1),n.gater=null,n.gain=1)}}clear(){for(let t of this.connections.in)t.eligibility=0,t.xtrace={nodes:[],values:[]};for(let t of this.connections.self)t.eligibility=0,t.xtrace={nodes:[],values:[]};for(let t of this.connections.gated)t.gain=0;this.error={responsibility:0,projected:0,gated:0},this.old=this.state=this.activation=0}isProjectingTo(t){return t===this&&this.connections.self.length>0?!0:this.connections.out.some(n=>n.to===t)}isProjectedBy(t){return t===this&&this.connections.self.length>0?!0:this.connections.in.some(n=>n.from===t)}applyBatchUpdates(t){return this.applyBatchUpdatesWithOptimizer({type:"sgd",momentum:t})}applyBatchUpdatesWithOptimizer(t){let n=t.type||"sgd",i=n==="lookahead"?t.baseType||"sgd":n,s=t.momentum??0,o=t.beta1??.9,a=t.beta2??.999,r=t.eps??1e-8,c=t.weightDecay??0,l=t.lrScale??1,u=Math.max(1,Math.floor(t.t??1));n==="lookahead"&&(this._la_k=this._la_k||t.la_k||5,this._la_alpha=this._la_alpha||t.la_alpha||.5,this._la_step=(this._la_step||0)+1,this._la_shadowBias||(this._la_shadowBias=this.bias));let p=h=>{let m=h.totalDeltaWeight||0;switch(Number.isFinite(m)||(m=0),i){case"rmsprop":{h.gradientAccumulator=(h.gradientAccumulator??0)*.9+.1*(m*m);let d=m/(Math.sqrt(h.gradientAccumulator)+r);this._safeUpdateWeight(h,d*l);break}case"adagrad":{h.gradientAccumulator=(h.gradientAccumulator??0)+m*m;let d=m/(Math.sqrt(h.gradientAccumulator)+r);this._safeUpdateWeight(h,d*l);break}case"adam":case"adamw":case"amsgrad":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(m*m),i==="amsgrad"&&(h.maxSecondMoment=Math.max(h.maxSecondMoment??0,h.secondMoment??0));let d=i==="amsgrad"?h.maxSecondMoment:h.secondMoment,f=h.firstMoment/(1-Math.pow(o,u)),b=d/(1-Math.pow(a,u)),g=f/(Math.sqrt(b)+r)*l;i==="adamw"&&c!==0&&(g-=c*(h.weight||0)),this._safeUpdateWeight(h,g);break}case"adamax":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m,h.infinityNorm=Math.max((h.infinityNorm??0)*a,Math.abs(m));let f=h.firstMoment/(1-Math.pow(o,u))/(h.infinityNorm||1e-12)*l;this._safeUpdateWeight(h,f);break}case"nadam":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(m*m);let d=h.firstMoment/(1-Math.pow(o,u)),f=h.secondMoment/(1-Math.pow(a,u)),b=d*o+(1-o)*m/(1-Math.pow(o,u));this._safeUpdateWeight(h,b/(Math.sqrt(f)+r)*l);break}case"radam":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m,h.secondMoment=(h.secondMoment??0)*a+(1-a)*(m*m);let d=h.firstMoment/(1-Math.pow(o,u)),f=h.secondMoment/(1-Math.pow(a,u)),b=2/(1-a)-1,g=b-2*u*Math.pow(a,u)/(1-Math.pow(a,u));if(g>4){let y=Math.sqrt((g-4)*(g-2)*b/((b-4)*(b-2)*g));this._safeUpdateWeight(h,y*d/(Math.sqrt(f)+r)*l)}else this._safeUpdateWeight(h,d*l);break}case"lion":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m,h.secondMomentum=(h.secondMomentum??0)*a+(1-a)*m;let d=Math.sign((h.firstMoment||0)+(h.secondMomentum||0));this._safeUpdateWeight(h,-d*l);break}case"adabelief":{h.firstMoment=(h.firstMoment??0)*o+(1-o)*m;let d=m-h.firstMoment;h.secondMoment=(h.secondMoment??0)*a+(1-a)*(d*d);let f=h.firstMoment/(1-Math.pow(o,u)),b=h.secondMoment/(1-Math.pow(a,u));this._safeUpdateWeight(h,f/(Math.sqrt(b)+r+1e-12)*l);break}default:{let d=m+s*(h.previousDeltaWeight||0);Number.isFinite(d)||(d=0),Math.abs(d)>1e3&&(d=Math.sign(d)*1e3),this._safeUpdateWeight(h,d*l),h.previousDeltaWeight=d}}i==="adamw"&&c!==0&&this._safeUpdateWeight(h,-c*(h.weight||0)*l),h.totalDeltaWeight=0};for(let h of this.connections.in)p(h);for(let h of this.connections.self)p(h);if(this.type!=="input"&&this.type!=="constant"){let h=this.totalDeltaBias||0;if(Number.isFinite(h)||(h=0),["adam","adamw","amsgrad","adamax","nadam","radam","lion","adabelief"].includes(i)){this.opt_mB=(this.opt_mB??0)*o+(1-o)*h,i==="lion"&&(this.opt_mB2=(this.opt_mB2??0)*a+(1-a)*h),this.opt_vB=(this.opt_vB??0)*a+(1-a)*(i==="adabelief"?Math.pow(h-this.opt_mB,2):h*h),i==="amsgrad"&&(this.opt_vhatB=Math.max(this.opt_vhatB??0,this.opt_vB??0));let m=i==="amsgrad"?this.opt_vhatB:this.opt_vB,d=this.opt_mB/(1-Math.pow(o,u)),f=m/(1-Math.pow(a,u)),b;if(i==="adamax")this.opt_uB=Math.max((this.opt_uB??0)*a,Math.abs(h)),b=d/(this.opt_uB||1e-12)*l;else if(i==="nadam")b=(d*o+(1-o)*h/(1-Math.pow(o,u)))/(Math.sqrt(f)+r)*l;else if(i==="radam"){let y=2/(1-a)-1,N=y-2*u*Math.pow(a,u)/(1-Math.pow(a,u));N>4?b=Math.sqrt((N-4)*(N-2)*y/((y-4)*(y-2)*N))*d/(Math.sqrt(f)+r)*l:b=d*l}else i==="lion"?b=-Math.sign(this.opt_mB+this.opt_mB2)*l:i==="adabelief"?b=d/(Math.sqrt(f)+r+1e-12)*l:b=d/(Math.sqrt(f)+r)*l;i==="adamw"&&c!==0&&(b-=c*(this.bias||0)*l);let g=this.bias+b;Number.isFinite(g)||(g=0),Math.abs(g)>1e6&&(g=Math.sign(g)*1e6),this.bias=g}else{let m=h+s*(this.previousDeltaBias||0);Number.isFinite(m)||(m=0),Math.abs(m)>1e3&&(m=Math.sign(m)*1e3);let d=this.bias+m*l;Number.isFinite(d)||(d=0),Math.abs(d)>1e6&&(d=Math.sign(d)*1e6),this.bias=d,this.previousDeltaBias=m}this.totalDeltaBias=0}else this.previousDeltaBias=0,this.totalDeltaBias=0;if(n==="lookahead"){let h=this._la_k||5,m=this._la_alpha||.5;if(this._la_step%h===0){this._la_shadowBias=(1-m)*this._la_shadowBias+m*this.bias,this.bias=this._la_shadowBias;let d=f=>{f.lookaheadShadowWeight||(f.lookaheadShadowWeight=f.weight),f.lookaheadShadowWeight=(1-m)*f.lookaheadShadowWeight+m*f.weight,f.weight=f.lookaheadShadowWeight};for(let f of this.connections.in)d(f);for(let f of this.connections.self)d(f)}}}_safeUpdateWeight(t,n){let i=t.weight+n;Number.isFinite(i)||(i=0),Math.abs(i)>1e6&&(i=Math.sign(i)*1e6),t.weight=i}}});function Gs(e,t,n=Math.random){t&&(e.type=t);let i=e.type;e.bias=i==="input"?0:n()*.2-.1,e.activation=0,e.state=0,e.old=0,e.mask=1,e.previousDeltaBias=0,e.totalDeltaBias=0,e.derivative=void 0,e.connections.in.length=0,e.connections.out.length=0,e.connections.gated.length=0,e.connections.self.length=0,e.error={responsibility:0,projected:0,gated:0},e.geneId=pn++}function _e(e={}){let{type:t="hidden",activationFn:n,rng:i}=e,s;return Jt.length?(s=Jt.pop(),$s++,Gs(s,t,i),n&&(s.squash=n)):(s=new Q(t,n,i),s.geneId=pn++,Hs++),s}function se(e){e.connections.in.length=0,e.connections.out.length=0,e.connections.gated.length=0,e.connections.self.length=0,e.error={responsibility:0,projected:0,gated:0},Jt.push(e),Jt.length>hn&&(hn=Jt.length)}var Jt,hn,pn,$s,Hs,xe=H(()=>{"use strict";lt();Jt=[],hn=0,pn=1,$s=0,Hs=0});var we={};ht(we,{TestWorker:()=>oe,default:()=>Bs});var dn,oe,Bs,Me=H(()=>{"use strict";dn=zt("child_process"),oe=class{worker;constructor(t,n){let i=null;try{i=zt("path")}catch{}let s=i?i.join(__dirname,"/worker"):"./worker";this.worker=(0,dn.fork)(s),this.worker.send({set:t,cost:n.name})}async evaluate(t){let n=t.serialize(),i={activations:n[0],states:n[1],conns:n[2]};return new Promise((s,o)=>{let a=u=>{l(),s(u)},r=u=>{l(),o(u)},c=(u,p)=>{l(),o(new Error(`worker exited${u!=null?` with code ${u}`:p?` with signal ${p}`:""}`))},l=()=>{this.worker.off("message",a),this.worker.off("error",r),this.worker.off("exit",c)};this.worker.once("message",a),this.worker.once("error",r),this.worker.once("exit",c),this.worker.send(i)})}terminate(){this.worker.kill()}},Bs=oe});var Ie={};ht(Ie,{TestWorker:()=>Ee});var Ee,Ce=H(()=>{"use strict";Xt();Ee=class e{worker;url;constructor(t,n){let i=new Blob([e._createBlobString(n)]);this.url=window.URL.createObjectURL(i),this.worker=new Worker(this.url);let s={set:new Float64Array(t).buffer};this.worker.postMessage(s,[s.set])}evaluate(t){return new Promise((n,i)=>{let s=t.serialize(),o={activations:new Float64Array(s[0]).buffer,states:new Float64Array(s[1]).buffer,conns:new Float64Array(s[2]).buffer};this.worker.onmessage=function(a){let r=new Float64Array(a.data.buffer)[0];n(r)},this.worker.postMessage(o,[o.activations,o.states,o.conns])})}terminate(){this.worker.terminate(),window.URL.revokeObjectURL(this.url)}static _createBlobString(t){return`
      const F = [${ft.activations.toString()}];
      const cost = ${t.toString()};
      const multi = {
        deserializeDataSet: ${ft.deserializeDataSet.toString()},
        testSerializedSet: ${ft.testSerializedSet.toString()},
        activateSerializedNetwork: ${ft.activateSerializedNetwork.toString()}
      };

      let set;

      this.onmessage = function (e) {
        if (typeof e.data.set === 'undefined') {
          const A = new Float64Array(e.data.activations);
          const S = new Float64Array(e.data.states);
          const data = new Float64Array(e.data.conns);

          const error = multi.testSerializedSet(set, cost, A, S, data, F);

          const answer = { buffer: new Float64Array([error]).buffer };
          postMessage(answer, [answer.buffer]);
        } else {
          set = multi.deserializeDataSet(new Float64Array(e.data.set));
        }
      };`}}});var ae,mn=H(()=>{"use strict";ae=class{static async getNodeTestWorker(){return(await Promise.resolve().then(()=>(Me(),we))).TestWorker}static async getBrowserTestWorker(){return(await Promise.resolve().then(()=>(Ce(),Ie))).TestWorker}}});var ft,Xt=H(()=>{"use strict";mn();pt();ft=class e{static workers=ae;static activations=[t=>1/(1+Math.exp(-t)),t=>Math.tanh(t),t=>t,t=>t>0?1:0,t=>t>0?t:0,t=>t/(1+Math.abs(t)),t=>Math.sin(t),t=>Math.exp(-Math.pow(t,2)),t=>(Math.sqrt(Math.pow(t,2)+1)-1)/2+t,t=>t>0?1:-1,t=>2/(1+Math.exp(-t))-1,t=>Math.max(-1,Math.min(1,t)),t=>Math.abs(t),t=>1-t,t=>{let n=1.6732632423543772;return(t>0?t:n*Math.exp(t)-n)*1.0507009873554805},t=>Math.log(1+Math.exp(t))];static serializeDataSet(t){let n=[t[0].input.length,t[0].output.length];for(let i=0;i<t.length;i++){for(let s=0;s<n[0];s++)n.push(t[i].input[s]);for(let s=0;s<n[1];s++)n.push(t[i].output[s])}return n}static activateSerializedNetwork(t,n,i,s,o){for(let r=0;r<s[0];r++)n[r]=t[r];for(let r=2;r<s.length;r++){let c=s[r++],l=s[r++],u=s[r++],p=s[r++],h=s[r++];for(i[c]=(h===-1?1:n[h])*p*i[c]+l;s[r]!==-2;)i[c]+=n[s[r++]]*s[r++]*(s[r++]===-1?1:n[s[r-1]]);n[c]=o[u](i[c])}let a=[];for(let r=n.length-s[1];r<n.length;r++)a.push(n[r]);return a}static deserializeDataSet(t){let n=[],i=t[0]+t[1];for(let s=0;s<(t.length-2)/i;s++){let o=[];for(let r=2+s*i;r<2+s*i+t[0];r++)o.push(t[r]);let a=[];for(let r=2+s*i+t[0];r<2+s*i+i;r++)a.push(t[r]);n.push({input:o,output:a})}return n}static logistic(t){return 1/(1+Math.exp(-t))}static tanh(t){return Math.tanh(t)}static identity(t){return t}static step(t){return t>0?1:0}static relu(t){return t>0?t:0}static softsign(t){return t/(1+Math.abs(t))}static sinusoid(t){return Math.sin(t)}static gaussian(t){return Math.exp(-Math.pow(t,2))}static bentIdentity(t){return(Math.sqrt(Math.pow(t,2)+1)-1)/2+t}static bipolar(t){return t>0?1:-1}static bipolarSigmoid(t){return 2/(1+Math.exp(-t))-1}static hardTanh(t){return Math.max(-1,Math.min(1,t))}static absolute(t){return Math.abs(t)}static inverse(t){return 1-t}static selu(t){let n=1.6732632423543772;return(t>0?t:n*Math.exp(t)-n)*1.0507009873554805}static softplus(t){return Math.log(1+Math.exp(t))}static testSerializedSet(t,n,i,s,o,a){let r=0;for(let c=0;c<t.length;c++){let l=e.activateSerializedNetwork(t[c].input,i,s,o,a);r+=n(t[c].output,l)}return r/t.length}static async getBrowserTestWorker(){let{TestWorker:t}=await Promise.resolve().then(()=>(Ce(),Ie));return t}static async getNodeTestWorker(){let{TestWorker:t}=await Promise.resolve().then(()=>(Me(),we));return t}}});var Te,yt,Kt=H(()=>{"use strict";At();Te=class{buckets=new Map;created=0;reused=0;maxPerBucket=Number.POSITIVE_INFINITY;acquire(t){let n=this.buckets.get(t);if(n&&n.length>0){this.reused++;let i=n.pop();return i.fill(0),i}return this.created++,U.float32Mode?new Float32Array(t):new Array(t).fill(0)}release(t){let n=t.length>>>0;this.buckets.has(n)||this.buckets.set(n,[]);let i=this.buckets.get(n);i.length<this.maxPerBucket&&i.push(t)}clear(){this.buckets.clear(),this.created=0,this.reused=0}stats(){return{created:this.created,reused:this.reused,bucketCount:this.buckets.size}}setMaxPerBucket(t){typeof t=="number"&&t>=0&&(this.maxPerBucket=t)}prewarm(t,n){let i=Math.max(0,Math.floor(n));this.buckets.has(t)||this.buckets.set(t,[]);let s=this.buckets.get(t);for(let o=0;o<i&&s.length<this.maxPerBucket;o++){let a=U.float32Mode?new Float32Array(t):new Array(t).fill(0);s.push(a),this.created++}}bucketSize(t){return this.buckets.get(t)?.length??0}},yt=new Te});var fn=Ss((lr,js)=>{js.exports={name:"@reicek/neataptic-ts",version:"0.1.12",description:"Architecture-free neural network library with genetic algorithm implementations",main:"./dist/neataptic.js",module:"./dist/neataptic.js",types:"./dist/neataptic.d.ts",type:"module",scripts:{test:"jest --config=jest.config.mjs --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts --verbose",pretest:"npm run build","test:bench":"jest --no-cache --runInBand --verbose --testPathPattern=benchmark","bench:asciiMaze":"node -r ts-node/register test/benchmarks/asciiMaze.micro.bench.ts","test:silent":"jest --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts --silent",deploy:"npm run build && npm run test:dist && npm publish",build:"npm run build:webpack && npm run build:ts","build:ts":"tsc","build:webpack":"webpack --config webpack.config.js","build:ascii-maze":"npx esbuild test/examples/asciiMaze/browser-entry.ts --bundle --outfile=docs/assets/ascii-maze.bundle.js --platform=browser --format=iife --minify --sourcemap --external:fs --external:child_process --external:path","start:ts":"ts-node src/neataptic.ts","test:e2e":"cross-env FORCE_COLOR=true jest e2e.test.ts --no-cache --runInBand","test:e2e:logs":"npx jest e2e.test.ts --verbose --runInBand --no-cache","test:dist":"npm run build:ts && jest --no-cache --coverage --collect-coverage --runInBand --testPathIgnorePatterns=.e2e.test.ts","docs:build-scripts":"tsc -p tsconfig.docs.json && node scripts/write-dist-docs-pkg.mjs","docs:folders":"npm run docs:build-scripts && node ./dist-docs/scripts/generate-docs.js","docs:html":"npm run docs:build-scripts && node ./dist-docs/scripts/render-docs-html.js","docs:examples":"node scripts/copy-examples.mjs",prettier:"npm run prettier:tests && npm run prettier:src","prettier:tests":"npx prettier --write test/**/*.ts","prettier:src":"npx prettier --write src/**/*.ts",docs:"npm run build:ascii-maze && npm run docs:examples && npm run docs:build-scripts && node ./dist-docs/scripts/generate-docs.js && node ./dist-docs/scripts/render-docs-html.js","onnx:export":"node scripts/export-onnx.mjs"},exports:{".":{types:"./dist/neataptic.d.ts",import:"./dist/neataptic.js"}},devDependencies:{"@types/chai":"^5.2.2","@types/fs-extra":"^11.0.4","@types/jest":"^30.0.0","@types/node":"^24.3.0","@types/seedrandom":"^3.0.8","@types/webpack":"^5.28.5","@types/webpack-dev-server":"^4.7.2",chai:"^6.0.1","copy-webpack-plugin":"^13.0.1","cross-env":"^10.0.0",esbuild:"^0.25.9","fast-glob":"^3.3.3","fs-extra":"^11.3.1",husky:"^9.1.7",jest:"^30.0.5","jest-environment-jsdom":"^30.0.5","jsdoc-to-markdown":"^9.1.2",marked:"^16.2.0",mkdocs:"^0.0.1",puppeteer:"^24.17.0","ts-jest":"^29.4.1","ts-loader":"^9.5.2","ts-morph":"^26.0.0","ts-node":"^10.9.2",typescript:"^5.9.2","undici-types":"^7.15.0",webpack:"^5.101.3","webpack-cli":"^6.0.1"},repository:{type:"git",url:"https://github.com/reicek/NeatapticTS.git"},keywords:["neural network","machine learning","genetic algorithm","mutation","neat"],author:{name:"Cesar Anton",email:"reicek@gmail.com"},license:"MIT",publishConfig:{access:"public",registry:"https://registry.npmjs.org/"},bugs:{url:"https://github.com/reicek/NeatapticTS/issues",email:"reicek@gmail.com"},homepage:"https://reicek.github.io/NeatapticTS/",engines:{node:">=22.0.0"},prettier:{singleQuote:!0},dependencies:{seedrandom:"^3.0.5",undici:"^7.15.0"}}});function Us(e){let t=new Set;e.nodes.forEach(n=>n.connections?.out.forEach(i=>t.add(i))),e.connections=Array.from(t)}function Zt(e){let t=(e?.name||"").toUpperCase();return t.includes("TANH")?"Tanh":t.includes("LOGISTIC")||t.includes("SIGMOID")?"Sigmoid":t.includes("RELU")?"Relu":(e&&console.warn(`Unsupported activation function ${e.name} for ONNX export, defaulting to Identity.`),"Identity")}function zs(e){let t=e.nodes.filter(r=>r.type==="input"),n=e.nodes.filter(r=>r.type==="output"),i=e.nodes.filter(r=>r.type==="hidden");if(i.length===0)return[t,n];let s=[...i],o=t,a=[];for(;s.length;){let r=s.filter(c=>c.connections.in.every(l=>o.includes(l.from)));if(!r.length)throw new Error("Invalid network structure for ONNX export: cannot resolve layered ordering.");a.push(o),o=r,s=s.filter(c=>!r.includes(c))}return a.push(o),a.push(n),a}function qs(e,t,n){for(let i=1;i<e.length;i++){let s=e[i-1],o=e[i],a=new Set(o.map(r=>r.squash&&r.squash.name));if(a.size>1&&!n.allowMixedActivations)throw new Error(`ONNX export error: Mixed activation functions detected in layer ${i}. (enable allowMixedActivations to decompose layer)`);a.size>1&&n.allowMixedActivations&&console.warn(`Warning: Mixed activations in layer ${i}; exporting per-neuron Gemm + Activation (+Concat) baseline.`);for(let r of o)for(let c of s)if(!r.connections.in.some(u=>u.from===c)&&!n.allowPartialConnectivity)throw new Error(`ONNX export error: Missing connection from node ${c.index} to node ${r.index} in layer ${i}. (enable allowPartialConnectivity)`)}}function Vs(e,t,n={}){let{includeMetadata:i=!1,opset:s=18,batchDimension:o=!1,legacyNodeOrdering:a=!1,producerName:r="neataptic-ts",producerVersion:c,docString:l}=n,u=t[0],p=t[t.length-1],h=o?[{dim_param:"N"},{dim_value:u.length}]:[{dim_value:u.length}],m=o?[{dim_param:"N"},{dim_value:p.length}]:[{dim_value:p.length}],d={graph:{inputs:[{name:"input",type:{tensor_type:{elem_type:1,shape:{dim:h}}}}],outputs:[{name:"output",type:{tensor_type:{elem_type:1,shape:{dim:m}}}}],initializer:[],node:[]}};if(i){let y=(()=>{try{return fn().version}catch{return"0.0.0"}})();d.ir_version=9,d.opset_import=[{version:s,domain:""}],d.producer_name=r,d.producer_version=c||y,d.doc_string=l||"Exported from NeatapticTS ONNX exporter (phases 1-2 baseline)"}let f="input",b=[];if(n.allowRecurrent&&n.recurrentSingleStep)for(let y=1;y<t.length-1;y++){let N=t[y];if(N.some(S=>S.connections.self.length>0)){b.push(y);let S=y===1?"hidden_prev":`hidden_prev_l${y}`;d.graph.inputs.push({name:S,type:{tensor_type:{elem_type:1,shape:{dim:o?[{dim_param:"N"},{dim_value:N.length}]:[{dim_value:N.length}]}}}})}}let g=[];for(let y=1;y<t.length;y++){let N=t[y-1],S=t[y],v=y===t.length-1;v||g.push(S.length);let _=n.conv2dMappings?.find(w=>w.layerIndex===y);if(_){let w=_.inHeight*_.inWidth*_.inChannels,I=N.length,C=_.outChannels*_.outHeight*_.outWidth,F=S.length,P=[_.padTop||0,_.padLeft||0,_.padBottom||0,_.padRight||0];if(!(w===I&&C===F))console.warn(`Conv2D mapping for layer ${y} skipped: dimension mismatch (expected prev=${w} got ${I}; expected this=${C} got ${F}).`);else{let E=[],T=[];for(let Y=0;Y<_.outChannels;Y++){let at=Y*_.outHeight*_.outWidth,ct=S[at];T.push(ct.bias);for(let W=0;W<_.inChannels;W++)for(let J=0;J<_.kernelHeight;J++)for(let X=0;X<_.kernelWidth;X++){let it=W*(_.inHeight*_.inWidth)+J*_.inWidth+X,nt=N[it],K=ct.connections.in.find(ot=>ot.from===nt);E.push(K?K.weight:0)}}let k=`ConvW${y-1}`,D=`ConvB${y-1}`;d.graph.initializer.push({name:k,data_type:1,dims:[_.outChannels,_.inChannels,_.kernelHeight,_.kernelWidth],float_data:E}),d.graph.initializer.push({name:D,data_type:1,dims:[_.outChannels],float_data:T});let O=`Conv_${y}`;d.graph.node.push({op_type:"Conv",input:[f,k,D],output:[O],name:`conv_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:[_.kernelHeight,_.kernelWidth]},{name:"strides",type:"INTS",ints:[_.strideHeight,_.strideWidth]},{name:"pads",type:"INTS",ints:P}]});let M=_.activation||Zt(S[0].squash),R=`Layer_${y}`;d.graph.node.push({op_type:M,input:[O],output:[R],name:`act_conv_l${y}`}),f=R;let L=n.pool2dMappings?.find(Y=>Y.afterLayerIndex===y);if(L){let Y=[L.kernelHeight,L.kernelWidth],at=[L.strideHeight,L.strideWidth],ct=[L.padTop||0,L.padLeft||0,L.padBottom||0,L.padRight||0],W=`Pool_${y}`;if(d.graph.node.push({op_type:L.type,input:[f],output:[W],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:Y},{name:"strides",type:"INTS",ints:at},{name:"pads",type:"INTS",ints:ct}]}),f=W,n.flattenAfterPooling){let it=`PoolFlat_${y}`;d.graph.node.push({op_type:"Flatten",input:[f],output:[it],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),f=it,d.metadata_props=d.metadata_props||[];let nt=d.metadata_props.find(K=>K.key==="flatten_layers");if(nt)try{let K=JSON.parse(nt.value);Array.isArray(K)&&!K.includes(y)&&(K.push(y),nt.value=JSON.stringify(K))}catch{nt.value=JSON.stringify([y])}else d.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}d.metadata_props=d.metadata_props||[];let J=d.metadata_props.find(it=>it.key==="pool2d_layers");if(J)try{let it=JSON.parse(J.value);Array.isArray(it)&&!it.includes(y)&&(it.push(y),J.value=JSON.stringify(it))}catch{J.value=JSON.stringify([y])}else d.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let X=d.metadata_props.find(it=>it.key==="pool2d_specs");if(X)try{let it=JSON.parse(X.value);Array.isArray(it)&&(it.push({...L}),X.value=JSON.stringify(it))}catch{X.value=JSON.stringify([L])}else d.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([L])})}d.metadata_props=d.metadata_props||[];let G=d.metadata_props.find(Y=>Y.key==="conv2d_layers");if(G)try{let Y=JSON.parse(G.value);Array.isArray(Y)&&!Y.includes(y)&&(Y.push(y),G.value=JSON.stringify(Y))}catch{G.value=JSON.stringify([y])}else d.metadata_props.push({key:"conv2d_layers",value:JSON.stringify([y])});let B=d.metadata_props.find(Y=>Y.key==="conv2d_specs");if(B)try{let Y=JSON.parse(B.value);Array.isArray(Y)&&(Y.push({..._}),B.value=JSON.stringify(Y))}catch{B.value=JSON.stringify([_])}else d.metadata_props.push({key:"conv2d_specs",value:JSON.stringify([_])});continue}}let x=n.allowMixedActivations&&new Set(S.map(w=>w.squash&&w.squash.name)).size>1;if(b.includes(y)&&!v){if(x)throw new Error(`Recurrent export does not yet support mixed activations in hidden layer ${y}.`);let w=[],I=new Array(S.length).fill(0);for(let T=0;T<S.length;T++){let k=S[T];I[T]=k.bias;for(let D=0;D<N.length;D++){let O=N[D],M=k.connections.in.find(R=>R.from===O);w.push(M?M.weight:0)}}let C=`W${y-1}`,F=`B${y-1}`;d.graph.initializer.push({name:C,data_type:1,dims:[S.length,N.length],float_data:w}),d.graph.initializer.push({name:F,data_type:1,dims:[S.length],float_data:I});let P=[];for(let T=0;T<S.length;T++)for(let k=0;k<S.length;k++)if(T===k){let D=S[T].connections.self[0];P.push(D?D.weight:0)}else P.push(0);let $=`R${y-1}`;d.graph.initializer.push({name:$,data_type:1,dims:[S.length,S.length],float_data:P}),d.graph.node.push({op_type:"Gemm",input:[f,C,F],output:[`Gemm_in_${y}`],name:`gemm_in_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]});let E=y===1?"hidden_prev":`hidden_prev_l${y}`;d.graph.node.push({op_type:"Gemm",input:[E,$],output:[`Gemm_rec_${y}`],name:`gemm_rec_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),d.graph.node.push({op_type:"Add",input:[`Gemm_in_${y}`,`Gemm_rec_${y}`],output:[`RecurrentSum_${y}`],name:`add_recurrent_l${y}`}),d.graph.node.push({op_type:Zt(S[0].squash),input:[`RecurrentSum_${y}`],output:[`Layer_${y}`],name:`act_l${y}`}),f=`Layer_${y}`}else if(x){let w=[];S.forEach((F,P)=>{let $=[];for(let O=0;O<N.length;O++){let M=N[O],R=F.connections.in.find(L=>L.from===M);$.push(R?R.weight:0)}let E=`W${y-1}_n${P}`,T=`B${y-1}_n${P}`,k=`Gemm_${y}_n${P}`,D=`Layer_${y}_n${P}`;d.graph.initializer.push({name:E,data_type:1,dims:[1,N.length],float_data:$}),d.graph.initializer.push({name:T,data_type:1,dims:[1],float_data:[F.bias]}),d.graph.node.push({op_type:"Gemm",input:[f,E,T],output:[k],name:`gemm_l${y}_n${P}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),d.graph.node.push({op_type:Zt(F.squash),input:[k],output:[D],name:`act_l${y}_n${P}`}),w.push(D)});let I=`Layer_${y}`;d.graph.node.push({op_type:"Concat",input:w,output:[I],name:`concat_l${y}`,attributes:[{name:"axis",type:"INT",i:o?1:0}]}),f=I;let C=n.pool2dMappings?.find(F=>F.afterLayerIndex===y);if(C){let F=[C.kernelHeight,C.kernelWidth],P=[C.strideHeight,C.strideWidth],$=[C.padTop||0,C.padLeft||0,C.padBottom||0,C.padRight||0],E=`Pool_${y}`;if(d.graph.node.push({op_type:C.type,input:[f],output:[E],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:F},{name:"strides",type:"INTS",ints:P},{name:"pads",type:"INTS",ints:$}]}),f=E,n.flattenAfterPooling){let D=`PoolFlat_${y}`;d.graph.node.push({op_type:"Flatten",input:[f],output:[D],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),f=D,d.metadata_props=d.metadata_props||[];let O=d.metadata_props.find(M=>M.key==="flatten_layers");if(O)try{let M=JSON.parse(O.value);Array.isArray(M)&&!M.includes(y)&&(M.push(y),O.value=JSON.stringify(M))}catch{O.value=JSON.stringify([y])}else d.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}d.metadata_props=d.metadata_props||[];let T=d.metadata_props.find(D=>D.key==="pool2d_layers");if(T)try{let D=JSON.parse(T.value);Array.isArray(D)&&!D.includes(y)&&(D.push(y),T.value=JSON.stringify(D))}catch{T.value=JSON.stringify([y])}else d.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let k=d.metadata_props.find(D=>D.key==="pool2d_specs");if(k)try{let D=JSON.parse(k.value);Array.isArray(D)&&(D.push({...C}),k.value=JSON.stringify(D))}catch{k.value=JSON.stringify([C])}else d.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([C])})}}else{let w=[],I=new Array(S.length).fill(0);for(let T=0;T<S.length;T++){let k=S[T];I[T]=k.bias;for(let D=0;D<N.length;D++){let O=N[D],M=k.connections.in.find(R=>R.from===O);w.push(M?M.weight:0)}}let C=`W${y-1}`,F=`B${y-1}`,P=`Gemm_${y}`,$=`Layer_${y}`;d.graph.initializer.push({name:C,data_type:1,dims:[S.length,N.length],float_data:w}),d.graph.initializer.push({name:F,data_type:1,dims:[S.length],float_data:I}),a?(d.graph.node.push({op_type:Zt(S[0].squash),input:[P],output:[$],name:`act_l${y}`}),d.graph.node.push({op_type:"Gemm",input:[f,C,F],output:[P],name:`gemm_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]})):(d.graph.node.push({op_type:"Gemm",input:[f,C,F],output:[P],name:`gemm_l${y}`,attributes:[{name:"alpha",type:"FLOAT",f:1},{name:"beta",type:"FLOAT",f:1},{name:"transB",type:"INT",i:1}]}),d.graph.node.push({op_type:Zt(S[0].squash),input:[P],output:[$],name:`act_l${y}`})),f=$;let E=n.pool2dMappings?.find(T=>T.afterLayerIndex===y);if(E){let T=[E.kernelHeight,E.kernelWidth],k=[E.strideHeight,E.strideWidth],D=[E.padTop||0,E.padLeft||0,E.padBottom||0,E.padRight||0],O=`Pool_${y}`;if(d.graph.node.push({op_type:E.type,input:[f],output:[O],name:`pool_after_l${y}`,attributes:[{name:"kernel_shape",type:"INTS",ints:T},{name:"strides",type:"INTS",ints:k},{name:"pads",type:"INTS",ints:D}]}),f=O,n.flattenAfterPooling){let L=`PoolFlat_${y}`;d.graph.node.push({op_type:"Flatten",input:[f],output:[L],name:`flatten_after_l${y}`,attributes:[{name:"axis",type:"INT",i:1}]}),f=L,d.metadata_props=d.metadata_props||[];let G=d.metadata_props.find(B=>B.key==="flatten_layers");if(G)try{let B=JSON.parse(G.value);Array.isArray(B)&&!B.includes(y)&&(B.push(y),G.value=JSON.stringify(B))}catch{G.value=JSON.stringify([y])}else d.metadata_props.push({key:"flatten_layers",value:JSON.stringify([y])})}d.metadata_props=d.metadata_props||[];let M=d.metadata_props.find(L=>L.key==="pool2d_layers");if(M)try{let L=JSON.parse(M.value);Array.isArray(L)&&!L.includes(y)&&(L.push(y),M.value=JSON.stringify(L))}catch{M.value=JSON.stringify([y])}else d.metadata_props.push({key:"pool2d_layers",value:JSON.stringify([y])});let R=d.metadata_props.find(L=>L.key==="pool2d_specs");if(R)try{let L=JSON.parse(R.value);Array.isArray(L)&&(L.push({...E}),R.value=JSON.stringify(L))}catch{R.value=JSON.stringify([E])}else d.metadata_props.push({key:"pool2d_specs",value:JSON.stringify([E])})}}}if(n.allowRecurrent)for(let y=1;y<t.length-1;y++){let N=t[y],S=N.length;if(d.metadata_props||(d.metadata_props=[]),S>=8&&S<10&&d.metadata_props.push({key:"rnn_pattern_fallback",value:JSON.stringify({layer:y,reason:"size_between_gru_lstm_thresholds"})}),S>=10&&S%5===0){let v=S/5,_=t[y-1],x=N.slice(0,v),w=N.slice(v,v*2),I=N.slice(v*2,v*3),C=N.slice(v*3,v*4),F=N.slice(v*4,v*5),P=[x,w,I,C],$=P.length,E=_.length,T=[],k=[],D=[];for(let M=0;M<$;M++){let R=P[M];for(let L=0;L<v;L++){let G=R[L];for(let B=0;B<E;B++){let Y=_[B],at=G.connections.in.find(ct=>ct.from===Y);T.push(at?at.weight:0)}for(let B=0;B<v;B++)if(R===I&&B===L){let Y=G.connections.self[0];k.push(Y?Y.weight:0)}else k.push(0);D.push(G.bias)}}d.graph.initializer.push({name:`LSTM_W${y-1}`,data_type:1,dims:[$*v,E],float_data:T}),d.graph.initializer.push({name:`LSTM_R${y-1}`,data_type:1,dims:[$*v,v],float_data:k}),d.graph.initializer.push({name:`LSTM_B${y-1}`,data_type:1,dims:[$*v],float_data:D}),d.graph.node.push({op_type:"LSTM",input:[f,`LSTM_W${y-1}`,`LSTM_R${y-1}`,`LSTM_B${y-1}`],output:[`Layer_${y}_lstm_hidden`],name:`lstm_l${y}`,attributes:[{name:"hidden_size",type:"INT",i:v},{name:"layout",type:"INT",i:0}]}),d.metadata_props=d.metadata_props||[];let O=d.metadata_props.findIndex(M=>M.key==="lstm_emitted_layers");if(O>=0)try{let M=JSON.parse(d.metadata_props[O].value);Array.isArray(M)&&!M.includes(y)&&(M.push(y),d.metadata_props[O].value=JSON.stringify(M))}catch{d.metadata_props[O].value=JSON.stringify([y])}else d.metadata_props.push({key:"lstm_emitted_layers",value:JSON.stringify([y])})}if(S>=8&&S%4===0){let v=S/4,_=t[y-1],x=N.slice(0,v),w=N.slice(v,v*2),I=N.slice(v*2,v*3),C=N.slice(v*3,v*4),F=[x,w,I],P=F.length,$=_.length,E=[],T=[],k=[];for(let M=0;M<P;M++){let R=F[M];for(let L=0;L<v;L++){let G=R[L];for(let B=0;B<$;B++){let Y=_[B],at=G.connections.in.find(ct=>ct.from===Y);E.push(at?at.weight:0)}for(let B=0;B<v;B++)if(R===I&&B===L){let Y=G.connections.self[0];T.push(Y?Y.weight:0)}else T.push(0);k.push(G.bias)}}d.graph.initializer.push({name:`GRU_W${y-1}`,data_type:1,dims:[P*v,$],float_data:E}),d.graph.initializer.push({name:`GRU_R${y-1}`,data_type:1,dims:[P*v,v],float_data:T}),d.graph.initializer.push({name:`GRU_B${y-1}`,data_type:1,dims:[P*v],float_data:k});let D=y===1?"input":`Layer_${y-1}`;d.graph.node.push({op_type:"GRU",input:[D,`GRU_W${y-1}`,`GRU_R${y-1}`,`GRU_B${y-1}`],output:[`Layer_${y}_gru_hidden`],name:`gru_l${y}`,attributes:[{name:"hidden_size",type:"INT",i:v},{name:"layout",type:"INT",i:0}]}),d.metadata_props=d.metadata_props||[];let O=d.metadata_props.findIndex(M=>M.key==="gru_emitted_layers");if(O>=0)try{let M=JSON.parse(d.metadata_props[O].value);Array.isArray(M)&&!M.includes(y)&&(M.push(y),d.metadata_props[O].value=JSON.stringify(M))}catch{d.metadata_props[O].value=JSON.stringify([y])}else d.metadata_props.push({key:"gru_emitted_layers",value:JSON.stringify([y])})}}if(i&&(d.metadata_props=d.metadata_props||[],d.metadata_props.push({key:"layer_sizes",value:JSON.stringify(g)}),b.length&&d.metadata_props.push({key:"recurrent_single_step",value:JSON.stringify(b)}),n.validateConvSharing&&n.conv2dMappings&&n.conv2dMappings.length)){let y=[],N=[];for(let S of n.conv2dMappings){let v=S.layerIndex,_=t[v-1],x=t[v];if(!x||!_)continue;let w=[],I=!0;for(let F=0;F<S.outChannels;F++){let P=F*(S.outHeight*S.outWidth),$=x[P],E=[];for(let T=0;T<S.inChannels;T++)for(let k=0;k<S.kernelHeight;k++)for(let D=0;D<S.kernelWidth;D++){let O=T*(S.inHeight*S.inWidth)+k*S.inWidth+D,M=_[O],R=$.connections.in.find(L=>L.from===M);E.push(R?R.weight:0)}w.push(E)}let C=1e-9;for(let F=0;F<S.outChannels&&I;F++)for(let P=0;P<S.outHeight&&I;P++)for(let $=0;$<S.outWidth&&I;$++){let E=F*(S.outHeight*S.outWidth)+P*S.outWidth+$,T=x[E];if(!T)continue;let k=0;for(let D=0;D<S.inChannels&&I;D++){let O=P*S.strideHeight-(S.padTop||0),M=$*S.strideWidth-(S.padLeft||0);for(let R=0;R<S.kernelHeight&&I;R++)for(let L=0;L<S.kernelWidth&&I;L++){let G=O+R,B=M+L;if(G<0||G>=S.inHeight||B<0||B>=S.inWidth){k++;continue}let Y=D*(S.inHeight*S.inWidth)+G*S.inWidth+B,at=_[Y],ct=T.connections.in.find(J=>J.from===at),W=ct?ct.weight:0;Math.abs(W-w[F][k])>C&&(I=!1),k++}}if(!I)break}I?y.push(v):(N.push(v),console.warn(`Conv2D weight sharing mismatch detected in layer ${v}`))}y.length&&d.metadata_props.push({key:"conv2d_sharing_verified",value:JSON.stringify(y)}),N.length&&d.metadata_props.push({key:"conv2d_sharing_mismatch",value:JSON.stringify(N)})}return d}function yn(e,t={}){if(Us(e),e.nodes.forEach((o,a)=>o.index=a),!e.connections||e.connections.length===0)throw new Error("ONNX export currently only supports simple MLPs");let n=zs(e),i=[];if(t.allowRecurrent)try{for(let o=1;o<n.length-1;o++){let a=n[o],r=a.length;if(r>=10&&r%5===0){let c=r/5;a.slice(c*2,c*3).every(p=>p.connections.self.length===1)&&i.push({layerIndex:o,unitSize:c})}}}catch{}qs(n,e,t);let s=Vs(e,n,t);if(t.includeMetadata){let o=[],a=[];for(let r=1;r<n.length-1;r++){let c=n[r-1].length,l=n[r].length,u=Math.sqrt(c);if(Math.abs(u-Math.round(u))>1e-9)continue;let p=Math.round(u);for(let h of[3,2]){if(h>=p)continue;let m=p-h+1;if(m*m===l){if(t.conv2dMappings?.some(f=>f.layerIndex===r))break;a.push(r),o.push({layerIndex:r,inHeight:p,inWidth:p,inChannels:1,kernelHeight:h,kernelWidth:h,strideHeight:1,strideWidth:1,outHeight:m,outWidth:m,outChannels:1,note:"heuristic_inferred_no_export_applied"});break}}}a.length&&(s.metadata_props=s.metadata_props||[],s.metadata_props.push({key:"conv2d_inferred_layers",value:JSON.stringify(a)}),s.metadata_props.push({key:"conv2d_inferred_specs",value:JSON.stringify(o)}))}return i.length&&(s.metadata_props=s.metadata_props||[],s.metadata_props.push({key:"lstm_groups_stub",value:JSON.stringify(i)})),s}var Oe=H(()=>{"use strict";mt();vt()});var gn=H(()=>{"use strict";Oe();Oe()});function An(e){if(!e.nodes.some(m=>m.type==="output"))throw new Error("Cannot create standalone function: network has no output nodes.");let t={},n=[],i={},s=0,o=[],a=[],r=[],c={logistic:"function logistic(x){ return 1 / (1 + Math.exp(-x)); }",tanh:"function tanh(x){ return Math.tanh(x); }",relu:"function relu(x){ return x > 0 ? x : 0; }",identity:"function identity(x){ return x; }",step:"function step(x){ return x > 0 ? 1 : 0; }",softsign:"function softsign(x){ return x / (1 + Math.abs(x)); }",sinusoid:"function sinusoid(x){ return Math.sin(x); }",gaussian:"function gaussian(x){ return Math.exp(-Math.pow(x, 2)); }",bentIdentity:"function bentIdentity(x){ return (Math.sqrt(Math.pow(x, 2) + 1) - 1) / 2 + x; }",bipolar:"function bipolar(x){ return x > 0 ? 1 : -1; }",bipolarSigmoid:"function bipolarSigmoid(x){ return 2 / (1 + Math.exp(-x)) - 1; }",hardTanh:"function hardTanh(x){ return Math.max(-1, Math.min(1, x)); }",absolute:"function absolute(x){ return Math.abs(x); }",inverse:"function inverse(x){ return 1 - x; }",selu:"function selu(x){ var a=1.6732632423543772,s=1.0507009873554805; var fx=x>0?x:a*Math.exp(x)-a; return fx*s; }",softplus:"function softplus(x){ if(x>30)return x; if(x<-30)return Math.exp(x); return Math.max(0,x)+Math.log(1+Math.exp(-Math.abs(x))); }",swish:"function swish(x){ var s=1/(1+Math.exp(-x)); return x*s; }",gelu:"function gelu(x){ var cdf=0.5*(1.0+Math.tanh(Math.sqrt(2.0/Math.PI)*(x+0.044715*Math.pow(x,3)))); return x*cdf; }",mish:"function mish(x){ var sp_x; if(x>30){sp_x=x;}else if(x<-30){sp_x=Math.exp(x);}else{sp_x=Math.log(1+Math.exp(x));} var tanh_sp_x=Math.tanh(sp_x); return x*tanh_sp_x; }"};e.nodes.forEach((m,d)=>{m.index=d,o.push(m.activation),a.push(m.state)}),r.push("for(var i = 0; i < input.length; i++) A[i] = input[i];");for(let m=e.input;m<e.nodes.length;m++){let d=e.nodes[m],f=d.squash,b=f.name||`anonymous_squash_${m}`;if(!(b in t)){let v;c[b]?(v=c[b],v.startsWith(`function ${b}`)||(v=`function ${b}${v.substring(v.indexOf("("))}`),v=bn(v)):(v=f.toString(),v=bn(v),v.startsWith("function")?v=`function ${b}${v.substring(v.indexOf("("))}`:v.includes("=>")?v=`function ${b}${v.substring(v.indexOf("("))}`:v=`function ${b}(x){ return x; }`),t[b]=v,n.push(v),i[b]=s++}let g=i[b],y=[];for(let v of d.connections.in){if(typeof v.from.index>"u")continue;let _=`A[${v.from.index}] * ${v.weight}`;v.gater&&typeof v.gater.index<"u"&&(_+=` * A[${v.gater.index}]`),y.push(_)}if(d.connections.self.length>0){let v=d.connections.self[0],_=`S[${m}] * ${v.weight}`;v.gater&&typeof v.gater.index<"u"&&(_+=` * A[${v.gater.index}]`),y.push(_)}let N=y.length>0?y.join(" + "):"0";r.push(`S[${m}] = ${N} + ${d.bias};`);let S=typeof d.mask=="number"&&d.mask!==1?d.mask:1;r.push(`A[${m}] = F[${g}](S[${m}])${S!==1?` * ${S}`:""};`)}let l=[];for(let m=e.nodes.length-e.output;m<e.nodes.length;m++)typeof e.nodes[m]?.index<"u"&&l.push(e.nodes[m].index);r.push(`return [${l.map(m=>`A[${m}]`).join(",")}];`);let u=Object.entries(i).sort(([,m],[,d])=>m-d).map(([m])=>m).join(","),p=e._activationPrecision==="f32"?"Float32Array":"Float64Array",h="";return h+=`(function(){
`,h+=`${n.join(`
`)}
`,h+=`var F = [${u}];
`,h+=`var A = new ${p}([${o.join(",")}]);
`,h+=`var S = new ${p}([${a.join(",")}]);
`,h+=`function activate(input){
`,h+=`if (!input || input.length !== ${e.input}) { throw new Error('Invalid input size. Expected ${e.input}, got ' + (input ? input.length : 'undefined')); }
`,h+=r.join(`
`),h+=`}
`,h+=`return activate;
})();`,h}var bn,Sn=H(()=>{"use strict";bn=e=>(e=e.replace(/\/\*\s*istanbul\s+ignore\s+[\s\S]*?\*\//g,""),e=e.replace(/cov_[\w$]+\(\)\.(s|f|b)\[\d+\](\[\d+\])?\+\+/g,""),e=e.replace(/cov_[\w$]+\(\)/g,""),e=e.replace(/^\s*\/\/ # sourceMappingURL=.*\s*$/gm,""),e=e.replace(/\(\s*,\s*/g,"( "),e=e.replace(/\s*,\s*\)/g," )"),e=e.trim(),e=e.replace(/^\s*;\s*$/gm,""),e=e.replace(/;{2,}/g,";"),e=e.replace(/^\s*[,;]?\s*$/gm,""),e)});function vn(){let e=this;if(!e._enforceAcyclic){e._topoOrder=null,e._topoDirty=!1;return}let t=new Map;this.nodes.forEach(s=>t.set(s,0));for(let s of this.connections)s.from!==s.to&&t.set(s.to,(t.get(s.to)||0)+1);let n=[];this.nodes.forEach(s=>{(s.type==="input"||(t.get(s)||0)===0)&&n.push(s)});let i=[];for(;n.length;){let s=n.shift();i.push(s);for(let o of s.connections.out){if(o.to===s)continue;let a=(t.get(o.to)||0)-1;t.set(o.to,a),a===0&&n.push(o.to)}}e._topoOrder=i.length===this.nodes.length?i:this.nodes.slice(),e._topoDirty=!1}function Nn(e,t){if(e===t)return!0;let n=new Set,i=[e];for(;i.length;){let s=i.pop();if(s===t)return!0;if(!n.has(s)){n.add(s);for(let o of s.connections.out)o.to!==s&&i.push(o.to)}}return!1}var _n=H(()=>{"use strict"});function Ys(){let e=U.slabPoolMaxPerKey;return e===void 0?4:e<0?0:e|0}function wn(e,t,n){return e+":"+t+":"+n}function Bt(e,t,n,i){if(!U.enableSlabArrayPooling)return Re.fresh++,new t(n);let s=wn(e,i,n),o=xn[s];return o&&o.length?(Re.pooled++,(Le[s]||={created:0,reused:0,maxRetained:0}).reused++,o.pop()):(Re.fresh++,(Le[s]||={created:0,reused:0,maxRetained:0}).created++,new t(n))}function Mt(e,t,n){if(!U.enableSlabArrayPooling)return;let i=wn(e,t,n.length),s=xn[i]||=[];s.length<Ys()&&s.push(n);let o=Le[i]||={created:0,reused:0,maxRetained:0};s.length>o.maxRetained&&(o.maxRetained=s.length)}function re(e=!1){let t=this;if(!e&&!t._slabDirty)return;t._nodeIndexDirty&&En.call(this);let n=this.connections.length,i=t._connCapacity||0,s=typeof window>"u"?1.75:1.25;if(i<n){for(i=i===0?Math.ceil(n*s):i;i<n;)i=Math.ceil(i*s);t._connWeights&&Mt("w",t._useFloat32Weights?4:8,t._connWeights),t._connFrom&&Mt("f",4,t._connFrom),t._connTo&&Mt("t",4,t._connTo),t._connFlags&&Mt("fl",1,t._connFlags),t._connGain&&Mt("g",t._useFloat32Weights?4:8,t._connGain),t._connPlastic&&Mt("p",t._useFloat32Weights?4:8,t._connPlastic),t._connWeights=Bt("w",t._useFloat32Weights?Float32Array:Float64Array,i,t._useFloat32Weights?4:8),t._connFrom=Bt("f",Uint32Array,i,4),t._connTo=Bt("t",Uint32Array,i,4),t._connFlags=Bt("fl",Uint8Array,i,1),t._connGain=null,t._connPlastic=null,t._connCapacity=i}else i=t._connCapacity;let a=t._connWeights,r=t._connFrom,c=t._connTo,l=t._connFlags,u=t._connGain,p=!1,h=t._connPlastic,m=!1;for(let d=0;d<n;d++){let f=this.connections[d];a[d]=f.weight,r[d]=f.from.index>>>0,c[d]=f.to.index>>>0,l[d]=f._flags&255;let b=f.gain;if(b!==1){if(!u){u=Bt("g",t._useFloat32Weights?Float32Array:Float64Array,i,t._useFloat32Weights?4:8),t._connGain=u;for(let g=0;g<d;g++)u[g]=1}u[d]=b,p=!0}else u&&(u[d]=1);f._flags&8&&(m=!0)}if(!p&&u&&(Mt("g",t._useFloat32Weights?4:8,u),t._connGain=null),m&&!h){h=Bt("p",t._useFloat32Weights?Float32Array:Float64Array,i,t._useFloat32Weights?4:8),t._connPlastic=h;for(let d=0;d<n;d++){let f=this.connections[d];h[d]=f.plasticityRate||0}}else!m&&h&&(Mt("p",t._useFloat32Weights?4:8,h),t._connPlastic=null);t._connCount=n,t._slabDirty=!1,t._adjDirty=!0,t._slabVersion=(t._slabVersion||0)+1}function Mn(){re.call(this);let e=this,t=e._connGain||null;if(!t){let n=e._connCapacity||e._connWeights&&e._connWeights.length||0;t=e._useFloat32Weights?new Float32Array(n):new Float64Array(n);for(let i=0;i<(e._connCount||0);i++)t[i]=1}return{weights:e._connWeights,from:e._connFrom,to:e._connTo,flags:e._connFlags,gain:t,plastic:e._connPlastic||null,version:e._slabVersion||0,used:e._connCount||0,capacity:e._connCapacity||e._connWeights&&e._connWeights.length||0}}function En(){let e=this;for(let t=0;t<this.nodes.length;t++)this.nodes[t].index=t;e._nodeIndexDirty=!1}function Js(){let e=this;if(!e._connFrom||!e._connTo)return;let t=this.nodes.length,n=e._connCount??e._connFrom.length,i=new Uint32Array(t);for(let c=0;c<n;c++)i[e._connFrom[c]]++;let s=new Uint32Array(t+1),o=0;for(let c=0;c<t;c++)s[c]=o,o+=i[c];s[t]=o;let a=new Uint32Array(n),r=s.slice();for(let c=0;c<n;c++){let l=e._connFrom[c];a[r[l]++]=c}e._outStart=s,e._outOrder=a,e._adjDirty=!1}function Xs(e){let t=this;return!e&&t._enforceAcyclic&&!t._topoDirty&&this.gates.length===0&&this.selfconns.length===0&&this.dropout===0&&t._weightNoiseStd===0&&t._weightNoisePerHidden.length===0&&t._stochasticDepth.length===0}function In(e){let t=this;if(re.call(this),t._adjDirty&&Js.call(this),this.gates&&this.gates.length>0)return this.activate(e,!1);if(!t._connWeights||!t._connFrom||!t._connTo||!t._outStart||!t._outOrder)return this.activate(e,!1);t._topoDirty&&this._computeTopoOrder(),t._nodeIndexDirty&&En.call(this);let n=t._topoOrder||this.nodes,i=this.nodes.length,s=t._activationPrecision==="f32";(!t._fastA||t._fastA.length!==i||s&&!(t._fastA instanceof Float32Array)||!s&&!(t._fastA instanceof Float64Array))&&(t._fastA=s?new Float32Array(i):new Float64Array(i)),(!t._fastS||t._fastS.length!==i||s&&!(t._fastS instanceof Float32Array)||!s&&!(t._fastS instanceof Float64Array))&&(t._fastS=s?new Float32Array(i):new Float64Array(i));let o=t._fastA,a=t._fastS;a.fill(0);for(let d=0;d<this.input;d++)o[d]=e[d],this.nodes[d].activation=e[d],this.nodes[d].state=0;let r=t._connWeights,c=t._connTo,l=t._outOrder,u=t._outStart;for(let d=0;d<n.length;d++){let f=n[d],b=f.index>>>0;if(b>=this.input){let S=a[b]+f.bias,v=f.squash(S);f.state=a[b],f.activation=v,o[b]=v}let g=u[b],y=u[b+1],N=o[b];for(let S=g;S<y;S++){let v=l[S],_=r[v],x=t._connGain;x&&(_*=x[v]),a[c[v]]+=N*_}}let p=i-this.output,h=yt.acquire(this.output);for(let d=0;d<this.output;d++)h[d]=o[p+d];let m=Array.from(h);return yt.release(h),m}function Cn(e){return Xs.call(this,e)}var xn,Le,Re,Tn=H(()=>{"use strict";Kt();At();xn=Object.create(null),Le=Object.create(null);Re={fresh:0,pooled:0}});function On(e,t){let n=[...e];return t==="snip"?n.sort((i,s)=>{let o=Math.abs(i.totalDeltaWeight)||Math.abs(i.previousDeltaWeight)||0,a=Math.abs(s.totalDeltaWeight)||Math.abs(s.previousDeltaWeight)||0,r=o?Math.abs(i.weight)*o:Math.abs(i.weight),c=a?Math.abs(s.weight)*a:Math.abs(s.weight);return r-c}):n.sort((i,s)=>Math.abs(i.weight)-Math.abs(s.weight)),n}function Ks(e,t,n){let i=e,s=0;for(;e.connections.length<t&&s<n;){s++;let o=e.nodes[Math.floor(i._rand()*e.nodes.length)],a=e.nodes[Math.floor(i._rand()*e.nodes.length)];!o||!a||o===a||e.connections.some(r=>r.from===o&&r.to===a)||i._enforceAcyclic&&e.nodes.indexOf(o)>e.nodes.indexOf(a)||e.connect(o,a)}}function Rn(e){let t=this._pruningConfig;if(!t||e<t.start||e>t.end||t.lastPruneIter!=null&&e===t.lastPruneIter||(e-t.start)%(t.frequency||1)!==0)return;let n=this._initialConnectionCount;if(!n)return;let i=(e-t.start)/Math.max(1,t.end-t.start),s=t.targetSparsity*Math.min(1,Math.max(0,i)),o=Math.max(1,Math.floor(n*(1-s))),a=this.connections.length-o;if(a<=0){t.lastPruneIter=e;return}let c=On(this.connections,t.method||"magnitude").slice(0,a);if(c.forEach(l=>this.disconnect(l.from,l.to)),t.regrowFraction&&t.regrowFraction>0){let l=Math.floor(c.length*t.regrowFraction);Ks(this,o,l*10)}t.lastPruneIter=e,this._topoDirty=!0}function Ln(e,t="magnitude"){if(e<=0)return;e>=1&&(e=.999);let n=this;n._evoInitialConnCount||(n._evoInitialConnCount=this.connections.length);let i=n._evoInitialConnCount,s=Math.max(1,Math.floor(i*(1-e))),o=this.connections.length-s;if(o<=0)return;On(this.connections,t).slice(0,o).forEach(c=>this.disconnect(c.from,c.to)),n._topoDirty=!0}function Pn(){let e=this._initialConnectionCount;return e?1-this.connections.length/e:0}var kn=H(()=>{"use strict";lt();vt()});function Dn(e,t){if(!this.nodes.includes(e))throw new Error("Gating node must be part of the network to gate a connection!");if(t.gater){U.warnings&&console.warn("Connection is already gated. Skipping.");return}e.gate(t),this.gates.push(t)}function Fn(e){let t=this.gates.indexOf(e);if(t===-1){U.warnings&&console.warn("Attempted to ungate a connection not in the gates list.");return}this.gates.splice(t,1),e.gater?.ungate(e)}var $n=H(()=>{"use strict";lt();vt();Vt();At()});function Hn(e){this._rngState=e>>>0,this._rand=()=>{this._rngState=this._rngState+1831565813>>>0;let t=Math.imul(this._rngState^this._rngState>>>15,1|this._rngState);return t^=t+Math.imul(t^t>>>7,61|t),((t^t>>>14)>>>0)/4294967296}}function Gn(){return{step:this._trainingStep,state:this._rngState}}function Bn(e){this._rand=e,this._rngState=void 0}function Wn(){return this._rngState}function jn(e){typeof e=="number"&&(this._rngState=e>>>0)}var Un=H(()=>{"use strict"});function Zs(e){try{return globalThis.structuredClone?globalThis.structuredClone(e):JSON.parse(JSON.stringify(e))}catch{return JSON.parse(JSON.stringify(e))}}function zn(){let e=this._lastStats;return e?Zs(e):null}var qn=H(()=>{"use strict"});function Vn(e){let t=this,n=this.nodes.indexOf(e);if(n===-1)throw new Error("Node not in network");if(e.type==="input"||e.type==="output")throw new Error("Cannot remove input or output node from the network.");this.gates=this.gates.filter(a=>a.gater===e?(a.gater=null,!1):!0);let i=e.connections.in.slice(),s=e.connections.out.slice();i.forEach(a=>this.disconnect(a.from,a.to)),s.forEach(a=>this.disconnect(a.from,a.to)),e.connections.self.slice().forEach(()=>this.disconnect(e,e));let o=this.nodes.splice(n,1)[0];U.enableNodePooling&&o&&se(o),i.forEach(a=>{s.forEach(r=>{if(!a.from||!r.to||a.from===r.to)return;this.connections.some(l=>l.from===a.from&&l.to===r.to)||this.connect(a.from,r.to)})}),t._topoDirty=!0,t._nodeIndexDirty=!0,t._slabDirty=!0,t._adjDirty=!0}var Yn=H(()=>{"use strict";xe();At()});function Jn(e,t,n){if(this._enforceAcyclic&&this.nodes.indexOf(e)>this.nodes.indexOf(t))return[];let i=e.connect(t,n);for(let s of i)if(e!==t)this.connections.push(s);else{if(this._enforceAcyclic)continue;this.selfconns.push(s)}return i.length&&(this._topoDirty=!0,this._slabDirty=!0),i}function Xn(e,t){let n=e===t?this.selfconns:this.connections;for(let i=0;i<n.length;i++){let s=n[i];if(s.from===e&&s.to===t){s.gater&&this.ungate(s),n.splice(i,1);break}}e.disconnect(t),this._topoDirty=!0,this._slabDirty=!0}var Kn=H(()=>{"use strict";lt();vt()});function Zn(){this.nodes.forEach((a,r)=>a.index=r);let e=this.nodes.map(a=>a.activation),t=this.nodes.map(a=>a.state),n=this.nodes.map(a=>a.squash.name),i=this.connections.concat(this.selfconns).map(a=>({from:a.from.index,to:a.to.index,weight:a.weight,gater:a.gater?a.gater.index:null})),s=this.input,o=this.output;return[e,t,n,i,s,o]}function Qn(e,t,n){let[i,s,o,a,r,c]=e,l=typeof t=="number"?t:r||0,u=typeof n=="number"?n:c||0,p=new(pt(),Z(kt)).default(l,u);return p.nodes=[],p.connections=[],p.selfconns=[],p.gates=[],i.forEach((h,m)=>{let d;m<l?d="input":m>=i.length-u?d="output":d="hidden";let f=new Q(d);f.activation=h,f.state=s[m];let b=o[m];V[b]||console.warn(`Unknown squash function '${String(b)}' encountered during deserialize. Falling back to identity.`),f.squash=V[b]||V.identity,f.index=m,p.nodes.push(f)}),a.forEach(h=>{if(h.from<p.nodes.length&&h.to<p.nodes.length){let m=p.nodes[h.from],d=p.nodes[h.to],f=p.connect(m,d,h.weight)[0];f&&h.gater!=null&&(h.gater<p.nodes.length?p.gate(p.nodes[h.gater],f):console.warn("Invalid gater index encountered during deserialize; skipping gater assignment."))}else console.warn("Invalid connection indices encountered during deserialize; skipping connection.")}),p}function ti(){let e={formatVersion:2,input:this.input,output:this.output,dropout:this.dropout,nodes:[],connections:[]};return this.nodes.forEach((t,n)=>{if(t.index=n,e.nodes.push({type:t.type,bias:t.bias,squash:t.squash.name,index:n,geneId:t.geneId}),t.connections.self.length>0){let i=t.connections.self[0];e.connections.push({from:n,to:n,weight:i.weight,gater:i.gater?i.gater.index:null,enabled:i.enabled!==!1})}}),this.connections.forEach(t=>{typeof t.from.index!="number"||typeof t.to.index!="number"||e.connections.push({from:t.from.index,to:t.to.index,weight:t.weight,gater:t.gater?t.gater.index:null,enabled:t.enabled!==!1})}),e}function ei(e){if(!e||typeof e!="object")throw new Error("Invalid JSON for network.");e.formatVersion!==2&&console.warn("fromJSONImpl: Unknown formatVersion, attempting import.");let t=new(pt(),Z(kt)).default(e.input,e.output);return t.dropout=e.dropout||0,t.nodes=[],t.connections=[],t.selfconns=[],t.gates=[],e.nodes.forEach((n,i)=>{let s=new Q(n.type);s.bias=n.bias,s.squash=V[n.squash]||V.identity,s.index=i,typeof n.geneId=="number"&&(s.geneId=n.geneId),t.nodes.push(s)}),e.connections.forEach(n=>{if(typeof n.from!="number"||typeof n.to!="number")return;let i=t.nodes[n.from],s=t.nodes[n.to],o=t.connect(i,s,n.weight)[0];o&&n.gater!=null&&typeof n.gater=="number"&&t.nodes[n.gater]&&t.gate(t.nodes[n.gater],o),o&&typeof n.enabled<"u"&&(o.enabled=n.enabled)}),t}var ni=H(()=>{"use strict";lt();vt();mt()});function ii(e,t,n=!1){if(e.input!==t.input||e.output!==t.output)throw new Error("Parent networks must have the same input and output sizes for crossover.");let i=new(pt(),Z(kt)).default(e.input,e.output);i.connections=[],i.nodes=[],i.selfconns=[],i.gates=[];let s=e.score||0,o=t.score||0,a=e.nodes.length,r=t.nodes.length,c;if(n||s===o){let f=Math.max(a,r),b=Math.min(a,r);c=Math.floor(Math.random()*(f-b+1)+b)}else c=s>o?a:r;let l=e.output;e.nodes.forEach((f,b)=>f.index=b),t.nodes.forEach((f,b)=>f.index=b);for(let f=0;f<c;f++){let b,g=f<a?e.nodes[f]:void 0,y=f<r?t.nodes[f]:void 0;if(f<e.input)b=g;else if(f>=c-l){let N=a-(c-f),S=r-(c-f),v=N>=e.input&&N<a?e.nodes[N]:void 0,_=S>=t.input&&S<r?t.nodes[S]:void 0;v&&_?b=(e._rand||Math.random)()>=.5?v:_:b=v||_}else g&&y?b=(e._rand||Math.random)()>=.5?g:y:g&&(s>=o||n)?b=g:y&&(o>=s||n)&&(b=y);if(b){let N=new Q(b.type);N.bias=b.bias,N.squash=b.squash,i.nodes.push(N)}}i.nodes.forEach((f,b)=>f.index=b);let u={},p={};e.connections.concat(e.selfconns).forEach(f=>{typeof f.from.index=="number"&&typeof f.to.index=="number"&&(u[dt.innovationID(f.from.index,f.to.index)]={weight:f.weight,from:f.from.index,to:f.to.index,gater:f.gater?f.gater.index:-1,enabled:f.enabled!==!1})}),t.connections.concat(t.selfconns).forEach(f=>{typeof f.from.index=="number"&&typeof f.to.index=="number"&&(p[dt.innovationID(f.from.index,f.to.index)]={weight:f.weight,from:f.from.index,to:f.to.index,gater:f.gater?f.gater.index:-1,enabled:f.enabled!==!1})});let h=[];Object.keys(u).forEach(f=>{let b=u[f];if(p[f]){let g=p[f],y=(e._rand||Math.random)()>=.5?b:g;if(b.enabled===!1||g.enabled===!1){let N=e._reenableProb??t._reenableProb??.25;y.enabled=Math.random()<N}h.push(y),delete p[f]}else if(s>=o||n){if(b.enabled===!1){let g=e._reenableProb??.25;b.enabled=Math.random()<g}h.push(b)}}),(o>=s||n)&&Object.keys(p).forEach(f=>{let b=p[f];if(b.enabled===!1){let g=t._reenableProb??.25;b.enabled=Math.random()<g}h.push(b)});let d=i.nodes.length;return h.forEach(f=>{if(f.from<d&&f.to<d){let b=i.nodes[f.from],g=i.nodes[f.to];if(f.from>=f.to)return;if(!b.isProjectingTo(g)){let y=i.connect(b,g)[0];y&&(y.weight=f.weight,y.enabled=f.enabled!==!1,f.gater!==-1&&f.gater<d&&i.gate(i.nodes[f.gater],y))}}}),i}var si=H(()=>{"use strict";lt();vt()});var ce={};ht(ce,{activateBatch:()=>eo,activateRaw:()=>to,noTraceActivate:()=>Qs});function Qs(e){let t=this;if(t._enforceAcyclic&&t._topoDirty&&this._computeTopoOrder(),!Array.isArray(e)||e.length!==this.input)throw new Error(`Input size mismatch: expected ${this.input}, got ${e?e.length:"undefined"}`);if(this._canUseFastSlab(!1))try{return this._fastSlabActivate(e)}catch{}let n=yt.acquire(this.output),i=0;this.nodes.forEach((o,a)=>{o.type==="input"?o.noTraceActivate(e[a]):o.type==="output"?n[i++]=o.noTraceActivate():o.noTraceActivate()});let s=Array.from(n);return yt.release(n),s}function to(e,t=!1,n=1e3){return this._reuseActivationArrays?this.activate(e,t,n):this.activate(e,t,n)}function eo(e,t=!1){if(!Array.isArray(e))throw new Error("inputs must be an array of input arrays");let n=new Array(e.length);for(let i=0;i<e.length;i++){let s=e[i];if(!Array.isArray(s)||s.length!==this.input)throw new Error(`Input[${i}] size mismatch: expected ${this.input}, got ${s?s.length:"undefined"}`);n[i]=this.activate(s,t)}return n}var le=H(()=>{"use strict";Kt()});var st,ue=H(()=>{"use strict";lt();Wt();At();mt();st=class e{nodes;connections;constructor(t){this.nodes=[],this.connections={in:[],out:[],self:[]};for(let n=0;n<t;n++)this.nodes.push(new Q)}activate(t){let n=[];if(t!==void 0&&t.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let i=0;i<this.nodes.length;i++){let s=t===void 0?this.nodes[i].activate():this.nodes[i].activate(t[i]);n.push(s)}return n}propagate(t,n,i){if(i!==void 0&&i.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let s=this.nodes.length-1;s>=0;s--)i===void 0?this.nodes[s].propagate(t,n,!0,0):this.nodes[s].propagate(t,n,!0,0,i[s])}connect(t,n,i){let s=[],o,a;if(t instanceof e){if(n===void 0&&(this!==t?(U.warnings&&console.warn("No group connection specified, using ALL_TO_ALL by default."),n=tt.ALL_TO_ALL):(U.warnings&&console.warn("Connecting group to itself, using ONE_TO_ONE by default."),n=tt.ONE_TO_ONE)),n===tt.ALL_TO_ALL||n===tt.ALL_TO_ELSE)for(o=0;o<this.nodes.length;o++)for(a=0;a<t.nodes.length;a++){if(n===tt.ALL_TO_ELSE&&this.nodes[o]===t.nodes[a])continue;let r=this.nodes[o].connect(t.nodes[a],i);this.connections.out.push(r[0]),t.connections.in.push(r[0]),s.push(r[0])}else if(n===tt.ONE_TO_ONE){if(this.nodes.length!==t.nodes.length)throw new Error("Cannot create ONE_TO_ONE connection: source and target groups must have the same size.");for(o=0;o<this.nodes.length;o++){let r=this.nodes[o].connect(t.nodes[o],i);this===t?this.connections.self.push(r[0]):(this.connections.out.push(r[0]),t.connections.in.push(r[0])),s.push(r[0])}}}else if(t instanceof Et)s=t.input(this,n,i);else if(t instanceof Q)for(o=0;o<this.nodes.length;o++){let r=this.nodes[o].connect(t,i);this.connections.out.push(r[0]),s.push(r[0])}return s}gate(t,n){if(n===void 0)throw new Error("Please specify a gating method: Gating.INPUT, Gating.OUTPUT, or Gating.SELF");Array.isArray(t)||(t=[t]);let i=[],s=[],o,a;for(o=0;o<t.length;o++){let r=t[o];i.includes(r.from)||i.push(r.from),s.includes(r.to)||s.push(r.to)}switch(n){case St.INPUT:for(let r=0;r<t.length;r++){let c=t[r];this.nodes[r%this.nodes.length].gate(c)}break;case St.OUTPUT:for(o=0;o<i.length;o++){let r=i[o],c=this.nodes[o%this.nodes.length];for(a=0;a<r.connections.out.length;a++){let l=r.connections.out[a];t.includes(l)&&c.gate(l)}}break;case St.SELF:for(o=0;o<i.length;o++){let r=i[o],c=this.nodes[o%this.nodes.length],l=Array.isArray(r.connections.self)?r.connections.self[0]:r.connections.self;t.includes(l)&&c.gate(l)}break}}set(t){for(let n=0;n<this.nodes.length;n++)t.bias!==void 0&&(this.nodes[n].bias=t.bias),this.nodes[n].squash=t.squash||this.nodes[n].squash,this.nodes[n].type=t.type||this.nodes[n].type}disconnect(t,n=!1){let i,s,o;if(t instanceof e)for(i=0;i<this.nodes.length;i++)for(s=0;s<t.nodes.length;s++){for(this.nodes[i].disconnect(t.nodes[s],n),o=this.connections.out.length-1;o>=0;o--){let a=this.connections.out[o];if(a.from===this.nodes[i]&&a.to===t.nodes[s]){this.connections.out.splice(o,1);break}}if(n){for(o=this.connections.in.length-1;o>=0;o--){let a=this.connections.in[o];if(a.from===t.nodes[s]&&a.to===this.nodes[i]){this.connections.in.splice(o,1);break}}for(o=t.connections.out.length-1;o>=0;o--){let a=t.connections.out[o];if(a.from===t.nodes[s]&&a.to===this.nodes[i]){t.connections.out.splice(o,1);break}}for(o=t.connections.in.length-1;o>=0;o--){let a=t.connections.in[o];if(a.from===this.nodes[i]&&a.to===t.nodes[s]){t.connections.in.splice(o,1);break}}}}else if(t instanceof Q)for(i=0;i<this.nodes.length;i++){for(this.nodes[i].disconnect(t,n),s=this.connections.out.length-1;s>=0;s--){let a=this.connections.out[s];if(a.from===this.nodes[i]&&a.to===t){this.connections.out.splice(s,1);break}}if(n)for(s=this.connections.in.length-1;s>=0;s--){let a=this.connections.in[s];if(a.from===t&&a.to===this.nodes[i]){this.connections.in.splice(s,1);break}}}}clear(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clear()}toJSON(){return{size:this.nodes.length,nodeIndices:this.nodes.map(t=>t.index),connections:{in:this.connections.in.length,out:this.connections.out.length,self:this.connections.self.length}}}}});var Pe={};ht(Pe,{default:()=>Et});var Et,Wt=H(()=>{"use strict";lt();ue();mt();Kt();Et=class e{nodes;connections;output;dropout=0;constructor(){this.output=null,this.nodes=[],this.connections={in:[],out:[],self:[]}}activate(t,n=!1){let i=yt.acquire(this.nodes.length);if(t!==void 0&&t.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");let s=1;n&&this.dropout>0?(s=Math.random()>=this.dropout?1:0,this.nodes.forEach(a=>{a.mask=s})):this.nodes.forEach(a=>{a.mask=1});for(let a=0;a<this.nodes.length;a++){let r;t===void 0?r=this.nodes[a].activate():r=this.nodes[a].activate(t[a]),i[a]=r}let o=Array.from(i);return yt.release(i),o}propagate(t,n,i){if(i!==void 0&&i.length!==this.nodes.length)throw new Error("Array with values should be same as the amount of nodes!");for(let s=this.nodes.length-1;s>=0;s--)i===void 0?this.nodes[s].propagate(t,n,!0,0):this.nodes[s].propagate(t,n,!0,0,i[s])}connect(t,n,i){if(!this.output)throw new Error("Layer output is not defined. Cannot connect from this layer.");let s=[];return t instanceof e?s=t.input(this,n,i):(t instanceof st||t instanceof Q)&&(s=this.output.connect(t,n,i)),s}gate(t,n){if(!this.output)throw new Error("Layer output is not defined. Cannot gate from this layer.");this.output.gate(t,n)}set(t){for(let n=0;n<this.nodes.length;n++){let i=this.nodes[n];i instanceof Q?(t.bias!==void 0&&(i.bias=t.bias),i.squash=t.squash||i.squash,i.type=t.type||i.type):this.isGroup(i)&&i.set(t)}}disconnect(t,n){n=n||!1;let i,s,o;if(t instanceof st)for(i=0;i<this.nodes.length;i++)for(s=0;s<t.nodes.length;s++){for(this.nodes[i].disconnect(t.nodes[s],n),o=this.connections.out.length-1;o>=0;o--){let a=this.connections.out[o];if(a.from===this.nodes[i]&&a.to===t.nodes[s]){this.connections.out.splice(o,1);break}}if(n)for(o=this.connections.in.length-1;o>=0;o--){let a=this.connections.in[o];if(a.from===t.nodes[s]&&a.to===this.nodes[i]){this.connections.in.splice(o,1);break}}}else if(t instanceof Q)for(i=0;i<this.nodes.length;i++){for(this.nodes[i].disconnect(t,n),s=this.connections.out.length-1;s>=0;s--){let a=this.connections.out[s];if(a.from===this.nodes[i]&&a.to===t){this.connections.out.splice(s,1);break}}if(n)for(o=this.connections.in.length-1;o>=0;o--){let a=this.connections.in[o];if(a.from===t&&a.to===this.nodes[i]){this.connections.in.splice(o,1);break}}}}clear(){for(let t=0;t<this.nodes.length;t++)this.nodes[t].clear()}input(t,n,i){if(t instanceof e&&(t=t.output),n=n||tt.ALL_TO_ALL,!this.output)throw new Error("Layer output (acting as input target) is not defined.");return t.connect(this.output,n,i)}static dense(t){let n=new e,i=new st(t);return n.nodes.push(...i.nodes),n.output=i,n.input=(s,o,a)=>(s instanceof e&&(s=s.output),o=o||tt.ALL_TO_ALL,s.connect(i,o,a)),n}static lstm(t){let n=new e,i=new st(t),s=new st(t),o=new st(t),a=new st(t),r=new st(t);i.set({bias:1}),s.set({bias:1}),a.set({bias:1}),o.set({bias:0}),r.set({bias:0}),o.connect(i,tt.ALL_TO_ALL),o.connect(s,tt.ALL_TO_ALL),o.connect(a,tt.ALL_TO_ALL),o.connect(o,tt.ONE_TO_ONE);let c=o.connect(r,tt.ALL_TO_ALL);return a.gate(c,St.OUTPUT),o.nodes.forEach((l,u)=>{let p=l.connections.self.find(h=>h.to===l&&h.from===l);p?(p.gater=s.nodes[u],s.nodes[u].connections.gated.includes(p)||s.nodes[u].connections.gated.push(p)):console.warn(`LSTM Warning: No self-connection found for memory cell node ${u}`)}),n.nodes=[...i.nodes,...s.nodes,...o.nodes,...a.nodes,...r.nodes],n.output=r,n.input=(l,u,p)=>{l instanceof e&&(l=l.output),u=u||tt.ALL_TO_ALL;let h=[],m=l.connect(o,u,p);return h=h.concat(m),h=h.concat(l.connect(i,u,p)),h=h.concat(l.connect(a,u,p)),h=h.concat(l.connect(s,u,p)),i.gate(m,St.INPUT),h},n}static gru(t){let n=new e,i=new st(t),s=new st(t),o=new st(t),a=new st(t),r=new st(t),c=new st(t);c.set({bias:0,squash:V.identity,type:"variant"}),a.set({squash:V.tanh}),s.set({bias:0,squash:V.inverse,type:"variant"}),i.set({bias:1}),o.set({bias:0}),c.connect(i,tt.ALL_TO_ALL),c.connect(o,tt.ALL_TO_ALL),i.connect(s,tt.ONE_TO_ONE,1);let l=c.connect(a,tt.ALL_TO_ALL);o.gate(l,St.OUTPUT);let u=c.connect(r,tt.ALL_TO_ALL),p=a.connect(r,tt.ALL_TO_ALL);return i.gate(u,St.OUTPUT),s.gate(p,St.OUTPUT),r.connect(c,tt.ONE_TO_ONE,1),n.nodes=[...i.nodes,...s.nodes,...o.nodes,...a.nodes,...r.nodes,...c.nodes],n.output=r,n.input=(h,m,d)=>{h instanceof e&&(h=h.output),m=m||tt.ALL_TO_ALL;let f=[];return f=f.concat(h.connect(i,m,d)),f=f.concat(h.connect(o,m,d)),f=f.concat(h.connect(a,m,d)),f},n}static memory(t,n){let i=new e,s=null;for(let a=0;a<n;a++){let r=new st(t);r.set({squash:V.identity,bias:0,type:"variant"}),s?.connect(r,tt.ONE_TO_ONE,1),i.nodes.push(r),s=r}i.nodes.reverse();let o=new st(0);for(let a of i.nodes)this.prototype.isGroup(a)?o.nodes=o.nodes.concat(a.nodes):console.warn("Unexpected Node type found directly in Memory layer nodes list during output group creation.");return i.output=o,i.input=(a,r,c)=>{a instanceof e&&(a=a.output),r=r||tt.ALL_TO_ALL;let l=i.nodes[i.nodes.length-1];if(!this.prototype.isGroup(l))throw new Error("Memory layer input block is not a Group.");if(a.nodes.length!==l.nodes.length)throw new Error(`Previous layer size (${a.nodes.length}) must be same as memory size (${l.nodes.length})`);return a.connect(l,tt.ONE_TO_ONE,1)},i}static batchNorm(t){let n=e.dense(t);n.batchNorm=!0;let i=n.activate.bind(n);return n.activate=function(s,o=!1){let a=i(s,o),r=a.reduce((u,p)=>u+p,0)/a.length,c=a.reduce((u,p)=>u+(p-r)**2,0)/a.length,l=(Pt(),Z(Se)).NORM_EPSILON;return a.map(u=>(u-r)/Math.sqrt(c+l))},n}static layerNorm(t){let n=e.dense(t);n.layerNorm=!0;let i=n.activate.bind(n);return n.activate=function(s,o=!1){let a=i(s,o),r=a.reduce((u,p)=>u+p,0)/a.length,c=a.reduce((u,p)=>u+(p-r)**2,0)/a.length,l=(Pt(),Z(Se)).NORM_EPSILON;return a.map(u=>(u-r)/Math.sqrt(c+l))},n}static conv1d(t,n,i=1,s=0){let o=new e;return o.nodes=Array.from({length:t},()=>new Q),o.output=new st(t),o.conv1d={kernelSize:n,stride:i,padding:s},o.activate=function(a){return a?a.slice(0,t):this.nodes.map(r=>r.activate())},o}static attention(t,n=1){let i=new e;return i.nodes=Array.from({length:t},()=>new Q),i.output=new st(t),i.attention={heads:n},i.activate=function(s){if(!s)return this.nodes.map(a=>a.activate());let o=s.reduce((a,r)=>a+r,0)/s.length;return Array(t).fill(o)},i}isGroup(t){return!!t&&typeof t.set=="function"&&Array.isArray(t.nodes)}}});var oi={};ht(oi,{mutateImpl:()=>io});function io(e){if(e==null)throw new Error("No (correct) mutate method given!");let t;if(typeof e=="string"?t=e:t=e?.name??e?.type??e?.identity,!t){for(let i in Gt)if(e===Gt[i]){t=i;break}}let n=t?no[t]:void 0;if(!n){U.warnings&&console.warn("[mutate] Unknown mutation method ignored:",t);return}n.call(this,e),this._topoDirty=!0}function so(){let e=this;if(e._enforceAcyclic&&(e._topoDirty=!0),U.deterministicChainMode){let c=this.nodes.find(N=>N.type==="input"),l=this.nodes.find(N=>N.type==="output");if(!c||!l)return;e._detChain||(this.connections.some(N=>N.from===c&&N.to===l)||this.connect(c,l),e._detChain=[c]);let u=e._detChain,p=u[u.length-1],h=this.connections.find(N=>N.from===p&&N.to===l);h||(h=this.connect(p,l)[0]);let m=h.gater;this.disconnect(h.from,h.to);let d=new Q("hidden",void 0,e._rand);d.mutate(Gt.MOD_ACTIVATION);let f=this.nodes.indexOf(l),b=Math.min(f,this.nodes.length-this.output);this.nodes.splice(b,0,d),e._nodeIndexDirty=!0;let g=this.connect(p,d)[0],y=this.connect(d,l)[0];u.push(d),e._preferredChainEdge=y,m&&this.gate(m,e._rand()>=.5?g:y);for(let N=0;N<u.length;N++){let S=u[N],v=N+1<u.length?u[N+1]:l,_=S.connections.out.find(x=>x.to===v);if(_){for(let x of S.connections.out.slice())if(x!==_)try{this.disconnect(x.from,x.to)}catch{}}}return}if(this.connections.length===0){let c=this.nodes.find(u=>u.type==="input"),l=this.nodes.find(u=>u.type==="output");if(c&&l)this.connect(c,l);else return}let t=this.connections[Math.floor(e._rand()*this.connections.length)];if(!t)return;let n=t.gater;this.disconnect(t.from,t.to);let i=new Q("hidden",void 0,e._rand);i.mutate(Gt.MOD_ACTIVATION);let s=this.nodes.indexOf(t.to),o=Math.min(s,this.nodes.length-this.output);this.nodes.splice(o,0,i),e._nodeIndexDirty=!0;let a=this.connect(t.from,i)[0],r=this.connect(i,t.to)[0];e._preferredChainEdge=r,n&&this.gate(n,e._rand()>=.5?a:r)}function oo(){let e=this.nodes.filter(s=>s.type==="hidden");if(e.length===0){U.warnings&&console.warn("No hidden nodes left to remove!");return}let n=e[Math.floor(this._rand()*e.length)];this.remove(n);let i=this.connections[0];i&&(i.weight+=1e-4)}function ao(){let e=this;e._enforceAcyclic&&(e._topoDirty=!0);let t=[];for(let i=0;i<this.nodes.length-this.output;i++){let s=this.nodes[i];for(let o=Math.max(i+1,this.input);o<this.nodes.length;o++){let a=this.nodes[o];s.isProjectingTo(a)||t.push([s,a])}}if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.connect(n[0],n[1])}function ro(){let e=this,t=this.connections.filter(i=>{let s=i.from.connections.out.length>1,o=i.to.connections.in.length>1,a=this.nodes.filter(c=>c.type===i.to.type&&Math.abs(this.nodes.indexOf(c)-this.nodes.indexOf(i.to))<Math.max(this.input,this.output)),r=!1;return a.length>0&&this.connections.filter(l=>l.from===i.from&&a.includes(l.to)).length<=1&&(r=!0),s&&o&&this.nodes.indexOf(i.to)>this.nodes.indexOf(i.from)&&!r});if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.disconnect(n.from,n.to)}function co(e){let t=this.connections.concat(this.selfconns);if(t.length===0)return;let n=t[Math.floor(this._rand()*t.length)],i=this._rand()*(e.max-e.min)+e.min;n.weight+=i}function lo(e){if(this.nodes.length<=this.input)return;let t=Math.floor(this._rand()*(this.nodes.length-this.input)+this.input);this.nodes[t].mutate(e)}function uo(e){let t=e.mutateOutput??!0,n=this.nodes.length-this.input-(t?0:this.output);if(n<=0){U.warnings&&console.warn("No nodes available for activation function mutation based on config.");return}let i=Math.floor(this._rand()*n+this.input);this.nodes[i].mutate(e)}function ho(){let e=this;if(e._enforceAcyclic)return;let t=this.nodes.filter((i,s)=>s>=this.input&&i.connections.self.length===0);if(t.length===0){U.warnings&&console.warn("All eligible nodes already have self-connections.");return}let n=t[Math.floor(e._rand()*t.length)];this.connect(n,n)}function po(){if(this.selfconns.length===0){U.warnings&&console.warn("No self-connections exist to remove.");return}let e=this.selfconns[Math.floor(this._rand()*this.selfconns.length)];this.disconnect(e.from,e.to)}function mo(){let e=this,n=this.connections.concat(this.selfconns).filter(a=>a.gater===null);if(n.length===0||this.nodes.length<=this.input){U.warnings&&console.warn("All connections are already gated.");return}let i=Math.floor(e._rand()*(this.nodes.length-this.input)+this.input),s=this.nodes[i],o=n[Math.floor(e._rand()*n.length)];this.gate(s,o)}function fo(){if(this.gates.length===0){U.warnings&&console.warn("No gated connections to ungate.");return}let e=Math.floor(this._rand()*this.gates.length),t=this.gates[e];this.ungate(t)}function yo(){let e=this;if(e._enforceAcyclic)return;let t=[];for(let i=this.input;i<this.nodes.length;i++){let s=this.nodes[i];for(let o=this.input;o<i;o++){let a=this.nodes[o];s.isProjectingTo(a)||t.push([s,a])}}if(t.length===0)return;let n=t[Math.floor(e._rand()*t.length)];this.connect(n[0],n[1])}function go(){let e=this.connections.filter(n=>n.from.connections.out.length>1&&n.to.connections.in.length>1&&this.nodes.indexOf(n.from)>this.nodes.indexOf(n.to));if(e.length===0)return;let t=e[Math.floor(this._rand()*e.length)];this.disconnect(t.from,t.to)}function bo(e){let t=this,n=e.mutateOutput??!0,i=this.nodes.length-this.input-(n?0:this.output);if(i<2)return;let s=Math.floor(t._rand()*i+this.input),o=Math.floor(t._rand()*i+this.input);for(;s===o;)o=Math.floor(t._rand()*i+this.input);let a=this.nodes[s],r=this.nodes[o],c=a.bias,l=a.squash;a.bias=r.bias,a.squash=r.squash,r.bias=c,r.squash=l}function Ao(){if(this._enforceAcyclic||this.connections.length===0)return;let t=this.connections[Math.floor(Math.random()*this.connections.length)],n=t.gater;this.disconnect(t.from,t.to);let s=(Wt(),Z(Pe)).default.lstm(1);s.nodes.forEach(o=>{o.type="hidden",this.nodes.push(o)}),this.connect(t.from,s.nodes[0]),this.connect(s.output.nodes[0],t.to),n&&this.gate(n,this.connections[this.connections.length-1])}function So(){if(this._enforceAcyclic||this.connections.length===0)return;let t=this.connections[Math.floor(Math.random()*this.connections.length)],n=t.gater;this.disconnect(t.from,t.to);let s=(Wt(),Z(Pe)).default.gru(1);s.nodes.forEach(o=>{o.type="hidden",this.nodes.push(o)}),this.connect(t.from,s.nodes[0]),this.connect(s.output.nodes[0],t.to),n&&this.gate(n,this.connections[this.connections.length-1])}function vo(e){if(this.nodes.length<=this.input)return;let t=this,n=Math.floor(t._rand()*(this.nodes.length-this.input)+this.input),i=this.nodes[n],s=e?.min??-1,o=e?.max??1,a=()=>t._rand()*(o-s)+s;for(let r of i.connections.in)r.weight=a();for(let r of i.connections.out)r.weight=a();for(let r of i.connections.self)r.weight=a()}function No(){let e=this.nodes.filter(i=>i.type==="hidden");if(!e.length)return;let n=e[Math.floor(this._rand()*e.length)];n._batchNorm=!0}var no,ai=H(()=>{"use strict";lt();Vt();At();no={ADD_NODE:so,SUB_NODE:oo,ADD_CONN:ao,SUB_CONN:ro,MOD_WEIGHT:co,MOD_BIAS:lo,MOD_ACTIVATION:uo,ADD_SELF_CONN:ho,SUB_SELF_CONN:po,ADD_GATE:mo,SUB_GATE:fo,ADD_BACK_CONN:yo,SUB_BACK_CONN:go,SWAP_NODES:bo,ADD_LSTM_NODE:Ao,ADD_GRU_NODE:So,REINIT_WEIGHT:vo,BATCH_NORM:No}});var ke={};ht(ke,{__trainingInternals:()=>wo,applyGradientClippingImpl:()=>ri,trainImpl:()=>Ro,trainSetImpl:()=>ci});function _o(e,t,n,i){if(n.window<=1&&n.type!=="ema"&&n.type!=="adaptive-ema")return e;let s=n.type;if(s==="median"){let o=[...t].sort((r,c)=>r-c),a=Math.floor(o.length/2);return o.length%2?o[a]:(o[a-1]+o[a])/2}if(s==="ema")return i.emaValue==null?i.emaValue=e:i.emaValue=i.emaValue+n.emaAlpha*(e-i.emaValue),i.emaValue;if(s==="adaptive-ema"){let o=t.reduce((u,p)=>u+p,0)/t.length,a=t.reduce((u,p)=>u+(p-o)*(p-o),0)/t.length,r=n.emaAlpha||2/(n.window+1),c=a/Math.max(o*o,1e-8),l=Math.min(.95,Math.max(r,r*(1+2*c)));return i.adaptiveBaseEmaValue==null?(i.adaptiveBaseEmaValue=e,i.adaptiveEmaValue=e):(i.adaptiveBaseEmaValue=i.adaptiveBaseEmaValue+r*(e-i.adaptiveBaseEmaValue),i.adaptiveEmaValue=i.adaptiveEmaValue+l*(e-i.adaptiveEmaValue)),Math.min(i.adaptiveEmaValue,i.adaptiveBaseEmaValue)}if(s==="gaussian"){let o=n.window/3||1,a=0,r=0,c=t.length;for(let l=0;l<c;l++){let u=Math.exp(-.5*Math.pow((l-(c-1))/o,2));a+=u,r+=u*t[l]}return r/(a||1)}if(s==="trimmed"){let o=Math.min(.49,Math.max(0,n.trimmedRatio||.1)),a=[...t].sort((l,u)=>l-u),r=Math.floor(a.length*o),c=a.slice(r,a.length-r);return c.reduce((l,u)=>l+u,0)/(c.length||1)}if(s==="wma"){let o=0,a=0;for(let r=0;r<t.length;r++){let c=r+1;o+=c,a+=c*t[r]}return a/(o||1)}return t.reduce((o,a)=>o+a,0)/t.length}function xo(e,t,n,i){if(n.window<=1&&n.type!=="ema")return e;if(n.type==="median"){let s=[...t].sort((a,r)=>a-r),o=Math.floor(s.length/2);return s.length%2?s[o]:(s[o-1]+s[o])/2}return n.type==="ema"?(i.plateauEmaValue==null?i.plateauEmaValue=e:i.plateauEmaValue=i.plateauEmaValue+n.emaAlpha*(e-i.plateauEmaValue),i.plateauEmaValue):t.reduce((s,o)=>s+o,0)/t.length}function Mo(e,t){if(!t._mixedPrecision.enabled)return!1;if(t._forceNextOverflow)return t._forceNextOverflow=!1,!0;let n=!1;return e.nodes.forEach(i=>{i._fp32Bias!==void 0&&(Number.isFinite(i.bias)||(n=!0))}),n}function Eo(e){e.nodes.forEach(t=>{t.connections.in.forEach(n=>{n.totalDeltaWeight=0}),t.connections.self.forEach(n=>{n.totalDeltaWeight=0}),typeof t.totalDeltaBias=="number"&&(t.totalDeltaBias=0),t.previousDeltaBias=0})}function Io(e,t){t<=1||e.nodes.forEach(n=>{n.connections.in.forEach(i=>{typeof i.totalDeltaWeight=="number"&&(i.totalDeltaWeight/=t)}),n.connections.self.forEach(i=>{typeof i.totalDeltaWeight=="number"&&(i.totalDeltaWeight/=t)}),typeof n.totalDeltaBias=="number"&&(n.totalDeltaBias/=t)})}function Co(e,t,n,i,s){let o=0;return e.nodes.forEach(a=>{a.type!=="input"&&(a.applyBatchUpdatesWithOptimizer({type:t.type,baseType:t.baseType,beta1:t.beta1,beta2:t.beta2,eps:t.eps,weightDecay:t.weightDecay,momentum:t.momentum??i,lrScale:n,t:s._optimizerStep,la_k:t.la_k,la_alpha:t.la_alpha}),a.connections.in.forEach(r=>{typeof r.previousDeltaWeight=="number"&&(o+=r.previousDeltaWeight*r.previousDeltaWeight)}),a.connections.self.forEach(r=>{typeof r.previousDeltaWeight=="number"&&(o+=r.previousDeltaWeight*r.previousDeltaWeight)}))}),Math.sqrt(o)}function To(e){e._mixedPrecisionState.goodSteps++;let t=e._mpIncreaseEvery||200;e._mixedPrecisionState.goodSteps>=t&&e._mixedPrecision.lossScale<e._mixedPrecisionState.maxLossScale&&(e._mixedPrecision.lossScale*=2,e._mixedPrecisionState.goodSteps=0,e._mixedPrecisionState.scaleUpEvents=(e._mixedPrecisionState.scaleUpEvents||0)+1)}function Oo(e){e._mixedPrecisionState.badSteps++,e._mixedPrecisionState.goodSteps=0,e._mixedPrecision.lossScale=Math.max(e._mixedPrecisionState.minLossScale,Math.floor(e._mixedPrecision.lossScale/2)||1),e._mixedPrecisionState.overflowCount=(e._mixedPrecisionState.overflowCount||0)+1,e._mixedPrecisionState.scaleDownEvents=(e._mixedPrecisionState.scaleDownEvents||0)+1,e._lastOverflowStep=e._optimizerStep}function ri(e,t){let n=e,s=(()=>{let r=[];if(t.mode.startsWith("layerwise"))if(e.layers&&e.layers.length>0)for(let c=0;c<e.layers.length;c++){let l=e.layers[c];if(!l||!l.nodes)continue;let u=[];l.nodes.forEach(p=>{!p||p.type==="input"||(p.connections.in.forEach(h=>{typeof h.totalDeltaWeight=="number"&&u.push(h.totalDeltaWeight)}),p.connections.self.forEach(h=>{typeof h.totalDeltaWeight=="number"&&u.push(h.totalDeltaWeight)}),typeof p.totalDeltaBias=="number"&&u.push(p.totalDeltaBias))}),u.length&&r.push(u)}else e.nodes.forEach(c=>{if(c.type==="input")return;let l=[];c.connections.in.forEach(u=>{typeof u.totalDeltaWeight=="number"&&l.push(u.totalDeltaWeight)}),c.connections.self.forEach(u=>{typeof u.totalDeltaWeight=="number"&&l.push(u.totalDeltaWeight)}),typeof c.totalDeltaBias=="number"&&l.push(c.totalDeltaBias),l.length&&r.push(l)});else{let c=[];e.nodes.forEach(l=>{l.connections.in.forEach(u=>{typeof u.totalDeltaWeight=="number"&&c.push(u.totalDeltaWeight)}),l.connections.self.forEach(u=>{typeof u.totalDeltaWeight=="number"&&c.push(u.totalDeltaWeight)}),typeof l.totalDeltaBias=="number"&&c.push(l.totalDeltaBias)}),c.length&&r.push(c)}return r})();n._lastGradClipGroupCount=s.length;let o=(r,c)=>{if(!r.length)return 0;let l=[...r].sort((p,h)=>Math.abs(p)-Math.abs(h)),u=Math.min(l.length-1,Math.max(0,Math.floor(c/100*l.length-1)));return Math.abs(l[u])},a=r=>{let c=0;e.nodes.forEach(l=>{if(t.mode.startsWith("layerwise")&&l.type==="input")return;let u=t.mode.startsWith("layerwise")?s[c++]:s[0];l.connections.in.forEach(p=>{typeof p.totalDeltaWeight=="number"&&(p.totalDeltaWeight=r(p.totalDeltaWeight,u))}),l.connections.self.forEach(p=>{typeof p.totalDeltaWeight=="number"&&(p.totalDeltaWeight=r(p.totalDeltaWeight,u))}),typeof l.totalDeltaBias=="number"&&(l.totalDeltaBias=r(l.totalDeltaBias,u))})};if(t.mode==="norm"||t.mode==="layerwiseNorm"){let r=t.maxNorm||1;s.forEach(c=>{let l=Math.sqrt(c.reduce((u,p)=>u+p*p,0));if(l>r&&l>0){let u=r/l;a((p,h)=>h===c?p*u:p)}})}else if(t.mode==="percentile"||t.mode==="layerwisePercentile"){let r=t.percentile||99;s.forEach(c=>{let l=o(c,r);l<=0||a((u,p)=>p===c&&Math.abs(u)>l?l*Math.sign(u):u)})}}function ci(e,t,n,i,s,o,a,r,c){let l=e,u=0,p=0;l._gradAccumMicroBatches=0;let h=0,m=e.nodes.filter(f=>f.type==="output"),d;typeof r=="function"?d=r:r&&typeof r.fn=="function"?d=r.fn:r&&typeof r.calculate=="function"?d=r.calculate:d=()=>0;for(let f=0;f<t.length;f++){let b=t[f],g=b.input,y=b.output;if(g.length!==e.input||y.length!==e.output){U.warnings&&console.warn(`Data point ${f} has incorrect dimensions (input: ${g.length}/${e.input}, output: ${y.length}/${e.output}), skipping.`);continue}try{let N=e.activate(g,!0);if(c&&c.type&&c.type!=="sgd"){for(let S=0;S<m.length;S++)m[S].propagate(s,o,!1,a,y[S]);for(let S=e.nodes.length-1;S>=0;S--){let v=e.nodes[S];v.type==="output"||v.type==="input"||v.propagate(s,o,!1,a)}}else{for(let S=0;S<m.length;S++)m[S].propagate(s,o,!0,a,y[S]);for(let S=e.nodes.length-1;S>=0;S--){let v=e.nodes[S];v.type==="output"||v.type==="input"||v.propagate(s,o,!0,a)}}u+=d(y,N),p++,h++}catch(N){U.warnings&&console.warn(`Error processing data point ${f} (input: ${JSON.stringify(g)}): ${N.message}. Skipping.`)}p>0&&((f+1)%n===0||f===t.length-1)&&c&&c.type&&c.type!=="sgd"&&(l._gradAccumMicroBatches++,(l._gradAccumMicroBatches%i===0||f===t.length-1)&&(l._optimizerStep=(l._optimizerStep||0)+1,Mo(e,l)?(Eo(e),l._mixedPrecision.enabled&&Oo(l),l._lastGradNorm=0):(l._currentGradClip&&ri(e,l._currentGradClip),i>1&&l._accumulationReduction==="average"&&Io(e,i),l._lastGradNorm=Co(e,c,s,o,l),l._mixedPrecision.enabled&&To(l))),p=0)}return l._lastGradNorm==null&&(l._lastGradNorm=0),h>0?u/h:0}function Ro(e,t,n){let i=e;if(!t||t.length===0||t[0].input.length!==e.input||t[0].output.length!==e.output)throw new Error("Dataset is invalid or dimensions do not match network input/output size!");if(n=n||{},typeof n.iterations>"u"&&typeof n.error>"u")throw U.warnings&&console.warn("Missing `iterations` or `error` option."),new Error("Missing `iterations` or `error` option. Training requires a stopping condition.");U.warnings&&(typeof n.rate>"u"&&(console.warn("Missing `rate` option"),console.warn("Missing `rate` option, using default learning rate 0.3.")),typeof n.iterations>"u"&&console.warn("Missing `iterations` option. Training will run potentially indefinitely until `error` threshold is met."));let s=n.error??-1/0,o=n.cost||Nt.mse;if(typeof o!="function"&&!(typeof o=="object"&&(typeof o.fn=="function"||typeof o.calculate=="function")))throw new Error("Invalid cost function provided to Network.train.");let a=n.rate??.3,r=n.dropout||0;if(r<0||r>=1)throw new Error("dropout must be in [0,1)");let c=n.momentum||0,l=n.batchSize||1;if(l>t.length)throw new Error("Batch size cannot be larger than the dataset length.");let u=n.accumulationSteps||1;if(i._accumulationReduction=n.accumulationReduction==="sum"?"sum":"average",u<1||!Number.isFinite(u))throw new Error("accumulationSteps must be >=1");if(n.gradientClip){let W=n.gradientClip;W.mode?i._currentGradClip={mode:W.mode,maxNorm:W.maxNorm,percentile:W.percentile}:typeof W.maxNorm=="number"?i._currentGradClip={mode:"norm",maxNorm:W.maxNorm}:typeof W.percentile=="number"&&(i._currentGradClip={mode:"percentile",percentile:W.percentile}),i._gradClipSeparateBias=!!W.separateBias}else i._currentGradClip=void 0,i._gradClipSeparateBias=!1;if(n.mixedPrecision){let W=n.mixedPrecision===!0?{lossScale:1024}:n.mixedPrecision;i._mixedPrecision.enabled=!0,i._mixedPrecision.lossScale=W.lossScale||1024;let J=W.dynamic||{};i._mixedPrecisionState.minLossScale=J.minScale||1,i._mixedPrecisionState.maxLossScale=J.maxScale||65536,i._mpIncreaseEvery=J.increaseEvery||J.stableStepsForIncrease||200,e.connections.forEach(X=>{X._fp32Weight=X.weight}),e.nodes.forEach(X=>{X.type!=="input"&&(X._fp32Bias=X.bias)})}else i._mixedPrecision.enabled=!1,i._mixedPrecision.lossScale=1,i._mpIncreaseEvery=200;let p=new Set(["sgd","rmsprop","adagrad","adam","adamw","amsgrad","adamax","nadam","radam","lion","adabelief","lookahead"]),h;if(typeof n.optimizer<"u"){if(typeof n.optimizer=="string")h={type:n.optimizer.toLowerCase()};else if(typeof n.optimizer=="object"&&n.optimizer!==null)h={...n.optimizer},typeof h.type=="string"&&(h.type=h.type.toLowerCase());else throw new Error("Invalid optimizer option; must be string or object");if(!p.has(h.type))throw new Error(`Unknown optimizer type: ${h.type}`);if(h.type==="lookahead"){if(h.baseType||(h.baseType="adam"),h.baseType==="lookahead")throw new Error("Nested lookahead (baseType lookahead) is not supported");if(!p.has(h.baseType))throw new Error(`Unknown baseType for lookahead: ${h.baseType}`);h.la_k=h.la_k||5,h.la_alpha=h.la_alpha??.5}}let m=n.iterations??Number.MAX_SAFE_INTEGER,d=Date.now(),f=1/0,b=Math.max(1,n.movingAverageWindow||1),g=n.movingAverageType||"sma",y=(()=>{if(g==="ema")return n.emaAlpha&&n.emaAlpha>0&&n.emaAlpha<=1?n.emaAlpha:2/(b+1)})(),N=Math.max(1,n.plateauMovingAverageWindow||b),S=n.plateauMovingAverageType||g,v=(()=>{if(S==="ema")return n.plateauEmaAlpha&&n.plateauEmaAlpha>0&&n.plateauEmaAlpha<=1?n.plateauEmaAlpha:2/(N+1)})(),_=n.earlyStopPatience,x=n.earlyStopMinDelta||0,w=1/0,I=0,C=b,F=new Array(C),P=0,$=0,E=W=>{if(C===1){F[0]=W,P=1,$=0;return}F[$]=W,$=($+1)%C,P<C&&P++},T=()=>{if(P===0)return[];if(P<C)return F.slice(0,P);let W=new Array(P),J=$;for(let X=0;X<P;X++)W[X]=F[(J+X)%C];return W},k,D,O,M=N,R=new Array(M),L=0,G=0,B=W=>{if(M===1){R[0]=W,L=1,G=0;return}R[G]=W,G=(G+1)%M,L<M&&L++},Y=()=>{if(L===0)return[];if(L<M)return R.slice(0,L);let W=new Array(L),J=G;for(let X=0;X<L;X++)W[X]=R[(J+X)%M];return W},at;e.dropout=r;let ct=0;for(let W=1;W<=m;W++){e._maybePrune&&e._maybePrune((i._globalEpoch||0)+W);let J=ci(e,t,l,u,a,c,{},o,h);ct=W,E(J);let X=J;if(b>1||g==="ema"||g==="adaptive-ema"){let nt=T();if(g==="median"){let K=[...nt].sort((ut,gt)=>ut-gt),ot=Math.floor(K.length/2);X=K.length%2?K[ot]:(K[ot-1]+K[ot])/2}else if(g==="ema")k==null?k=J:k=k+y*(J-k),X=k;else if(g==="adaptive-ema"){let K=nt.reduce((bt,It)=>bt+It,0)/nt.length,ot=nt.reduce((bt,It)=>bt+(It-K)*(It-K),0)/nt.length,ut=y||2/(b+1),gt=ot/Math.max(K*K,1e-8),_t=Math.min(.95,Math.max(ut,ut*(1+2*gt)));D==null?(D=J,O=J):(D=D+ut*(J-D),O=O+_t*(J-O)),X=Math.min(O,D)}else if(g==="gaussian"){let K=nt,ot=K.length,ut=b/3||1,gt=0,_t=0;for(let bt=0;bt<ot;bt++){let It=Math.exp(-.5*Math.pow((bt-(ot-1))/ut,2));gt+=It,_t+=It*K[bt]}X=_t/(gt||1)}else if(g==="trimmed"){let K=Math.min(.49,Math.max(0,n.trimmedRatio||.1)),ot=[...nt].sort((_t,bt)=>_t-bt),ut=Math.floor(ot.length*K),gt=ot.slice(ut,ot.length-ut);X=gt.reduce((_t,bt)=>_t+bt,0)/(gt.length||1)}else if(g==="wma"){let K=0,ot=0;for(let ut=0;ut<nt.length;ut++){let gt=ut+1;K+=gt,ot+=gt*nt[ut]}X=ot/(K||1)}else X=nt.reduce((K,ot)=>K+ot,0)/nt.length}f=X,B(J);let it=J;if(N>1||S==="ema")if(S==="median"){let nt=[...Y()].sort((ot,ut)=>ot-ut),K=Math.floor(nt.length/2);it=nt.length%2?nt[K]:(nt[K-1]+nt[K])/2}else if(S==="ema")at==null?at=J:at=at+v*(J-at),it=at;else{let nt=Y();it=nt.reduce((K,ot)=>K+ot,0)/nt.length}if(typeof n.metricsHook=="function")try{n.metricsHook({iteration:W,error:f,plateauError:it,gradNorm:i._lastGradNorm??0})}catch{}if(n.checkpoint&&typeof n.checkpoint.save=="function"){if(n.checkpoint.last)try{n.checkpoint.save({type:"last",iteration:W,error:f,network:e.toJSON()})}catch{}if(n.checkpoint.best&&(f<e._checkpointBestError||e._checkpointBestError==null)){e._checkpointBestError=f;try{n.checkpoint.save({type:"best",iteration:W,error:f,network:e.toJSON()})}catch{}}}if(n.schedule&&n.schedule.iterations&&W%n.schedule.iterations===0)try{n.schedule.function({error:f,iteration:W})}catch{}if(f<w-x?(w=f,I=0):_&&I++,_&&I>=_||f<=s)break}return e.nodes.forEach(W=>{W.type==="hidden"&&(W.mask=1)}),e.dropout=0,i._globalEpoch=(i._globalEpoch||0)+ct,{error:f,iterations:ct,time:Date.now()-d}}var wo,De=H(()=>{"use strict";mt();At();wo={computeMonitoredError:_o,computePlateauMetric:xo}});var hi={};ht(hi,{evolveNetwork:()=>Po});function Fe(e,t){let n=e.nodes.length,i=e.connections.length,s=e.gates.length,o=li.get(e);if(o&&o.nodes===n&&o.conns===i&&o.gates===s)return o.value*t;let a=n-e.input-e.output+i+s;return li.set(e,{nodes:n,conns:i,gates:s,value:a}),a*t}function ui(e,t,n,i){return s=>{let o=0;for(let a=0;a<n;a++)try{o-=s.test(e,t).error}catch(r){return U.warnings&&console.warn(`Genome evaluation failed: ${r&&r.message||r}. Penalizing with -Infinity fitness.`),-1/0}return o-=Fe(s,i),o=isNaN(o)?-1/0:o,o/n}}async function Lo(e,t,n,i,s,o){let a=ft.serializeDataSet(e),r=[],c=null;try{let u=typeof process<"u"&&!!process.versions?.node;u&&ft.workers?.getNodeTestWorker?c=await ft.workers.getNodeTestWorker():!u&&ft.workers?.getBrowserTestWorker&&(c=await ft.workers.getBrowserTestWorker())}catch(u){U.warnings&&console.warn("Failed to load worker class; falling back to single-thread path:",u?.message||u)}if(!c)return{fitnessFunction:ui(e,t,n,i),threads:1};for(let u=0;u<s;u++)try{r.push(new c(a,{name:t.name||t.toString?.()||"cost"}))}catch(p){U.warnings&&console.warn("Worker spawn failed",p)}let l=u=>new Promise(p=>{if(!r.length){p();return}let h=u.slice(),m=r.length,d=f=>{if(!h.length){--m===0&&p();return}let b=h.shift();f.evaluate(b).then(g=>{typeof b<"u"&&typeof g=="number"&&(b.score=-g-Fe(b,i),b.score=isNaN(g)?-1/0:b.score),d(f)}).catch(()=>d(f))};r.forEach(f=>d(f))});return o.fitnessPopulation=!0,o._workerTerminators=()=>{r.forEach(u=>{try{u.terminate&&u.terminate()}catch{}})},{fitnessFunction:l,threads:s}}async function Po(e,t){if(!e||e.length===0||e[0].input.length!==this.input||e[0].output.length!==this.output)throw new Error("Dataset is invalid or dimensions do not match network input/output size!");t=t||{};let n=t.error??.05,i=t.growth??1e-4,s=t.cost||Nt.mse,o=t.amount||1,a=t.log||0,r=t.schedule,c=t.clear||!1,l=typeof t.threads>"u"?1:t.threads,u=Date.now(),p={targetError:n,growth:i,cost:s,amount:o,log:a,schedule:r,clear:c,threads:l};if(typeof t.iterations>"u"&&typeof t.error>"u")throw new Error("At least one stopping condition (`iterations` or `error`) must be specified for evolution.");typeof t.error>"u"?n=-1:typeof t.iterations>"u"&&(t.iterations=0);let h;if(l===1)h=ui(e,s,o,i);else{let v=await Lo(e,s,o,i,l,t);h=v.fitnessFunction,l=v.threads}t.network=this,t.populationSize!=null&&t.popsize==null&&(t.popsize=t.populationSize),typeof t.speciation>"u"&&(t.speciation=!1);let{default:m}=await Promise.resolve().then(()=>($e(),di)),d=new m(this.input,this.output,h,t);if(typeof t.iterations=="number"&&t.iterations===0&&d._warnIfNoBestGenome)try{d._warnIfNoBestGenome()}catch{}t.popsize&&t.popsize<=10&&(d.options.mutationRate=d.options.mutationRate??.5,d.options.mutationAmount=d.options.mutationAmount??1);let f=1/0,b=-1/0,g,y=0,N=5,S=typeof t.iterations=="number";for(;(n===-1||f>n)&&(!S||d.generation<t.iterations);){let v=await d.evolve(),_=v.score??-1/0;if(f=-(_-Fe(v,i))||1/0,_>b&&(b=_,g=v),!isFinite(f)||isNaN(f)){if(++y>=N)break}else y=0;if(r&&d.generation%r.iterations===0)try{r.function({fitness:b,error:f,iteration:d.generation})}catch{}}if(typeof g<"u")this.nodes=g.nodes,this.connections=g.connections,this.selfconns=g.selfconns,this.gates=g.gates,c&&this.clear();else if(d._warnIfNoBestGenome)try{d._warnIfNoBestGenome()}catch{}try{t._workerTerminators&&t._workerTerminators()}catch{}return{error:f,iterations:d.generation,time:Date.now()-u}}var li,pi=H(()=>{"use strict";pt();mt();At();Xt();li=new WeakMap});var kt={};ht(kt,{default:()=>rt});var rt,pt=H(()=>{"use strict";lt();xe();vt();Xt();mt();Vt();At();Kt();gn();Sn();_n();Tn();kn();$n();Un();qn();Yn();Kn();ni();si();rt=class e{input;output;score;nodes;connections;gates;selfconns;dropout=0;_dropConnectProb=0;_lastGradNorm;_optimizerStep=0;_weightNoiseStd=0;_weightNoisePerHidden=[];_weightNoiseSchedule;_stochasticDepth=[];_wnOrig;_trainingStep=0;_rand=Math.random;_rngState;_lastStats=null;_stochasticDepthSchedule;_mixedPrecision={enabled:!1,lossScale:1};_mixedPrecisionState={goodSteps:0,badSteps:0,minLossScale:1,maxLossScale:65536,overflowCount:0,scaleUpEvents:0,scaleDownEvents:0};_gradAccumMicroBatches=0;_currentGradClip;_lastRawGradNorm=0;_accumulationReduction="average";_gradClipSeparateBias=!1;_lastGradClipGroupCount=0;_lastOverflowStep=-1;_forceNextOverflow=!1;_pruningConfig;_initialConnectionCount;_enforceAcyclic=!1;_topoOrder=null;_topoDirty=!0;_globalEpoch=0;layers;_evoInitialConnCount;_activationPrecision="f64";_reuseActivationArrays=!1;_returnTypedActivations=!1;_activationPool;_connWeights;_connFrom;_connTo;_slabDirty=!0;_useFloat32Weights=!0;_nodeIndexDirty=!0;_outStart;_outOrder;_adjDirty=!0;_fastA;_fastS;_preferredChainEdge;_canUseFastSlab(t){return Cn.call(this,t)}_fastSlabActivate(t){return In.call(this,t)}rebuildConnectionSlab(t=!1){return re.call(this,t)}getConnectionSlab(){return Mn.call(this)}fastSlabActivate(t){return this._fastSlabActivate(t)}constructor(t,n,i){if(typeof t>"u"||typeof n>"u")throw new Error("No input or output size given");this.input=t,this.output=n,this.nodes=[],this.connections=[],this.gates=[],this.selfconns=[],this.dropout=0,this._enforceAcyclic=i?.enforceAcyclic||!1,i?.activationPrecision?this._activationPrecision=i.activationPrecision:U.float32Mode&&(this._activationPrecision="f32"),i?.reuseActivationArrays&&(this._reuseActivationArrays=!0),i?.returnTypedActivations&&(this._returnTypedActivations=!0);try{typeof U.poolMaxPerBucket=="number"&&yt.setMaxPerBucket(U.poolMaxPerBucket);let o=typeof U.poolPrewarmCount=="number"?U.poolPrewarmCount:2;yt.prewarm(this.output,o)}catch{}i?.seed!==void 0&&this.setSeed(i.seed);for(let o=0;o<this.input+this.output;o++){let a=o<this.input?"input":"output";U.enableNodePooling?this.nodes.push(_e({type:a,rng:this._rand})):this.nodes.push(new Q(a,void 0,this._rand))}for(let o=0;o<this.input;o++)for(let a=this.input;a<this.input+this.output;a++){let r=this._rand()*this.input*Math.sqrt(2/this.input);this.connect(this.nodes[o],this.nodes[a],r)}let s=i?.minHidden||0;if(s>0)for(;this.nodes.length<this.input+this.output+s;)this.addNodeBetween()}addNodeBetween(){if(this.connections.length===0)return;let t=Math.floor(this._rand()*this.connections.length),n=this.connections[t];if(!n)return;this.disconnect(n.from,n.to);let i=U.enableNodePooling?_e({type:"hidden",rng:this._rand}):new Q("hidden",void 0,this._rand);this.nodes.push(i),this.connect(n.from,i,n.weight),this.connect(i,n.to,1),this._topoDirty=!0,this._nodeIndexDirty=!0}enableDropConnect(t){if(t<0||t>=1)throw new Error("DropConnect probability must be in [0,1)");this._dropConnectProb=t}disableDropConnect(){this._dropConnectProb=0}setEnforceAcyclic(t){this._enforceAcyclic=!!t}_computeTopoOrder(){return vn.call(this)}_hasPath(t,n){return Nn.call(this,t,n)}configurePruning(t){let{start:n,end:i,targetSparsity:s}=t;if(n<0||i<n)throw new Error("Invalid pruning schedule window");if(s<=0||s>=1)throw new Error("targetSparsity must be in (0,1)");this._pruningConfig={start:n,end:i,targetSparsity:s,regrowFraction:t.regrowFraction??0,frequency:t.frequency??1,method:t.method||"magnitude",lastPruneIter:void 0},this._initialConnectionCount=this.connections.length}getCurrentSparsity(){return Pn.call(this)}_maybePrune(t){return Rn.call(this,t)}pruneToSparsity(t,n="magnitude"){return Ln.call(this,t,n)}enableWeightNoise(t){if(typeof t=="number"){if(t<0)throw new Error("Weight noise stdDev must be >= 0");this._weightNoiseStd=t,this._weightNoisePerHidden=[]}else if(t&&Array.isArray(t.perHiddenLayer)){if(!this.layers||this.layers.length<3)throw new Error("Per-hidden-layer weight noise requires a layered network with at least one hidden layer");let n=this.layers.length-2;if(t.perHiddenLayer.length!==n)throw new Error(`Expected ${n} std dev entries (one per hidden layer), got ${t.perHiddenLayer.length}`);if(t.perHiddenLayer.some(i=>i<0))throw new Error("Weight noise std devs must be >= 0");this._weightNoiseStd=0,this._weightNoisePerHidden=t.perHiddenLayer.slice()}else throw new Error("Invalid weight noise configuration")}disableWeightNoise(){this._weightNoiseStd=0,this._weightNoisePerHidden=[]}setWeightNoiseSchedule(t){this._weightNoiseSchedule=t}clearWeightNoiseSchedule(){this._weightNoiseSchedule=void 0}setRandom(t){this._rand=t}setSeed(t){Hn.call(this,t)}testForceOverflow(){this._forceNextOverflow=!0}get trainingStep(){return this._trainingStep}get lastSkippedLayers(){return this._lastSkippedLayers||[]}snapshotRNG(){return Gn.call(this)}restoreRNG(t){Bn.call(this,t)}getRNGState(){return Wn.call(this)}setRNGState(t){jn.call(this,t)}setStochasticDepthSchedule(t){this._stochasticDepthSchedule=t}clearStochasticDepthSchedule(){this._stochasticDepthSchedule=void 0}getRegularizationStats(){return zn.call(this)}setStochasticDepth(t){if(!Array.isArray(t))throw new Error("survival must be an array");if(t.some(i=>i<=0||i>1))throw new Error("Stochastic depth survival probs must be in (0,1]");if(!this.layers||this.layers.length===0)throw new Error("Stochastic depth requires layer-based network");let n=Math.max(0,this.layers.length-2);if(t.length!==n)throw new Error(`Expected ${n} survival probabilities for hidden layers, got ${t.length}`);this._stochasticDepth=t.slice()}disableStochasticDepth(){this._stochasticDepth=[]}clone(){return e.fromJSON(this.toJSON())}resetDropoutMasks(){if(this.layers&&this.layers.length>0){for(let t of this.layers)if(typeof t.nodes<"u")for(let n of t.nodes)typeof n.mask<"u"&&(n.mask=1)}else for(let t of this.nodes)typeof t.mask<"u"&&(t.mask=1)}standalone(){return An(this)}activate(t,n=!1,i=1e3){if(this._enforceAcyclic&&this._topoDirty&&this._computeTopoOrder(),!Array.isArray(t)||t.length!==this.input)throw new Error(`Input size mismatch: expected ${this.input}, got ${t?t.length:"undefined"}`);if(this._canUseFastSlab(n))try{return this._fastSlabActivate(t)}catch{}let s=yt.acquire(this.output);if(!this.nodes||this.nodes.length===0)throw new Error("Network structure is corrupted or empty. No nodes found.");let o=s;this._lastSkippedLayers=[];let a={droppedHiddenNodes:0,totalHiddenNodes:0,droppedConnections:0,totalConnections:this.connections.length,skippedLayers:[],weightNoise:{count:0,sumAbs:0,maxAbs:0,meanAbs:0}},r=!1,c=this._weightNoiseStd;if(n&&(this._weightNoiseSchedule&&(c=this._weightNoiseSchedule(this._trainingStep)),c>0||this._weightNoisePerHidden.length>0))for(let u of this.connections){if(u._origWeightNoise!=null)continue;u._origWeightNoise=u.weight;let p=c;if(this._weightNoisePerHidden.length>0&&this.layers){let h=-1;for(let m=0;m<this.layers.length;m++)if(this.layers[m].nodes.includes(u.from)){h=m;break}if(h>0&&h<this.layers.length){let m=h-1;m>=0&&m<this._weightNoisePerHidden.length&&(p=this._weightNoisePerHidden[m])}}if(p>0){let h=p*e._gaussianRand(this._rand);u.weight+=h,u._wnLast=h,r=!0}else u._wnLast=0}if(n&&this._stochasticDepthSchedule&&this._stochasticDepth.length>0){let u=this._stochasticDepthSchedule(this._trainingStep,this._stochasticDepth.slice());Array.isArray(u)&&u.length===this._stochasticDepth.length&&!u.some(p=>p<=0||p>1)&&(this._stochasticDepth=u.slice())}if(this.layers&&this.layers.length>0&&this._stochasticDepth.length>0){let u;for(let p=0;p<this.layers.length;p++){let h=this.layers[p],m=p>0&&p<this.layers.length-1,d=!1;if(n&&m){let b=p-1;if(b<this._stochasticDepth.length){let g=this._stochasticDepth[b];if(d=this._rand()>=g,d&&(!u||u.length!==h.nodes.length)&&(d=!1),!d){let y=p===0?h.activate(t,n):h.activate(void 0,n);u=g<1?y.map(N=>N*(1/g)):y;continue}}}if(d){this._lastSkippedLayers.push(p),a.skippedLayers.push(p);continue}u=p===0?h.activate(t,n):h.activate(void 0,n)}if(u)for(let p=0;p<u.length&&p<this.output;p++)o[p]=u[p]}else if(this.layers&&this.layers.length>0){let u;for(let p=0;p<this.layers.length;p++){let h=this.layers[p],m=p>0&&p<this.layers.length-1,d=p===0?h.activate(t,!1):h.activate(void 0,!1);if(m&&n&&this.dropout>0){let f=0;for(let b of h.nodes)b.mask=this._rand()<this.dropout?0:1,a.totalHiddenNodes++,b.mask===0&&a.droppedHiddenNodes++,b.mask===0&&(b.activation=0,f++);if(f===h.nodes.length&&h.nodes.length>0){let b=Math.floor(this._rand()*h.nodes.length);h.nodes[b].mask=1,h.nodes[b].activation=d[b]}}else if(m)for(let f of h.nodes)f.mask=1;u=d}if(u)if(this._reuseActivationArrays)for(let p=0;p<u.length&&p<this.output;p++)o[p]=u[p];else for(let p=0;p<u.length&&p<this.output;p++)o[p]=u[p]}else{let u=this.nodes.filter(m=>m.type==="hidden"),p=0;if(n&&this.dropout>0){for(let m of u)m.mask=this._rand()<this.dropout?0:1,a.totalHiddenNodes++,m.mask===0&&(p++,a.droppedHiddenNodes++);if(p===u.length&&u.length>0){let m=Math.floor(this._rand()*u.length);u[m].mask=1}}else for(let m of u)m.mask=1;if(n&&this._weightNoiseStd>0){this._wnOrig||(this._wnOrig=new Array(this.connections.length));for(let m=0;m<this.connections.length;m++){let d=this.connections[m];if(d._origWeightNoise!=null)continue;d._origWeightNoise=d.weight;let f=this._weightNoiseStd*e._gaussianRand(this._rand);d.weight+=f}}let h=0;if(this.nodes.forEach((m,d)=>{if(m.type==="input")m.activate(t[d]);else if(m.type==="output"){let f=m.activate();o[h++]=f}else m.activate()}),n&&this._dropConnectProb>0)for(let m of this.connections){let d=this._rand()<this._dropConnectProb?0:1;d===0&&a.droppedConnections++,m.dcMask=d,d===0?(m._origWeight==null&&(m._origWeight=m.weight),m.weight=0):m._origWeight!=null&&(m.weight=m._origWeight,delete m._origWeight)}else for(let m of this.connections)m._origWeight!=null&&(m.weight=m._origWeight,delete m._origWeight),m.dcMask=1;if(n&&r)for(let m of this.connections)m._origWeightNoise!=null&&(m.weight=m._origWeightNoise,delete m._origWeightNoise)}n&&this._trainingStep++,a.weightNoise.count>0&&(a.weightNoise.meanAbs=a.weightNoise.sumAbs/a.weightNoise.count),this._lastStats=a;let l=Array.from(o);return yt.release(o),l}static _gaussianRand(t=Math.random){let n=0,i=0;for(;n===0;)n=t();for(;i===0;)i=t();return Math.sqrt(-2*Math.log(n))*Math.cos(2*Math.PI*i)}noTraceActivate(t){let{noTraceActivate:n}=(le(),Z(ce));return n.call(this,t)}activateRaw(t,n=!1,i=1e3){let{activateRaw:s}=(le(),Z(ce));return s.call(this,t,n,i)}activateBatch(t,n=!1){let{activateBatch:i}=(le(),Z(ce));return i.call(this,t,n)}propagate(t,n,i,s,o=0,a){if(!s||s.length!==this.output)throw new Error("Output target length should match network output length");let r=s.length;for(let c=this.nodes.length-1;c>=this.nodes.length-this.output;c--)a?this.nodes[c].propagate(t,n,i,o,s[--r],a):this.nodes[c].propagate(t,n,i,o,s[--r]);for(let c=this.nodes.length-this.output-1;c>=this.input;c--)this.nodes[c].propagate(t,n,i,o)}clear(){this.nodes.forEach(t=>t.clear())}mutate(t){let{mutateImpl:n}=(ai(),Z(oi));return n.call(this,t)}connect(t,n,i){return Jn.call(this,t,n,i)}gate(t,n){return Dn.call(this,t,n)}remove(t){let n=Vn.call(this,t);if(U.enableNodePooling)try{se(t)}catch{}return n}disconnect(t,n){return Xn.call(this,t,n)}ungate(t){return Fn.call(this,t)}_applyGradientClipping(t){let{applyGradientClippingImpl:n}=(De(),Z(ke));n(this,t)}train(t,n){let{trainImpl:i}=(De(),Z(ke));return i(this,t,n)}getRawGradientNorm(){return this._lastRawGradNorm}getLossScale(){return this._mixedPrecision.lossScale}getLastGradClipGroupCount(){return this._lastGradClipGroupCount}getTrainingStats(){return{gradNorm:this._lastGradNorm??0,gradNormRaw:this._lastRawGradNorm,lossScale:this._mixedPrecision.lossScale,optimizerStep:this._optimizerStep,mp:{good:this._mixedPrecisionState.goodSteps,bad:this._mixedPrecisionState.badSteps,overflowCount:this._mixedPrecisionState.overflowCount||0,scaleUps:this._mixedPrecisionState.scaleUpEvents||0,scaleDowns:this._mixedPrecisionState.scaleDownEvents||0,lastOverflowStep:this._lastOverflowStep}}}static adjustRateForAccumulation(t,n,i){return i==="sum"&&n>1?t/n:t}async evolve(t,n){let{evolveNetwork:i}=await Promise.resolve().then(()=>(pi(),hi));return i.call(this,t,n)}test(t,n){if(!Array.isArray(t)||t.length===0)throw new Error("Test set is empty or not an array.");for(let r of t){if(!Array.isArray(r.input)||r.input.length!==this.input)throw new Error(`Test sample input size mismatch: expected ${this.input}, got ${r.input?r.input.length:"undefined"}`);if(!Array.isArray(r.output)||r.output.length!==this.output)throw new Error(`Test sample output size mismatch: expected ${this.output}, got ${r.output?r.output.length:"undefined"}`)}let i=0,s=n||Nt.mse,o=Date.now();this.nodes.forEach(r=>{r.type==="hidden"&&(r.mask=1)});let a=this.dropout;return this.dropout>0&&(this.dropout=0),t.forEach(r=>{let c=this.noTraceActivate(r.input);i+=s(r.output,c)}),this.dropout=a,{error:i/t.length,time:Date.now()-o}}serialize(){return Zn.call(this)}static deserialize(t,n,i){return Qn(t,n,i)}toJSON(){return ti.call(this)}static fromJSON(t){return ei(t)}static crossOver(t,n,i=!1){return ii(t,n,i)}set(t){this.nodes.forEach(n=>{typeof t.bias<"u"&&(n.bias=t.bias),typeof t.squash<"u"&&(n.squash=t.squash)})}toONNX(){return yn(this)}static createMLP(t,n,i){let s=Array.from({length:t},()=>new Q("input")),o=n.map(u=>Array.from({length:u},()=>new Q("hidden"))),a=Array.from({length:i},()=>new Q("output")),r=[...s,...o.flat(),...a],c=new e(t,i);c.nodes=r;let l=s;for(let u of o){for(let p of u)for(let h of l)h.connect(p);l=u}for(let u of a)for(let p of l)p.connect(u);return c.connections=c.nodes.flatMap(u=>u.connections.out),c._topoDirty=!0,c}static rebuildConnections(t){let n=new Set;t.nodes.forEach(i=>{i.connections.out.forEach(s=>{n.add(s)})}),t.connections=Array.from(n)}}});function mi(){let e=(mt(),Z(et));for(let t of this.population){this.options.adaptiveMutation?.enabled&&t._mutRate===void 0&&(t._mutRate=this.options.mutationRate!==void 0?this.options.mutationRate:this.options.adaptiveMutation.initialRate??(this.options.mutationRate||.7),this.options.adaptiveMutation.adaptAmount&&(t._mutAmount=this.options.mutationAmount||1));let n=this.options.mutationRate!==void 0?this.options.mutationRate:this.options.adaptiveMutation?.enabled?t._mutRate:this.options.mutationRate||.7,i=this.options.adaptiveMutation?.enabled&&this.options.adaptiveMutation.adaptAmount?t._mutAmount??(this.options.mutationAmount||1):this.options.mutationAmount||1;if(this._getRNG()()<=n)for(let s=0;s<i;s++){let o=this.selectMutationMethod(t,!1);if(Array.isArray(o)){let a=o;o=a[Math.floor(this._getRNG()()*a.length)]}if(o&&o.name){let a=t.nodes.length,r=t.connections.length;if(o===e.mutation.ADD_NODE){this._mutateAddNodeReuse(t);try{t.mutate(e.mutation.MOD_WEIGHT)}catch{}this._invalidateGenomeCaches(t)}else if(o===e.mutation.ADD_CONN){this._mutateAddConnReuse(t);try{t.mutate(e.mutation.MOD_WEIGHT)}catch{}this._invalidateGenomeCaches(t)}else t.mutate(o),(o===e.mutation.ADD_GATE||o===e.mutation.SUB_NODE||o===e.mutation.SUB_CONN||o===e.mutation.ADD_SELF_CONN||o===e.mutation.ADD_BACK_CONN)&&this._invalidateGenomeCaches(t);if(this._getRNG()()<.5&&this._mutateAddConnReuse(t),this.options.operatorAdaptation?.enabled){let c=this._operatorStats.get(o.name)||{success:0,attempts:0};c.attempts++;let l=t.nodes.length,u=t.connections.length;(l>a||u>r)&&c.success++,this._operatorStats.set(o.name,c)}}}}}function fi(e){if(e.connections.length===0){let l=e.nodes.find(p=>p.type==="input"),u=e.nodes.find(p=>p.type==="output");if(l&&u)try{e.connect(l,u,1)}catch{}}let t=e.connections.filter(l=>l.enabled!==!1);if(!t.length)return;let n=t[Math.floor(this._getRNG()()*t.length)],i=n.from.geneId,s=n.to.geneId,o=i+"->"+s,a=n.weight;e.disconnect(n.from,n.to);let r=this._nodeSplitInnovations.get(o),c=(lt(),Z(ie)).default;if(r){let l=new c("hidden");l.geneId=r.newNodeGeneId;let u=e.nodes.indexOf(n.to),p=Math.min(u,e.nodes.length-e.output);e.nodes.splice(p,0,l);let h=e.connect(n.from,l,1)[0],m=e.connect(l,n.to,a)[0];h&&(h.innovation=r.inInnov),m&&(m.innovation=r.outInnov)}else{let l=new c("hidden"),u=e.connect(n.from,l,1)[0],p=e.connect(l,n.to,a)[0];u&&(u.innovation=this._nextGlobalInnovation++),p&&(p.innovation=this._nextGlobalInnovation++),r={newNodeGeneId:l.geneId,inInnov:u?.innovation,outInnov:p?.innovation},this._nodeSplitInnovations.set(o,r);let h=e.nodes.indexOf(n.to),m=Math.min(h,e.nodes.length-e.output);e.nodes.splice(m,0,l)}}function yi(e){let t=[];for(let h=0;h<e.nodes.length-e.output;h++){let m=e.nodes[h];for(let d=Math.max(h+1,e.input);d<e.nodes.length;d++){let f=e.nodes[d];m.isProjectingTo(f)||t.push([m,f])}}if(!t.length)return;let n=t.filter(h=>{let m=h[0].geneId,d=h[1].geneId,f=m<d?m+"::"+d:d+"::"+m;return this._connInnovations.has(f)}),i=n.length?[]:t.filter(h=>h[0].type==="hidden"&&h[1].type==="hidden"),s=n.length?n:i.length?i:t,o=s.length===1?s[0]:s[Math.floor(this._getRNG()()*s.length)],a=o[0],r=o[1],c=a.geneId,l=r.geneId,u=c<l?c+"::"+l:l+"::"+c;if(e._enforceAcyclic&&(()=>{let m=[r],d=new Set;for(;m.length;){let f=m.pop();if(f===a)return!0;if(!d.has(f)){d.add(f);for(let b of f.connections.out)m.push(b.to)}}return!1})())return;let p=e.connect(a,r)[0];if(p)if(this._connInnovations.has(u))p.innovation=this._connInnovations.get(u);else{let h=this._nextGlobalInnovation++;p.innovation=h,this._connInnovations.set(u,h);let m=c+"::"+l,d=l+"::"+c;this._connInnovations.set(m,h),this._connInnovations.set(d,h)}}function gi(e,t){let n=this.options.maxNodes||1/0,i=Math.min(this.getMinimumHiddenSize(t),n-e.nodes.filter(l=>l.type!=="hidden").length),s=e.nodes.filter(l=>l.type==="input"),o=e.nodes.filter(l=>l.type==="output"),a=e.nodes.filter(l=>l.type==="hidden");if(s.length===0||o.length===0){try{console.warn("Network is missing input or output nodes \u2014 skipping minHidden enforcement")}catch{}return}let r=a.length;for(let l=r;l<i&&e.nodes.length<n;l++){let u=(lt(),Z(ie)).default,p=new u("hidden");e.nodes.push(p),a.push(p)}for(let l of a){if(l.connections.in.length===0){let u=s.concat(a.filter(p=>p!==l));if(u.length>0){let p=this._getRNG(),h=u[Math.floor(p()*u.length)];try{e.connect(h,l)}catch{}}}if(l.connections.out.length===0){let u=o.concat(a.filter(p=>p!==l));if(u.length>0){let p=this._getRNG(),h=u[Math.floor(p()*u.length)];try{e.connect(l,h)}catch{}}}}(pt(),Z(kt)).default.rebuildConnections(e)}function bi(e){let t=e.nodes.filter(a=>a.type==="input"),n=e.nodes.filter(a=>a.type==="output"),i=e.nodes.filter(a=>a.type==="hidden"),s=a=>a.connections&&a.connections.out&&a.connections.out.length>0,o=a=>a.connections&&a.connections.in&&a.connections.in.length>0;for(let a of t)if(!s(a)){let r=i.length>0?i:n;if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(a,l)}catch{}}}for(let a of n)if(!o(a)){let r=i.length>0?i:t;if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(l,a)}catch{}}}for(let a of i){if(!o(a)){let r=t.concat(i.filter(c=>c!==a));if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(l,a)}catch{}}}if(!s(a)){let r=n.concat(i.filter(c=>c!==a));if(r.length>0){let c=this._getRNG(),l=r[Math.floor(c()*r.length)];try{e.connect(a,l)}catch{}}}}}function Ai(e,t=!0){let n=(mt(),Z(et)),i=this.options.mutation===n.mutation.FFW,s=Array.isArray(this.options.mutation)&&this.options.mutation.length===1&&this.options.mutation[0]===n.mutation.FFW;if((i||s)&&t)return n.mutation.FFW;if(i)return n.mutation.FFW[Math.floor(this._getRNG()()*n.mutation.FFW.length)];if(s)return n.mutation.FFW[Math.floor(this._getRNG()()*n.mutation.FFW.length)];let o=this.options.mutation;if(t&&Array.isArray(o)&&o.length===n.mutation.FFW.length&&o.every((r,c)=>r&&r.name===n.mutation.FFW[c].name))return n.mutation.FFW;if(o.length===1&&Array.isArray(o[0])&&o[0].length&&(o=o[0]),this.options.phasedComplexity?.enabled&&this._phase){if(o=o.filter(r=>!!r),this._phase==="simplify"){let r=o.filter(c=>c&&c.name&&c.name.startsWith&&c.name.startsWith("SUB_"));r.length&&(o=[...o,...r])}else if(this._phase==="complexify"){let r=o.filter(c=>c&&c.name&&c.name.startsWith&&c.name.startsWith("ADD_"));r.length&&(o=[...o,...r])}}if(this.options.operatorAdaptation?.enabled){let r=this.options.operatorAdaptation.boost??2,c=this._operatorStats,l=[];for(let u of o){l.push(u);let p=c.get(u.name);if(p&&p.attempts>5){let h=p.success/p.attempts;if(h>.55)for(let m=0;m<Math.min(r,Math.floor(h*r));m++)l.push(u)}}o=l}let a=o[Math.floor(this._getRNG()()*o.length)];if(a===n.mutation.ADD_GATE&&e.gates.length>=(this.options.maxGates||1/0)||a===n.mutation.ADD_NODE&&e.nodes.length>=(this.options.maxNodes||1/0)||a===n.mutation.ADD_CONN&&e.connections.length>=(this.options.maxConns||1/0))return null;if(this.options.operatorBandit?.enabled){let r=this.options.operatorBandit.c??1.4,c=this.options.operatorBandit.minAttempts??5,l=this._operatorStats;for(let m of o)l.has(m.name)||l.set(m.name,{success:0,attempts:0});let u=Array.from(l.values()).reduce((m,d)=>m+d.attempts,0)+1e-9,p=a,h=-1/0;for(let m of o){let d=l.get(m.name),f=d.attempts>0?d.success/d.attempts:0,b=d.attempts<c?1/0:r*Math.sqrt(Math.log(u)/(d.attempts+1e-9)),g=f+b;g>h&&(h=g,p=m)}a=p}return a===n.mutation.ADD_GATE&&e.gates.length>=(this.options.maxGates||1/0)||!this.options.allowRecurrent&&(a===n.mutation.ADD_BACK_CONN||a===n.mutation.ADD_SELF_CONN)?null:a}var Si=H(()=>{"use strict";Pt()});function vi(e){let t=this._getObjectives(),n=e.map(u=>t.map(p=>{try{return p.accessor(u)}catch{return 0}})),i=(u,p)=>{let h=!1;for(let m=0;m<u.length;m++)if((t[m].direction||"max")==="max"){if(u[m]<p[m])return!1;u[m]>p[m]&&(h=!0)}else{if(u[m]>p[m])return!1;u[m]<p[m]&&(h=!0)}return h},s=[],o=new Array(e.length).fill(0),a=e.map(()=>[]),r=[];for(let u=0;u<e.length;u++){for(let p=0;p<e.length;p++)u!==p&&(i(n[u],n[p])?a[u].push(p):i(n[p],n[u])&&o[u]++);o[u]===0&&r.push(u)}let c=r,l=0;for(;c.length;){let u=[];for(let p of c){e[p]._moRank=l;for(let h of a[p])o[h]--,o[h]===0&&u.push(h)}if(s.push(c.map(p=>e[p])),c=u,l++,l>50)break}for(let u of s)if(u.length!==0){for(let p of u)p._moCrowd=0;for(let p=0;p<t.length;p++){let h=u.slice().sort((b,g)=>{let y=t[p].accessor(b),N=t[p].accessor(g);return y-N});h[0]._moCrowd=1/0,h[h.length-1]._moCrowd=1/0;let m=t[p].accessor(h[0]),f=t[p].accessor(h[h.length-1])-m||1;for(let b=1;b<h.length-1;b++){let g=t[p].accessor(h[b-1]),y=t[p].accessor(h[b+1]);h[b]._moCrowd+=(y-g)/f}}}return this.options.multiObjective?.enabled&&(this._paretoArchive.push({generation:this.generation,fronts:s.slice(0,3).map(u=>u.map(p=>p._id))}),this._paretoArchive.length>100&&this._paretoArchive.shift()),s}var He=H(()=>{"use strict"});var Dt={};ht(Dt,{applyAdaptiveMutation:()=>Ho,applyAncestorUniqAdaptive:()=>$o,applyComplexityBudget:()=>ko,applyMinimalCriterionAdaptive:()=>Fo,applyOperatorAdaptation:()=>Go,applyPhasedComplexity:()=>Do});function ko(){if(!this.options.complexityBudget?.enabled)return;let e=this.options.complexityBudget;if(e.mode==="adaptive"){this._cbHistory||(this._cbHistory=[]),this._cbHistory.push(this.population[0]?.score||0);let t=e.improvementWindow??10;this._cbHistory.length>t&&this._cbHistory.shift();let n=this._cbHistory,i=n.length>1?n[n.length-1]-n[0]:0,s=0;if(n.length>2){let p=n.length,h=0,m=0,d=0,f=0;for(let g=0;g<p;g++)h+=g,m+=n[g],d+=g*n[g],f+=g*g;let b=p*f-h*h||1;s=(p*d-h*m)/b}this._cbMaxNodes===void 0&&(this._cbMaxNodes=e.maxNodesStart??this.input+this.output+2);let o=e.increaseFactor??1.1,a=e.stagnationFactor??.95,r=Math.min(2,Math.max(-2,s/(Math.abs(n[0])+1e-9))),c=o+.05*Math.max(0,r),l=a-.03*Math.max(0,-r),u=this._noveltyArchive.length>5?1:.9;if(i>0||s>0?this._cbMaxNodes=Math.min(e.maxNodesEnd??this._cbMaxNodes*4,Math.floor(this._cbMaxNodes*c*u)):n.length===t&&(this._cbMaxNodes=Math.max(e.minNodes??this.input+this.output+2,Math.floor(this._cbMaxNodes*l))),e.minNodes!==void 0)this._cbMaxNodes=Math.max(e.minNodes,this._cbMaxNodes);else{let p=this.input+this.output+2;this._cbMaxNodes<p&&(this._cbMaxNodes=p)}this.options.maxNodes=this._cbMaxNodes,e.maxConnsStart&&(this._cbMaxConns===void 0&&(this._cbMaxConns=e.maxConnsStart),i>0||s>0?this._cbMaxConns=Math.min(e.maxConnsEnd??this._cbMaxConns*4,Math.floor(this._cbMaxConns*c*u)):n.length===t&&(this._cbMaxConns=Math.max(e.maxConnsStart,Math.floor(this._cbMaxConns*l))),this.options.maxConns=this._cbMaxConns)}else{let t=e.maxNodesStart??this.input+this.output+2,n=e.maxNodesEnd??t*4,i=e.horizon??100,s=Math.min(1,this.generation/i);this.options.maxNodes=Math.floor(t+(n-t)*s)}}function Do(){if(!this.options.phasedComplexity?.enabled)return;let e=this.options.phasedComplexity.phaseLength??10;this._phase||(this._phase=this.options.phasedComplexity.initialPhase??"complexify",this._phaseStartGeneration=this.generation),this.generation-this._phaseStartGeneration>=e&&(this._phase=this._phase==="complexify"?"simplify":"complexify",this._phaseStartGeneration=this.generation)}function Fo(){if(!this.options.minimalCriterionAdaptive?.enabled)return;let e=this.options.minimalCriterionAdaptive;this._mcThreshold===void 0&&(this._mcThreshold=e.initialThreshold??0);let t=this.population.map(a=>a.score||0),n=t.filter(a=>a>=this._mcThreshold).length,i=t.length?n/t.length:0,s=e.targetAcceptance??.5,o=e.adjustRate??.1;i>s*1.05?this._mcThreshold*=1+o:i<s*.95&&(this._mcThreshold*=1-o);for(let a of this.population)(a.score||0)<this._mcThreshold&&(a.score=0)}function $o(){if(!this.options.ancestorUniqAdaptive?.enabled)return;let e=this.options.ancestorUniqAdaptive,t=e.cooldown??5;if(this.generation-this._lastAncestorUniqAdjustGen<t)return;let n=this._telemetry[this._telemetry.length-1]?.lineage,i=n?n.ancestorUniq:void 0;if(typeof i!="number")return;let s=e.lowThreshold??.25,o=e.highThreshold??.55,a=e.adjust??.01;if(e.mode==="epsilon"&&this.options.multiObjective?.adaptiveEpsilon?.enabled)i<s?(this.options.multiObjective.dominanceEpsilon=(this.options.multiObjective.dominanceEpsilon||0)+a,this._lastAncestorUniqAdjustGen=this.generation):i>o&&(this.options.multiObjective.dominanceEpsilon=Math.max(0,(this.options.multiObjective.dominanceEpsilon||0)-a),this._lastAncestorUniqAdjustGen=this.generation);else if(e.mode==="lineagePressure"){this.options.lineagePressure||(this.options.lineagePressure={enabled:!0,mode:"spread",strength:.01});let r=this.options.lineagePressure;i<s?(r.strength=(r.strength||.01)*1.15,r.mode="spread",this._lastAncestorUniqAdjustGen=this.generation):i>o&&(r.strength=(r.strength||.01)*.9,this._lastAncestorUniqAdjustGen=this.generation)}}function Ho(){if(!this.options.adaptiveMutation?.enabled)return;let e=this.options.adaptiveMutation,t=e.adaptEvery??1;if(!(t<=1||this.generation%t===0))return;let n=this.population.filter(h=>typeof h.score=="number");n.sort((h,m)=>(h.score||0)-(m.score||0));let i=Math.floor(n.length/2),s=n.slice(i),o=n.slice(0,i),a=(e.sigma??.05)*1.5,r=e.minRate??.01,c=e.maxRate??1,l=e.strategy||"twoTier",u=!1,p=!1;for(let h=0;h<this.population.length;h++){let m=this.population[h];if(m._mutRate===void 0)continue;let d=m._mutRate,f=this._getRNG()()*2-1;if(f*=a,l==="twoTier")s.length===0||o.length===0?f=h%2===0?Math.abs(f):-Math.abs(f):s.includes(m)?f=-Math.abs(f):o.includes(m)&&(f=Math.abs(f));else if(l==="exploreLow")f=o.includes(m)?Math.abs(f*1.5):-Math.abs(f*.5);else if(l==="anneal"){let b=Math.min(1,this.generation/(50+this.population.length));f*=1-b}if(d+=f,d<r&&(d=r),d>c&&(d=c),d>(this.options.adaptiveMutation.initialRate??.5)&&(u=!0),d<(this.options.adaptiveMutation.initialRate??.5)&&(p=!0),m._mutRate=d,e.adaptAmount){let b=e.amountSigma??.25,g=(this._getRNG()()*2-1)*b;l==="twoTier"&&(s.length===0||o.length===0?g=h%2===0?Math.abs(g):-Math.abs(g):g=o.includes(m)?Math.abs(g):-Math.abs(g));let y=m._mutAmount??(this.options.mutationAmount||1);y+=g,y=Math.round(y);let N=e.minAmount??1,S=e.maxAmount??10;y<N&&(y=N),y>S&&(y=S),m._mutAmount=y}}if(l==="twoTier"&&!(u&&p)){let h=this.options.adaptiveMutation.initialRate??.5,m=Math.floor(this.population.length/2);for(let d=0;d<this.population.length;d++){let f=this.population[d];f._mutRate!==void 0&&(d<m?f._mutRate=Math.min(f._mutRate+a,1):f._mutRate=Math.max(f._mutRate-a,.01))}}}function Go(){if(!this.options.operatorAdaptation?.enabled)return;let e=this.options.operatorAdaptation.decay??.9;for(let[t,n]of this._operatorStats.entries())n.success*=e,n.attempts*=e,this._operatorStats.set(t,n)}var Ft=H(()=>{"use strict";Pt()});var Ge={};ht(Ge,{buildAnc:()=>Ni,computeAncestorUniqueness:()=>Wo});function Ni(e){let t=new Set;if(!Array.isArray(e._parents))return t;let n=[];for(let i of e._parents)n.push({id:i,depth:1,genomeRef:this.population.find(s=>s._id===i)});for(;n.length;){let i=n.shift();if(!(i.depth>4)&&(i.id!=null&&t.add(i.id),i.genomeRef&&Array.isArray(i.genomeRef._parents)))for(let s of i.genomeRef._parents)n.push({id:s,depth:i.depth+1,genomeRef:this.population.find(o=>o._id===s)})}return t}function Wo(){let e=Ni.bind(this),t=0,n=0,i=Math.min(Bo,this.population.length*(this.population.length-1)/2);for(let o=0;o<i&&!(this.population.length<2);o++){let a=Math.floor(this._getRNG()()*this.population.length),r=Math.floor(this._getRNG()()*this.population.length);r===a&&(r=(r+1)%this.population.length);let c=e(this.population[a]),l=e(this.population[r]);if(c.size===0&&l.size===0)continue;let u=0;for(let m of c)l.has(m)&&u++;let p=c.size+l.size-u||1,h=1-u/p;n+=h,t++}return t?+(n/t).toFixed(3):0}var Bo,Be=H(()=>{"use strict";Bo=30});var xi={};ht(xi,{applyTelemetrySelect:()=>_i,buildTelemetryEntry:()=>qo,computeDiversityStats:()=>Uo,recordTelemetryEntry:()=>zo,structuralEntropy:()=>jo});function _i(e){if(!this._telemetrySelect||!this._telemetrySelect.size)return e;let t=this._telemetrySelect,n={gen:e.gen,best:e.best,species:e.species};for(let i of Object.keys(e))i in n||t.has(i)||delete e[i];return Object.assign(e,n)}function jo(e){let t=e;if(t._entropyGen===this.generation&&typeof t._entropyVal=="number")return t._entropyVal;let n={};for(let a of e.nodes)n[a.geneId]=0;for(let a of e.connections)if(a.enabled){let r=a.from.geneId,c=a.to.geneId;n[r]!==void 0&&n[r]++,n[c]!==void 0&&n[c]++}let i={},s=e.nodes.length||1;for(let a in n){let r=n[a];i[r]=(i[r]||0)+1}let o=0;for(let a in i){let r=i[a]/s;r>0&&(o-=r*Math.log(r+1e-9))}return t._entropyGen=this.generation,t._entropyVal=o,o}function Uo(){if(!this.options.diversityMetrics?.enabled)return;if(this.options.fastMode&&!this._fastModeTuned){let g=this.options.diversityMetrics;g&&(g.pairSample==null&&(g.pairSample=20),g.graphletSample==null&&(g.graphletSample=30)),this.options.novelty?.enabled&&this.options.novelty.k==null&&(this.options.novelty.k=5),this._fastModeTuned=!0}let e=this.options.diversityMetrics.pairSample??40,t=this.options.diversityMetrics.graphletSample??60,n=this.population,i=n.length,s=0,o=0,a=0;for(let g=0;g<e&&!(i<2);g++){let y=Math.floor(this._getRNG()()*i),N=Math.floor(this._getRNG()()*i);N===y&&(N=(N+1)%i);let S=this._compatibilityDistance(n[y],n[N]);s+=S,o+=S*S,a++}let r=a?s/a:0,c=a?Math.max(0,o/a-r*r):0,l=n.map(g=>this._structuralEntropy(g)),u=l.reduce((g,y)=>g+y,0)/(l.length||1),p=l.length?l.reduce((g,y)=>g+(y-u)*(y-u),0)/l.length:0,h=[0,0,0,0];for(let g=0;g<t;g++){let y=n[Math.floor(this._getRNG()()*i)];if(!y)break;if(y.nodes.length<3)continue;let N=new Set;for(;N.size<3;)N.add(Math.floor(this._getRNG()()*y.nodes.length));let S=Array.from(N).map(_=>y.nodes[_]),v=0;for(let _ of y.connections)_.enabled&&S.includes(_.from)&&S.includes(_.to)&&v++;v>3&&(v=3),h[v]++}let m=h.reduce((g,y)=>g+y,0)||1,d=0;for(let g=0;g<h.length;g++){let y=h[g]/m;y>0&&(d-=y*Math.log(y))}let f=0,b=0;if(this._lineageEnabled&&i>0){let g=n.map(S=>S._depth??0);f=g.reduce((S,v)=>S+v,0)/i;let y=0,N=0;for(let S=0;S<Math.min(e,i*(i-1)/2)&&!(i<2);S++){let v=Math.floor(this._getRNG()()*i),_=Math.floor(this._getRNG()()*i);_===v&&(_=(_+1)%i),y+=Math.abs(g[v]-g[_]),N++}b=N?y/N:0}this._diversityStats={meanCompat:r,varCompat:c,meanEntropy:u,varEntropy:p,graphletEntropy:d,lineageMeanDepth:f,lineageMeanPairDist:b}}function zo(e){try{_i.call(this,e)}catch{}this._telemetry||(this._telemetry=[]),this._telemetry.push(e);try{this.options.telemetryStream?.enabled&&this.options.telemetryStream.onEntry&&this.options.telemetryStream.onEntry(e)}catch{}this._telemetry.length>500&&this._telemetry.shift()}function qo(e){let t=this.generation,n=0;if(this.options.multiObjective?.enabled){let o=this.options.multiObjective.complexityMetric||"connections",a=this.population.map(h=>h.score||0),r=Math.min(...a),c=Math.max(...a),l=[];for(let h=0;h<5;h++){let m=this.population.filter(d=>(d._moRank??0)===h).length;if(!m)break;l.push(m)}for(let h of this.population){if((h._moRank??0)!==0)continue;let d=c>r?((h.score||0)-r)/(c-r):0,f=o==="nodes"?h.nodes.length:h.connections.length;n+=d*(1/(f+1))}let u=Array.from(this._operatorStats.entries()).map(([h,m])=>({op:h,succ:m.success,att:m.attempts})),p={gen:t,best:e.score,species:this._species.length,hyper:n,fronts:l,diversity:this._diversityStats,ops:u};if(p.objImportance||(p.objImportance={}),this._lastObjImportance&&(p.objImportance=this._lastObjImportance),this._objectiveAges?.size&&(p.objAges=Array.from(this._objectiveAges.entries()).reduce((h,m)=>(h[m[0]]=m[1],h),{})),this._pendingObjectiveAdds?.length||this._pendingObjectiveRemoves?.length){p.objEvents=[];for(let h of this._pendingObjectiveAdds)p.objEvents.push({type:"add",key:h});for(let h of this._pendingObjectiveRemoves)p.objEvents.push({type:"remove",key:h});this._objectiveEvents.push(...p.objEvents.map(h=>({gen:t,type:h.type,key:h.key}))),this._pendingObjectiveAdds=[],this._pendingObjectiveRemoves=[]}this._lastOffspringAlloc&&(p.speciesAlloc=this._lastOffspringAlloc.slice());try{p.objectives=this._getObjectives().map(h=>h.key)}catch{}if(this.options.rngState&&this._rngState!==void 0&&(p.rng=this._rngState),this._lineageEnabled){let h=this.population[0],m=this.population.map(b=>b._depth??0);this._lastMeanDepth=m.reduce((b,g)=>b+g,0)/(m.length||1);let{computeAncestorUniqueness:d}=(Be(),Z(Ge)),f=d.call(this);p.lineage={parents:Array.isArray(h._parents)?h._parents.slice():[],depthBest:h._depth??0,meanDepth:+this._lastMeanDepth.toFixed(2),inbreeding:this._prevInbreedingCount,ancestorUniq:f}}if(this.options.telemetry?.hypervolume&&this.options.multiObjective?.enabled&&(p.hv=+n.toFixed(4)),this.options.telemetry?.complexity){let h=this.population.map(_=>_.nodes.length),m=this.population.map(_=>_.connections.length),d=h.reduce((_,x)=>_+x,0)/(h.length||1),f=m.reduce((_,x)=>_+x,0)/(m.length||1),b=h.length?Math.max(...h):0,g=m.length?Math.max(...m):0,y=this.population.map(_=>{let x=0,w=0;for(let I of _.connections)I.enabled===!1?w++:x++;return x+w?x/(x+w):0}),N=y.reduce((_,x)=>_+x,0)/(y.length||1),S=this._lastMeanNodes!==void 0?d-this._lastMeanNodes:0,v=this._lastMeanConns!==void 0?f-this._lastMeanConns:0;this._lastMeanNodes=d,this._lastMeanConns=f,p.complexity={meanNodes:+d.toFixed(2),meanConns:+f.toFixed(2),maxNodes:b,maxConns:g,meanEnabledRatio:+N.toFixed(3),growthNodes:+S.toFixed(2),growthConns:+v.toFixed(2),budgetMaxNodes:this.options.maxNodes,budgetMaxConns:this.options.maxConns}}return this.options.telemetry?.performance&&(p.perf={evalMs:this._lastEvalDuration,evolveMs:this._lastEvolveDuration}),p}let i=Array.from(this._operatorStats.entries()).map(([o,a])=>({op:o,succ:a.success,att:a.attempts})),s={gen:t,best:e.score,species:this._species.length,hyper:n,diversity:this._diversityStats,ops:i,objImportance:{}};if(this._lastObjImportance&&(s.objImportance=this._lastObjImportance),this._objectiveAges?.size&&(s.objAges=Array.from(this._objectiveAges.entries()).reduce((o,a)=>(o[a[0]]=a[1],o),{})),this._pendingObjectiveAdds?.length||this._pendingObjectiveRemoves?.length){s.objEvents=[];for(let o of this._pendingObjectiveAdds)s.objEvents.push({type:"add",key:o});for(let o of this._pendingObjectiveRemoves)s.objEvents.push({type:"remove",key:o});this._objectiveEvents.push(...s.objEvents.map(o=>({gen:t,type:o.type,key:o.key}))),this._pendingObjectiveAdds=[],this._pendingObjectiveRemoves=[]}this._lastOffspringAlloc&&(s.speciesAlloc=this._lastOffspringAlloc.slice());try{s.objectives=this._getObjectives().map(o=>o.key)}catch{}if(this.options.rngState&&this._rngState!==void 0&&(s.rng=this._rngState),this._lineageEnabled){let o=this.population[0],a=this.population.map(h=>h._depth??0);this._lastMeanDepth=a.reduce((h,m)=>h+m,0)/(a.length||1);let{buildAnc:r}=(Be(),Z(Ge)),c=0,l=0,u=Math.min(30,this.population.length*(this.population.length-1)/2);for(let h=0;h<u&&!(this.population.length<2);h++){let m=Math.floor(this._getRNG()()*this.population.length),d=Math.floor(this._getRNG()()*this.population.length);d===m&&(d=(d+1)%this.population.length);let f=r.call(this,this.population[m]),b=r.call(this,this.population[d]);if(f.size===0&&b.size===0)continue;let g=0;for(let S of f)b.has(S)&&g++;let y=f.size+b.size-g||1,N=1-g/y;l+=N,c++}let p=c?+(l/c).toFixed(3):0;s.lineage={parents:Array.isArray(o._parents)?o._parents.slice():[],depthBest:o._depth??0,meanDepth:+this._lastMeanDepth.toFixed(2),inbreeding:this._prevInbreedingCount,ancestorUniq:p}}if(this.options.telemetry?.hypervolume&&this.options.multiObjective?.enabled&&(s.hv=+n.toFixed(4)),this.options.telemetry?.complexity){let o=this.population.map(f=>f.nodes.length),a=this.population.map(f=>f.connections.length),r=o.reduce((f,b)=>f+b,0)/(o.length||1),c=a.reduce((f,b)=>f+b,0)/(a.length||1),l=o.length?Math.max(...o):0,u=a.length?Math.max(...a):0,p=this.population.map(f=>{let b=0,g=0;for(let y of f.connections)y.enabled===!1?g++:b++;return b+g?b/(b+g):0}),h=p.reduce((f,b)=>f+b,0)/(p.length||1),m=this._lastMeanNodes!==void 0?r-this._lastMeanNodes:0,d=this._lastMeanConns!==void 0?c-this._lastMeanConns:0;this._lastMeanNodes=r,this._lastMeanConns=c,s.complexity={meanNodes:+r.toFixed(2),meanConns:+c.toFixed(2),maxNodes:l,maxConns:u,meanEnabledRatio:+h.toFixed(3),growthNodes:+m.toFixed(2),growthConns:+d.toFixed(2),budgetMaxNodes:this.options.maxNodes,budgetMaxConns:this.options.maxConns}}return this.options.telemetry?.performance&&(s.perf={evalMs:this._lastEvalDuration,evolveMs:this._lastEvolveDuration}),s}var wi=H(()=>{"use strict";Pt()});var Qt={};ht(Qt,{applyAdaptivePruning:()=>Yo,applyEvolutionPruning:()=>Vo});function Vo(){let e=this.options.evolutionPruning;if(!e||this.generation<(e.startGeneration||0))return;let t=e.interval||1;if((this.generation-e.startGeneration)%t!==0)return;let n=e.rampGenerations||0,i=1;n>0&&(i=Math.min(1,Math.max(0,(this.generation-e.startGeneration)/n)));let s=(e.targetSparsity||0)*i;for(let o of this.population)o&&typeof o.pruneToSparsity=="function"&&o.pruneToSparsity(s,e.method||"magnitude")}function Yo(){if(!this.options.adaptivePruning?.enabled)return;let e=this.options.adaptivePruning;this._adaptivePruneLevel===void 0&&(this._adaptivePruneLevel=0);let t=e.metric||"connections",n=this.population.reduce((p,h)=>p+h.nodes.length,0)/(this.population.length||1),i=this.population.reduce((p,h)=>p+h.connections.length,0)/(this.population.length||1),s=t==="nodes"?n:i;this._adaptivePruneBaseline===void 0&&(this._adaptivePruneBaseline=s);let o=this._adaptivePruneBaseline,a=e.targetSparsity??.5,r=o*(1-a),c=e.tolerance??.05,l=e.adjustRate??.02,u=(s-r)/(o||1);if(Math.abs(u)>c){this._adaptivePruneLevel=Math.max(0,Math.min(a,this._adaptivePruneLevel+l*(u>0?1:-1)));for(let p of this.population)typeof p.pruneToSparsity=="function"&&p.pruneToSparsity(this._adaptivePruneLevel,"magnitude")}}var te=H(()=>{"use strict"});async function Mi(){let e=typeof performance<"u"&&performance.now?performance.now():Date.now();this.population[this.population.length-1].score===void 0&&await this.evaluate(),this._objectivesList=void 0;try{(Ft(),Z(Dt)).applyComplexityBudget.call(this)}catch{}try{(Ft(),Z(Dt)).applyPhasedComplexity.call(this)}catch{}this.sort();try{let l=this.population[0]?.score;typeof l=="number"&&(this._bestScoreLastGen===void 0||l>this._bestScoreLastGen)&&(this._bestScoreLastGen=l,this._lastGlobalImproveGeneration=this.generation)}catch{}try{(Ft(),Z(Dt)).applyMinimalCriterionAdaptive.call(this)}catch{}try{this._computeDiversityStats&&this._computeDiversityStats()}catch{}if(this.options.multiObjective?.enabled){let l=this.population,u=vi.call(this,l),p=this._getObjectives(),h=new Array(l.length).fill(0),m=p.map(f=>l.map(b=>f.accessor(b)));for(let f of u){let b=f.map(g=>this.population.indexOf(g));if(b.length<3){b.forEach(g=>h[g]=1/0);continue}for(let g=0;g<p.length;g++){let y=[...b].sort((v,_)=>m[g][v]-m[g][_]);h[y[0]]=1/0,h[y[y.length-1]]=1/0;let N=m[g][y[0]],S=m[g][y[y.length-1]];for(let v=1;v<y.length-1;v++){let _=m[g][y[v-1]],x=m[g][y[v+1]],w=S-N||1;h[y[v]]+=(x-_)/w}}}let d=new Map;for(let f=0;f<l.length;f++)d.set(l[f],f);this.population.sort((f,b)=>{let g=f._moRank??0,y=b._moRank??0;if(g!==y)return g-y;let N=d.get(f),S=d.get(b);return h[S]-h[N]});for(let f=0;f<l.length;f++)l[f]._moCrowd=h[f];if(u.length){let f=u[0],b=f.map(g=>({id:g._id??-1,score:g.score||0,nodes:g.nodes.length,connections:g.connections.length}));if(this._paretoArchive.push({gen:this.generation,size:f.length,genomes:b}),this._paretoArchive.length>200&&this._paretoArchive.shift(),p.length){let g=f.map(y=>({id:y._id??-1,values:p.map(N=>N.accessor(y))}));this._paretoObjectivesArchive.push({gen:this.generation,vectors:g}),this._paretoObjectivesArchive.length>200&&this._paretoObjectivesArchive.shift()}}if(this.options.multiObjective?.adaptiveEpsilon?.enabled&&u.length){let f=this.options.multiObjective.adaptiveEpsilon,b=f.targetFront??Math.max(3,Math.floor(Math.sqrt(this.population.length))),g=f.adjust??.002,y=f.min??0,N=f.max??.5,S=f.cooldown??2;if(this.generation-this._lastEpsilonAdjustGen>=S){let v=u[0].length,_=this.options.multiObjective.dominanceEpsilon||0;v>b*1.2?_=Math.min(N,_+g):v<b*.8&&(_=Math.max(y,_-g)),this.options.multiObjective.dominanceEpsilon=_,this._lastEpsilonAdjustGen=this.generation}}if(this.options.multiObjective?.pruneInactive?.enabled){let f=this.options.multiObjective.pruneInactive,b=f.window??5,g=f.rangeEps??1e-6,y=new Set(["fitness","complexity",...f.protect||[]]),N=this._getObjectives(),S={};for(let _ of N){let x=1/0,w=-1/0;for(let I of this.population){let C=_.accessor(I);C<x&&(x=C),C>w&&(w=C)}S[_.key]={min:x,max:w}}let v=[];for(let _ of N){if(y.has(_.key))continue;let x=S[_.key];if(x.max-x.min<g){let I=(this._objectiveStale.get(_.key)||0)+1;this._objectiveStale.set(_.key,I),I>=b&&v.push(_.key)}else this._objectiveStale.set(_.key,0)}v.length&&this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=this.options.multiObjective.objectives.filter(_=>!v.includes(_.key)),this._objectivesList=void 0)}}try{(Ft(),Z(Dt)).applyAncestorUniqAdaptive.call(this)}catch{}if(this.options.speciation){try{this._speciate()}catch{}try{this._applyFitnessSharing()}catch{}try{let l=this.options;if(l.autoCompatTuning?.enabled){let u=l.autoCompatTuning.target??l.targetSpecies??Math.max(2,Math.round(Math.sqrt(this.population.length))),p=this._species.length||1,h=u-p,m=l.autoCompatTuning.adjustRate??.01,d=l.autoCompatTuning.minCoeff??.1,f=l.autoCompatTuning.maxCoeff??5,b=1-m*Math.sign(h);h===0&&(b=1+(this._getRNG()()-.5)*m*.5),l.excessCoeff=Math.min(f,Math.max(d,l.excessCoeff*b)),l.disjointCoeff=Math.min(f,Math.max(d,l.disjointCoeff*b))}}catch{}this.sort();try{this.options.speciesAllocation?.extendedHistory||(!this._speciesHistory||this._speciesHistory.length===0||this._speciesHistory[this._speciesHistory.length-1].generation!==this.generation)&&(this._speciesHistory.push({generation:this.generation,stats:this._species.map(l=>({id:l.id,size:l.members.length,best:l.bestScore,lastImproved:l.lastImproved}))}),this._speciesHistory.length>200&&this._speciesHistory.shift())}catch{}}let t=rt.fromJSON(this.population[0].toJSON());t.score=this.population[0].score,this._computeDiversityStats();try{let l=this._getObjectives().map(p=>p.key),u=this.options.multiObjective?.dynamic;if(this.options.multiObjective?.enabled)if(u?.enabled){let p=u.addComplexityAt??1/0,h=u.addEntropyAt??1/0;if(this.generation+1>=p&&!l.includes("complexity")&&(this.registerObjective("complexity","min",m=>m.connections.length),this._pendingObjectiveAdds.push("complexity")),this.generation+1>=h&&!l.includes("entropy")&&(this.registerObjective("entropy","max",m=>this._structuralEntropy(m)),this._pendingObjectiveAdds.push("entropy")),l.includes("entropy")&&u.dropEntropyOnStagnation!=null){let m=u.dropEntropyOnStagnation;this.generation>=m&&!this._entropyDropped&&this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=this.options.multiObjective.objectives.filter(d=>d.key!=="entropy"),this._objectivesList=void 0,this._pendingObjectiveRemoves.push("entropy"),this._entropyDropped=this.generation)}else!l.includes("entropy")&&this._entropyDropped&&u.readdEntropyAfter!=null&&this.generation-this._entropyDropped>=u.readdEntropyAfter&&(this.registerObjective("entropy","max",m=>this._structuralEntropy(m)),this._pendingObjectiveAdds.push("entropy"),this._entropyDropped=void 0)}else this.options.multiObjective.autoEntropy&&this.generation>=3&&!l.includes("entropy")&&(this.registerObjective("entropy","max",h=>this._structuralEntropy(h)),this._pendingObjectiveAdds.push("entropy"));for(let p of l)this._objectiveAges.set(p,(this._objectiveAges.get(p)||0)+1);for(let p of this._pendingObjectiveAdds)this._objectiveAges.set(p,0)}catch{}try{let l=this.options.multiObjective;if(l?.enabled&&l.pruneInactive&&l.pruneInactive.enabled===!1){let u=this._getObjectives().map(p=>p.key);u.includes("fitness")&&u.length>1&&!this._fitnessSuppressedOnce&&(this._suppressFitnessObjective=!0,this._fitnessSuppressedOnce=!0,this._objectivesList=void 0)}}catch{}let n=null;try{let l=this._getObjectives();if(l.length){n={};let u=this.population;for(let p of l){let h=u.map(g=>p.accessor(g)),m=Math.min(...h),d=Math.max(...h),f=h.reduce((g,y)=>g+y,0)/h.length,b=h.reduce((g,y)=>g+(y-f)*(y-f),0)/(h.length||1);n[p.key]={range:d-m,var:b}}this._lastObjImportance=n}}catch{}this.options.telemetry?.enabled;{let l=(wi(),Z(xi)),u=l.buildTelemetryEntry.call(this,t);l.recordTelemetryEntry.call(this,u)}(t.score??-1/0)>this._bestGlobalScore&&(this._bestGlobalScore=t.score??-1/0,this._lastGlobalImproveGeneration=this.generation);let i=[],s=Math.max(0,Math.min(this.options.elitism||0,this.population.length));for(let l=0;l<s;l++){let u=this.population[l];u&&i.push(u)}let o=Math.max(0,this.options.popsize||0),a=Math.max(0,o-i.length),r=Math.max(0,Math.min(this.options.provenance||0,a));for(let l=0;l<r;l++)this.options.network?i.push(rt.fromJSON(this.options.network.toJSON())):i.push(new rt(this.input,this.output,{minHidden:this.options.minHidden}));if(this.options.speciation&&this._species.length>0){this._suppressTournamentError=!0;let l=o-i.length;if(l>0){let u=this.options.speciesAgeBonus||{},p=u.youngThreshold??5,h=u.youngMultiplier??1.3,m=u.oldThreshold??30,d=u.oldMultiplier??.7,f=this._species.map(x=>{let w=x.members.reduce((C,F)=>C+(F.score||0),0),I=this.generation-x.lastImproved;return I<=p?w*h:I>=m?w*d:w}),b=f.reduce((x,w)=>x+w,0)||1,g=this.options.speciesAllocation?.minOffspring??1,y=this._species.map((x,w)=>f[w]/b*l),N=y.map(x=>Math.floor(x));for(let x=0;x<N.length;x++)N[x]<g&&l>=this._species.length*g&&(N[x]=g);let S=N.reduce((x,w)=>x+w,0),v=l-S,_=y.map((x,w)=>({i:w,frac:x-Math.floor(x)}));_.sort((x,w)=>w.frac-x.frac);for(let x of _){if(v<=0)break;N[x.i]++,v--}if(v<0){let x=N.map((w,I)=>({i:I,v:w})).sort((w,I)=>I.v-w.v);for(let w of x){if(v===0)break;N[w.i]>g&&(N[w.i]--,v++)}}this._lastOffspringAlloc=this._species.map((x,w)=>({id:x.id,alloc:N[w]||0})),this._prevInbreedingCount=this._lastInbreedingCount,this._lastInbreedingCount=0,N.forEach((x,w)=>{if(x<=0)return;let I=this._species[w];this._sortSpeciesMembers(I);let C=I.members.slice(0,Math.max(1,Math.floor(I.members.length*(this.options.survivalThreshold||.5))));for(let F=0;F<x;F++){let P=C[Math.floor(this._getRNG()()*C.length)],$;if(this.options.crossSpeciesMatingProb&&this._species.length>1&&this._getRNG()()<(this.options.crossSpeciesMatingProb||0)){let T=w,k=0;for(;T===w&&k++<5;)T=Math.floor(this._getRNG()()*this._species.length);let D=this._species[T];this._sortSpeciesMembers(D);let O=D.members.slice(0,Math.max(1,Math.floor(D.members.length*(this.options.survivalThreshold||.5))));$=O[Math.floor(this._getRNG()()*O.length)]}else $=C[Math.floor(this._getRNG()()*C.length)];let E=rt.crossOver(P,$,this.options.equal||!1);if(E._reenableProb=this.options.reenableProb,E._id=this._nextGenomeId++,this._lineageEnabled){E._parents=[P._id,$._id];let T=P._depth??0,k=$._depth??0;E._depth=1+Math.max(T,k),P._id===$._id&&this._lastInbreedingCount++}i.push(E)}}),this._suppressTournamentError=!1}}else{this._suppressTournamentError=!0;let l=Math.max(0,o-i.length);for(let u=0;u<l;u++)i.push(this.getOffspring());this._suppressTournamentError=!1}for(let l of i)l&&(this.ensureMinHiddenNodes(l),this.ensureNoDeadEnds(l));this.population=i;try{(te(),Z(Qt)).applyEvolutionPruning.call(this)}catch{}try{(te(),Z(Qt)).applyAdaptivePruning.call(this)}catch{}this.mutate();try{(Ft(),Z(Dt)).applyAdaptiveMutation.call(this)}catch{}if(this.population.forEach(l=>{l._compatCache&&delete l._compatCache}),this.population.forEach(l=>l.score=void 0),this.generation++,this.options.speciation&&this._updateSpeciesStagnation(),(this.options.globalStagnationGenerations||0)>0&&this.generation-this._lastGlobalImproveGeneration>(this.options.globalStagnationGenerations||0)){let u=Math.max(this.options.elitism||0,Math.floor(this.population.length*.8));for(let p=u;p<this.population.length;p++){let h=new rt(this.input,this.output,{minHidden:this.options.minHidden});h.score=void 0,h._reenableProb=this.options.reenableProb,h._id=this._nextGenomeId++,this._lineageEnabled&&(h._parents=[],h._depth=0);try{if(this.ensureMinHiddenNodes(h),this.ensureNoDeadEnds(h),h.nodes.filter(d=>d.type==="hidden").length===0){let d=(lt(),Z(ie)).default,f=new d("hidden");h.nodes.splice(h.nodes.length-h.output,0,f);let b=h.nodes.filter(y=>y.type==="input"),g=h.nodes.filter(y=>y.type==="output");if(b.length&&g.length){try{h.connect(b[0],f,1)}catch{}try{h.connect(f,g[0],1)}catch{}}}}catch{}this.population[p]=h}this._lastGlobalImproveGeneration=this.generation}if(this.options.reenableProb!==void 0){let l=0,u=0;for(let p of this.population)l+=p._reenableSuccess||0,u+=p._reenableAttempts||0,p._reenableSuccess=0,p._reenableAttempts=0;if(u>20){let m=l/u-.3;this.options.reenableProb=Math.min(.9,Math.max(.05,this.options.reenableProb-m*.1))}}try{(Ft(),Z(Dt)).applyOperatorAdaptation.call(this)}catch{}let c=typeof performance<"u"&&performance.now?performance.now():Date.now();this._lastEvolveDuration=c-e;try{this._speciesHistory||(this._speciesHistory=[]),this.options.speciesAllocation?.extendedHistory||(this._speciesHistory.length===0||this._speciesHistory[this._speciesHistory.length-1].generation!==this.generation)&&(this._speciesHistory.push({generation:this.generation,stats:this._species.map(l=>({id:l.id,size:l.members.length,best:l.bestScore,lastImproved:l.lastImproved}))}),this._speciesHistory.length>200&&this._speciesHistory.shift())}catch{}return t}var Ei=H(()=>{"use strict";pt();He()});async function Ii(){let e=this.options||{};if(e.fitnessPopulation)e.clear&&this.population.forEach(t=>t.clear&&t.clear()),await this.fitness(this.population);else for(let t of this.population){e.clear&&t.clear&&t.clear();let n=await this.fitness(t);t.score=n}try{let t=e.novelty;if(t?.enabled&&typeof t.descriptor=="function"){let n=Math.max(1,t.k||3),i=t.blendFactor??.3,s=this.population.map(a=>{try{return t.descriptor(a)||[]}catch{return[]}}),o=[];for(let a=0;a<s.length;a++){o[a]=[];for(let r=0;r<s.length;r++){if(a===r){o[a][r]=0;continue}let c=s[a],l=s[r],u=0,p=Math.min(c.length,l.length);for(let h=0;h<p;h++){let m=(c[h]||0)-(l[h]||0);u+=m*m}o[a][r]=Math.sqrt(u)}}for(let a=0;a<this.population.length;a++){let c=o[a].toSorted((p,h)=>p-h).slice(1,n+1),l=c.length?c.reduce((p,h)=>p+h,0)/c.length:0;this.population[a]._novelty=l,typeof this.population[a].score=="number"&&(this.population[a].score=(1-i)*this.population[a].score+i*l),this._noveltyArchive||(this._noveltyArchive=[]);let u=t.archiveAddThreshold??1/0;(t.archiveAddThreshold===0||l>u)&&this._noveltyArchive.length<200&&this._noveltyArchive.push({desc:s[a],novelty:l})}}}catch{}this._diversityStats||(this._diversityStats={});try{let t=e.entropySharingTuning;if(t?.enabled){let n=t.targetEntropyVar??.2,i=t.adjustRate??.1,s=t.minSigma??.1,o=t.maxSigma??10,a=this._diversityStats.varEntropy;if(typeof a=="number"){let r=this.options.sharingSigma??0;a<n*.9?r=Math.max(s,r*(1-i)):a>n*1.1&&(r=Math.min(o,r*(1+i))),this.options.sharingSigma=r}}}catch{}try{let t=e.entropyCompatTuning;if(t?.enabled){let n=this._diversityStats.meanEntropy,i=t.targetEntropy??.5,s=t.deadband??.05,o=t.adjustRate??.05,a=this.options.compatibilityThreshold??3;typeof n=="number"&&(n<i-s?a=Math.max(t.minThreshold??.5,a*(1-o)):n>i+s&&(a=Math.min(t.maxThreshold??10,a*(1+o))),this.options.compatibilityThreshold=a)}}catch{}try{this.options.speciation&&(this.options.targetSpecies||this.options.compatAdjust||this.options.speciesAllocation?.extendedHistory)&&this._speciate()}catch{}try{let t=this.options.autoDistanceCoeffTuning;if(t?.enabled&&this.options.speciation){let n=this.population.map(c=>c.connections.length),i=n.reduce((c,l)=>c+l,0)/(n.length||1),s=n.reduce((c,l)=>c+(l-i)*(l-i),0)/(n.length||1),o=t.adjustRate??.05,a=t.minCoeff??.05,r=t.maxCoeff??8;if(this._lastConnVar===void 0||this._lastConnVar===null){this._lastConnVar=s;try{this.options.excessCoeff=Math.min(r,(this.options.excessCoeff??1)*(1+o)),this.options.disjointCoeff=Math.min(r,(this.options.disjointCoeff??1)*(1+o))}catch{}}s<this._lastConnVar*.95?(this.options.excessCoeff=Math.min(r,this.options.excessCoeff*(1+o)),this.options.disjointCoeff=Math.min(r,this.options.disjointCoeff*(1+o))):s>this._lastConnVar*1.05&&(this.options.excessCoeff=Math.max(a,this.options.excessCoeff*(1-o)),this.options.disjointCoeff=Math.max(a,this.options.disjointCoeff*(1-o))),this._lastConnVar=s}}catch{}try{this.options.multiObjective?.enabled&&this.options.multiObjective.autoEntropy&&(this.options.multiObjective.dynamic?.enabled||this._getObjectives().map(n=>n.key).includes("entropy")||(this.registerObjective("entropy","max",n=>this._structuralEntropy(n)),this._pendingObjectiveAdds.push("entropy"),this._objectivesList=void 0))}catch{}}var Ci=H(()=>{"use strict"});function Ti(e,t=1){let n=e.clone?e.clone():(pt(),Z(kt)).default.fromJSON(e.toJSON());n.score=void 0,n._reenableProb=this.options.reenableProb,n._id=this._nextGenomeId++,n._parents=[e._id],n._depth=(e._depth??0)+1,this.ensureMinHiddenNodes(n),this.ensureNoDeadEnds(n);for(let i=0;i<t;i++)try{let s=this.selectMutationMethod(n,!1);if(Array.isArray(s)){let o=s;s=o[Math.floor(this._getRNG()()*o.length)]}s&&s.name&&n.mutate(s)}catch{}return this._invalidateGenomeCaches(n),n}function Oi(e,t){try{if(e.score=void 0,e._reenableProb=this.options.reenableProb,e._id=this._nextGenomeId++,e._parents=Array.isArray(t)?t.slice():[],e._depth=0,e._parents.length){let n=e._parents.map(i=>this.population.find(s=>s._id===i)).filter(Boolean).map(i=>i._depth??0);e._depth=n.length?Math.max(...n)+1:1}this.ensureMinHiddenNodes(e),this.ensureNoDeadEnds(e),this._invalidateGenomeCaches(e),this.population.push(e)}catch{this.population.push(e)}}function he(e){try{this.population=[];let t=this.options?.popsize||50;for(let n=0;n<t;n++){let i=e?rt.fromJSON(e.toJSON()):new rt(this.input,this.output,{minHidden:this.options?.minHidden});i.score=void 0;try{this.ensureNoDeadEnds(i)}catch{}i._reenableProb=this.options.reenableProb,i._id=this._nextGenomeId++,this._lineageEnabled&&(i._parents=[],i._depth=0),this.population.push(i)}}catch{}}var Ri=H(()=>{"use strict";pt()});function Li(){if(this._objectivesList)return this._objectivesList;let e=[];if(this._suppressFitnessObjective||e.push({key:"fitness",direction:"max",accessor:t=>t.score||0}),this.options.multiObjective?.enabled&&Array.isArray(this.options.multiObjective.objectives))for(let t of this.options.multiObjective.objectives)!t||!t.key||typeof t.accessor!="function"||e.push(t);return this._objectivesList=e,e}function Pi(e,t,n){this.options.multiObjective||(this.options.multiObjective={enabled:!0});let i=this.options.multiObjective;i.objectives||(i.objectives=[]),i.objectives=i.objectives.filter(s=>s.key!==e),i.objectives.push({key:e,direction:t,accessor:n}),this._objectivesList=void 0}function ki(){this.options.multiObjective?.objectives&&(this.options.multiObjective.objectives=[]),this._objectivesList=void 0}var Di=H(()=>{"use strict"});function We(e){let t=e.nodes.map(o=>o.connections.out.length),n=t.reduce((o,a)=>o+a,0)||1,i=t.map(o=>o/n).filter(o=>o>0),s=0;for(let o of i)s-=o*Math.log(o);return s}function jt(e){return e.length?e.reduce((t,n)=>t+n,0)/e.length:0}function Fi(e){if(!e.length)return 0;let t=jt(e);return jt(e.map(n=>(n-t)*(n-t)))}function $i(e,t){if(!e.length)return;let n=[];for(let g of e)typeof g._depth=="number"&&n.push(g._depth);let i=jt(n),s=0,o=0;for(let g=0;g<n.length&&g<30;g++)for(let y=g+1;y<n.length&&y<30;y++)s+=Math.abs(n[g]-n[y]),o++;let a=o?s/o:0,r=e.map(g=>g.nodes.length),c=e.map(g=>g.connections.length),l=jt(r),u=jt(c),p=Fi(r),h=Fi(c),m=0,d=0;for(let g=0;g<e.length&&g<25;g++)for(let y=g+1;y<e.length&&y<25;y++)m+=t._compatibilityDistance(e[g],e[y]),d++;let f=d?m/d:0,b=jt(e.map(g=>We(g)));return{lineageMeanDepth:i,lineageMeanPairDist:a,meanNodes:l,meanConns:u,nodeVar:p,connVar:h,meanCompat:f,graphletEntropy:b,population:e.length}}var Hi=H(()=>{"use strict";pt()});function Gi(e){let t=e.from?.index??0,n=e.to?.index??0;return t*1e5+n}function Bi(e,t){(!this._compatCacheGen||this._compatCacheGen!==this.generation)&&(this._compatCacheGen=this.generation,this._compatDistCache=new Map);let n=e._id<t._id?`${e._id}|${t._id}`:`${t._id}|${e._id}`,i=this._compatDistCache;if(i.has(n))return i.get(n);let s=N=>{if(!N._compatCache){let S=N.connections.map(v=>[v.innovation??this._fallbackInnov(v),v.weight]);S.sort((v,_)=>v[0]-_[0]),N._compatCache=S}return N._compatCache},o=s(e),a=s(t),r=0,c=0,l=0,u=0,p=0,h=0,m=o.length?o[o.length-1][0]:0,d=a.length?a[a.length-1][0]:0;for(;r<o.length&&c<a.length;){let[N,S]=o[r],[v,_]=a[c];N===v?(l++,h+=Math.abs(S-_),r++,c++):N<v?(N>d?p++:u++,r++):(v>m?p++:u++,c++)}r<o.length&&(p+=o.length-r),c<a.length&&(p+=a.length-c);let f=Math.max(1,Math.max(o.length,a.length)),b=l?h/l:0,g=this.options,y=g.excessCoeff*p/f+g.disjointCoeff*u/f+g.weightDiffCoeff*b;return i.set(n,y),y}var Wi=H(()=>{"use strict"});function ji(){this._prevSpeciesMembers.clear();for(let t of this._species){let n=new Set;for(let i of t.members)n.add(i._id);this._prevSpeciesMembers.set(t.id,n)}this._species.forEach(t=>t.members=[]);for(let t of this.population){let n=!1;for(let i of this._species)if(this._compatibilityDistance(t,i.representative)<(this.options.compatibilityThreshold||3)){i.members.push(t),n=!0;break}if(!n){let i=this._nextSpeciesId++;this._species.push({id:i,members:[t],representative:t,lastImproved:this.generation,bestScore:t.score||-1/0}),this._speciesCreated.set(i,this.generation)}}this._species=this._species.filter(t=>t.members.length>0),this._species.forEach(t=>{t.representative=t.members[0]});let e=this.options.speciesAgeProtection||{grace:3,oldPenalty:.5};for(let t of this._species){let n=this._speciesCreated.get(t.id)??this.generation;if(this.generation-n>=(e.grace??3)*10){let s=e.oldPenalty??.5;s<1&&t.members.forEach(o=>{typeof o.score=="number"&&(o.score*=s)})}}if(this.options.speciation&&(this.options.targetSpecies||0)>0){let t=this.options.targetSpecies,n=this._species.length,i=this.options.compatAdjust,o=2/(Math.max(1,i.smoothingWindow||1)+1);this._compatSpeciesEMA=this._compatSpeciesEMA===void 0?n:this._compatSpeciesEMA+o*(n-this._compatSpeciesEMA);let a=this._compatSpeciesEMA,r=t-a;this._compatIntegral=this._compatIntegral*(i.decay||.95)+r;let c=(i.kp||0)*r+(i.ki||0)*this._compatIntegral,l=(this.options.compatibilityThreshold||3)-c,u=i.minThreshold||.5,p=i.maxThreshold||10;l<u&&(l=u,this._compatIntegral=0),l>p&&(l=p,this._compatIntegral=0),this.options.compatibilityThreshold=l}if(this.options.autoCompatTuning?.enabled){let t=this.options.autoCompatTuning.target??this.options.targetSpecies??Math.max(2,Math.round(Math.sqrt(this.population.length))),n=this._species.length||1,i=t-n,s=this.options.autoCompatTuning.adjustRate??.01,o=this.options.autoCompatTuning.minCoeff??.1,a=this.options.autoCompatTuning.maxCoeff??5,c=1-s*Math.sign(i);i===0&&(c=1+(this._getRNG()()-.5)*s*.5),this.options.excessCoeff=Math.min(a,Math.max(o,this.options.excessCoeff*c)),this.options.disjointCoeff=Math.min(a,Math.max(o,this.options.disjointCoeff*c))}if(this.options.speciesAllocation?.extendedHistory){let t=this._species.map(n=>{let i=n.members.map(E=>({nodes:E.nodes.length,conns:E.connections.length,score:E.score||0,nov:E._novelty||0,ent:this._structuralEntropy(E)})),s=E=>E.length?E.reduce((T,k)=>T+k,0)/E.length:0,o=0,a=0;for(let E=0;E<n.members.length&&E<10;E++)for(let T=E+1;T<n.members.length&&T<10;T++)o+=this._compatibilityDistance(n.members[E],n.members[T]),a++;let r=a?o/a:0,c=this._speciesLastStats.get(n.id),l=s(i.map(E=>E.nodes)),u=s(i.map(E=>E.conns)),p=c?l-c.meanNodes:0,h=c?u-c.meanConns:0,m=c?n.bestScore-c.best:0,d=this._speciesCreated.get(n.id)??this.generation,f=this.generation-d,b=0,g=this._prevSpeciesMembers.get(n.id);if(g&&n.members.length){let E=0;for(let T of n.members)g.has(T._id)||E++;b=E/n.members.length}let y=E=>{if(!E.length)return 0;let T=s(E);return s(E.map(k=>(k-T)*(k-T)))},N=y(i.map(E=>E.nodes)),S=y(i.map(E=>E.conns)),v=0,_=0,x=-1/0,w=1/0,I=0,C=0;for(let E of n.members)for(let T of E.connections){let k=T.innovation??this._fallbackInnov(T);v+=k,_++,k>x&&(x=k),k<w&&(w=k),T.enabled===!1?C++:I++}let F=_?v/_:0,P=isFinite(x)&&isFinite(w)&&x>w?x-w:0,$=I+C>0?I/(I+C):0;return{id:n.id,size:n.members.length,best:n.bestScore,lastImproved:n.lastImproved,age:f,meanNodes:l,meanConns:u,meanScore:s(i.map(E=>E.score)),meanNovelty:s(i.map(E=>E.nov)),meanCompat:r,meanEntropy:s(i.map(E=>E.ent)),varNodes:N,varConns:S,deltaMeanNodes:p,deltaMeanConns:h,deltaBestScore:m,turnoverRate:b,meanInnovation:F,innovationRange:P,enabledRatio:$}});for(let n of t)this._speciesLastStats.set(n.id,{meanNodes:n.meanNodes,meanConns:n.meanConns,best:n.best});this._speciesHistory.push({generation:this.generation,stats:t})}else this._speciesHistory.push({generation:this.generation,stats:this._species.map(t=>({id:t.id,size:t.members.length,best:t.bestScore,lastImproved:t.lastImproved}))});this._speciesHistory.length>200&&this._speciesHistory.shift()}function Ui(){let e=this.options.sharingSigma||0;e>0?this._species.forEach(t=>{let n=t.members;for(let i=0;i<n.length;i++){let s=n[i];if(typeof s.score!="number")continue;let o=0;for(let a=0;a<n.length;a++){let r=n[a],c=i===a?0:this._compatibilityDistance(s,r);if(c<e){let l=c/e;o+=1-l*l}}o<=0&&(o=1),s.score=s.score/o}}):this._species.forEach(t=>{let n=t.members.length;t.members.forEach(i=>{typeof i.score=="number"&&(i.score=i.score/n)})})}function zi(e){e.members.sort((t,n)=>(n.score||0)-(t.score||0))}function qi(){let e=this.options.stagnationGenerations||15;this._species.forEach(n=>{this._sortSpeciesMembers(n);let i=n.members[0];(i.score||-1/0)>n.bestScore&&(n.bestScore=i.score||-1/0,n.lastImproved=this.generation)});let t=this._species.filter(n=>this.generation-n.lastImproved<=e);t.length&&(this._species=t)}var Vi=H(()=>{"use strict"});function Yi(){return this._species.map(t=>({id:t.id,size:t.members.length,bestScore:t.bestScore,lastImproved:t.lastImproved}))}function Ji(){let e=this._speciesHistory;if(this.options?.speciesAllocation?.extendedHistory)for(let t of e)for(let n of t.stats){if("innovationRange"in n&&"enabledRatio"in n)continue;let i=this._species.find(s=>s.id===n.id);if(i&&i.members&&i.members.length){let s=-1/0,o=1/0,a=0,r=0;for(let c of i.members)for(let l of c.connections){let u=l.innovation??this._fallbackInnov?.(l)??0;u>s&&(s=u),u<o&&(o=u),l.enabled===!1?r++:a++}n.innovationRange=isFinite(s)&&isFinite(o)&&s>o?s-o:0,n.enabledRatio=a+r?a/(a+r):0}}return e}var Xi=H(()=>{"use strict"});function Ki(){return this._telemetry.map(e=>JSON.stringify(e)).join(`
`)}function Zi(e=500){let t=Array.isArray(this._telemetry)?this._telemetry.slice(-e):[];if(!t.length)return"";let n=Jo(t),i=Xo(n),s=[i.join(",")];for(let o of t)s.push(Ko(o,i));return s.join(`
`)}function Jo(e){let t=new Set,n=new Set,i=new Set,s=new Set,o=new Set,a=!1,r=!1,c=!1,l=!1,u=!1,p=!1;for(let h of e)Object.keys(h).forEach(m=>{m!=="complexity"&&m!=="perf"&&m!=="ops"&&m!==Ve&&t.add(m)}),Array.isArray(h.fronts)&&t.add(Ve),h.complexity&&Object.keys(h.complexity).forEach(m=>n.add(m)),h.perf&&Object.keys(h.perf).forEach(m=>i.add(m)),h.lineage&&Object.keys(h.lineage).forEach(m=>s.add(m)),h.diversity&&("lineageMeanDepth"in h.diversity&&o.add("lineageMeanDepth"),"lineageMeanPairDist"in h.diversity&&o.add("lineageMeanPairDist")),"rng"in h&&t.add("rng"),Array.isArray(h.ops)&&h.ops.length&&(a=!0),Array.isArray(h.objectives)&&(r=!0),h.objAges&&(c=!0),Array.isArray(h.speciesAlloc)&&(l=!0),Array.isArray(h.objEvents)&&h.objEvents.length&&(u=!0),h.objImportance&&(p=!0);return{baseKeys:t,complexityKeys:n,perfKeys:i,lineageKeys:s,diversityLineageKeys:o,includeOps:a,includeObjectives:r,includeObjAges:c,includeSpeciesAlloc:l,includeObjEvents:u,includeObjImportance:p}}function Xo(e){let t=[...e.baseKeys,...[...e.complexityKeys].map(n=>`${je}${n}`),...[...e.perfKeys].map(n=>`${Ue}${n}`),...[...e.lineageKeys].map(n=>`${ze}${n}`),...[...e.diversityLineageKeys].map(n=>`${qe}${n}`)];return e.includeOps&&t.push(Qi),e.includeObjectives&&t.push(ts),e.includeObjAges&&t.push(es),e.includeSpeciesAlloc&&t.push(ns),e.includeObjEvents&&t.push(is),e.includeObjImportance&&t.push(ss),t}function Ko(e,t){let n=[];for(let i of t)switch(!0){case i.startsWith(je):{let s=i.slice(je.length);n.push(e.complexity&&s in e.complexity?JSON.stringify(e.complexity[s]):"");break}case i.startsWith(Ue):{let s=i.slice(Ue.length);n.push(e.perf&&s in e.perf?JSON.stringify(e.perf[s]):"");break}case i.startsWith(ze):{let s=i.slice(ze.length);n.push(e.lineage&&s in e.lineage?JSON.stringify(e.lineage[s]):"");break}case i.startsWith(qe):{let s=i.slice(qe.length);n.push(e.diversity&&s in e.diversity?JSON.stringify(e.diversity[s]):"");break}case i===Ve:{n.push(Array.isArray(e.fronts)?JSON.stringify(e.fronts):"");break}case i===Qi:{n.push(Array.isArray(e.ops)?JSON.stringify(e.ops):"");break}case i===ts:{n.push(Array.isArray(e.objectives)?JSON.stringify(e.objectives):"");break}case i===es:{n.push(e.objAges?JSON.stringify(e.objAges):"");break}case i===ns:{n.push(Array.isArray(e.speciesAlloc)?JSON.stringify(e.speciesAlloc):"");break}case i===is:{n.push(Array.isArray(e.objEvents)?JSON.stringify(e.objEvents):"");break}case i===ss:{n.push(e.objImportance?JSON.stringify(e.objImportance):"");break}default:{n.push(JSON.stringify(e[i]));break}}return n.join(",")}function os(e=200){if(Array.isArray(this._speciesHistory)||(this._speciesHistory=[]),!this._speciesHistory.length&&Array.isArray(this._species)&&this._species.length){let s=this._species.map(o=>({id:o.id??-1,size:Array.isArray(o.members)?o.members.length:0,best:o.bestScore??0,lastImproved:o.lastImproved??0}));this._speciesHistory.push({generation:this.generation||0,stats:s})}let t=this._speciesHistory.slice(-e);if(!t.length)return"generation,id,size,best,lastImproved";let n=new Set(["generation"]);for(let s of t)for(let o of s.stats)Object.keys(o).forEach(a=>n.add(a));let i=Array.from(n);return Qo(t,i)}function Qo(e,t){let n=[t.join(",")];for(let i of e)for(let s of i.stats){let o=[];for(let a of t){if(a===Zo){o.push(JSON.stringify(i.generation));continue}o.push(JSON.stringify(s[a]))}n.push(o.join(","))}return n.join(`
`)}var je,Ue,ze,qe,Ve,Qi,ts,es,ns,is,ss,Zo,as=H(()=>{"use strict";je="complexity.",Ue="perf.",ze="lineage.",qe="diversity.",Ve="fronts",Qi="ops",ts="objectives",es="objAges",ns="speciesAlloc",is="objEvents",ss="objImportance";Zo="generation"});function rs(){this.population.sort((e,t)=>(t.score??0)-(e.score??0))}function cs(){let e=this.options.selection,t=e?.name,n=this._getRNG.bind(this),i=this.population;switch(t){case"POWER":i[0]?.score!==void 0&&i[1]?.score!==void 0&&i[0].score<i[1].score&&this.sort();let s=Math.floor(Math.pow(n()(),e.power||1)*i.length);return i[s];case"FITNESS_PROPORTIONATE":let o=0,a=0;i.forEach(h=>{a=Math.min(a,h.score??0),o+=h.score??0});let r=Math.abs(a);o+=r*i.length;let c=n()()*o,l=0;for(let h of i)if(l+=(h.score??0)+r,c<l)return h;return i[Math.floor(n()()*i.length)];case"TOURNAMENT":if((e.size||2)>i.length){if(!this._suppressTournamentError)throw new Error("Tournament size must be less than population size.");return i[Math.floor(n()()*i.length)]}let u=e.size||2,p=[];for(let h=0;h<u;h++)p.push(i[Math.floor(n()()*i.length)]);p.sort((h,m)=>(m.score??0)-(h.score??0));for(let h=0;h<p.length;h++)if(n()()<(e.probability??.5)||h===p.length-1)return p[h];break;default:return i[0]}return i[0]}function ls(){let e=this.population;return e[e.length-1].score===void 0&&this.evaluate(),e[1]&&(e[0].score??0)<(e[1].score??0)&&this.sort(),e[0]}function us(){let e=this.population;return e[e.length-1].score===void 0&&this.evaluate(),e.reduce((n,i)=>n+(i.score??0),0)/e.length}var hs=H(()=>{"use strict"});var ps={};ht(ps,{exportPopulation:()=>Ye,exportState:()=>Xe,fromJSONImpl:()=>Qe,importPopulation:()=>Je,importStateImpl:()=>Ke,toJSONImpl:()=>Ze});function Ye(){return this.population.map(e=>e.toJSON())}function Je(e){let t=(pt(),Z(kt)).default;this.population=e.map(n=>t.fromJSON(n)),this.options.popsize=this.population.length}function Xe(){let{toJSONImpl:e,exportPopulation:t}=(tn(),Z(ps));return{neat:e.call(this),population:t.call(this)}}function Ke(e,t){if(!e||typeof e!="object")throw new Error("Invalid state bundle");let n=this.fromJSON(e.neat,t);return Array.isArray(e.population)&&n.import(e.population),n}function Ze(){return{input:this.input,output:this.output,generation:this.generation,options:this.options,nodeSplitInnovations:Array.from(this._nodeSplitInnovations.entries()),connInnovations:Array.from(this._connInnovations.entries()),nextGlobalInnovation:this._nextGlobalInnovation}}function Qe(e,t){let n=this,i=new n(e.input,e.output,t,e.options||{});return i.generation=e.generation||0,Array.isArray(e.nodeSplitInnovations)&&(i._nodeSplitInnovations=new Map(e.nodeSplitInnovations)),Array.isArray(e.connInnovations)&&(i._connInnovations=new Map(e.connInnovations)),typeof e.nextGlobalInnovation=="number"&&(i._nextGlobalInnovation=e.nextGlobalInnovation),i}var tn=H(()=>{"use strict"});var di={};ht(di,{default:()=>$t});var $t,$e=H(()=>{"use strict";pt();mt();Ne();lt();Si();Ei();Ci();Ri();Di();Hi();He();Wi();Vi();Xi();as();hs();tn();$t=class e{input;output;fitness;options;population=[];generation=0;_rngState;_rng;_species=[];_operatorStats=new Map;_nodeSplitInnovations=new Map;_connInnovations=new Map;_nextGlobalInnovation=1;_nextGenomeId=1;_lineageEnabled=!1;_lastInbreedingCount=0;_prevInbreedingCount=0;_phase;_telemetry=[];_prevSpeciesMembers=new Map;_speciesLastStats=new Map;_speciesHistory=[];_paretoArchive=[];_paretoObjectivesArchive=[];_noveltyArchive=[];_objectiveStale=new Map;_objectiveAges=new Map;_objectiveEvents=[];_pendingObjectiveAdds=[];_pendingObjectiveRemoves=[];_lastOffspringAlloc;_adaptivePruneLevel;_lastEvalDuration;_lastEvolveDuration;_diversityStats;_objectivesList;_lastGlobalImproveGeneration=0;_bestScoreLastGen;_speciesCreated=new Map;_compatSpeciesEMA;_compatIntegral=0;_lastEpsilonAdjustGen=-1/0;_lastAncestorUniqAdjustGen=-1/0;_mcThreshold;_getRNG(){if(!this._rng){let t=this.options?.rng;if(typeof t=="function")this._rng=t;else{if(this._rngState===void 0){let n=(Date.now()^(this.population.length+1)*2654435761)>>>0;n===0&&(n=439041101),this._rngState=n>>>0}this._rng=()=>{let n=this._rngState>>>0;return n^=n<<13,n>>>=0,n^=n>>17,n>>>=0,n^=n<<5,n>>>=0,this._rngState=n>>>0,(n>>>0)/4294967295}}}return this._rng}ensureMinHiddenNodes(t,n){return gi.call(this,t,n)}constructor(t,n,i,s={}){this.input=t??0,this.output=n??0,this.fitness=i??(a=>0),this.options=s||{};let o=this.options;o.popsize===void 0&&(o.popsize=50),o.elitism===void 0&&(o.elitism=0),o.provenance===void 0&&(o.provenance=0),o.mutationRate===void 0&&(o.mutationRate=.7),o.mutationAmount===void 0&&(o.mutationAmount=1),o.fitnessPopulation===void 0&&(o.fitnessPopulation=!1),o.clear===void 0&&(o.clear=!1),o.equal===void 0&&(o.equal=!1),o.compatibilityThreshold===void 0&&(o.compatibilityThreshold=3),o.maxNodes===void 0&&(o.maxNodes=1/0),o.maxConns===void 0&&(o.maxConns=1/0),o.maxGates===void 0&&(o.maxGates=1/0),o.excessCoeff===void 0&&(o.excessCoeff=1),o.disjointCoeff===void 0&&(o.disjointCoeff=1),o.weightDiffCoeff===void 0&&(o.weightDiffCoeff=.5),o.mutation===void 0&&(o.mutation=j.ALL?j.ALL.slice():j.FFW?[j.FFW]:[]),o.selection===void 0&&(o.selection=wt&&wt.TOURNAMENT||wt?.TOURNAMENT||wt.FITNESS_PROPORTIONATE),o.crossover===void 0&&(o.crossover=Yt?Yt.SINGLE_POINT:void 0),o.novelty===void 0&&(o.novelty={enabled:!1}),o.diversityMetrics===void 0&&(o.diversityMetrics={enabled:!0}),o.fastMode&&o.diversityMetrics&&(o.diversityMetrics.pairSample==null&&(o.diversityMetrics.pairSample=20),o.diversityMetrics.graphletSample==null&&(o.diversityMetrics.graphletSample=30),o.novelty?.enabled&&o.novelty.k==null&&(o.novelty.k=5)),this._noveltyArchive=[],o.speciation===void 0&&(o.speciation=!1),o.multiObjective&&o.multiObjective.enabled&&!Array.isArray(o.multiObjective.objectives)&&(o.multiObjective.objectives=[]),this.population=this.population||[];try{this.options.network!==void 0?this.createPool(this.options.network):this.options.popsize&&this.createPool(null)}catch{}(this.options.lineage?.enabled||this.options.provenance>0)&&(this._lineageEnabled=!0),this.options.lineageTracking===!0&&(this._lineageEnabled=!0),s.lineagePressure?.enabled&&this._lineageEnabled!==!0&&(this._lineageEnabled=!0)}async evolve(){return Mi.call(this)}async evaluate(){return Ii.call(this)}createPool(t){try{if(he&&typeof he=="function")return he.call(this,t)}catch{}this.population=[];let n=this.options.popsize||50;for(let i=0;i<n;i++){let s=t?rt.fromJSON(t.toJSON()):new rt(this.input,this.output,{minHidden:this.options.minHidden});s.score=void 0;try{this.ensureNoDeadEnds(s)}catch{}s._reenableProb=this.options.reenableProb,s._id=this._nextGenomeId++,this._lineageEnabled&&(s._parents=[],s._depth=0),this.population.push(s)}}snapshotRNGState(){return this._rngState}restoreRNGState(t){this._rngState=t,this._rng=void 0}importRNGState(t){this._rngState=t,this._rng=void 0}exportRNGState(){return this._rngState}getOffspring(){let t,n;try{t=this.getParent()}catch{t=this.population[0]}try{n=this.getParent()}catch{n=this.population[Math.floor(this._getRNG()()*this.population.length)]||this.population[0]}let i=rt.crossOver(t,n,this.options.equal||!1);if(i._reenableProb=this.options.reenableProb,i._id=this._nextGenomeId++,this._lineageEnabled){i._parents=[t._id,n._id];let s=t._depth??0,o=n._depth??0;i._depth=1+Math.max(s,o),t._id===n._id&&this._lastInbreedingCount++}return this.ensureMinHiddenNodes(i),this.ensureNoDeadEnds(i),i}_warnIfNoBestGenome(){try{console.warn("Evolution completed without finding a valid best genome (no fitness improvements recorded).")}catch{}}spawnFromParent(t,n=1){return Ti.call(this,t,n)}addGenome(t,n){return Oi.call(this,t,n)}selectMutationMethod(t,n=!0){try{return Ai.call(this,t,n)}catch{return null}}ensureNoDeadEnds(t){try{return bi.call(this,t)}catch{return}}getMinimumHiddenSize(t){let n=this.options;if(typeof n.minHidden=="number")return n.minHidden;let i=t??n.minHiddenMultiplier;return typeof i=="number"&&isFinite(i)?Math.max(0,Math.round(i*(this.input+this.output))):0}sampleRandom(t){let n=this._getRNG(),i=[];for(let s=0;s<t;s++)i.push(n());return i}_getObjectives(){return Li.call(this)}getObjectiveKeys(){return this._getObjectives().map(t=>t.key)}_invalidateGenomeCaches(t){!t||typeof t!="object"||(delete t._compatCache,delete t._outputCache,delete t._traceCache)}_computeDiversityStats(){this._diversityStats=$i(this.population,this)}_structuralEntropy(t){return We(t)}mutate(){return mi.call(this)}_mutateAddNodeReuse(t){return fi.call(this,t)}_mutateAddConnReuse(t){return yi.call(this,t)}_fallbackInnov(t){return Gi.call(this,t)}_compatibilityDistance(t,n){return Bi.call(this,t,n)}_speciate(){return ji.call(this)}_applyFitnessSharing(){return Ui.call(this)}_sortSpeciesMembers(t){return zi.call(this,t)}_updateSpeciesStagnation(){return qi.call(this)}getSpeciesStats(){return Yi.call(this)}getSpeciesHistory(){return Ji.call(this)}getNoveltyArchiveSize(){return this._noveltyArchive?this._noveltyArchive.length:0}getMultiObjectiveMetrics(){return this.population.map(t=>({rank:t._moRank??0,crowding:t._moCrowd??0,score:t.score||0,nodes:t.nodes.length,connections:t.connections.length}))}getOperatorStats(){return Array.from(this._operatorStats.entries()).map(([t,n])=>({name:t,success:n.success,attempts:n.attempts}))}applyEvolutionPruning(){try{(te(),Z(Qt)).applyEvolutionPruning.call(this)}catch{}}applyAdaptivePruning(){try{(te(),Z(Qt)).applyAdaptivePruning.call(this)}catch{}}getTelemetry(){return this._telemetry}exportTelemetryJSONL(){return Ki.call(this)}exportTelemetryCSV(t=500){return Zi.call(this,t)}clearTelemetry(){this._telemetry=[]}getObjectives(){return this._getObjectives().map(t=>({key:t.key,direction:t.direction}))}getObjectiveEvents(){return this._objectiveEvents.slice()}getLineageSnapshot(t=20){return this.population.slice(0,t).map(n=>({id:n._id??-1,parents:Array.isArray(n._parents)?n._parents.slice():[]}))}exportSpeciesHistoryCSV(t=200){return os.call(this,t)}getParetoFronts(t=3){if(!this.options.multiObjective?.enabled)return[[...this.population]];let n=[];for(let i=0;i<t;i++){let s=this.population.filter(o=>(o._moRank??0)===i);if(!s.length)break;n.push(s)}return n}getDiversityStats(){return this._diversityStats}registerObjective(t,n,i){return Pi.call(this,t,n,i)}clearObjectives(){return ki.call(this)}getParetoArchive(t=50){return this._paretoArchive.slice(-t)}exportParetoFrontJSONL(t=100){return this._paretoObjectivesArchive.slice(-t).map(i=>JSON.stringify(i)).join(`
`)}getPerformanceStats(){return{lastEvalMs:this._lastEvalDuration,lastEvolveMs:this._lastEvolveDuration}}exportSpeciesHistoryJSONL(t=200){return this._speciesHistory.slice(-t).map(i=>JSON.stringify(i)).join(`
`)}resetNoveltyArchive(){this._noveltyArchive=[]}clearParetoArchive(){this._paretoArchive=[]}sort(){return rs.call(this)}getParent(){return cs.call(this)}getFittest(){return ls.call(this)}getAverage(){return us.call(this)}export(){return Ye.call(this)}import(t){return Je.call(this,t)}exportState(){return Xe.call(this)}static importState(t,n){return Ke.call(e,t,n)}toJSON(){return Ze.call(this)}static fromJSON(t,n){return Qe.call(e,t,n)}}});var ee=class e{static#n=60;static#t=10;static deprecatedTriesKey="tries";static#e(t){return t??(typeof document<"u"?document.getElementById("ascii-maze-output"):null)}static createTerminalClearer(t){let n=this.#e(t);return()=>{n&&(n.innerHTML="")}}static async evolveUntilSolved(t,n=e.#n,i=e.#t){let s=0,o={success:!1,progress:0};for(;s<i;){s++;let{finalResult:a}=await t();if(o=a,a.success||a.progress>=n)return{finalResult:a,attemptCount:s,tries:s}}return{finalResult:o,attemptCount:s,tries:s}}};var q=class e{static#n=new Set(["#","\u2550","\u2551","\u2554","\u2557","\u255A","\u255D","\u2560","\u2563","\u2566","\u2569","\u256C"]);static#t=[[0,-1],[1,0],[0,1],[-1,0]];static posKey(t){let[n,i]=t;return`${n},${i}`}static tail(t,n){if(!Array.isArray(t)||n<=0)return[];let i=t.length,s=Math.max(0,i-n),o=i-s,a=new Array(o),r=0;for(let c=s;c<i;c++)a[r++]=t[c];return a}static safeLast(t){if(!(!Array.isArray(t)||t.length===0))return t.at?t.at(-1):t[t.length-1]}static pushHistory(t,n,i){if(!Array.isArray(t))return[n];t.push(n);let s=t.length-i;return s>0&&(s===1?t.shift():t.splice(0,s)),t}static encodeMaze(t){let n=e.#n,i=new Map([[".",0],["E",1],["S",2]]);return t.map((s,o)=>{let a=s.length,r=new Array(a);for(let c=0;c<a;c++){let l=s[c];if(n.has(l)){r[c]=-1;continue}r[c]=i.get(l)??0}return r})}static findPosition(t,n){let i=t.length;for(let s=0;s<i;s++){let o=t[s];if(!o)continue;let a=o.indexOf(n);if(a!==-1)return[a,s]}throw new Error(`Character ${n} not found in maze`)}static bfsDistance(t,n,i){let[s,o]=n,[a,r]=i,c=t.length,l=t[0].length;if(o<0||o>=c||s<0||s>=l||r<0||r>=c||a<0||a>=l||t[o][s]===-1||t[r][a]===-1)return 1/0;if(s===a&&o===r)return 0;let u=c*l,p=new Int8Array(u);for(let S=0,v=0;S<c;S++){let _=t[S];for(let x=0;x<l;x++,v++)p[v]=_[x]===-1?-1:0}let h=new Int32Array(u);for(let S=0;S<u;S++)h[S]=-1;let m=o*l+s,d=r*l+a;h[m]=0;let f=new Int32Array(u),b=0,g=0;f[g++]=m;let y=-l,N=l;for(;b<g;){let S=f[b++],v=h[S];if(S===d)return v;let _=S/l|0,x=S-_*l;for(let w=0;w<4;w++){let I;switch(w){case 0:if(_===0)continue;I=S+y;break;case 1:if(x+1>=l)continue;I=S+1;break;case 2:if(_+1>=c)continue;I=S+N;break;default:if(x===0)continue;I=S-1}if(p[I]!==-1&&h[I]===-1){if(h[I]=v+1,I===d)return v+1;f[g++]=I}}}return 1/0}static calculateProgress(t,n,i,s){let o=e.bfsDistance(t,i,s);if(o===0)return 100;let a=e.bfsDistance(t,n,s);return Math.min(100,Math.max(0,Math.round((o-a)/o*100)))}static calculateProgressFromDistanceMap(t,n,i){let[s,o]=i,[a,r]=n,c=t[o]?.[s],l=t[r]?.[a];if(c==null||l==null||!isFinite(c)||c<=0)return 0;let u=(c-l)/c*100;return Math.min(100,Math.max(0,Math.round(u)))}static buildDistanceMap(t,n){let{width:i,height:s,distances:o,WALL_VALUE:a,UNREACHABLE_VALUE:r}=e.buildDistanceMapFlat(t,n),c=Array.from({length:s},()=>new Array(i));for(let l=0,u=0;l<s;l++){let p=c[l];for(let h=0;h<i;h++,u++){let m=o[u];p[h]=m===a||m===r?1/0:m}}return c}static buildDistanceMapFlat(t,n){let i=t.length,s=t[0].length,o=-2,a=-1,r=s*i,c=new Int32Array(r);for(let g=0;g<r;g++)c[g]=a;let[l,u]=n;if(u<0||u>=i||l<0||l>=s||t[u][l]===-1){for(let g=0,y=0;g<i;g++){let N=t[g];for(let S=0;S<s;S++,y++)N[S]===-1&&(c[y]=o)}return{width:s,height:i,distances:c,WALL_VALUE:o,UNREACHABLE_VALUE:a}}for(let g=0,y=0;g<i;g++){let N=t[g];for(let S=0;S<s;S++,y++)N[S]===-1&&(c[y]=o)}let p=u*s+l;c[p]=0;let h=new Int32Array(r),m=0,d=0;h[d++]=p;let f=-s,b=s;for(;m<d;){let g=h[m++],y=c[g],N=g/s|0,S=g-N*s;for(let v=0;v<4;v++){let _;switch(v){case 0:if(N===0)continue;_=g+f;break;case 1:if(S+1>=s)continue;_=g+1;break;case 2:if(N+1>=i)continue;_=g+b;break;default:if(S===0)continue;_=g-1}c[_]===a&&(c[_]=y+1,h[d++]=_)}}return{width:s,height:i,distances:c,WALL_VALUE:o,UNREACHABLE_VALUE:a}}};var sn=Object.freeze({205:"#ff6ac1",93:"#b48bf2",154:"#a6d189",51:"#00bcd4",226:"#ffd166",214:"#ff9f43",196:"#ff3b30",46:"#00e676",123:"#6ec6ff",177:"#caa6ff",80:"#00bfa5",121:"#9bdc8a",203:"#ff6b9f",99:"#6b62d6",44:"#00a9e0",220:"#ffd54f",250:"#ececec",45:"#00aaff",201:"#ff4fc4",231:"#ffffff",218:"#ffc6d3",217:"#ffcdb5",117:"#6fb3ff",118:"#6ee07a",48:"#00a300",57:"#2f78ff",33:"#1e90ff",87:"#00d7ff",159:"#cfeeff",208:"#ff8a00",197:"#ff5ea6",234:"#0e1114",23:"#123044",17:"#000b16",16:"#000000",39:"#0078ff"}),Ns="700",_s=0,xs=1,ws=22,Ms=38,Es=48,Is=39,Cs=49,Ts=/[&<>]/,Os=Object.freeze(["#000000","#800000","#008000","#808000","#000080","#800080","#008080","#c0c0c0"]),Rs=Object.freeze(["#808080","#ff0000","#00ff00","#ffff00","#0000ff","#ff00ff","#00ffff","#ffffff"]);function on(e){return Ts.test(e)?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e}function Ls(e){let t=e??(typeof document<"u"?document.getElementById("ascii-maze-output"):null);if(!t)return null;let n=t.querySelector("pre");return n||(n=document.createElement("pre"),n.style.fontFamily="monospace",n.style.whiteSpace="pre",n.style.margin="0",n.style.padding="4px",n.style.fontSize="10px",t.appendChild(n)),n}var ge=class e{static#n=/\x1b\[([0-9;]*)m/g;static#t="<br/>";static#e=[];static#i=32;static#s=new Map;#o="";#c="";#h=0;#l;#m;#f;#d=!1;#u="";#p=[];constructor(){}static#M(t){let n=this.#e.pop()??new e;return n.#a(t),n}static#x(t){this.#e.length<this.#i&&this.#e.push(t)}static convert(t){let n=this.#M(t);try{return n.#w(),n.#c}finally{this.#x(n)}}#a(t){this.#o=t,this.#c="",this.#h=0,this.#S(),e.#n.lastIndex=0}#w(){let t;for(;(t=e.#n.exec(this.#o))!==null;)this.#A(t.index),this.#g(t[1]),this.#h=e.#n.lastIndex;this.#A(this.#o.length)}#A(t){if(this.#h>=t)return;let n=this.#o.substring(this.#h,t);if(!n)return;if(!n.includes(`
`)){let s=on(n);this.#c+=this.#I(s);return}let i=0;for(let s=0;s<=n.length;s++){let o=s===n.length,a=!o&&n.charCodeAt(s)===10;if(a||o){if(s>i){let r=n.substring(i,s);this.#c+=this.#I(on(r))}a&&(this.#c+=e.#t),i=s+1}}}#g(t){if(t===""){this.#S();return}let n="",i=0;for(let s=0;s<t.length;s++){let o=t[s];o===";"?n&&(this.#p[i++]=parseInt(n,10),n=""):n+=o}n&&(this.#p[i++]=parseInt(n,10)),this.#E(i),this.#L()}#E(t){for(let n=0;n<t;n++){let i=this.#p[n];switch(!0){case i===_s:{this.#S();break}case i===xs:{this.#f=Ns,this.#d=!0;break}case i===ws:{this.#f=void 0,this.#d=!!(this.#l||this.#m||this.#f);break}case(i===Ms&&this.#p[n+1]===5):{let s=this.#p[n+2];if(s!=null){let o=sn[s];o&&(this.#l=o,this.#d=!0)}n+=2;break}case(i===Es&&this.#p[n+1]===5):{let s=this.#p[n+2];if(s!=null){let o=sn[s];o&&(this.#m=o,this.#d=!0)}n+=2;break}case(i>=30&&i<=37):{this.#l=Os[i-30],this.#d=!0;break}case(i>=90&&i<=97):{this.#l=Rs[i-90],this.#d=!0;break}case i===Is:{this.#l=void 0,this.#d=!!(this.#m||this.#f);break}case i===Cs:{this.#m=void 0,this.#d=!!(this.#l||this.#f);break}default:}}}#S(){this.#l=this.#m=this.#f=void 0,this.#d=!1,this.#u=""}#L(){if(!this.#d){this.#u="";return}let t=this.#l??"",n=this.#m??"",i=this.#f??"",s=`${t}|${n}|${i}`,o=e.#s.get(s);if(o){this.#u=o;return}let a=[];t&&a.push(`color: ${t}`),n&&a.push(`background: ${n}`),i&&a.push(`font-weight: ${i}`);let r=a.length?`<span style="${a.join(";")}">`:"";e.#s.set(s,r),this.#u=r}#I(t){return this.#u?`${this.#u}${t}</span>`:t}static formatWithNewlines(t){return this.convert(t)}};function be(e){return(...t)=>{let n=Ls(e),i;if(t.length){let a=q.safeLast(t);a&&typeof a=="object"&&"prepend"in a&&(i=a,t.pop())}let s="";for(let a=0;a<t.length;a++){a&&(s+=" ");let r=t[a];s+=typeof r=="string"?r:JSON.stringify(r)}if(!n)return;let o=ge.formatWithNewlines(s)+"<br/>";i&&i.prepend?(n.insertAdjacentHTML("afterbegin",o),n.scrollTop=0):(n.insertAdjacentHTML("beforeend",o),n.scrollTop=n.scrollHeight)}}var A={reset:"\x1B[0m",bright:"\x1B[1m",dim:"\x1B[2m",neonPink:"\x1B[38;5;205m",neonPurple:"\x1B[38;5;93m",neonLime:"\x1B[38;5;154m",neonAqua:"\x1B[38;5;51m",neonYellow:"\x1B[38;5;226m",neonOrange:"\x1B[38;5;214m",neonRed:"\x1B[38;5;196m",neonGreen:"\x1B[38;5;46m",neonSky:"\x1B[38;5;123m",neonViolet:"\x1B[38;5;177m",neonTurquoise:"\x1B[38;5;80m",neonMint:"\x1B[38;5;121m",neonCoral:"\x1B[38;5;203m",neonIndigo:"\x1B[38;5;99m",neonTeal:"\x1B[38;5;44m",neonGold:"\x1B[38;5;220m",neonSilver:"\x1B[38;5;250m",neonBlue:"\x1B[38;5;45m",neonMagenta:"\x1B[38;5;201m",neonCyan:"\x1B[38;5;87m",neonWhite:"\x1B[38;5;231m",neonRose:"\x1B[38;5;218m",neonPeach:"\x1B[38;5;217m",neonAzure:"\x1B[38;5;117m",neonChartreuse:"\x1B[38;5;118m",neonSpring:"\x1B[38;5;48m",neonAmber:"\x1B[38;5;214m",neonFuchsia:"\x1B[38;5;207m",blueCore:"\x1B[38;5;39m",cyanNeon:"\x1B[38;5;87m",blueNeon:"\x1B[38;5;45m",whiteNeon:"\x1B[38;5;159m",orangeNeon:"\x1B[38;5;208m",magentaNeon:"\x1B[38;5;201m",red:"\x1B[38;5;197m",green:"\x1B[38;5;118m",yellow:"\x1B[38;5;220m",blue:"\x1B[38;5;33m",cyan:"\x1B[38;5;51m",bgNeonPink:"\x1B[48;5;205m",bgNeonPurple:"\x1B[48;5;93m",bgNeonLime:"\x1B[48;5;154m",bgNeonAqua:"\x1B[48;5;51m",bgNeonYellow:"\x1B[48;5;226m",bgNeonOrange:"\x1B[48;5;214m",bgNeonRed:"\x1B[48;5;196m",bgNeonGreen:"\x1B[48;5;46m",bgNeonSky:"\x1B[48;5;123m",bgNeonViolet:"\x1B[48;5;177m",bgNeonTurquoise:"\x1B[48;5;80m",bgNeonMint:"\x1B[48;5;121m",bgNeonCoral:"\x1B[48;5;203m",bgNeonIndigo:"\x1B[48;5;99m",bgNeonTeal:"\x1B[48;5;44m",bgNeonGold:"\x1B[48;5;220m",bgNeonSilver:"\x1B[48;5;250m",bgNeonBlue:"\x1B[48;5;45m",bgNeonMagenta:"\x1B[48;5;201m",bgNeonCyan:"\x1B[48;5;87m",bgNeonWhite:"\x1B[48;5;231m",bgNeonRose:"\x1B[48;5;218m",bgNeonPeach:"\x1B[48;5;217m",bgNeonAzure:"\x1B[48;5;117m",bgNeonChartreuse:"\x1B[48;5;118m",bgNeonSpring:"\x1B[48;5;48m",bgNeonAmber:"\x1B[48;5;214m",bgNeonFuchsia:"\x1B[48;5;207m",bgBlueCore:"\x1B[48;5;39m",bgCyanNeon:"\x1B[48;5;87m",bgBlueNeon:"\x1B[48;5;45m",bgWhiteNeon:"\x1B[48;5;159m",bgOrangeNeon:"\x1B[48;5;208m",bgMagentaNeon:"\x1B[48;5;201m",bgRed:"\x1B[48;5;197m",bgGreen:"\x1B[48;5;118m",bgYellow:"\x1B[48;5;220m",bgBlue:"\x1B[48;5;33m",darkWallBg:"\x1B[48;5;17m",darkWallText:"\x1B[38;5;17m",floorBg:"\x1B[48;5;234m",floorText:"\x1B[38;5;234m",gridLineBg:"\x1B[48;5;23m",gridLineText:"\x1B[38;5;23m",bgBlack:"\x1B[48;5;16m",pureBlue:"\x1B[38;5;57;1m",pureOrange:"\x1B[38;5;214;1m",pureGreen:"\x1B[38;5;46;1m"};var z=class e{static#n="  \u2500\u2500\u25B6  ";static#t=e.#n.length;static#e=150;static#i=[{min:2,max:1/0,label:"v-high+"},{min:1,max:2,label:"high+"},{min:.5,max:1,label:"mid+"},{min:.1,max:.5,label:"low+"},{min:-.1,max:.1,label:"zero\xB1"},{min:-.5,max:-.1,label:"low-"},{min:-1,max:-.5,label:"mid-"},{min:-2,max:-1,label:"high-"},{min:-1/0,max:-2,label:"v-high-"}];static#s=new Int32Array(16);static#o=0;static#c=[];static#h=[];static pad(t,n,i=" ",s="center"){t=t??"";let o=t.replace(/\x1b\[[0-9;]*m/g,"").length;if(o>=n)return t;let a=n-o;if(s==="left")return t+i.repeat(a);if(s==="right")return i.repeat(a)+t;let r=Math.floor(a/2),c=a-r;return i.repeat(r)+t+i.repeat(c)}static#l(t){return typeof t.activation=="number"&&isFinite(t.activation)&&!isNaN(t.activation)?t.type==="output"?Math.max(0,Math.min(1,t.activation)):Math.max(-999,Math.min(999,t.activation)):0}static#m(t){return t>=2?A.bgOrangeNeon+A.bright:t>=1?A.orangeNeon:t>=.5?A.cyanNeon:t>=.1?A.neonGreen:t>=-.1?A.whiteNeon:t>=-.5?A.blue:t>=-1?A.blueCore:t>=-2?A.bgNeonAqua+A.bright:A.bgNeonViolet+A.neonSilver}static#f(t){if(typeof t!="number"||isNaN(t)||!isFinite(t))return" 0.000";let n=this.#m(t),i;return i=(t>=0?" ":"")+t.toFixed(6),n+i+A.reset}static#d(t,n,i,s){let o=e.#l(i),a=e.#f(o);return`${`${t}${n}${A.reset}`}${a}${s??""}`}static#u(t,n,i){if(n.length===0)return[];let s=[],o=t,a=[...n];for(;a.length>0;){let r=a.filter(c=>c.connections&&c.connections.in&&c.connections.in.length>0&&c.connections.in.every(l=>o.includes(l.from)));if(r.length===0){s.push(a);break}s.push(r),o=r,a=a.filter(c=>!r.includes(c))}return s}static#p(t){let n=t.map(o=>e.#l(o)),i=[],s=[];for(let o of e.#i){let a=t.filter((r,c)=>n[c]>=o.min&&n[c]<o.max);a.length>0&&(i.push(a),s.push(o.label))}return{groups:i,labels:s}}static#M(t,n=10){let i=n,s={},o=[],a=[];return t.forEach((r,c)=>{if(r.length<=i)o.push([...r]),a.push(r.length);else{let{avgNodes:l,count:u}=e.#x({layer:r,layerIndex:c,maxVisible:i,averageNodesStore:s});o.push(l),a.push(u)}}),{displayLayers:o,layerDisplayCounts:a,averageNodes:s}}static#x(t){let{layer:n,layerIndex:i,maxVisible:s,averageNodesStore:o}=t,{groups:a,labels:r}=e.#p(n),{finalGroups:c,finalLabels:l}=a.length>s?e.#w({groups:a,labels:r,maxVisible:s}):{finalGroups:a,finalLabels:r},u=c.map((p,h)=>e.#a({group:p,groupIndex:h,layerIndex:i,label:l[h],averageNodesStore:o}));return{avgNodes:u,count:u.length}}static#a(t){let{group:n,groupIndex:i,layerIndex:s,label:o,averageNodesStore:a}=t,r=`layer${s}-avg-${i}`,c=n.reduce((u,p)=>u+e.#l(p),0),l=n.length?c/n.length:0;return a[r]={avgValue:l,count:n.length},{id:-1*(s*1e3+i),uuid:r,type:"hidden",activation:l,isAverage:!0,avgCount:n.length,label:o}}static#w(t){let{groups:n,labels:i,maxVisible:s}=t,o=n.map((p,h)=>({group:p,label:i[h],size:p.length})),a=e.#g(o,(p,h)=>h.size-p.size),r=Math.max(0,s-1),c=a.slice(0,r),l=a.slice(r);l.length&&c.push(e.#A(l));let u=e.#g(c,e.#E);return{finalGroups:u.map(p=>p.group),finalLabels:u.map(p=>p.label)}}static#A(t){return t.reduce((n,i)=>(n.group.push(...i.group),n.size+=i.size,n),{group:[],label:"other\xB1",size:0})}static#g(t,n){let i=t;return typeof i.toSorted=="function"?i.toSorted(n):[...t].sort(n)}static#E(t,n){let i=t.label.includes("-"),s=n.label.includes("-");if(i!==s)return i?1:-1;let o=t.label.startsWith("v-high"),a=n.label.startsWith("v-high");if(o!==a)return o?-1:1;let r=t.label.includes("high"),c=n.label.includes("high");return r!==c?r?-1:1:0}static#S(t,n){let i=typeof t.index=="number"?t.index:n;return{id:i,uuid:String(i),type:t.type,activation:t.activation,bias:t.bias}}static#L(t){let n=[],i=[],s=[],o=t.nodes||[];for(let a=0;a<o.length;a++){let r=o[a],c=e.#S(r,a);switch(r.type){case"input":case"constant":n.push(c);break;case"hidden":i.push(c);break;case"output":s.push(c);break;default:break}}return{inputNodes:n,hiddenNodes:i,outputNodes:s,inputCountDetected:n.length}}static#I(t){if(e.#s.length<t){let n=e.#s.length;for(;n<t;)n*=2;e.#s=new Int32Array(n)}return e.#s}static#at(t,n,i,s){let o=i.length,a=o>0?o+1:1,r=e.#I(a);r.fill(0,0,a),e.#o=a;let c=new Set(n.map(h=>Number(h.id))),l=new Set(s.map(h=>Number(h.id))),u=i.map(h=>new Set(h.map(m=>Number(m.id)))),p=t.connections||[];for(let h=0;h<p.length;h++){let m=p[h],d=Number(m.from?.index??-1),f=Number(m.to?.index??-1);if(c.has(d)){(u[0]&&u[0].has(f)||u.length===0&&l.has(f))&&r[0]++;continue}for(let b=0;b<u.length;b++){if(!u[b].has(d))continue;if(b===u.length-1){if(l.has(f)){r[u.length]++;break}}else if(u[b+1].has(f)){r[1+b]++;break}}}return r}static#J(t,n,i,s){let o=n.length,{columnWidth:a}=e.#F(o),r=e.#h;r.length=0,r.push(e.#P({prefix:`${A.blueCore}\u2551`,label:`${A.neonGreen}Input Layer [${t}]${A.reset}`,width:a-1})),r.push(e.#C(s[0]??0));for(let c=0;c<o;c++)r.push(e.pad(`${A.cyanNeon}Hidden ${c+1} [${n[c].length}]${A.reset}`,a)),r.push(e.#C(s[c+1]||0));return r.push(e.pad(`${A.orangeNeon}Output Layer [${i}]${A.reset}`,a," ","center")+`${A.blueCore}\u2551${A.reset}`),r.join("")}static#P(t){let{prefix:n="",label:i,width:s}=t;return n+e.pad(i,s," ","center")}static#C(t){let n=`${A.blueNeon}${t} ${e.#n.trim()}${A.reset}`;return e.pad(n,e.#t)}static#z(){return[`${A.blueCore}\u2551       ${e.pad(" ",140)} \u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad("Arrows indicate feed-forward flow.",140," ","left")} ${A.blueCore}\u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad(" ",140)} \u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad(`${A.whiteNeon}Legend:  ${A.neonGreen}\u25CF${A.reset}=Input                    ${A.cyanNeon}\u25A0${A.reset}=Hidden                    ${A.orangeNeon}\u25B2${A.reset}=Output`,140," ","left")} ${A.blueCore}\u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad(`${A.whiteNeon}Groups:  ${A.bgOrangeNeon}${A.bright}v-high+${A.reset}=Very high positive   ${A.orangeNeon}high+${A.reset}=High positive    ${A.cyanNeon}mid+${A.reset}=Medium positive    ${A.neonGreen}low+${A.reset}=Low positive`,140," ","left")} ${A.blueCore}\u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad(`${A.whiteNeon}         zero\xB1${A.reset}=Near zero`,140," ","left")} ${A.blueCore}\u2551${A.reset}`,`${A.blueCore}\u2551       ${e.pad(`         ${A.bgBlueCore}${A.bright}v-high-${A.reset}=Very high negative   ${A.blueNeon}${A.bright}high-${A.reset}=High negative    ${A.blueCore}mid-${A.reset}=Medium negative    ${A.blue}low-${A.reset}=Low negative`,140," ","left")} ${A.blueCore}\u2551${A.reset}`]}static#X(t,n){let i=e.#rt(t),{maxRows:s,rows:o,inputDisplayNodes:a,outputDisplayNodes:r,numHiddenLayers:c,inputCount:l,outputCount:u,inputNodes:p,displayLayers:h,connectionCounts:m}=i;for(let d=0;d<s;d++){let f="";f+=e.#k({rowIndex:d,inputCount:l,columnWidth:n,inputDisplayNodes:a}),f+=e.#ct({rowIndex:d,inputCount:l,inputNodes:p,displayLayers:h,connectionCounts:m});for(let b=0;b<c;b++)f+=e.#lt({rowIndex:d,layerIndex:b,columnWidth:n,displayLayers:h}),f+=e.#D({rowIndex:d,layerIndex:b,numHiddenLayers:c,displayLayers:h,connectionCounts:m,outputCount:u});f+=e.#ut({rowIndex:d,outputCount:u,outputDisplayNodes:r,columnWidth:n}),o.push(f)}return o.slice()}static#rt(t){let{inputCount:n,outputCount:i,inputNodes:s,displayLayers:o,layerDisplayCounts:a,outputNodes:r,connectionCounts:c}=t,l=Math.max(n,...a,i),u=e.#c;u.length=0;let p=Array.from({length:n},(m,d)=>s[d]||{activation:0}),h=Array.from({length:i},(m,d)=>r[d]||{activation:0});return{maxRows:l,rows:u,inputDisplayNodes:p,outputDisplayNodes:h,numHiddenLayers:o.length,inputCount:n,outputCount:i,inputNodes:s,displayLayers:o,connectionCounts:c}}static#k(t){let{rowIndex:n,inputCount:i,columnWidth:s,inputDisplayNodes:o}=t;if(n>=i)return e.pad("",s);let a=["compass","openN","openE","openS","openW","progress"],r=o[n],c=n<6?a[n]:"",l=c?` ${A.whiteNeon}${c}${A.reset}`:"";return e.pad(`${A.blueCore}\u2551   ${e.#d(A.neonGreen,"\u25CF",r,l)}`,s," ","left")}static#ct(t){let{rowIndex:n,inputCount:i,inputNodes:s,displayLayers:o,connectionCounts:a}=t,r=o[0]?.length||0,c=Math.min(i,s.length),l=`${A.blueNeon}${e.#n}${A.reset}`;if(n===0&&c&&r){let u=Math.ceil((a[0]||0)/Math.max(1,c));return e.pad(`${A.blueNeon}${u} \u2500\u2500\u25B6${A.reset}`,e.#t)}if(n<i&&n<r&&c&&r){let u=Math.ceil((a[0]||0)/Math.max(3,c*2));return e.pad(`${A.blueNeon}${u} \u2500\u2500\u25B6${A.reset}`,e.#t)}return e.pad(l,e.#t)}static#lt(t){let{rowIndex:n,layerIndex:i,columnWidth:s,displayLayers:o}=t,a=o[i];if(n>=a.length)return e.pad(" ",s);let r=a[n];if(r.isAverage){let c=r.label?`${r.label} `:"",l=` ${A.dim}(${c}avg of ${r.avgCount})${A.reset}`;return e.pad(e.#d(A.cyanNeon,"\u25A0",r,l),s," ","left")}return e.pad(e.#d(A.cyanNeon,"\u25A0",r),s," ","left")}static#D(t){let{rowIndex:n,layerIndex:i,numHiddenLayers:s,displayLayers:o,connectionCounts:a,outputCount:r}=t,c=o[i],l=`${A.blueNeon}${e.#n}${A.reset}`;if(!(i===s-1)){let h=a[i+1]||0;if(n===0){let m=c.length||1,d=Math.ceil(h/Math.max(3,m*2));return e.pad(`${A.blueNeon}${d} \u2500\u2500\u25B6${A.reset}`,e.#t)}if(n<c.length&&n<(o[i+1]?.length||0)){let m=c.length||1,d=Math.max(1,Math.min(5,Math.ceil(h/Math.max(3,m))));return e.pad(`${A.blueNeon}${d} \u2500\u2500\u25B6${A.reset}`,e.#t)}return e.pad(l,e.#t)}let p=a[s]||0;if(n===0){let h=c.length||1,m=Math.ceil(p/Math.max(3,h*2));return e.pad(`${A.blueNeon}${m} \u2500\u2500\u25B6${A.reset}`,e.#t)}if(n<c.length&&n<r){let h=c.length||1,m=Math.max(1,Math.min(5,Math.ceil(p/Math.max(5,h*2))));return e.pad(`${A.blueNeon}${m} \u2500\u2500\u25B6${A.reset}`,e.#t)}return e.pad(l,e.#t)}static#ut(t){let{rowIndex:n,outputCount:i,outputDisplayNodes:s,columnWidth:o}=t;if(n>=i)return e.pad("",o);let a=s[n];return e.pad(e.#d(A.orangeNeon,"\u25B2",a),o," ","left")+`${A.blueCore}\u2551${A.reset}`}static visualizeNetworkSummary(t){let n=e.#L(t),i=n.inputCountDetected||18,s=4,o=e.#u(n.inputNodes,n.hiddenNodes,n.outputNodes),a=e.#M(o),r=e.#at(t,n.inputNodes,o,n.outputNodes),{columnWidth:c}=e.#F(o.length),l=e.#J(i,o,s,r),u=e.#X({inputCount:i,outputCount:s,inputNodes:n.inputNodes,displayLayers:a.displayLayers,layerDisplayCounts:a.layerDisplayCounts,outputNodes:n.outputNodes,connectionCounts:r},c),p=e.#z();return[l,...u,...p].join(`
`)}static#F(t){let n=2+t,i=n-1,s=e.#e-i*e.#t;return{columnWidth:Math.floor(s/n)}}};var Ct=class e{static#n=new Set(["#","\u2550","\u2551","\u2554","\u2557","\u255A","\u255D","\u2560","\u2563","\u2566","\u2569","\u256C"]);static get WALL_CHARS(){return e.#n}static#t(t){return q.safeLast(t)}static#e([t,n]){return`${t},${n}`}static renderCell(t,n,i,s,o,a){let r=e.WALL_CHARS;return n===s&&i===o?t==="S"?`${A.bgBlack}${A.orangeNeon}S${A.reset}`:t==="E"?`${A.bgBlack}${A.orangeNeon}E${A.reset}`:`${A.bgBlack}${A.orangeNeon}A${A.reset}`:t==="S"?`${A.bgBlack}${A.orangeNeon}S${A.reset}`:t==="E"?`${A.bgBlack}${A.orangeNeon}E${A.reset}`:t==="."?a&&a.has(`${n},${i}`)?`${A.floorBg}${A.orangeNeon}\u2022${A.reset}`:`${A.floorBg}${A.gridLineText}.${A.reset}`:r.has(t)?`${A.bgBlack}${A.blueNeon}${t}${A.reset}`:t}static visualizeMaze(t,[n,i],s){let o;if(s){o=new Set;for(let a of s)o.add(e.#e(a))}return t.map((a,r)=>[...a].map((c,l)=>this.renderCell(c,l,r,n,i,o)).join("")).join(`
`)}static printMazeStats(t,n,i){let{result:s,generation:o}=t,a=s.success?A.cyanNeon:A.neonRed,r=q.findPosition(n,"S"),c=q.findPosition(n,"E"),l=q.bfsDistance(q.encodeMaze(n),r,c),u=148,p=7,h=1,m=u-p-h;if(i(`${A.blueCore}\u2551${z.pad(" ",u," ")}${A.blueCore}\u2551${A.reset}`),i(`${A.blueCore}\u2551${z.pad(" ",u," ")}${A.blueCore}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Success:${A.neonIndigo} ${a}${s.success?"YES":"NO"}`,m," ","left")}${" ".repeat(h)}${A.blueCore}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Generation:${A.neonIndigo} ${a}${o}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Fitness:${A.neonOrange} ${s.fitness.toFixed(2)}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Steps taken:${A.neonIndigo} ${s.steps}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Path length:${A.neonIndigo} ${s.path.length}${A.blueCore}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Optimal distance to exit:${A.neonYellow} ${l}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${z.pad(" ",u," ")}${A.blueCore}\u2551${A.reset}`),s.success){let d=s.path.length-1,f=Math.min(100,Math.round(l/d*100)).toFixed(1),b=(d/l*100-100).toFixed(1),g=new Set,y=0,N=0,S=null;for(let C=0;C<s.path.length;C++){let[F,P]=s.path[C],$=`${F},${P}`;if(g.has($)?y++:g.add($),C>0){let[E,T]=s.path[C-1],k=F-E,D=P-T,O="";k>0?O="E":k<0?O="W":D>0?O="S":D<0&&(O="N"),S!==null&&O!==S&&N++,S=O}}let v=n[0].length,_=n.length,x=q.encodeMaze(n),w=0;for(let C=0;C<_;C++)for(let F=0;F<v;F++)x[C][F]!==-1&&w++;let I=(g.size/w*100).toFixed(1);i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Path efficiency:      ${A.neonIndigo} ${l}/${d} (${f}%)`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Optimal steps:        ${A.neonIndigo} ${l}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Path overhead:        ${A.neonIndigo} ${b}% longer than optimal`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Direction changes:    ${A.neonIndigo} ${N}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Unique cells visited: ${A.neonIndigo} ${g.size} (${I}% of maze)`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Cells revisited:      ${A.neonIndigo} ${y} times`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Decisions per cell:   ${A.neonIndigo} ${(N/g.size).toFixed(2)}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonOrange}Agent successfully navigated the maze!`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`)}else{let d=e.#t(s.path)??r,f=q.calculateProgress(q.encodeMaze(n),d,r,c),b=new Set;for(let[g,y]of s.path)b.add(`${g},${y}`);i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Best progress toward exit:      ${A.neonIndigo} ${f}%`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Shortest possible steps:        ${A.neonIndigo} ${l}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Unique cells visited:           ${A.neonIndigo} ${b.size}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`),i(`${A.blueCore}\u2551${" ".repeat(p)}${z.pad(`${A.neonSilver}Agent trying to reach the exit. ${A.neonIndigo}`,m," ","left")}${" ".repeat(h)}\u2551${A.reset}`)}}static displayProgressBar(t,n=60){let i=Math.max(0,Math.min(n,Math.floor(n*t/100))),s=`${A.blueCore}|>|`,o=`${A.blueCore}|<|`,a=`${A.neonOrange}\u2550`,r=`${A.neonIndigo}:`,c=`${A.neonOrange}\u25B6`,l="";l+=s,i>0&&(l+=a.repeat(i-1),l+=c);let u=n-i;return u>0&&(l+=r.repeat(u)),l+=o,`${t<30?A.neonYellow:t<70?A.orangeNeon:A.cyanNeon}${l}${A.reset} ${t}%`}static formatElapsedTime(t){if(t<60)return`${t.toFixed(1)}s`;if(t<3600){let s=Math.floor(t/60),o=t%60;return`${s}m ${o.toFixed(0)}s`}let n=Math.floor(t/3600),i=Math.floor(t%3600/60);return`${n}h ${i}m`}};var ne=class e{#n=[];#t=new Set;#e=null;#i=null;#s=null;#o=[];#c=[];#h=[];#l=[];#m=[];#f=[];#d=null;#u=null;#p=null;#M=null;#x=null;#a;#w;#A;static#g=500;static#E=148;static#S=7;static#L=1;static#I=28;static#at=64;static#J=64;static#P=22;static#C=200;static#z=Object.freeze(["\u2581","\u2582","\u2583","\u2584","\u2585","\u2586","\u2587","\u2588"]);static#X=1e-9;static#rt=6;static#k=8;static#ct=5;static#lt=4;static#D="Path efficiency";static#ut="Path overhead";static#F="Unique cells visited";static#ht="Cells revisited";static#q="Steps";static#V="Fitness";static#K="Architecture";static#Y="\u2550";static#Ot="\u2566\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2566";static#Rt="\u2569\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2569";static#b="\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550";static get FRAME_INNER_WIDTH(){return e.#E}static get LEFT_PADDING(){return e.#S}static get RIGHT_PADDING(){return e.#L}static get CONTENT_WIDTH(){return e.#E-e.#S-e.#L}static get STAT_LABEL_WIDTH(){return e.#I}static get HISTORY_MAX(){return e.#g}constructor(t,n,i){let s=()=>{};this.#w=typeof t=="function"?t:s,this.#a=typeof n=="function"?n:s,this.#A=typeof i=="function"?i:void 0}#r(){this.#a(`${A.blueCore}\u2551${z.pad(" ",e.FRAME_INNER_WIDTH," ")}${A.blueCore}\u2551${A.reset}`)}#T(t,n,i=A.neonSilver,s=A.cyanNeon,o=e.#I){let r=(t.endsWith(":")?t:`${t}:`).padEnd(o," "),c=typeof n=="number"?`${n}`:String(n),l=`${i}${r}${s} ${c}${A.reset}`,u=" ".repeat(e.LEFT_PADDING);return`${A.blueCore}\u2551${u}${z.pad(l,e.CONTENT_WIDTH," ","left")}${" ".repeat(e.RIGHT_PADDING)}${A.blueCore}\u2551${A.reset}`}#v(t,n=32){if(!Array.isArray(t)||!t.length||n<=0)return"";let i=q.tail(t,n),s=i.length;if(!s)return"";let o=0;for(let h=0;h<s;h++){let m=i[h];Number.isFinite(m)&&(i[o++]=m)}if(o===0)return"";let a=1/0,r=-1/0;for(let h=0;h<o;h++){let m=i[h];m<a&&(a=m),m>r&&(r=m)}let c=r-a;Math.abs(c)<e.#X&&(c=e.#X);let l=e.#z,u=l.length-1,p="";for(let h=0;h<o;h++){let m=(i[h]-a)/c,d=Math.min(u,Math.max(0,Math.floor(m*u)));p+=l[d]}return p}#O(t){return t.join("")}#pt(t,n){if(!this.#A)return;let i=[];this.#H(i,t,n),this.#$(i,t.network),this.#dt(i,t),this.#Nt(i,t),this.#Pt(i)}redraw(t,n){this.#x=globalThis.performance?.now?.()??Date.now(),this.#Lt(),this.#e&&this.#wt(t),this.#R(n),this.#r()}#Z={scores:[],speciesSizes:[],operatorStats:[],mutationEntries:[]};#Lt(){this.#w(),this.#ft()}#R(t){let n=this.#i;if(!(!n&&!this.#e))try{let i=n?.complexity,s=n?.perf,o=n?.lineage,a=n?.diversity,r=Array.isArray(n?.fronts)?n.fronts:null,c=n?.objectives,l=n?.hyper,u=n?.mutationStats||n?.mutation?.stats,p=this.#e?.result?.fitness,h=this.#e?.result?.saturationFraction,m=this.#e?.result?.actionEntropy,d=this.#Q(t);d.mean==null&&typeof p=="number"&&(d.mean=+p.toFixed(2)),d.median==null&&typeof p=="number"&&(d.median=+p.toFixed(2)),d.speciesCount==null&&typeof n?.species=="number"&&(d.speciesCount=n.species);let f=e.#J,b={fitness:this.#v(this.#o,f)||null,nodes:this.#v(this.#c,f)||null,conns:this.#v(this.#h,f)||null,hyper:this.#v(this.#l,f)||null,progress:this.#v(this.#m,f)||null,species:this.#v(this.#f,f)||null},g=r?.[0]?.length||0,y=r?r.map(w=>w?.length||0):null,N=this.#vt(()=>t?.getNoveltyArchiveSize?t.getNoveltyArchiveSize():null,null),S=this.#St(t),v=this.#tt(u),_=this.#N(t),x=(()=>{if(typeof p!="number")return null;let w=this.#o.at(-2)??null;return w==null?null:+(p-w).toFixed(3)})();this.#d={generation:this.#e?.generation||0,bestFitness:typeof p=="number"?p:null,bestFitnessDelta:x,saturationFraction:typeof h=="number"?h:null,actionEntropy:typeof m=="number"?m:null,populationMean:d.mean,populationMedian:d.median,enabledConnRatio:d.enabledRatio,complexity:i||null,simplifyPhaseActive:!!(i&&(i.growthNodes<0||i.growthConns<0)),perf:s||null,lineage:o||null,diversity:a||null,speciesCount:d.speciesCount,topSpeciesSizes:_,objectives:c||null,paretoFrontSizes:y,firstFrontSize:g,hypervolume:typeof l=="number"?l:null,noveltyArchiveSize:N,operatorAcceptance:S,topMutations:v,mutationStats:u||null,trends:b,histories:{bestFitness:this.#B(this.#o),nodes:this.#B(this.#c),conns:this.#B(this.#h),hyper:this.#B(this.#l),progress:this.#B(this.#m),species:this.#B(this.#f)},timestamp:Date.now()}}catch{}}#Q(t){if(!t||!Array.isArray(t.population)||t.population.length===0)return{mean:null,median:null,speciesCount:null,enabledRatio:null};let{scores:n}=this.#Z;n.length=0;let i=0,s=0;for(let l of t.population){typeof l?.score=="number"&&n.push(l.score);let u=l?.connections;if(Array.isArray(u))for(let p of u)s++,p?.enabled!==!1&&i++}let o=null,a=null;if(n.length){let l=0;for(let m=0;m<n.length;m++)l+=n[m];o=+(l/n.length).toFixed(2);let u=[...n].sort((m,d)=>m-d),p=Math.floor(u.length/2);a=+(u.length%2===0?(u[p-1]+u[p])/2:u[p]).toFixed(2)}let r=s?+(i/s).toFixed(2):null,c=Array.isArray(t.species)?t.species.length:null;return{mean:o,median:a,speciesCount:c,enabledRatio:r}}#St(t){if(typeof t?.getOperatorStats!="function")return null;let n;try{n=t.getOperatorStats()}catch{return null}if(!Array.isArray(n)||n.length===0)return null;let i=this.#Z.operatorStats;i.length=0;for(let r of n)r&&typeof r.name=="string"&&typeof r.success=="number"&&typeof r.attempts=="number"&&i.push(r);if(!i.length)return null;let s=[...i].sort((r,c)=>{let l=r.success/Math.max(1,r.attempts),u=c.success/Math.max(1,c.attempts);return u!==l?u-l:0}),o=Math.min(e.#rt,s.length),a=[];for(let r=0;r<o;r++){let c=s[r],l=+(100*c.success/Math.max(1,c.attempts)).toFixed(2);a.push({name:c.name,acceptancePct:l})}return a.length?a:null}#tt(t){if(!t||typeof t!="object")return null;let n=this.#Z.mutationEntries;n.length=0;for(let o of Object.keys(t)){let a=t[o];typeof a=="number"&&Number.isFinite(a)&&n.push([o,a])}if(!n.length)return null;n.sort((o,a)=>a[1]-o[1]);let i=Math.min(e.#k,n.length),s=[];for(let o=0;o<i;o++){let[a,r]=n[o];s.push({name:a,count:r})}return s}#N(t){if(!Array.isArray(t?.species)||t.species.length===0)return null;let n=this.#Z.speciesSizes;n.length=0;for(let o of t.species){let a=Array.isArray(o?.members)?o.members.length:0;n.push(a)}if(!n.length)return null;n.sort((o,a)=>a-o);let i=Math.min(e.#ct,n.length),s=[];for(let o=0;o<i;o++)s.push(n[o]);return s}#vt(t,n){try{return t()}catch{return n}}#H(t,n,i){let s=e.FRAME_INNER_WIDTH;t.push(`${A.blueCore}\u2554${z.pad("\u2550".repeat(s),s,"\u2550")}\u2557${A.reset}`);let{result:o,generation:a}=n,r=o?.fitness,c=typeof r=="number"&&Number.isFinite(r)?r.toFixed(2):"n/a",l=` SOLVED #${Math.max(1,i)} (GEN ${a})  FITNESS ${c} `,u=Math.max(0,Math.floor((s-l.length)/2)),p=Math.max(0,s-l.length-u);t.push(`${A.blueCore}\u2551${" ".repeat(u)}${A.orangeNeon}${l}${A.blueCore}${" ".repeat(p)}\u2551${A.reset}`),t.push(`${A.blueCore}\u2551${z.pad(" ",s," ")}\u2551${A.reset}`)}#$(t,n){let i=e.#P,s=(r,c)=>this.#T(r,c,A.neonSilver,A.cyanNeon,i),o=(r,c)=>{c&&t.push(s(r,c))};if(n){let r="n/a";try{r=this.#y(n)}catch{r="n/a"}if(r!=="n/a"){let c=r.split(/\s*-\s*/).join(" <=> ");o(e.#K,c)}}let a=e.#at;o("Fitness trend",this.#v(this.#o,a)),o("Nodes trend",this.#v(this.#c,a)),o("Conns trend",this.#v(this.#h,a)),o("Hypervol trend",this.#v(this.#l,a)),o("Progress trend",this.#v(this.#m,a)),o("Species trend",this.#v(this.#f,a)),t.push(`${A.blueCore}\u2551${z.pad(" ",e.FRAME_INNER_WIDTH," ")}${A.blueCore}\u2551${A.reset}`)}#dt(t,n){let i=n.result.path,s=i?.at(-1)??[0,0],o=Ct.visualizeMaze(n.maze,s,i??[]),a=Array.isArray(o)?o:o.split(`
`),r=e.FRAME_INNER_WIDTH;for(let c of a){let l=z.pad(c,r," ");t.push(`${A.blueCore}\u2551${z.pad(l,r," ")}${A.blueCore}\u2551${A.reset}`)}}#Nt(t,n){let i=this.#_t(n.maze,n.result),s=e.#P,o=(a,r)=>this.#T(a,r,A.neonSilver,A.cyanNeon,s);t.push(o(e.#D,`${i.optimalLength}/${i.pathLength} (${i.efficiencyPct}%)`)),t.push(o(e.#ut,`${i.overheadPct}% longer than optimal`)),t.push(o(e.#F,`${i.uniqueCellsVisited}`)),t.push(o(e.#ht,`${i.revisitedCells} times`)),t.push(o(e.#q,`${i.totalSteps}`)),t.push(o(e.#V,`${i.fitnessValue.toFixed(2)}`))}static#mt=null;#Pt(t){let n=e.FRAME_INNER_WIDTH;e.#mt===null&&(e.#mt=`${A.blueCore}\u255A${z.pad("\u2550".repeat(n),n,"\u2550")}\u255D${A.reset}`),t.push(e.#mt);try{this.#A(t.join(`
`),{prepend:!0}),t.length=0;return}catch{let i=this.#A??(()=>{});for(let s=0;s<t.length;s++)i(t[s]);t.length=0}}#_t(t,n){let i=q.findPosition(t,"S"),s=q.findPosition(t,"E"),o=q.bfsDistance(q.encodeMaze(t),i,s),a=typeof o=="number"?o:0,r=Math.max(0,n.path.length-1),c="0.0",l="0.0";r>0&&a>0&&(c=(Math.min(1,a/r)*100).toFixed(1),l=(r/a*100-100).toFixed(1));let u=new Set,p=0;for(let[h,m]of n.path){let d=`${h},${m}`;u.has(d)?p++:u.add(d)}return{optimalLength:a,pathLength:r,efficiencyPct:c,overheadPct:l,uniqueCellsVisited:u.size,revisitedCells:p,totalSteps:n.steps,fitnessValue:n.fitness}}#y(t){if(!t)return"n/a";let n=t.layers;if(Array.isArray(n)&&n.length>=2){let s=[];for(let o of n){let a=Array.isArray(o?.nodes)?o.nodes.length:Array.isArray(o)?o.length:0;s.push(a)}return s.join(" - ")}let i=t.nodes;if(Array.isArray(i)){let s=i.filter(h=>h.type==="input"),o=i.filter(h=>h.type==="output"),a=i.filter(h=>h.type==="hidden");if(!a.length)return typeof t.input=="number"&&typeof t.output=="number"?`${t.input} - ${t.output}`:`${s.length} - ${o.length}`;let r=new Set(s),c=a.slice(),l=[],u=a.length*e.#lt,p=0;for(;c.length&&p<u;){p++;let h=c.filter(m=>m.connections?.in?.every(d=>r.has(d.from)));if(!h.length){l.push(c.length);break}l.push(h.length);for(let m of h)r.add(m);c=c.filter(m=>!r.has(m))}return[`${s.length}`,...l.map(h=>`${h}`),`${o.length}`].join(" - ")}return typeof t.input=="number"&&typeof t.output=="number"?`${t.input} - ${t.output}`:"n/a"}update(t,n,i,s,o){if(this.#u==null&&(this.#u=Date.now(),this.#p=globalThis.performance?.now?.()??this.#u),this.#x=globalThis.performance?.now?.()??Date.now(),this.#M=s,this.#e={result:n,network:i,generation:s},n?.success){let r=this.#O(t);if(!this.#t.has(r)){this.#n.push({maze:t,result:n,network:i,generation:s}),this.#t.add(r);let c=this.#n.length;this.#pt({maze:t,result:n,network:i,generation:s},c)}}let a=o?.getTelemetry?.();if(Array.isArray(a)&&a.length){this.#i=q.safeLast(a);let r=this.#e?.result?.fitness;typeof r=="number"&&(this.#s=r,this.#o=q.pushHistory(this.#o,r,e.HISTORY_MAX));let c=this.#i?.complexity;c&&(typeof c.meanNodes=="number"&&(this.#c=q.pushHistory(this.#c,c.meanNodes,e.HISTORY_MAX)),typeof c.meanConns=="number"&&(this.#h=q.pushHistory(this.#h,c.meanConns,e.HISTORY_MAX)));let l=this.#i?.hyper;typeof l=="number"&&(this.#l=q.pushHistory(this.#l,l,e.HISTORY_MAX));let u=this.#e?.result?.progress;typeof u=="number"&&(this.#m=q.pushHistory(this.#m,u,e.HISTORY_MAX));let p=this.#i?.species;typeof p=="number"&&(this.#f=q.pushHistory(this.#f,p,e.HISTORY_MAX))}this.redraw(t,o);try{let r=this.#p!=null&&globalThis.performance?.now?globalThis.performance.now()-this.#p:this.#u?Date.now()-this.#u:0,c=r>0?s/(r/1e3):0,l={type:"asciiMaze:telemetry",generation:s,bestFitness:this.#s,progress:this.#e?.result?.progress??null,speciesCount:this.#f.at(-1)??null,gensPerSec:+c.toFixed(3),timestamp:Date.now(),details:this.#d||null};if(typeof window<"u"){try{window.dispatchEvent(new CustomEvent("asciiMazeTelemetry",{detail:l}))}catch{}try{window.parent&&window.parent!==window&&window.parent.postMessage(l,"*")}catch{}window.asciiMazeLastTelemetry=l}try{this._telemetryHook&&this._telemetryHook(l)}catch{}}catch{}}getLastTelemetry(){let t=this.#p!=null&&typeof performance<"u"?performance.now()-this.#p:this.#u?Date.now()-this.#u:0,n=this.#M??0,i=t>0?n/(t/1e3):0;return{generation:n,bestFitness:this.#s,progress:this.#e?.result?.progress??null,speciesCount:q.safeLast(this.#f)??null,gensPerSec:+i.toFixed(3),timestamp:this.#xt(),details:this.#d||null}}#xt(){return this.#x==null?Date.now():this.#p!=null&&typeof globalThis.performance?.now=="function"&&this.#u!=null?this.#u+(this.#x-this.#p):this.#x}#ft(){let t=e.FRAME_INNER_WIDTH;this.#a(`${A.blueCore}\u2554${z.pad(e.#Y,t,e.#Y)}\u2557${A.reset}`),this.#a(`${A.blueCore}\u255A${z.pad(e.#Ot,t,e.#Y)}\u255D${A.reset}`);let i="\u2551 ASCII maze \u2551".length,s=t-i,o=Math.max(0,Math.ceil(s/2))+1,a=Math.max(0,s-o),r=`\u2551 ${A.neonYellow}ASCII maze${A.blueCore} \u2551`,c=`${A.blueCore}${" ".repeat(o)}${r}${" ".repeat(a)}${A.reset}`;this.#a(c),this.#a(`${A.blueCore}\u2554${z.pad(e.#Rt,t,e.#Y)}\u2557${A.reset}`)}#wt(t){let n=this.#e.generation,i=e.#b;this.#a(`${A.blueCore}\u2560${z.pad(i,e.FRAME_INNER_WIDTH,"\u2550")}${A.blueCore}\u2563${A.reset}`),this.#a(`${A.blueCore}\u2551${z.pad(`${A.orangeNeon}EVOLVING (GEN ${n})`,e.FRAME_INNER_WIDTH," ")}${A.blueCore}\u2551${A.reset}`),this.#a(`${A.blueCore}\u2560${z.pad(i,e.FRAME_INNER_WIDTH,"\u2550")}${A.blueCore}\u2563${A.reset}`),this.#r(),this.#G(),this.#et(t),this.#Mt(t),this.#kt()}#G(){this.#r(),this.#a(z.visualizeNetworkSummary(this.#e.network)),this.#r()}#et(t){let n=this.#e.result.path,i=n?.at(-1)??[0,0],s=Ct.visualizeMaze(t,i,n),o=Array.isArray(s)?s:s.split(`
`),a=e.FRAME_INNER_WIDTH;this.#r();for(let r of o){let c=z.pad(r,a," ");this.#a(`${A.blueCore}\u2551${c}${A.blueCore}\u2551${A.reset}`)}this.#r()}static#nt=[];#Mt(t){this.#r();let n=this.#e;if(!n){this.#r();return}let i=d=>{let f=e.#nt.pop();return f&&f.length>=d?f.subarray(0,d):new Int32Array(d)},s=d=>{e.#nt.length<8&&e.#nt.push(d)},o=i(3),a=n.result?.fitness;o[0]=typeof a=="number"&&Number.isFinite(a)?Math.round(a*100):0;let r=Number(n.result?.steps??0);o[1]=Number.isFinite(r)?r:0;let c=Number(n.result?.progress??0);o[2]=Number.isFinite(c)?Math.round(c*100):0;let l=(o[0]/100).toFixed(2),u=`${o[1]}`,p=`${o[2]}%`,h=e.#P,m=(d,f)=>this.#T(d,f,A.neonSilver,A.cyanNeon,h);this.#a(m("Fitness",l)),this.#a(m("Steps",u)),this.#a(m("Progress",p)),Ct.printMazeStats(n,t,this.#a),s(o),this.#r()}#kt(){let t=()=>this.#a(`${A.blueCore}\u2551${z.pad(" ",e.FRAME_INNER_WIDTH," ")}${A.blueCore}\u2551${A.reset}`);t();let n=this.#e?.result?.progress??0,i=Number(n),s=Number.isFinite(i)?i:0,a=`Progress to exit: ${Ct.displayProgressBar(s)}`;this.#a(`${A.blueCore}\u2551${z.pad(" "+A.neonSilver+a+A.reset,e.FRAME_INNER_WIDTH," ")}${A.blueCore}\u2551${A.reset}`),t()}reset(){this.#n=[],this.#t.clear(),this.#e=null}#B(t){if(!Array.isArray(t)||!t.length)return[];let n=Math.max(0,t.length-e.#C);if(n===0)return t.slice();let i=t.length-n,s=new Array(i);for(let o=0;o<i;o++)s[o]=t[n+o];return s}};$e();pt();lt();Wt();ue();vt();lt();Wt();ue();pt();mt();vt();mt();At();Xt();var pe=class e{static#n=[[0,-1,0],[1,0,1],[0,1,2],[-1,0,3]];static#t=4;static#e=.25;static#i=2;static#s=1e3;static#o=5e3;static#c=.001;static#h=2;static#l=4;static#m=.5;static#f=new Int32Array(e.#t);static#d=new Int32Array(e.#t);static#u=new Float32Array(e.#t);static#p=new Uint8Array(e.#t);static#M=new Float32Array(e.#t);static#x=new Float32Array(e.#t);static#a(){return[0,0,0,0,0,e.#m]}static#w(t,n,i){return Array.isArray(t)&&i>=0&&i<t.length&&Array.isArray(t[i])&&n>=0&&n<t[i].length}static#A(t,n,i){return e.#w(t,n,i)&&t[i][n]!==-1}static#g(t){return(t+e.#i)%e.#t}static buildInputs6(t,n,i,s,o,a,r){if(!Array.isArray(t)||t.length===0)return e.#a();let[c,l]=n;if(!Number.isFinite(c)||!Number.isFinite(l))return e.#a();if(!e.#w(t,c,l))return e.#a();let u=e.#s,p=e.#o,h=0,m=1,d=2,f=3,b=e.#t,g=e.#f,y=e.#d,N=e.#u,S=e.#p,v=e.#M,_=e.#n,x=s;N.fill(1/0),S.fill(0),v.fill(0);let w=Number.isFinite(x?.[l]?.[c])?x[l][c]:void 0,I=w!=null&&Number.isFinite(w),C=e.#x;C.fill(NaN);for(let M=0;M<b;M++){let R=_[M],L=R[0],G=R[1],B=R[2],Y=c+L,at=l+G;g[B]=Y,y[B]=at;let ct=t[at];if(!ct||ct[Y]===-1){N[B]=1/0,S[B]=0,v[B]=0,C[B]=NaN;continue}let W=x&&x[at],J=W?W[Y]:void 0;C[B]=Number.isFinite(J)?J:NaN;let X=J!=null&&Number.isFinite(J);if(S[B]=1,X&&I&&J<w){let it=1+J;N[B]=it<=u?it:1/0,v[B]=0}else N[B]=1/0,v[B]=0}let F=1/0;for(let M=0;M<b;M++)S[M]&&Number.isFinite(N[M])&&N[M]<F&&(F=N[M]);if(F<1/0)for(let M=0;M<b;M++)S[M]&&Number.isFinite(N[M])&&(v[M]=N[M]===F?1:F/N[M]);let P=v[h],$=v[m],E=v[d],T=v[f];if(P===0&&$===0&&E===0&&T===0&&r!=null)switch(e.#g(r)){case h:e.#A(t,c,l-1)&&(P=e.#c);break;case m:e.#A(t,c+1,l)&&($=e.#c);break;case d:e.#A(t,c,l+1)&&(E=e.#c);break;case f:e.#A(t,c-1,l)&&(T=e.#c);break}let k=0;if(s){let M=1/0,R=!1;for(let L=0;L<b;L++){let G=C[L];if(Number.isFinite(G)){let B=G+1;B<M&&B<=p&&(M=B,k=L,R=!0)}}if(!R){let L=i[0]-c,G=i[1]-l;k=Math.abs(L)>Math.abs(G)?L>0?1:3:G>0?2:0}}else{let M=i[0]-c,R=i[1]-l;k=Math.abs(M)>Math.abs(R)?M>0?1:3:R>0?2:0}let D=k*e.#e,O=e.#m;if(o!=null&&Number.isFinite(o)&&Number.isFinite(a)){let M=o-a,R=Math.max(-e.#h,Math.min(e.#h,M));O=e.#m+R/e.#l}return[D,P,$,E,T,O]}};var Ut=class e{static#n=3e3;static#t=6;static#e=.5;static#i=10;static#s=2;static#o=.2;static#c=10;static#h=1e3;static#l=10;static#m=.985;static#f=.01;static#d=.01;static#u=.25;static#p=.35;static#M=6;static#x=5;static#a=5;static#w=.5;static#A=10;static#g=12;static#E=6;static#S=3;static#L=4;static#I=5;static#at=10;static#J=10;static#P=.01;static#C=.5;static#z=4;static#X=4;static#rt=8;static#k=12;static#ct=4;static#lt=2;static#D=5;static#ut=.35;static#F=.5;static#ht=.25;static#q=.3;static#V=.05;static#K=5;static#Y=30;static#Ot=5;static#Rt=8;static#b=.05;static#r=.3;static#T=.7;static#v=.02;static#O=.5;static#pt=2;static#Z=.4;static#Lt=.6;static#R=.05;static#Q=.15;static#St=.95;static#tt=.55;static#N=.25;static#vt=.03;static#H=.015;static#$=.05;static#dt=.2;static#Nt=.05;static#mt=.1;static#Pt=40;static#_t=2;static#y=4;static#xt=Math.log(e.#y);static#ft=new Float64Array(4);static#wt=new Float64Array(4);static#G=-1;static#et=1e-6;static#nt=.01;static#Mt=.03;static#kt=1;static#B=.5;static#Yt=1;static#Jt=1.2;static#Xt=80;static#Kt=.01;static#Zt=650;static#Qt=.2;static#te=5;static#ee=150;static#ne=.3;static#ie=.5;static#se=1.3;static#oe=500;static#ae="output";static#yt=[[0,-1],[1,0],[0,1],[-1,0]];static#re=[2,3,0,1];static#Et=null;static#Dt=null;static#it=null;static#gt=null;static#Ft=0;static#$t=0;static#Ht=0;static#ce=0;static#It=new Float64Array(4);static#bt=null;static#_=0;static#W=0;static#st=void 0;static seedDeterministic(t){e.#bt=t>>>0||2654435769}static clearDeterministicSeed(){e.#bt=null}static#Ct(){if(e.#bt==null)return Math.random();let t=e.#bt+=1831565813;return t=Math.imul(t^t>>>15,t|1),t^=t+Math.imul(t^t>>>7,t|61),((t^t>>>14)>>>0)/4294967296}static#le(t,n){return n*e.#Ht+t}static#ue(t,n,i){let s=t*n;if(!this.#Et||s>this.#Ft){let o=e.#Gt(s);this.#Et=new Uint8Array(o),this.#Dt=new Uint16Array(o),this.#Ft=o}else this.#Et.fill(0,0,s),this.#Dt.fill(0,0,s);if(!this.#it||i+1>this.#$t){let o=e.#Gt(i+1);this.#it=new Int32Array(o),this.#gt=new Int32Array(o),this.#$t=o}this.#Ht=t,this.#ce=n}static#Gt(t){let n=1;for(;n<t;)n<<=1;return n}static#Bt(t){let n=e.#it,i=e.#gt,s=new Array(t);for(let o=0;o<t;o++)s[o]=[n[o],i[o]];return s}static#Pe(t){return(t+e.#y/2)%e.#y}static#Wt(t,n){let i=0,s=n+e.#ct;for(let o=n;o<s;o++)i+=t[o];return i}static#he(t,n,i,s){let o=0;switch(!0){case t<e.#A:o=e.#ut;break;case n>e.#g:o=e.#F;break;case n>e.#E:o=e.#ht;break;case s>e.#S:o=e.#q;break;default:break}return i<=e.#D&&(o=Math.min(o,e.#V)),o}static#jt(t,n,i){return i>=0&&i<t.length&&n>=0&&n<t[0].length&&t[i][n]!==-1}static#j(t,[n,i],s){return Number.isFinite(s?.[i]?.[n])?s[i][n]:1/0}static isValidMove(t,n,i){if(Array.isArray(n)){let[s,o]=n;return e.#jt(t,s,o)}return e.#jt(t,n,i)}static moveAgent(t,n,i){if(i===e.#G)return[n[0],n[1]];let s=[n[0],n[1]];if(i>=0&&i<e.#y){let[o,a]=e.#yt[i];s[0]+=o,s[1]+=a}return e.isValidMove(t,s)?s:[n[0],n[1]]}static selectDirection(t){if(!t||t.length!==e.#y)return{direction:e.#G,softmax:[0,0,0,0],entropy:0,maxProb:0,secondProb:0};let n=(t[0]+t[1]+t[2]+t[3])/e.#y,i=0;for(let d=0;d<e.#y;d++){let f=t[d]-n;i+=f*f,e.#ft[d]=f}i/=e.#y;let s=Math.sqrt(i);(!Number.isFinite(s)||s<e.#et)&&(s=e.#et);let o=s<e.#nt?e.#kt:s<e.#Mt?e.#B:0,a=e.#Yt+e.#Jt*o,r=-1/0;for(let d=0;d<e.#y;d++){let f=e.#ft[d];f>r&&(r=f)}let c=0;for(let d=0;d<e.#y;d++){let f=Math.exp((e.#ft[d]-r)/a);e.#wt[d]=f,c+=f}c||(c=1);let l=0,u=-1/0,p=0,h=e.#It;for(let d=0;d<e.#y;d++){let f=e.#wt[d]/c;h[d]=f,f>u?(p=u,u=f,l=d):f>p&&(p=f)}let m=0;for(let d=0;d<e.#y;d++){let f=h[d];f>0&&(m+=-f*Math.log(f))}return m/=e.#xt,{direction:l,softmax:Array.from(h),entropy:m,maxProb:u,secondProb:p}}static simulateAgent(t,n,i,s,o,a=e.#n){let r=e.#pe(n,i,o,a);for(;r.steps<a&&(r.steps++,e.#me(r,n),e.#Ut(r,n,s,o),e.#fe(r,t,n,o),e.#ye(r,n,o),e.#ge(r,n),e.#be(r,n),e.#Ae(r,n,o),e.#Se(r),!e.#Ie(r));)if(r.position[0]===s[0]&&r.position[1]===s[1])return e.#Ce(r,a);return e.#Te(r,n,i,s,o)}static#pe(t,n,i,s){e.#_=0,e.#W=0,e.#st=void 0;let o=t.length,a=t[0].length,r=Array.isArray(i)&&i.length===o;e.#ue(a,o,s);let c=[n[0],n[1]];e.#it[0]=c[0],e.#gt[0]=c[1];let l=e.#t;return{position:c,steps:0,pathLength:1,visitedUniqueCount:0,hasDistanceMap:r,distanceMap:i,minDistanceToExit:r?i[c[1]]?.[c[0]]??1/0:e.#j(t,c,i),progressReward:0,newCellExplorationBonus:0,invalidMovePenalty:0,prevAction:e.#G,stepsSinceImprovement:0,lastDistanceGlobal:e.#j(t,c,i),saturatedSteps:0,recentPositions:[],localAreaPenalty:0,directionCounts:[0,0,0,0],moveHistoryRing:new Int32Array(l),moveHistoryLength:0,moveHistoryHead:0,currentCellIndex:0,loopPenalty:0,memoryPenalty:0,revisitPenalty:0,visitsAtCurrent:0,distHere:1/0,vision:[],actionStats:null,direction:e.#G,moved:!1,prevDistance:1/0,earlyTerminate:!1}}static#de(t,n){let{moveHistoryRing:i,moveHistoryHead:s,moveHistoryLength:o}=t,a=i.length;i[s]=n,t.moveHistoryHead=(s+1)%a,o<a&&t.moveHistoryLength++}static#At(t,n){if(n>t.moveHistoryLength)return;let i=t.moveHistoryRing.length,s=(t.moveHistoryHead-n+i)%i;return t.moveHistoryRing[s]}static#me(t,n){let i=e.#Et,s=e.#Dt,o=e.#e,a=e.#le(t.position[0],t.position[1]);t.currentCellIndex=a,i[a]||(i[a]=1,t.visitedUniqueCount++),s[a]++,e.#de(t,a);let r=t.visitsAtCurrent=s[a];if(t.loopPenalty=0,t.moveHistoryLength>=e.#L){let c=e.#At(t,1),l=e.#At(t,2),u=e.#At(t,3),p=e.#At(t,4);c===u&&l!==void 0&&p!==void 0&&l===p&&(t.loopPenalty-=e.#i*o)}if(t.memoryPenalty=0,t.moveHistoryLength>1){for(let c=2;c<=t.moveHistoryLength;c++)if(e.#At(t,c)===a){t.memoryPenalty-=e.#s*o;break}}t.revisitPenalty=0,r>1&&(t.revisitPenalty-=e.#o*(r-1)*o),r>e.#c&&(t.invalidMovePenalty-=e.#h*o,t.earlyTerminate=!0)}static#Ut(t,n,i,s){if(t.earlyTerminate)return;let o=t.hasDistanceMap,r=o?s[t.position[1]]?.[t.position[0]]??void 0:e.#j(n,t.position,s);t.vision=pe.buildInputs6(n,t.position,i,s,e.#st,r,t.prevAction),e.#st=r,t.distHere=o?s[t.position[1]]?.[t.position[0]]??1/0:e.#j(n,t.position,s)}static#fe(t,n,i,s){if(!t.earlyTerminate)try{let o=n.activate(t.vision);n._lastStepOutputs=q.pushHistory(n._lastStepOutputs,[...o],e.#Xt),t.actionStats=e.selectDirection(o),e.#Ee(t,o,n),t.direction=t.actionStats.direction}catch(o){console.error("Error activating network:",o),t.direction=e.#G}}static#ye(t,n,i){if(!t.earlyTerminate&&t.distHere<=e.#lt){let s=t.direction,o=1/0;for(let a=0;a<e.#y;a++){let[r,c]=e.#yt[a],l=t.position[0]+r,u=t.position[1]+c;if(!e.isValidMove(n,l,u))continue;let p=e.#j(n,[l,u],i);p<o&&(o=p,s=a)}s!=null&&(t.direction=s)}}static#ge(t,n){if(t.earlyTerminate)return;let i=e.#he(t.steps,t.stepsSinceImprovement,t.distHere,e.#_);if(e.#Ct()<i)for(let s=0;s<e.#y;s++){let o=Math.floor(e.#Ct()*e.#y);if(o===t.prevAction)continue;let[a,r]=e.#yt[o],c=t.position[0]+a,l=t.position[1]+r;if(e.isValidMove(n,c,l)){t.direction=o;break}}}static#be(t,n){if(!t.earlyTerminate&&(t.direction===e.#G?e.#W++:e.#W=0,e.#W>=e.#K)){for(let i=0;i<e.#y;i++){let s=Math.floor(e.#Ct()*e.#y),[o,a]=e.#yt[s],r=t.position[0]+o,c=t.position[1]+a;if(e.isValidMove(n,r,c)){t.direction=s;break}}e.#W=0}}static#Ae(t,n,i){if(t.earlyTerminate)return;if(t.prevDistance=e.#j(n,t.position,i),t.moved=!1,t.direction>=0&&t.direction<e.#y){let[r,c]=e.#yt[t.direction],l=t.position[0]+r,u=t.position[1]+c;e.isValidMove(n,l,u)&&(t.position[0]=l,t.position[1]=u,t.moved=!0)}let s=e.#e,o=e.#it,a=e.#gt;if(t.moved){o[t.pathLength]=t.position[0],a[t.pathLength]=t.position[1],t.pathLength++,q.pushHistory(t.recentPositions,[t.position[0],t.position[1]],e.#Y),e.#ve(t,s);let r=t.hasDistanceMap?t.distanceMap[t.position[1]]?.[t.position[0]]??1/0:e.#j(n,t.position,t.distanceMap),c=t.prevDistance-r,l=c>0,u=!l&&r>t.prevDistance;e.#Ne(t,c,l,u,s),e.#_e(t,s),t.direction>=0&&t.directionCounts[t.direction]++,t.minDistanceToExit=Math.min(t.minDistanceToExit,r)}else t.invalidMovePenalty-=e.#l*s;e.#xe(t,n,s)}static#Se(t){if(t.earlyTerminate)return;let n=e.#e;e.#ot(t,n),t.moved&&(t.prevAction=t.direction),e.#we(t,n),e.#Me(t,n),t.invalidMovePenalty+=t.loopPenalty+t.memoryPenalty+t.revisitPenalty}static#ve(t,n){if(t.recentPositions.length!==e.#Y)return;let i=1/0,s=-1/0,o=1/0,a=-1/0;for(let[c,l]of t.recentPositions)c<i&&(i=c),c>s&&(s=c),l<o&&(o=l),l>a&&(a=l);s-i+(a-o)<=e.#Ot&&t.stepsSinceImprovement>e.#Rt&&(t.localAreaPenalty-=e.#b*n)}static#Ne(t,n,i,s,o){if(i){let a=t.actionStats?.maxProb??1,r=(e.#r+e.#T*a)*o;t.stepsSinceImprovement>0&&(t.progressReward+=Math.min(t.stepsSinceImprovement*e.#v*o,e.#O*o)),t.progressReward+=r,t.stepsSinceImprovement=0,t.progressReward+=n*e.#pt*(e.#Z+e.#Lt*a)}else if(s){let a=t.actionStats?.maxProb??.5;t.progressReward-=(e.#R+e.#Q*a)*o,t.stepsSinceImprovement++}else t.stepsSinceImprovement++}static#_e(t,n){t.visitsAtCurrent===1?t.newCellExplorationBonus+=e.#ne*n:t.newCellExplorationBonus-=e.#ie*n}static#xe(t,n,i){let s=t.hasDistanceMap?t.distanceMap[t.position[1]]?.[t.position[0]]??1/0:e.#j(n,t.position,t.distanceMap);s<t.lastDistanceGlobal&&(t.stepsSinceImprovement>e.#J&&(t.progressReward+=Math.min((t.stepsSinceImprovement-e.#J)*e.#P*i,e.#C*i)),t.stepsSinceImprovement=0),t.lastDistanceGlobal=s}static#ot(t,n){t.prevAction===t.direction&&t.stepsSinceImprovement>e.#z&&(t.invalidMovePenalty-=e.#$*(t.stepsSinceImprovement-e.#z)*n),t.prevAction>=0&&t.direction>=0&&t.stepsSinceImprovement>0&&t.direction===e.#re[t.prevAction]&&(t.invalidMovePenalty-=e.#dt*n)}static#we(t,n){if(!t.actionStats)return;let{entropy:i,maxProb:s,secondProb:o}=t.actionStats,a=e.#Wt(t.vision,e.#rt)>0||e.#Wt(t.vision,e.#k)>0;switch(!0){case i>e.#St:t.invalidMovePenalty-=e.#vt*n;break;case(a&&i<e.#tt&&s-o>e.#N):t.newCellExplorationBonus+=e.#H*n;break;default:break}}static#Me(t,n){e.#_<e.#I||(t.invalidMovePenalty-=e.#Nt*n,e.#_%e.#at===0&&(t.invalidMovePenalty-=e.#mt*n))}static#Ee(t,n,i){let s=e.#e,o=t.actionStats.maxProb>e.#m&&t.actionStats.secondProb<e.#f,a=n.reduce((p,h)=>p+h,0)/e.#y,r=0;for(let p of n){let h=p-a;r+=h*h}r/=e.#y;let l=Math.sqrt(r)<e.#d,u=e.#_;if(o||l?(u++,t.saturatedSteps++):u>0&&u--,e.#_=u,o&&(t.invalidMovePenalty-=e.#u*s),l&&(t.invalidMovePenalty-=e.#p*s),e.#_>e.#M&&t.steps%e.#x===0)try{let p=i.nodes?.filter(h=>h.type===e.#ae);if(p?.length){let h=p.reduce((m,d)=>m+d.bias,0)/p.length;for(let m of p)m.bias=Math.max(-e.#a,Math.min(e.#a,m.bias-h*e.#w))}}catch{}}static#Ie(t){if(t.stepsSinceImprovement>e.#Pt){let n=e.#e;try{if(typeof window>"u")return t.invalidMovePenalty-=e.#_t*n,!0}catch{return t.invalidMovePenalty-=e.#_t*n,!0}}return t.earlyTerminate}static#zt(t){let n=t.reduce((s,o)=>s+o,0)||1,i=0;for(let s of t){if(!s)continue;let o=s/n;i-=o*Math.log(o)}return i/e.#xt}static#Ce(t,n){let i=n-t.steps,s=e.#zt(t.directionCounts),o=e.#Zt+i*e.#Qt+t.progressReward+t.newCellExplorationBonus+t.invalidMovePenalty+s*e.#te,a=e.#Bt(t.pathLength);return{success:!0,steps:t.steps,path:a,fitness:Math.max(e.#ee,o),progress:100,saturationFraction:t.steps?t.saturatedSteps/t.steps:0,actionEntropy:s}}static#Te(t,n,i,s,o){let a=e.#it,r=e.#gt,c=[a[t.pathLength-1]??0,r[t.pathLength-1]??0],l=o?q.calculateProgressFromDistanceMap(o,c,i):q.calculateProgress(n,c,i,s),u=l/100,p=Math.pow(u,e.#se)*e.#oe,h=t.visitedUniqueCount*1,m=e.#zt(t.directionCounts),d=m*e.#X,y=p+h+t.progressReward+t.newCellExplorationBonus+t.invalidMovePenalty+d+t.localAreaPenalty+0+0+e.#Ct()*e.#Kt,N=y>=0?y:-Math.log1p(1-y),S=e.#Bt(t.pathLength);return{success:!1,steps:t.steps,path:S,fitness:N,progress:l,saturationFraction:t.steps?t.saturatedSteps/t.steps:0,actionEntropy:m}}};var de=class e{static#n=200;static#t=1.5;static#e=.5;static#i=5e3;static#s=8e3;static#o=80;static#c=new Uint16Array(0);static#h=0;static#l=0;static#m(t,n){if(!(t<=0||n<=0)){if(t===this.#h&&n===this.#l){this.#c.fill(0);return}this.#h=t,this.#l=n,this.#c=new Uint16Array(t*n)}}static evaluateNetworkFitness(t,n,i,s,o,a){let r=Ut.simulateAgent(t,n,i,s,o,a),c=0,l=n.length,u=n[0]?.length||0;e.#m(u,l);let p=e.#c,h=e.#h;for(let f=0;f<r.path.length;f++){let[b,g]=r.path[f],y=g*h+b;p[y]++}let m=l+u;for(let f=0;f<r.path.length;f++){let[b,g]=r.path[f],y=g*h+b;if(p[y]!==1)continue;let N=o?o[g]?.[b]??1/0:q.bfsDistance(n,[b,g],s),S=e.#t-e.#e*(N/m);c+=e.#n*S}p.fill(0);let d=r.fitness+c;if(r.success){d+=e.#i;let f=o?o[i[1]]?.[i[0]]??1/0:q.bfsDistance(n,i,s),b=(r.path.length-1)/f*100-100,g=Math.max(0,e.#s-b*e.#o);d+=g}return d}static defaultFitnessEvaluator(t,n){return e.evaluateNetworkFitness(t,n.encodedMaze,n.startPosition,n.exitPosition,n.distanceMap,n.agentSimConfig.maxSteps)}};var me=class e{static#n=new Float64Array(4);static#t=[];static#e=new Float64Array(4);static#i=new Float64Array(4);static#s;static#o=new Float64Array(4);static#c;static#h;static#l=new Int32Array(4);static#m=new Int32Array(0);static#f=.7;static#d=2654435761;static#u=new Int32Array(64);static#p=new Int32Array(64);static#M=[];static#x=[];static#a=new Uint8Array(128);static#w=new Array(64);static#A=new Array(64);static#g=new Array(512);static#E;static#S=new Int32Array(128);static#L=new Array(0);static#I=new Array(0);static#at=new Array(0);static#J={generation:0,bestFitness:0,simplifyMode:!1,plateauCounter:0,timestamp:0,telemetryTail:void 0,top:void 0};static#P=new Uint16Array(0);static#C=4;static#z=1/Math.log(4);static#X=1664525;static#rt=1013904223;static#k=4;static#ct=9;static#lt=1/8388608;static#D=512;static#ut=8192;static#F=!1;static#ht=(()=>{let t=e.#D,n=new Array(t);for(let i=0;i<t;i++)n[i]=new Float32Array(e.#C);return n})();static#q;static#V;static#K=0;static#Y(t){let n=new Array(t);for(let i=0;i<t;i++)n[i]=new Float32Array(e.#C);return n}static#Ot(t){try{if(typeof SharedArrayBuffer>"u"||globalThis?.crossOriginIsolated!==!0||!Number.isInteger(t)||t<=0)return;let n=e.#C,i=t*n,s=Int32Array.BYTES_PER_ELEMENT,o=Float32Array.BYTES_PER_ELEMENT,a=new SharedArrayBuffer(s+i*o);e.#V=new Int32Array(a,0,1),e.#q=new Float32Array(a,s,i),Atomics.store(e.#V,0,0),e.#q.fill(0),e.#F=!0}catch{e.#F=!1,e.#q=void 0,e.#V=void 0}}static#Rt(t){if(!Number.isFinite(t)||t<0)return;let n=128,i=e.#ut,s=e.#D,o=s,a=r=>r<=1?1:1<<Math.ceil(Math.log2(r));if(t>s*3/4&&s<i){let r=Math.min(t*2,i);o=Math.min(a(Math.ceil(r)),i)}else if(t<s/4&&s>n){let r=s;for(;r>n&&t*2<=r/2;)r>>=1;o=Math.max(r,n)}o!==s&&(e.#D=o,e.#K=0,e.#ht=e.#Y(o),e.#F&&e.#Ot(o))}static#b=new Int32Array(64);static#r=new Array(40);static#T=new Array(64);static#v=(Date.now()^2654435769)>>>0;static#O=(()=>{try{return typeof process<"u"&&process?.env?.ASCII_MAZE_PROFILE_DETAILS==="1"}catch{return!1}})();static#pt={telemetry:0,simplify:0,snapshot:0,prune:0};static#Z=new Int32Array(64);static#Lt=63;static#R(){return e.#H()}static#Q(t,n){e.#O&&(e.#pt[t]=(e.#pt[t]||0)+n)}static#St=new Float64Array(e.#k);static#tt=e.#k;static#N(){if(e.#tt>=e.#k){let n=e.#v>>>0;for(let i=0;i<e.#k;i++)n=n*e.#X+e.#rt>>>0,e.#St[i]=(n>>>e.#ct)*e.#lt;e.#v=n>>>0,e.#tt=0}return e.#St[e.#tt++]}static#vt=!1;static#H(){return globalThis.performance?.now?.()??Date.now()}static setDeterministic(t){if(e.#vt=!0,typeof t=="number"&&Number.isFinite(t)){let n=t>>>0||2654435769;e.#v=n>>>0,e.#tt=e.#k}}static clearDeterministic(){e.#vt=!1}static#$=!1;static#dt=!1;static#Nt=!1;static#mt=40;static#Pt=500;static#_t=.2;static#y=.3;static#xt=.1;static#ft=.2;static#wt=20;static#G=10;static#et=.01;static#nt=.001;static#Mt=.2;static#kt=2;static#B=20;static#Yt=1e3;static#Jt=.5;static#Xt=.01;static#Kt=.005;static#Zt=[.3,.8];static#Qt=.5;static#te=.25;static#ee=.5;static#ne=.25;static#ie=.25;static#se=.7;static#oe=.55;static#ae=.25;static#yt=.05;static#re=.01;static#Et=5;static#Dt=.1;static#it=.2;static#gt="[ACTION_ENTROPY]";static#Ft="[OUTPUT_BIAS]";static#$t="[LOGITS]";static#Ht=.92;static#ce=.02;static#It=.7;static#bt=.9;static#_=.6;static#W=.55;static#st=.4;static#Ct=.45;static#le=.001;static#ue=.95;static#Gt=.05;static#Bt=.35;static#Pe=.1;static#Wt=.05;static#he=60;static#jt=8;static#j=.002;static#pe=.1;static#de=4;static#At=.35;static#me=.97;static#Ut=20;static#fe=50;static#ye=6;static#ge=.6;static#be=.8;static#Ae=.4;static#Se=1.5;static#ve=1.3;static#Ne=1.2;static#_e=24;static#xe=(()=>{let t=new Int8Array(9);return t.fill(-1),t[3]=0,t[7]=1,t[5]=2,t[1]=3,t})();static#ot(t,n){if(!Array.isArray(t)||t.length===0)return 0;let i=t,s=n,o=0,a=e.#b;for(let r=0;r<i.length;r++){let c=i[r];if(!(!c||c.type!==s)){if(o>=a.length){let l=1<<Math.ceil(Math.log2(o+1)),u=new Int32Array(l);u.set(a),e.#b=u,a=u}a[o++]=r}}return o}static#we(t){let n=t?.length||0;if(n===0)return{unique:0,pathLen:0,ratio:0};if(n<32){let s=e.#Me(t,n);return{unique:s,pathLen:n,ratio:s/n}}let i=e.#Ee(t,n);return{unique:i,pathLen:n,ratio:i/n}}static#Me(t,n){if(n===0)return 0;let i=e.#Z,s=e.#Lt;i.fill(0);let o=0;for(let a=0;a<n;a++){let r=t[a],c=(r[0]&65535)<<16|r[1]&65535,l=Math.imul(c,e.#d)>>>0,u=c+1|0;for(;;){let p=l&s,h=i[p];if(h===0){i[p]=u,o++;break}if(h===u)break;l=l+1|0}}return o}static#Ee(t,n){let i=n<<1,s=e.#m;if(s.length===0||i>s.length*e.#f){let r=Math.ceil(i/e.#f),c=1<<Math.ceil(Math.log2(r));s=e.#m=new Int32Array(c)}else s.fill(0);let o=s.length-1,a=0;for(let r=0;r<n;r++){let c=t[r],l=(c[0]&65535)<<16|c[1]&65535,u=Math.imul(l,e.#d)>>>0,p=l+1|0;for(;;){let h=u&o,m=s[h];if(m===0){s[h]=p,a++;break}if(m===p)break;u=u+1|0}}return a}static#Ie(t,n=40){let i=Array.isArray(t?.population)?t.population:e.#t,s=i.length|0;if(s===0)return{speciesUniqueCount:0,simpson:0,wStd:0};let o=e.#u,a=e.#p;if(s>o.length){let g=1<<Math.ceil(Math.log2(s));e.#u=new Int32Array(g),e.#p=new Int32Array(g),o=e.#u,a=e.#p}else a.fill(0);let r=0,c=0;for(let g=0;g<s;g++){let y=i[g],N=(y&&y.species!=null?y.species:-1)|0,S=-1;for(let v=0;v<r;v++)if(o[v]===N){S=v;break}S===-1?(o[r]=N,a[r]=1,r++):a[S]++,c++}c===0&&(c=1);let l=0;for(let g=0;g<r;g++){let y=a[g]/c;l+=y*y}let u=1-l,p=n>0?Math.min(s,n|0):0,h=p?e.#Pn(i,p):0,m=0,d=0,f=0;for(let g=0;g<h;g++){let N=e.#r[g]?.connections??e.#t;for(let S=0;S<N.length;S++){let v=N[S];if(v&&v.enabled!==!1){let _=Number.isFinite(v.weight)?v.weight:0;f++;let x=_-m;m+=x/f,d+=x*(_-m)}}}let b=f?Math.sqrt(d/f):0;return{speciesUniqueCount:r,simpson:u,wStd:b}}static#zt(t,n){if(!Array.isArray(t)||n<=0)return[];let i=Math.floor(n),s=t.length|0;if(s===0||i===0)return[];if(i>e.#A.length){let a=1<<Math.ceil(Math.log2(i));e.#A=new Array(a)}let o=e.#A;for(let a=0;a<i;a++)o[a]=t[e.#N()*s|0];return o.length=i,o}static#Ce(t,n,i){if(!t||!Array.isArray(t.population)||t.population.length===0)return;let s=t.population,o=Number.isFinite(i)?Math.max(0,Math.min(1,i)):0;if(o!==0)for(let a=0;a<s.length;a++){let r=s[a];try{if(!r||!Array.isArray(r.connections))continue;e.#Ze(r,n??"",o)}catch{}}}static#Te(t){try{if(!t)return;let n=t.nodes??e.#t,i=t.connections??e.#t,s=e.#ot(n,"output"),o=e.#ot(n,"input"),a=e.#ae,r=e.#oe;for(let u=0;u<4;u++){let p=u+1<o?e.#b[u+1]:-1,h=u<s?e.#b[u]:-1,m=p===-1?void 0:n[p],d=h===-1?void 0:n[h];if(!m||!d)continue;let f;for(let g=0,y=i.length;g<y;g++){let N=i[g];if(N.from===m&&N.to===d){f=N;break}}let b=e.#N()*a+r;f?f.weight=b:t.connect(m,d,b)}let c=o>0?e.#b[0]:-1,l=c===-1?void 0:n[c];if(!l)return;for(let u=0;u<s;u++){let p=n[e.#b[u]];if(!p)continue;let h;for(let d=0,f=i.length;d<f;d++){let b=i[d];if(b.from===l&&b.to===p){h=b;break}}let m=e.#yt+u*e.#re;h?h.weight=m:t.connect(l,p,m)}}catch{}}static#$e(t,n,i){let s=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,o=Number.isFinite(n)?Math.max(0,Math.floor(n)):0,a=Number.isFinite(i)?Math.max(0,Math.floor(i)):0;if(s<o)return 0;try{if(typeof window<"u")return 0}catch{}return a}static#He(t,n,i,s){let o=Number.isFinite(n)?Math.max(0,Math.floor(n)):0;if(o===0||!t||!Array.isArray(t.population)||t.population.length===0)return 0;try{if(typeof window<"u")return o}catch{}let a=e.#O,r=a?e.#R():0;if(e.#Ce(t,i,s),a){let c=e.#R()-r||0;e.#Q("simplify",c)}return Math.max(0,o-1)}static#Ge(t,n,i,s,o,a,r){if(!t||!Array.isArray(t.population)||t.population.length===0||!Array.isArray(n)||n.length===0||!Number.isFinite(i)||i<=0)return 0;let c=a?e.#H():0,l=s&&s>0&&s<n.length?e.#zt(n,s):n,u=0,p=0,h=t.population;for(let m of h)if(m)try{m.train(l,{iterations:i,error:e.#et,rate:e.#nt,momentum:e.#Mt,batchSize:e.#kt,allowRecurrent:!0,cost:et.Cost.softmaxCrossEntropy}),e.#wn(m);try{let f=m.getTrainingStats?.()?.gradNorm;Number.isFinite(f)&&(u+=f,p++)}catch{}}catch{}if(p>0){let m=u/p;o(`[GRAD] gen=${r} meanGradNorm=${m.toFixed(4)} samples=${p}
`)}return a?e.#H()-c:0}static#Be(t,n,i,s,o){if(e.#dt)return;let a=e.#O,r=a?e.#R():0;try{e.#We(i,s,o),e.#je(n,s,o),e.#Ue(t,n,s,o),e.#ze(i,s,o),e.#qe(t,s,o)}catch{}a&&e.#Q("telemetry",e.#R()-r||0)}static#We(t,n,i){if(typeof i!="function")return;let s=t?.path;try{let o=e.#sn(s),a=e.#gt,r=Number.isFinite(o?.entropyNorm)?o.entropyNorm.toFixed(3):"0.000",c=Number.isFinite(o?.uniqueMoves)?String(o.uniqueMoves):"0",l=Number.isFinite(o?.pathLen)?String(o.pathLen):"0";i(`${a} gen=${n} entropyNorm=${r} uniqueMoves=${c} pathLen=${l}
`)}catch{}}static#je(t,n,i){if(typeof i!="function")return;let s=t?.nodes??[];try{let o=e.#ot(s,"output");if(o<=0)return;let a=e.#hn(s,o),r=e.#Ft,c=Number.isFinite(a?.mean)?a.mean.toFixed(3):"0.000",l=Number.isFinite(a?.std)?a.std.toFixed(3):"0.000",u=String(a?.biasesStr??"");i(`${r} gen=${n} mean=${c} std=${l} biases=${u}
`)}catch{}}static#Ue(t,n,i,s){if(typeof s=="function")try{let o=n?._lastStepOutputs??e.#t;if(!o.length)return;let a=e.#Le(o,e.#mt),r=e.#on(a);s(`${e.#$t} gen=${i} means=${r.meansStr} stds=${r.stdsStr} kurt=${r.kurtStr} entMean=${Number.isFinite(r.entMean)?r.entMean.toFixed(3):"0.000"} stability=${Number.isFinite(r.stability)?r.stability.toFixed(3):"0.000"} steps=${a.length}
`),e._collapseStreak=e._collapseStreak||0;let c=r.stds||[],l=!0;for(let p=0;p<c.length;p++)if(!(c[p]<e.#Kt)){l=!1;break}l&&(r.entMean<e.#At||r.stability>e.#me)?e._collapseStreak++:e._collapseStreak=0,e._collapseStreak===e.#ye&&e.#Wn(t,i,s)}catch{}}static#ze(t,n,i){if(typeof i!="function")return;let s=t?.path,o=t?.progress,a=t?.saturationFraction;try{let r=e.#we(s),c="[EXPLORE]",l=Number.isFinite(r?.unique)?String(r.unique):"0",u=Number.isFinite(r?.pathLen)?String(r.pathLen):"0",p=Number.isFinite(r?.ratio)?r.ratio.toFixed(3):"0.000",h=Number.isFinite(o)?o.toFixed(1):"0.0",m=Number.isFinite(a)?a.toFixed(3):"0.000";i(`${c} gen=${n} unique=${l} pathLen=${u} ratio=${p} progress=${h} satFrac=${m}
`)}catch{}}static#qe(t,n,i){if(typeof i=="function"&&!(!t||!Array.isArray(t.population)))try{let s=e.#Ie(t),o="[DIVERSITY]",a=Number.isFinite(s?.speciesUniqueCount)?String(s.speciesUniqueCount):"0",r=Number.isFinite(s?.simpson)?s.simpson.toFixed(3):"0.000",c=Number.isFinite(s?.wStd)?s.wStd.toFixed(3):"0.000";i(`${o} gen=${n} species=${a} simpson=${r} weightStd=${c}
`)}catch{}}static#Ve(t,n,i,s,o,a,r,c,l,u){if(!(!t||typeof t.writeFileSync!="function"||!n||typeof n.join!="function"||!i||!Number.isFinite(a)||a<=0)&&!(!Number.isFinite(o)||o%a!==0)&&!(!r||!Array.isArray(r.population)||r.population.length===0))try{let p=e.#O?e.#R():0,h=e.#J;h.generation=o,h.bestFitness=c,h.simplifyMode=!!l,h.plateauCounter=Number.isFinite(u)?u:0,h.timestamp=Date.now(),h.telemetryTail=e.#Ye(r,5);let m=r.population??e.#t,d=e.#Fe(m)??e.#t,f=Math.max(0,Math.floor(Number.isFinite(s)?s:0)),b=Math.min(f,d.length),g=e.#at;g.length<b&&(g.length=b);for(let N=0;N<b;N++){let S=g[N]??(g[N]={}),v=m[d[N]];S.idx=d[N],S.score=v?.score,S.nodes=v?.nodes?.length??0,S.connections=v?.connections?.length??0,S.json=typeof v?.toJSON=="function"?v.toJSON():void 0}g.length=b,h.top=g;let y=n.join(i,`snapshot_gen${o}.json`);t.writeFileSync(y,JSON.stringify(h)),e.#O&&e.#Q("snapshot",e.#R()-p||0)}catch{}}static#Ye(t,n=10){if(!t||typeof t.getTelemetry!="function")return;let i=Number.isFinite(n)?Math.max(0,Math.floor(n)):10;try{let s=t.getTelemetry?.();return Array.isArray(s)?e.#Le(s,i):s}catch{return}}static#Je(t){let n=t?.length||0;if(n<2)return 0;let i=0,s=0,o=-1,a=e.#C,r=a===4;for(let c=0;c<n;c++){let l=t[c];if(!l||l.length===0)continue;let u;if(r&&l.length>=4){let p=l[0];u=0;let h=l[1];h>p&&(p=h,u=1);let m=l[2];m>p&&(p=m,u=2),l[3]>p&&(u=3)}else{u=0;let p=l[0];for(let h=1;h<a&&h<l.length;h++){let m=l[h];m>p&&(p=m,u=h)}}o!==-1&&(s++,o===u&&i++),o=u}return s?i/s:0}static#Oe(t,n){if(!t||!t.length)return 0;let i=Math.min(t.length,n.length);if(i<=1)return 0;if(i===4){let c=t[0]||0,l=t[1]||0,u=t[2]||0,p=t[3]||0,h=c;l>h&&(h=l),u>h&&(h=u),p>h&&(h=p);let m=Math.exp(c-h),d=Math.exp(l-h),f=Math.exp(u-h),b=Math.exp(p-h),g=m+d+f+b||1,y=m/g,N=d/g,S=f/g,v=b/g,_=0;return y>0&&(_+=-y*Math.log(y)),N>0&&(_+=-N*Math.log(N)),S>0&&(_+=-S*Math.log(S)),v>0&&(_+=-v*Math.log(v)),_*e.#z}let s=-1/0;for(let c=0;c<i;c++){let l=t[c]||0;l>s&&(s=l)}let o=0;for(let c=0;c<i;c++){let l=Math.exp((t[c]||0)-s);n[c]=l,o+=l}o||(o=1);let a=0;for(let c=0;c<i;c++){let l=n[c]/o;l>0&&(a+=-l*Math.log(l))}let r=Math.log(i);return r>0?a/r:0}static#Re(t,n,i=3){if(!t)return"";let s=t.length>>>0;if(!Number.isFinite(n)||n<=0||s===0)return"";let o=n>s?s:n,a=i;if(Number.isFinite(a)||(a=0),a<0?a=0:a>20&&(a=20),o>e.#T.length){let u=1<<Math.ceil(Math.log2(o));e.#T=new Array(u)}let r=e.#T;for(let u=0;u<o;u++){let p=t[u]??0;r[u]=Number.isFinite(p)?p.toFixed(a):"NaN"}let c=r.length;r.length=o;let l=r.join(",");return r.length=c,l}static#Le(t,n){if(!Array.isArray(t)||t.length===0||!Number.isFinite(n)||n<=0)return[];let i=Math.floor(n),s=i>=t.length?t.length:i;if(s===0)return[];if(s>e.#w.length){let r=1<<Math.ceil(Math.log2(s));e.#w=new Array(r)}let o=e.#w,a=t.length-s;for(let r=0;r<s;r++)o[r]=t[a+r];return o.length=s,o}static#Xe(t,n,i){return q.pushHistory(t,n,i)}static#Ke(t){try{let n=t?.nodes??e.#t,i=n.length|0;if(i===0)return;let s=0;for(let l=0;l<i;l++){let u=n[l];u&&u.type==="output"&&(e.#b[s++]=l)}if(s===0)return;let o=0,a=0;for(let l=0;l<s;l++){let u=e.#b[l],p=Number(n[u].bias)||0,h=l+1,m=p-o;o+=m/h,a+=m*(p-o)}let r=s?Math.sqrt(a/s):0,c=e.#Et;for(let l=0;l<s;l++){let u=e.#b[l],h=(Number(n[u].bias)||0)-o;h>c?h=c:h<-c&&(h=-c),n[u].bias=h}t._outputBiasStats={mean:o,std:r}}catch{}}static#Ze(t,n,i){try{if(!t||!Array.isArray(t.connections))return;let s=Number.isFinite(i)?i:0;if(s<=0)return;let o=t.connections,a=e.#Qe(o),r=a.length;if(r===0)return;let c=s>=1?1:s<0?0:s,l=Math.floor(r*c);if(c>0&&l===0&&(l=1),l<=0)return;a=e.#en(a,n),e.#in(a,Math.min(l,a.length))}catch{}}static#Qe(t){if(!Array.isArray(t)||t.length===0)return[];let n=e.#M;n.length=0;for(let i=0;i<t.length;i++){let s=t[i];s&&s.enabled!==!1&&n.push(s)}return n}static#tn(t,n,i){if(!t||!t.connections||!Array.isArray(n)||n.length===0||!Number.isFinite(i)||i<=0)return[];let s=e.#b.length,o=Math.min(i|0,s,n.length);if(o<=0)return[];let a=e.#x;a.length=0;let r=t.connections.out??e.#t;for(let c=0;c<r.length;c++){let l=r[c];if(!(!l||l.enabled===!1))for(let u=0;u<o;u++){let p=e.#b[u],h=n[p];if(l.to===h){a.push(l);break}}}return a}static#en(t,n){if(!Array.isArray(t)||t.length===0)return t;if(n==="weakRecurrentPreferred"){let i=0;for(let s=0;s<t.length;s++){let o=t[s];if(o&&(o.from===o.to||o.gater)){if(s!==i){let a=t[i];t[i]=t[s],t[s]=a}i++}}return e.#qt(t,0,i),e.#qt(t,i,t.length),t}return e.#qt(t,0,t.length),t}static#qt(t,n,i){if(!Array.isArray(t)||t.length===0)return;let s=t.length,o=Number.isFinite(n)?n|0:0,a=Number.isFinite(i)?i|0:0;if(o<0&&(o=0),a>s&&(a=s),!(a-o<2))for(let r=o+1;r<a;r++){let c=t[r],l=Math.abs(c&&Number.isFinite(c.weight)?c.weight:0),u=r-1;for(;u>=o;){let p=t[u];if(Math.abs(p&&Number.isFinite(p.weight)?p.weight:0)<=l)break;t[u+1]=p,u--}t[u+1]=c}}static#nn=64;static#in(t,n){if(!Array.isArray(t)||!t.length||!Number.isFinite(n)||n<=0)return;let i=t.length;n>=i&&(n=i);let s=e.#a;i>s.length?(e.#a=new Uint8Array(i),s=e.#a):s.fill(0,0,i);let o=0;for(let c=0;c<i;c++){let l=t[c];l&&l.enabled!==!1&&(c!==o&&(t[o]=l),o++)}if(o===0)return;if(n>=o&&(n=o),n>=o>>>1){o<=e.#nn?e.#qt(t,0,o):t.slice(0,o).sort((l,u)=>Math.abs(l?.weight||0)-Math.abs(u?.weight||0)).forEach((l,u)=>{t[u]=l});let c=n;for(let l=0;l<c;l++){let u=t[l];u&&u.enabled!==!1&&(u.enabled=!1)}return}let a=n,r=o;for(;a>0&&r>0;){let c=0,l=Math.abs(t[0]&&Number.isFinite(t[0].weight)?t[0].weight:0);for(let h=1;h<r;h++){let m=t[h],d=Math.abs(m&&Number.isFinite(m.weight)?m.weight:0);d<l&&(l=d,c=h)}let u=t[c];u&&u.enabled!==!1&&(u.enabled=!1);let p=--r;t[c]=t[p],a--}}static#sn(t){if(!Array.isArray(t)||t.length<2)return{entropyNorm:0,uniqueMoves:0,pathLen:t?.length|0};let n=e.#l??new Int32Array(4),i=n.length;for(let h=0;h<i;h++)n[h]=0;let s=0,o=e.#xe;for(let h=1;h<t.length;h++){let m=t[h],d=t[h-1];if(!m||!d)continue;let f=(Number.isFinite(m[0])?m[0]:0)-(Number.isFinite(d[0])?d[0]:0),b=(Number.isFinite(m[1])?m[1]:0)-(Number.isFinite(d[1])?d[1]:0);if(f<-1||f>1||b<-1||b>1)continue;let g=(f+1)*3+(b+1),y=o[g];Number.isFinite(y)&&y>=0&&y<i&&(n[y]=(n[y]|0)+1,s++)}if(s===0)return{entropyNorm:0,uniqueMoves:0,pathLen:t.length};let a=0,r=0,c=1/s,l=e.#z??1/Math.log(4),u=Math.min(4,i);for(let h=0;h<u;h++){let m=n[h];if(m>0){let d=m*c;a+=-d*Math.log(d),r++}}return{entropyNorm:a*l,uniqueMoves:r,pathLen:t.length}}static#on(t){if(!Array.isArray(t)||t.length===0)return{meansStr:"",stdsStr:"",kurtStr:"",entMean:0,stability:0,steps:0,means:e.#e,stds:e.#i};let n=e.#$,i=Math.max(0,e.#C),s=t.length;e.#an(i,n);let o=0;n?(o=e.#rn(t,i),e.#un(i,s)):i===4?(o=e.#cn(t,s),e.#ke(i,s)):(o=e.#ln(t,i),e.#ke(i,s));let a=o/s,r=e.#Je(t),c=e.#Re(e.#e,i,3),l=e.#Re(e.#i,i,3),u=n?"":e.#Re(e.#s,i,2);return{meansStr:c,stdsStr:l,kurtStr:u,entMean:a,stability:r,steps:s,means:e.#e,stds:e.#i}}static#an(t,n){let i=Number.isFinite(t)?Math.max(0,Math.floor(t)):0;if(i===0)return;(!e.#e||e.#e.length<i)&&(e.#e=new Float64Array(i)),(!e.#o||e.#o.length<i)&&(e.#o=new Float64Array(i)),(!e.#i||e.#i.length<i)&&(e.#i=new Float64Array(i));let s=e.#e,o=e.#o,a=e.#i;s.fill(0,0,i),o.fill(0,0,i),a.fill(0,0,i),n||((!e.#c||e.#c.length<i)&&(e.#c=new Float64Array(i)),(!e.#h||e.#h.length<i)&&(e.#h=new Float64Array(i)),(!e.#s||e.#s.length<i)&&(e.#s=new Float64Array(i)),e.#c.fill(0,0,i),e.#h.fill(0,0,i),e.#s.fill(0,0,i))}static#rn(t,n){let i=Array.isArray(t)?t.length:0;if(i===0||n<=0)return 0;let s=e.#e,o=e.#o,a=e.#i,r=0;for(let[l,u]of t.entries()){let p=u??e.#t,h=l+1;for(let m=0;m<n;m++){let d=p[m]??0,f=s[m],b=d-f,g=b/h,y=f+g;s[m]=y;let N=d-y;o[m]+=b*N}r+=e.#Oe(p,e.#n)}let c=1/i;for(let l=0;l<n;l++){let u=o[l]*c;a[l]=u>0?Math.sqrt(u):0}return r}static#cn(t,n){if(!Array.isArray(t)||n===0)return 0;let i=0,s=0,o=0,a=0,r=0,c=0,l=0,u=0,p=0,h=0,m=0,d=0,f=0,b=0,g=0,y=0,N=0,S=e.#n;for(let P=0;P<n;P++){let $=t[P]??e.#t,E=$[0]??0,T=$[1]??0,k=$[2]??0,D=$[3]??0,O=P+1;{let M=E-i,R=M/O,L=R*R,G=M*R*(O-1);f+=G*L*(O*O-3*O+3)+6*L*r-4*R*p,p+=G*R*(O-2)-3*R*r,r+=G,i+=R}{let M=T-s,R=M/O,L=R*R,G=M*R*(O-1);b+=G*L*(O*O-3*O+3)+6*L*c-4*R*h,h+=G*R*(O-2)-3*R*c,c+=G,s+=R}{let M=k-o,R=M/O,L=R*R,G=M*R*(O-1);g+=G*L*(O*O-3*O+3)+6*L*l-4*R*m,m+=G*R*(O-2)-3*R*l,l+=G,o+=R}{let M=D-a,R=M/O,L=R*R,G=M*R*(O-1);y+=G*L*(O*O-3*O+3)+6*L*u-4*R*d,d+=G*R*(O-2)-3*R*u,u+=G,a+=R}N+=e.#Oe($,S)}let v=e.#e;v[0]=i,v[1]=s,v[2]=o,v[3]=a;let _=1/n,x=r*_,w=c*_,I=l*_,C=u*_,F=e.#i;if(F[0]=x>0?Math.sqrt(x):0,F[1]=w>0?Math.sqrt(w):0,F[2]=I>0?Math.sqrt(I):0,F[3]=C>0?Math.sqrt(C):0,!e.#$){let P=e.#s;P[0]=x>1e-18?n*f/(r*r)-3:0,P[1]=w>1e-18?n*b/(c*c)-3:0,P[2]=I>1e-18?n*g/(l*l)-3:0,P[3]=C>1e-18?n*y/(u*u)-3:0}return N}static#ln(t,n){let i=Array.isArray(t)?t.length:0;if(i===0||n<=0)return 0;let s=e.#e??new Float64Array(n),o=e.#o??new Float64Array(n),a=e.#c??(e.#$?void 0:new Float64Array(n)),r=e.#h??(e.#$?void 0:new Float64Array(n)),c=e.#n??new Float64Array(Math.max(4,n)),l=0;for(let u=0;u<i;u++){let p=t[u]??e.#t,h=u+1,m=Math.min(n,s.length);for(let d=0;d<m;d++){let b=(Number.isFinite(p[d])?p[d]:0)-s[d],g=b/h,y=g*g,N=b*g*(h-1);if(!e.#$){let S=o[d],v=a?a[d]:0;r[d]+=N*y*(h*h-3*h+3)+6*y*S-4*g*v,a[d]+=N*g*(h-2)-3*g*S}o[d]+=N,s[d]+=g}l+=e.#Oe(p,c)}return l}static#ke(t,n){let i=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,s=Number.isFinite(n)&&n>0?Math.floor(n):0;if(i===0)return;let o=e.#o??new Float64Array(i),a=e.#h??new Float64Array(i);e.#i||(e.#i=new Float64Array(i));let r=e.#i;e.#s||(e.#s=new Float64Array(i));let c=e.#s,l=s>0?1/s:0,u=1e-18;for(let p=0;p<i;p++){let h=o[p]||0,m=l>0?h*l:0;if(r[p]=m>0?Math.sqrt(m):0,!e.#$){let d=a[p]||0,f=h*h;f>0&&m>u&&s>0?c[p]=s*d/f-3:c[p]=0}}}static#un(t,n){let i=Number.isFinite(t)?Math.max(0,Math.floor(t)):0,s=Number.isFinite(n)&&n>0?Math.floor(n):0;if(i===0)return;let o=e.#o??new Float64Array(i);e.#i||(e.#i=new Float64Array(i));let a=e.#i,r=s>0?1/s:0;for(let c=0;c<i;c++){let l=r>0?o[c]*r:0;a[c]=l>0?Math.sqrt(l):0}}static#hn(t,n){if(!Array.isArray(t)||!Number.isFinite(n)||n<=0)return{mean:0,std:0,biasesStr:""};if(!e.#U||e.#U.length<n){let u=1<<Math.ceil(Math.log2(Math.max(1,n)));e.#U=new Float64Array(u)}let i=e.#U;for(let u=0;u<n;u++){let p=e.#b[u];i[u]=t[p]?.bias??0}let s=0,o=0;for(let u=0;u<n;u++){let p=i[u],h=u+1,m=p-s;s+=m/h,o+=m*(p-s)}let a=n>0?Math.sqrt(o/n):0;if(n>e.#T.length){let u=1<<Math.ceil(Math.log2(Math.max(1,n)));e.#T=new Array(u)}let r=e.#T;for(let u=0;u<n;u++)r[u]=i[u].toFixed(2);let c=r.length;r.length=n;let l=r.join(",");return r.length=c,{mean:s,std:a,biasesStr:l}}static#pn(t,n,i,s){let o=Number.isFinite(n)?Math.max(0,Math.floor(n)):0;if(o<=0)return;let{populationRef:a,sortedIdx:r,parentPoolSize:c}=e.#dn(t,o);if(!Array.isArray(a)||a.length===0||!Number.isFinite(c)||c===0)return;for(let u=0;u<o;u++){let p=Math.floor(e.#N()*c),h=a[r[p]];try{e.#yn(t,h)}catch{}}t.options||(t.options=t.options||{});let l=Array.isArray(t.population)?t.population.length:0;t.options.popsize=l;try{i?.(`[DYNAMIC_POP] Expanded population to ${l} at gen ${s}
`)}catch{}}static#dn(t,n){let i=Array.isArray(t?.population)?t.population:[];if(i.length===0)return{populationRef:i,sortedIdx:[],parentPoolSize:0};let s=e.#Fe(i),o=Math.ceil(s.length*e.#ne),a=Math.max(2,o),r=Math.min(a,s.length);return{populationRef:i,sortedIdx:s,parentPoolSize:r}}static#mn(){return 1+(e.#N()<e.#ee?1:0)}static#fn(t,n,i){let s=e.#An(n),o=s.length|0;if(o===0)return;if(e.#P.length<o){let l=1<<Math.ceil(Math.log2(o));e.#P=new Uint16Array(l)}let a=e.#P;for(let l=0;l<o;l++)a[l]=l;let r=Math.max(0,Math.floor(i||0)),c=Math.min(r,o);if(c!==0){if(c===1){let l=a[0],u=s[l];typeof t?.mutate=="function"&&t.mutate(u);return}if(c===2){let l=a[0],u=a[1];typeof t?.mutate=="function"&&(t.mutate(s[l]),t.mutate(s[u]));return}for(let l=0;l<c;l++){let u=o-l,p=e.#N()*u|0,h=l+p,m=a[l];a[l]=a[h],a[h]=m;let d=a[l],f=s[d];typeof t?.mutate=="function"&&t.mutate(f)}}}static#De(t,n,i){if(!(!t||!n))try{if(typeof t.addGenome=="function"){t.addGenome(n,[i]);return}if(Array.isArray(t.population)||(t.population=[]),typeof t._invalidateGenomeCaches=="function")try{t._invalidateGenomeCaches(n)}catch{}t.population.push(n);return}catch{try{t&&!Array.isArray(t.population)&&(t.population=[]),t?.population?.push(n)}catch{}}}static#yn(t,n){if(!t||!n)return;let i=e.#mn();if(typeof t.spawnFromParent=="function")try{let s=t.spawnFromParent(n,i);if(s){e.#De(t,s,n?._id);return}}catch{}try{let s=typeof n.clone=="function"?n.clone():n;try{e.#fn(s,t,i)}catch{}try{s.score=void 0}catch{}e.#De(t,s,n?._id)}catch{}}static#Fe(t){let n=t.length|0;if(n===0)return[];let i=!1,s=e.#E;if(s&&s.length>=n)i=!0;else if(!s&&n>512){let c=1<<Math.ceil(Math.log2(n));e.#E=new Int32Array(c),i=!0}if(e.#g.length<n){let c=1<<Math.ceil(Math.log2(n));e.#g=new Array(c)}let o=i?e.#E:e.#g;for(let c=0;c<n;c++)o[c]=c;i||(e.#g.length=n);let a=e.#S;a.length<2&&(a=e.#S=new Int32Array(128));let r=0;for(a[r++]=0,a[r++]=n-1;r>0;){let c=a[--r],l=a[--r];if(l>=c)continue;if(c-l<=e.#_e){e.#gn(o,l,c,t);continue}let u=l,p=c,h=e.#bn(o,l,c,t);for(;u<=p;){for(;;){let f=o[u];if((t[f]?.score??-1/0)<=h)break;u++}for(;;){let f=o[p];if((t[f]?.score??-1/0)>=h)break;p--}if(u<=p){let f=o[u];o[u]=o[p],o[p]=f,u++,p--}}let m=p-l,d=c-u;m>d?(l<p&&(r=e.#Vt(r,l,p),a=e.#S),u<c&&(r=e.#Vt(r,u,c),a=e.#S)):(u<c&&(r=e.#Vt(r,u,c),a=e.#S),l<p&&(r=e.#Vt(r,l,p),a=e.#S))}if(i){e.#g.length<n&&(e.#g=new Array(1<<Math.ceil(Math.log2(n))));let c=e.#g,l=e.#E;for(let u=0;u<n;u++)c[u]=l[u];return c.length=n,c}return e.#g.length=n,e.#g}static#gn(t,n,i,s){if(!t||n>=i)return;let o=s??e.#t,a=r=>o[r]?.score??Number.NEGATIVE_INFINITY;for(let r=n+1;r<=i;r++){let c=t[r],l=a(c),u=r-1;for(;u>=n&&a(t[u])<l;)t[u+1]=t[u],u--;t[u+1]=c}}static#bn(t,n,i,s){let o=n+i>>1,a=t[n],r=t[o],c=t[i],l=s??e.#t,u=l[a]?.score??Number.NEGATIVE_INFINITY,p=l[r]?.score??Number.NEGATIVE_INFINITY,h=l[c]?.score??Number.NEGATIVE_INFINITY;if(u>p){let m=u;u=p,p=m}if(p>h){let m=p;if(p=h,h=m,u>p){let d=u;u=p,p=d}}return p}static#Vt(t,n,i){let s=e.#S,o=t+2;if(o>s.length){let a=Math.max(s.length<<1,4);for(;a<o;)a<<=1;let r=new Int32Array(a);r.set(s),e.#S=s=r}return s[t++]=n|0,s[t++]=i|0,t}static#Tt=null;static#U=new Float64Array(0);static#An(t){try{if(!t)return e.#t;let n=t?.options?.mutation;if(n&&e.#Tt!==n)if(Array.isArray(n))e.#Tt=n;else if(n&&typeof n=="object"){let i=n.length;Number.isFinite(i)&&i>=0?e.#Tt=n:e.#Tt=Object.values(n)}else e.#Tt=e.#t;return e.#Tt??e.#t}catch{return e.#t}}static#Sn(t){try{if(!t)return;let n=Array.isArray(t.population)?t.population:e.#t;for(let i=0;i<n.length;i++){let s=n[i];if(!s)continue;let o=Array.isArray(s.nodes)?s.nodes:e.#t;for(let a=0;a<o.length;a++){let r=o[a];r&&r.type==="output"&&(r.squash=et.Activation.identity)}}}catch{}}static#vn(t){try{e._speciesHistory=e._speciesHistory??e.#t;let n=Array.isArray(t?.population)?t.population:e.#t,i=e.#u,s=e.#p;if(n.length>i.length){let u=1<<Math.ceil(Math.log2(n.length||1));e.#u=new Int32Array(u),e.#p=new Int32Array(u),i=e.#u,s=e.#p}let o=0;for(let u=0;u<n.length;u++){let p=n[u];if(!p||p.species==null)continue;let h=p.species|0,m=-1;for(let d=0;d<o;d++)if(i[d]===h){m=d;break}m===-1?(i[o]=h,s[o]=1,o++):s[m]++}let a=o||1;e._speciesHistory=e.#Xe(e._speciesHistory,a,e.#fe);let r=e._speciesHistory??e.#t,c=e.#Le(r,e.#Ut),l=c.length===e.#Ut&&c.every(u=>u===1);if(l){let u=t;typeof u.mutationRate=="number"&&(u.mutationRate=Math.min(e.#ge,u.mutationRate*e.#Se)),typeof u.mutationAmount=="number"&&(u.mutationAmount=Math.min(e.#be,u.mutationAmount*e.#ve)),u.config&&u.config.novelty&&(u.config.novelty.blendFactor=Math.min(e.#Ae,u.config.novelty.blendFactor*e.#Ne))}return l}catch{return!1}}static#Nn(t,n,i,s,o,a,r,c,l,u){try{if(!n||i<=0)return;let p=Array.isArray(t?.population)?t.population:e.#t,h=Number.isFinite(s)?Math.max(0,s|0):0;if(p.length>=h)return;let m=Number.isFinite(o)&&o>0?o|0:0,d=m>0?Math.min(1,(a|0)/m):0,f=Number.isFinite(r)&&r>0?Math.max(1,r|0):0;if(f===0||!((i|0)%f===0))return;let g=Number.isFinite(l)?l:0;if(d<g)return;let y=p.length|0,N=Number.isFinite(c)?Math.max(0,c):0,S=Math.floor(Math.max(1,y*N)),v=Math.max(0,h-y),_=Math.min(S,v);_>0&&e.#pn(t,_,u,i|0)}catch{}}static async#_n(t,n,i,s,o,a,r){let c=a,l=r;if(c?.update&&typeof c.update=="function")try{c.update(t,n,i,s,o)}catch{}if(typeof l=="function")try{await l()}catch{}}static async#xn(t,n,i,s,o,a,r){let c=a,l=c?.update,u=r;if(!(typeof l!="function"||!i||!n)){try{l.call(c,t,n,i,s,o)}catch{}if(typeof u=="function")try{await u()}catch{}}}static#wn(t){try{if(!t)return;let n=t.nodes??e.#t,i=e.#ot(n,"output");if(i<=0)return;let s=e.#U;if(s.length<i){let u=s.length||1;for(;u<i;)u<<=1;s=e.#U=new Float64Array(u)}let o=0,a=0;for(let u=0;u<i;u++){let p=e.#b[u],h=n[p]?.bias??0;s[u]=h;let m=u+1,d=h-o;o+=d/m,a+=d*(h-o)}let r=i>0?Math.sqrt(a/i):0,c=e.#ie,l=e.#se;for(let u=0;u<i;u++){let p=e.#b[u],h=s[u]-o;r<c&&(h*=l),n[p].bias=Math.max(-5,Math.min(5,h))}}catch{}}static#Mn(){let t=[],n=e.#Ht,i=e.#ce,s=[[n,i,i,i],[i,n,i,i],[i,i,n,i],[i,i,i,n]],o=(r,c,l,u,p,h)=>[r,c,l,u,p,h],a=(r,c)=>t.push({input:r,output:s[c]});a(o(0,1,0,0,0,e.#It),0),a(o(.25,0,1,0,0,e.#It),1),a(o(.5,0,0,1,0,e.#It),2),a(o(.75,0,0,0,1,e.#It),3),a(o(0,1,0,0,0,e.#bt),0),a(o(.25,0,1,0,0,e.#bt),1),a(o(0,1,.6,0,0,e.#_),0),a(o(0,1,0,.6,0,e.#_),0),a(o(.25,.6,1,0,0,e.#_),1),a(o(.25,0,1,.6,0,e.#_),1),a(o(.5,0,.6,1,0,e.#_),2),a(o(.5,0,0,1,.6,e.#_),2),a(o(.75,0,0,.6,1,e.#_),3),a(o(.75,.6,0,0,1,e.#_),3),a(o(0,1,.8,.5,.4,e.#W),0),a(o(.25,.7,1,.6,.5,e.#W),1),a(o(.5,.6,.55,1,.65,e.#W),2),a(o(.75,.5,.45,.7,1,e.#W),3),a(o(0,1,.3,0,0,e.#st),0),a(o(.25,.5,1,.4,0,e.#st),1),a(o(.5,0,.3,1,.2,e.#st),2),a(o(.75,0,.5,.4,1,e.#st),3),a(o(0,0,0,e.#le,0,e.#Ct),2);for(let r=0;r<t.length;r++){let c=t[r];for(let l=1;l<=4;l++)c.input[l]===1&&e.#N()<e.#te&&(c.input[l]=e.#ue+e.#N()*e.#Gt);e.#N()<e.#Bt&&(c.input[5]=Math.min(1,Math.max(0,c.input[5]+(e.#N()*e.#Pe-e.#Wt))))}return t}static#En(t,n){if(!t)return;let i=t.population??e.#t;if(!(!Array.isArray(i)||i.length===0))for(let s=0;s<i.length;s++){let o=i[s];try{if(!o||typeof o.train!="function")continue;let a=Math.min(e.#he,e.#jt+Math.floor((n?.length||0)/2));o.train(n,{iterations:a,error:e.#et,rate:e.#j,momentum:e.#pe,batchSize:e.#de,allowRecurrent:!0,cost:et.Cost.softmaxCrossEntropy});try{e.#Te(o)}catch{}try{e.#Ke(o)}catch{}}catch{}}}static#In(){let t=()=>new Promise(o=>globalThis.requestAnimationFrame?globalThis.requestAnimationFrame(()=>o()):setTimeout(()=>o(),0)),n=()=>new Promise(o=>typeof setImmediate=="function"?setImmediate(o):setTimeout(o,0)),i=()=>new Promise(o=>setTimeout(o,0)),s=typeof globalThis.requestAnimationFrame=="function"?t:typeof setImmediate=="function"?n:i;return async()=>{for(;;)if(await s(),!globalThis.asciiMazePaused)return}}static#Cn(t){let n=null,i=null;try{let s=globalThis.require??(typeof zt=="function"?zt:null);if(s)try{n=s("fs"),i=s("path")}catch{}}catch{}if(n&&typeof n.existsSync=="function"&&t)try{n.existsSync(t)||typeof n.mkdirSync=="function"&&n.mkdirSync(t,{recursive:!0})}catch{}return{fs:n,path:i}}static#Tn(t){let n=(()=>{try{return typeof process<"u"&&process&&process.stdout&&typeof process.stdout.write=="function"}catch{return!1}})(),i=(()=>{try{return t&&t.logFunction?t.logFunction.bind(t):null}catch{return null}})();return s=>{if(!(!s&&s!=="")){if(n)try{process.stdout.write(s);return}catch{}if(i)try{i(s);return}catch{}try{typeof console<"u"&&typeof console.log=="function"&&console.log(s.trim())}catch{}}}}static#On(t,n,i,s){let o=s??{},a=Number.isFinite(o.popSize)?o.popSize:e.#Pt,r=Array.isArray(o.mutation)?o.mutation:[et.mutation.ADD_NODE,et.mutation.SUB_NODE,et.mutation.ADD_CONN,et.mutation.SUB_CONN,et.mutation.MOD_BIAS,et.mutation.MOD_ACTIVATION,et.mutation.MOD_CONNECTION,et.mutation.ADD_LSTM_NODE],c=Math.max(1,Math.floor(a*e.#xt)),l=Math.max(1,Math.floor(a*e.#ft)),u=o.allowRecurrent!==!1,p=o.adaptiveMutation??{enabled:!0,strategy:"twoTier"},h=o.multiObjective??{enabled:!0,complexityMetric:"nodes",autoEntropy:!0},m=o.telemetry??{enabled:!0,performance:!0,complexity:!0,hypervolume:!0},d=o.lineageTracking===!0,f=o.novelty??{enabled:!0,blendFactor:.15},b=o.targetSpecies??e.#G,g=o.adaptiveTargetSpecies??{enabled:!0,entropyRange:e.#Zt,speciesRange:[6,14],smooth:e.#Qt};return new $t(t,n,i,{popsize:a,mutation:r,mutationRate:e.#_t,mutationAmount:e.#y,elitism:c,provenance:l,allowRecurrent:u,minHidden:e.#wt,adaptiveMutation:p,multiObjective:h,telemetry:m,lineageTracking:d,novelty:f,targetSpecies:b,adaptiveTargetSpecies:g})}static#Rn(t,n,i,s){if(t)try{if(Array.isArray(n)&&n.length>0){let o=n.length,a=e.#L;(!Array.isArray(a)||a.length<o)&&(a=new Array(o),e.#L=a);for(let r=0;r<o;r++){let c=n[r];try{a[r]=c&&typeof c.clone=="function"?c.clone():c}catch{a[r]=c}}a.length=o,t.population=a}if(i){Array.isArray(t.population)||(t.population=[]);try{t.population[0]=typeof i.clone=="function"?i.clone():i}catch{}}try{t.options=t.options||{},t.options.popsize=Array.isArray(t.population)?t.population.length:s}catch{}}catch{try{t.options=t.options||{},t.options.popsize=Array.isArray(t.population)?t.population.length:s}catch{}}}static#Ln(t,n){try{let i=t?.cancellation;if(i&&typeof i.isCancelled=="function"&&i.isCancelled())return n&&(n.exitReason="cancelled"),"cancelled";if(t?.signal?.aborted)return n&&(n.exitReason="aborted"),"aborted"}catch{}}static#Pn(t,n){if(!Array.isArray(t)||n<=0)return 0;let i=Math.floor(n),s=t.length|0;if(s===0)return 0;let o=e.#r;if(Array.isArray(o)||(o=e.#r=[]),o.length<i){let u=o.length>0?o.length:1;for(;u<i;)u<<=1;let p=new Array(u);for(let h=0;h<o.length;h++)p[h]=o[h];e.#r=p,o=p}let a=Math.min(i,o.length),r=0,c=e.#N,l=a&-4;for(;r<l;)o[r++]=t[c()*s|0],o[r++]=t[c()*s|0],o[r++]=t[c()*s|0],o[r++]=t[c()*s|0];for(;r<a;)o[r++]=t[c()*s|0];return a}static#kn(t,n,i){if(!Array.isArray(t)||i<=0)return 0;let s=t.length|0,o=Math.max(0,n|0);if(o>=s)return 0;let a=s-o;if(a<=0)return 0;let r=Math.max(0,Math.floor(i));if(r===0)return 0;let c=Array.isArray(e.#r)?e.#r:e.#r=[];if(c.length<r){let d=c.length>0?c.length:1;for(;d<r;)d<<=1;let f=new Array(d);for(let b=0;b<c.length;b++)f[b]=c[b];e.#r=f,c=f}let l=Math.min(r,c.length),u=e.#N,p=o,h=l&-4,m=0;for(;m<h;)c[m++]=t[p+(u()*a|0)],c[m++]=t[p+(u()*a|0)],c[m++]=t[p+(u()*a|0)],c[m++]=t[p+(u()*a|0)];for(;m<l;)c[m++]=t[p+(u()*a|0)];return l}static async#Dn(t,n,i,s,o,a,r,c,l,u,p,h,m,d){let f=!!n,b=()=>e.#H(),g=f?b():0,y=null,N=0,S=0;try{y=await t?.evolve(),f&&(N=b()-g)}catch(v){try{a?.(`#runGeneration: evolve() threw: ${String(v)}`)}catch{}}try{e.#Sn(t)}catch(v){try{a?.(`#runGeneration: ensureOutputIdentity failed: ${String(v)}`)}catch{}}try{e.#vn(t)}catch(v){try{a?.(`#runGeneration: handleSpeciesHistory failed: ${String(v)}`)}catch{}}try{e.#Nn(t,!!c,r,l,u,p,h,m,d,a)}catch(v){try{a?.(`#runGeneration: maybeExpandPopulation failed: ${String(v)}`)}catch{}}try{Number.isFinite(i)&&i>0&&Array.isArray(s)&&s.length>0&&(S=e.#Ge(t,s,i,o,a,n,r))}catch(v){try{a?.(`#runGeneration: applyLamarckianTraining failed: ${String(v)}`)}catch{}}return{fittest:y,tEvolve:N,tLamarck:S}}static#Fn(t,n,i,s){if(!Number.isFinite(t))return{plateauCounter:i,lastBestFitnessForPlateau:n};let o=Number.isFinite(n)?n:-1/0,a=Number.isFinite(s)&&s>0?s:0,r=Number.isFinite(i)&&i>=0?Math.floor(i):0;return t>o+a?(n=t,r=0,{plateauCounter:r,lastBestFitnessForPlateau:n}):(r=Math.min(536870911,r+1),{plateauCounter:r,lastBestFitnessForPlateau:o})}static#$n(t,n,i,s,o,a,r,c){let l=Number.isFinite(n)&&n>=0?Math.floor(n):0,u=Number.isFinite(i)&&i>0?Math.floor(i):0,p=Number.isFinite(s)&&s>0?Math.floor(s):0,h=Number.isFinite(a)&&a>0?Math.floor(a):0,m=!!o;if(!m)try{let d=e.#$e(l,u,p);Number.isFinite(d)&&d>0&&(m=!0,h=Math.floor(d),l=0)}catch{}if(m)try{h=e.#He(t,h,r,c),(!Number.isFinite(h)||h<=0)&&(m=!1,h=0)}catch{m=!1,h=0}return{simplifyMode:m,simplifyRemaining:h,plateauCounter:l}}static#Hn(t,n,i,s,o,a,r,c,l,u,p){let h=r?e.#H():0,m=Ut.simulateAgent(t,n,i,s,o,a);try{t._lastStepOutputs||(t._lastStepOutputs=e.#ht)}catch{}try{t._saturationFraction=m?.saturationFraction??0,t._actionEntropy=m?.actionEntropy??0}catch{}try{let f=m?.stepOutputs;if(Array.isArray(f)&&f.length>0){e.#Rt(f.length);let b=e.#F&&e.#q&&e.#V,g=e.#C;if(b){let y=e.#q,N=e.#V,S=e.#D-1;for(let v=0;v<f.length;v++){let _=f[v];if(!Array.isArray(_))continue;let w=(Atomics.load(N,0)&S)*g,I=Math.min(g,_.length);for(let C=0;C<I;C++)y[w+C]=_[C]??0;Atomics.store(N,0,Atomics.load(N,0)+1&2147483647)}}else{let y=e.#D-1;for(let N=0;N<f.length;N++){let S=f[N];if(!Array.isArray(S))continue;let v=e.#K&y,_=e.#ht[v],x=Math.min(g,S.length);for(let w=0;w<x;w++)_[w]=S[w]??0;e.#K=e.#K+1&2147483647}}}}catch{}try{m?.saturationFraction&&m.saturationFraction>e.#Jt&&e.#Bn(t)}catch{}try{!e.#dt&&l>0&&u%l===0&&e.#Be(p,t,m,u,c)}catch{}let d=r?e.#H()-h:0;return{generationResult:m,simTime:d}}static async#Gn(t,n,i,s,o,a,r,c,l,u,p,h,m){let d=!!t,f=!u;if(t?.success&&t.progress>=(c??0)){try{a?.update?.(i,t,n,s,o)}catch{}try{await r?.()}catch{}if(l)try{if(typeof window<"u"){window.asciiMazePaused=!0;try{window.dispatchEvent(new CustomEvent("asciiMazeSolved",{detail:{maze:i,generations:s,progress:t?.progress}}))}catch{}}}catch{}return d&&(t.exitReason="solved"),"solved"}if(f&&isFinite(h)&&p>=h){try{a?.update?.(i,t,n,s,o)}catch{}try{await r?.()}catch{}return d&&(t.exitReason="stagnation"),"stagnation"}if(f&&isFinite(m)&&s>=m)return d&&(t.exitReason="maxGenerations"),"maxGenerations"}static#Bn(t){try{let n=e.#O?e.#R():0,i=t?.nodes??e.#t,s=e.#ot(i,"output"),o=e.#ot(i,"hidden"),a=e.#n,r=e.#b;for(let c=0;c<o;c++){let l=i[Number(e.#b[s+c])];if(!l)continue;let u=e.#tn(l,i,s)||[],p=u.length;if(p<2)continue;let h=p;if(!a||a.length<h){let g=1;for(;g<h;)g<<=1;a=new Float64Array(g),e.#n=a}let m=Math.min(p,a.length);for(let g=0;g<m;g++){let y=u[g];a[g]=Math.abs(y?.weight)||0}let d=0,f=0;for(let g=0;g<m;g++){let y=a[g],N=g+1,S=y-d;d+=S/N,f+=S*(y-d)}let b=m?f/m:0;if(d<.5&&b<e.#Xt){let g=Math.max(1,Math.floor(p/2));for(let y=0;y<p;y++)r[y]=0;for(let y=0;y<g;y++){let N=-1,S=1/0;for(let v=0;v<p;v++){if(r[v])continue;let _=u[v];if(!_||_.enabled===!1){r[v]=1;continue}let x=Math.abs(_.weight)||0;x<S&&(S=x,N=v)}if(N>=0)u[N].enabled=!1,r[N]=1;else break}for(let y=0;y<p;y++)r[y]=0}}e.#O&&e.#Q("prune",e.#R()-n||0)}catch{}}static#Wn(t,n,i){try{let s=t??null;if(!s)return;let o=Number.isFinite(s?.options?.elitism)?Math.max(0,Math.floor(s.options.elitism)):0,a=Array.isArray(s.population)?s.population:e.#t,r=o,c=Math.max(0,a.length-r);if(c===0)return;let u=Math.floor(c*.3)||1,p=e.#r;Array.isArray(p)||(p=e.#r=[]);let h=e.#kn(a,r,u);if(h<=0)return;let m=0,d=0;for(let f=0;f<h;f++){let b=p[f];if(b)try{let{connReset:g,biasReset:y}=e.#jn(b)||{connReset:0,biasReset:0};m+=Number(g)||0,d+=Number(y)||0}catch{}}try{i(`[ANTICOLLAPSE] gen=${n} reinitGenomes=${h} connReset=${m} biasReset=${d}
`)}catch{}}catch{}}static#jn(t){try{let n=Array.isArray(t?.nodes)?t.nodes:[],i=e.#r;Array.isArray(i)||(i=e.#r=[]);let s=n.length;if(i.length<s){let u=Math.max(1,i.length);for(;u<s;)u<<=1;i.length=u}let o=0;for(let u of n)u&&u.type==="output"&&(i[o++]=u);let a=0,r=Number(e.#Dt)||0;for(let u=0;u<o;u++){let p=i[u];p&&(p.bias=e.#N()*(2*r)-r,a++)}let c=0,l=Array.isArray(t?.connections)?t.connections:[];if(l.length>0&&o>0){let u=new Set;for(let h=0;h<o;h++){let m=i[h];m&&u.add(m)}let p=Number(e.#it)||0;for(let h of l)try{u.has(h?.to)&&(h.weight=e.#N()*(2*p)-p,c++)}catch{}}return{connReset:c,biasReset:a}}catch{return{connReset:0,biasReset:0}}}static#Un(t){try{let n=Array.isArray(t?.connections)?t.connections:[],i=n.length;if(i===0)return 0;let s=0;for(let a=0;a<i;a++){let r=n[a];r&&r.enabled!==!1&&(a!==s&&(n[s]=r),s++)}let o=i-s;return o>0&&(n.length=s),o}catch{return 0}}static#zn(t){try{let n=Array.isArray(t?.population)?t.population:[],i=n.length;if(i===0)return 0;let s=e.#r;if(Array.isArray(s)||(s=e.#r=[]),s.length<i){let a=Math.max(1,s.length);for(;a<i;)a<<=1;s.length=a}let o=0;for(let a=0;a<i;a++)try{let r=n[a],c=e.#Un(r)|0;s[a]=c,o+=c}catch{s[a]=0}return o}catch{return 0}}static#qn(t){try{let n=Array.isArray(t?.population)?t.population.length:0;if(!n)return;let i=8,a=(r=>1<<Math.ceil(Math.log2(Math.max(1,r))))(Math.max(8,n));try{let r=e.#g;Array.isArray(r)&&r.length>n*i&&(e.#g=new Array(a))}catch{}try{let r=e.#r;Array.isArray(r)||(r=e.#r=[]),r.length>n*i&&(r.length=a,e.#r=r)}catch{}try{let r=e.#n;if(r instanceof Float64Array&&r.length>n*i){let c=a,l=new Float64Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#n=l}}catch{}try{let r=e.#U;if(r instanceof Float64Array&&r.length>n*i){let c=a,l=new Float64Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#U=l}}catch{}try{let r=e.#b;if(r instanceof Int32Array&&r.length>n*i){let c=a,l=new Int32Array(c);l.set(r.subarray(0,Math.min(r.length,c))),e.#b=l}}catch{}}catch{}}static async runMazeEvolution(t){let n=e.#Zn(t),{encodedMaze:i,startPosition:s,exitPosition:o,distanceMap:a,inputSize:r,outputSize:c,fitnessContext:l}=e.#Qn(n),u=e.#Yn(n,r,c,l);e.#ti(n.popSize,r,c);let p=e.#Mn();e.#Jn(u,p);let h=e.#Xn(n),m=typeof process<"u"&&typeof process.env<"u"&&process.env.ASCII_MAZE_PROFILE==="1",d=await e.#Kn(u,n,p,i,s,o,a,h,m),{bestNetwork:f,bestResult:b,completedGenerations:g,totalEvolveMs:y,totalLamarckMs:N,totalSimMs:S}=d;return m&&g>0&&e.#Vn(h.safeWrite,g,y,N,S),{bestNetwork:f,bestResult:b,neat:u,exitReason:b?.exitReason??"incomplete"}}static#Vn(t,n,i,s,o){try{let a=Number.isFinite(n)&&n>0?Math.floor(n):0;if(a===0)return;let r=e._PROFILE_SCRATCH_TA??(e._PROFILE_SCRATCH_TA=new Float64Array(4));r[0]=Number.isFinite(i)?i:0,r[1]=Number.isFinite(s)?s:0,r[2]=Number.isFinite(o)?o:0,r[0]=r[0]/a,r[1]=r[1]/a,r[2]=r[2]/a,r[3]=r[0]+r[1]+r[2];let c=r[0].toFixed(2),l=r[1].toFixed(2),u=r[2].toFixed(2),p=r[3].toFixed(2);if(t(`
[PROFILE] Generations=${a} avg(ms): evolve=${c} lamarck=${l} sim=${u} totalPerGen=${p}
`),e.#O){let h=e.#pt,m=a||1,d=Number.isFinite(h?.telemetry)?(h.telemetry/m).toFixed(2):"0.00",f=Number.isFinite(h?.simplify)?(h.simplify/m).toFixed(2):"0.00",b=Number.isFinite(h?.snapshot)?(h.snapshot/m).toFixed(2):"0.00",g=Number.isFinite(h?.prune)?(h.prune/m).toFixed(2):"0.00";t(`[PROFILE_DETAIL] avgTelemetry=${d} avgSimplify=${f} avgSnapshot=${b} avgPrune=${g}
`)}}catch{}}static#Yn(t,n,i,s){try{let o=r=>(t.fitnessEvaluator??de.defaultFitnessEvaluator)(r,s),a=e.#On(n,i,o,t.neatOptions);e.#Rn(a,t.initialPopulation??void 0,t.initialBestNetwork??void 0,Number.isFinite(t.popSize)?Math.max(0,Math.floor(t.popSize)):0);try{let r=Number.isFinite(t.popSize)?Math.max(0,Math.floor(t.popSize)):0;if(r>0){let c=e.#r;if(Array.isArray(c)&&c.length<r){let l=c.length||1;for(;l<r;)l<<=1;c.length=l}}}catch{}return a}catch{return null}}static#Jn(t,n){try{if(!(Array.isArray(n)&&n.length>0)||!t)return;let s=Number.isFinite(t?.options?.popSize)?Math.max(0,Math.floor(t.options.popSize)):Math.max(8,n.length),o=r=>1<<Math.ceil(Math.log2(Math.max(1,r))),a=o(Math.max(8,s));try{let r=e._SCRATCH_SAMPLE;Array.isArray(r)||(r=e._SCRATCH_SAMPLE=[]),r.length<a&&(r.length=a)}catch{}try{let r=e._SCRATCH_EXPS;if(!(r instanceof Float64Array)||r.length<16){let c=Math.max(16,o(Math.min(256,s)));r=e._SCRATCH_EXPS=new Float64Array(c)}}catch{}try{e.#En(t,n)}catch{}}catch{}}static#Xn(t){let n=e.#In(),{fs:i,path:s}=e.#Cn(t?.persistDir),o=e.#Tn(t?.reportingConfig?.dashboardManager);try{Array.isArray(e._SCRATCH_SAMPLE)||(e._SCRATCH_SAMPLE=[]),e._PROFILE_SCRATCH_TA instanceof Float64Array||(e._PROFILE_SCRATCH_TA=new Float64Array(4)),e._SCRATCH_EXPS instanceof Float64Array||(e._SCRATCH_EXPS=new Float64Array(64))}catch{}return{flushToFrame:n,fs:i,path:s,safeWrite:o}}static async#Kn(t,n,i,s,o,a,r,c,l){let{flushToFrame:u,fs:p,path:h,safeWrite:m}=c,d=n.initialBestNetwork,f=-1/0,b,g=0,y=0,N=0,S=!1,v=0,_=-1/0,x=0,w=e._PROFILE_SCRATCH_TA??(e._PROFILE_SCRATCH_TA=new Float64Array(4));for(w[0]=0,w[1]=0,w[2]=0;!e.#Ln(n,b);){let $=await e.#Dn(t,l,n.lamarckianIterations,i,n.lamarckianSampleSize,m,y,n.dynamicPopEnabled,n.dynamicPopMax,n.plateauGenerations,N,n.dynamicPopExpandInterval,n.dynamicPopExpandFactor,n.dynamicPopPlateauSlack),E=$.fittest;if(l&&(w[0]+=Number($.tEvolve??0),w[1]+=Number($.tLamarck??0)),!e.#Nt)try{E.train(i,{iterations:e.#Yt,error:e.#et,rate:e.#nt,momentum:e.#Mt,batchSize:e.#B,allowRecurrent:!0})}catch{}let T=E.score??0;y+=1,{plateauCounter:N,lastBestFitnessForPlateau:_}=e.#Fn(T,_,N,n.plateauImprovementThreshold),{simplifyMode:S,simplifyRemaining:v,plateauCounter:N}=e.#$n(t,N,n.plateauGenerations,n.simplifyDuration,S,v,n.simplifyStrategy,n.simplifyPruneFraction);let k=e.#Hn(E,s,o,a,r,n.agentSimConfig?.maxSteps,l,m,n.reportingConfig?.logEvery??10,y,t),D=k.generationResult;if(l&&(w[2]+=Number(k.simTime??0)),T>f){f=T,d=E,b=D,g=0;try{await e.#_n(n.mazeConfig.maze,D,E,y,t,n.reportingConfig?.dashboardManager,u)}catch{}}else if(g+=1,y%(n.reportingConfig?.logEvery??10)===0)try{await e.#xn(n.mazeConfig.maze,b,d,y,t,n.reportingConfig?.dashboardManager,u)}catch{}if(e.#Ve(p,h,n.persistDir,n.persistTopK,y,n.persistEvery,t,f,S,N),await e.#Gn(b,d,n.mazeConfig.maze,y,t,n.reportingConfig?.dashboardManager,u,n.minProgressToPass,n.autoPauseOnSolve,n.stopOnlyOnSolve,g,n.maxStagnantGenerations,n.maxGenerations))break;if(n.memoryCompactionInterval>0&&y-x>=n.memoryCompactionInterval){let M=e.#zn(t);M>0&&(e.#qn(t),m(`[COMPACT] gen=${y} removedDisabledConns=${M}
`)),x=y}if(n.reportingConfig?.paceEveryGeneration)try{await u()}catch{}}let I=Number(w[0]||0),C=Number(w[1]||0),F=Number(w[2]||0);return{bestNetwork:d,bestResult:b,neat:t,completedGenerations:y,totalEvolveMs:I,totalLamarckMs:C,totalSimMs:F}}static#Zn(t){let n=t?.mazeConfig,i=t?.agentSimConfig??{},s=t?.evolutionAlgorithmConfig??{},o=t?.reportingConfig??{},{allowRecurrent:a=!0,popSize:r=500,maxStagnantGenerations:c=500,minProgressToPass:l=95,maxGenerations:u=1/0,randomSeed:p,initialPopulation:h,initialBestNetwork:m,lamarckianIterations:d=10,lamarckianSampleSize:f,plateauGenerations:b=40,plateauImprovementThreshold:g=1e-6,simplifyDuration:y=30,simplifyPruneFraction:N=.05,simplifyStrategy:S="weakWeight",persistEvery:v=25,persistDir:_="./ascii_maze_snapshots",persistTopK:x=3,dynamicPopEnabled:w=!0,dynamicPopMax:I,dynamicPopExpandInterval:C=25,dynamicPopExpandFactor:F=.15,dynamicPopPlateauSlack:P=.6,stopOnlyOnSolve:$=!1,autoPauseOnSolve:E=!0,deterministic:T=!1,memoryCompactionInterval:k=50,telemetryReduceStats:D=!1,telemetryMinimal:O=!1,disableBaldwinianRefinement:M=!1}=s;(T||typeof p=="number")&&e.setDeterministic(typeof p=="number"?p:305419896),e.#$=!!D,e.#dt=!!O,e.#Nt=!!M;let R=typeof I=="number"?I:Math.max(r,120);return{mazeConfig:n,agentSimConfig:i,evolutionAlgorithmConfig:s,reportingConfig:o,fitnessEvaluator:t?.fitnessEvaluator,popSize:r,allowRecurrent:a,maxStagnantGenerations:c,minProgressToPass:l,maxGenerations:u,randomSeed:p,initialPopulation:h,initialBestNetwork:m,lamarckianIterations:d,lamarckianSampleSize:f,plateauGenerations:b,plateauImprovementThreshold:g,simplifyDuration:y,simplifyPruneFraction:N,simplifyStrategy:S,persistEvery:v,persistDir:_,persistTopK:x,dynamicPopEnabled:w,dynamicPopMax:R,dynamicPopExpandInterval:C,dynamicPopExpandFactor:F,dynamicPopPlateauSlack:P,stopOnlyOnSolve:$,autoPauseOnSolve:E,deterministic:T,memoryCompactionInterval:k,telemetryReduceStats:D,telemetryMinimal:O,disableBaldwinianRefinement:M,neatOptions:{popSize:r,allowRecurrent:a,adaptiveMutation:{enabled:!0,strategy:"twoTier"},multiObjective:{enabled:!0,complexityMetric:"nodes",autoEntropy:!0},telemetry:{enabled:!0,performance:!0,complexity:!0,hypervolume:!0},lineageTracking:!0,novelty:{enabled:!0,blendFactor:.15},targetSpecies:10,adaptiveTargetSpecies:{enabled:!0,entropyRange:[.3,.8],speciesRange:[6,14],smooth:.5}},maze:n?.maze}}static#Qn(t){let n=t?.maze??t?.mazeConfig?.maze,i=q.encodeMaze(n),s=q.findPosition(n,"S"),o=q.findPosition(n,"E"),a=q.buildDistanceMap(i,o),r=6,c=4,l={encodedMaze:i,startPosition:s,exitPosition:o,agentSimConfig:t?.agentSimConfig??{},distanceMap:a};try{let u=e;Array.isArray(u._SCRATCH_SAMPLE)||(u._SCRATCH_SAMPLE=new Array(32)),u._PROFILE_SCRATCH_TA||(u._PROFILE_SCRATCH_TA=new Float64Array(4))}catch{}return{encodedMaze:i,startPosition:s,exitPosition:o,distanceMap:a,inputSize:r,outputSize:c,fitnessContext:l}}static#ti(t,n,i){let s=o=>o<=1?1:2**Math.ceil(Math.log2(o));try{let o=Math.max(32,s(Math.max(1,t))),a=Math.max(1,n+i),r=Math.max(64,s(a));e.#r?e.#r.length<o&&(e.#r.length=o):e.#r=new Array(o);let c=(l,u)=>{if(l&&l.length>=u)return l;let p=Math.max(u,s(u)),h=new Float64Array(p);return l&&l.length>0&&h.set(l.subarray(0,Math.min(l.length,p))),h};e.#n=c(e.#n,r),e.#U=c(e.#U,r),e.#a||(e.#a=new Uint8Array(32)),e._PROFILE_SCRATCH_TA||(e._PROFILE_SCRATCH_TA=new Float64Array(4)),Array.isArray(e._SCRATCH_NODE_BUCKETS)||(e._SCRATCH_NODE_BUCKETS=[[],[],[]]),Array.isArray(e._SCRATCH_ACT_NAMES)||(e._SCRATCH_ACT_NAMES=[])}catch{}}static printNetworkStructure(t){try{console.log("Network Structure:");let{nodeList:n,inputNodes:i,hiddenNodes:s,outputNodes:o}=e.#ei(t);console.log("Nodes:",n.length),console.log("  Input nodes:",i.length),console.log("  Hidden nodes:",s.length),console.log("  Output nodes:",o.length);let a=e.#si(t);console.log("Activation functions:",a);let r=Array.isArray(t?.connections)?t.connections:[];console.log("Connections:",r.length);let c=e.#oi(r);console.log("Has recurrent/gated connections:",c)}catch{console.log("printNetworkStructure: failed to inspect network (partial data)")}}static#ei(t){let n=e.#ni(t);return e.#ii(n)}static#ni(t){return Array.isArray(t?.nodes)?t.nodes:[]}static#ii(t){let n=Array.isArray(t)?t:[],i=e;i._SCRATCH_NODE_BUCKETS||(i._SCRATCH_NODE_BUCKETS=[[],[],[]]);let s=i._SCRATCH_NODE_BUCKETS,o=s[0],a=s[1],r=s[2];o.length=0,a.length=0,r.length=0;for(let c=0;c<n.length;c++){let l=n[c];if(!l)continue;let u=String(l.type??"hidden");u==="input"?o.push(l):u==="output"?r.push(l):a.push(l)}return{nodeList:n,inputNodes:o,hiddenNodes:a,outputNodes:r}}static#si(t){let n=Array.isArray(t?.nodes)?t.nodes:[],i=n.length;Array.isArray(e.#I)||(e.#I=[]);let s=e.#I,o=a=>{let r=1;for(;r<a;)r<<=1;return r};if(s.length<i){let a=o(Math.max(1,i));s.length=a}for(let a=0;a<i;a++){let c=n[a]?.squash;typeof c=="function"?s[a]=c.name&&c.name.length?c.name:"anonymous":s[a]=String(c??"unknown")}return s.length=i,s}static#oi(t){if(!Array.isArray(t)||t.length===0)return!1;let n=t.length;if(n<128){for(let s=0;s<n;s++){let o=t[s];if(o&&(o.gater||o.from===o.to))return!0}return!1}try{let s=e.#ai(n);if(!s){for(let o=0;o<n;o++){let a=t[o];if(a&&(a.gater||a.from===a.to))return!0}return!1}s.fill(0,0,n);for(let o=0;o<n;o++){let a=t[o];if(a){if(a.gater||a.from===a.to)return!0;s[o]=1}}return!1}catch{for(let s=0;s<n;s++){let o=t[s];if(o&&(o.gater||o.from===o.to))return!0}return!1}}static#ai(t){try{let n=Math.max(0,Math.trunc(Number(t)||0));if(n===0)return new Int8Array(0);let i=e,s=i._SCRATCH_CONN_FLAGS;if(s instanceof Int8Array&&s.length>=n)return s;let o=1;for(;o<n;)o<<=1;let a=new Int8Array(o);if(s instanceof Int8Array&&s.length>0){let r=Math.min(s.length,a.length);a.set(s.subarray(0,r),0)}return i._SCRATCH_CONN_FLAGS=a,a}catch{return null}}};var fe=class e{#n;#t;#e=[];#i=0;#s=0;#o={x:0,y:0,depth:0};static WALL=1;static PATH=0;static START=2;static EXIT=3;constructor(t,n){this.#n=t,this.#t=n,this.#c(),this.#h(),this.#m(),this.#f()}#c(){this.#n=Math.max(5,Math.floor(this.#n)),this.#t=Math.max(5,Math.floor(this.#t)),this.#n%2===0&&(this.#n-=1),this.#t%2===0&&(this.#t-=1)}#h(){this.#e=Array.from({length:this.#t},()=>Array.from({length:this.#n},()=>e.WALL));let t=n=>n%2===0?n-1:n;this.#i=t(Math.floor(this.#n/2)),this.#s=t(Math.floor(this.#t/2)),this.#e[this.#s][this.#i]=e.PATH,this.#o={x:this.#i,y:this.#s,depth:0}}#l(t,n){return t>=0&&n>=0&&t<this.#n&&n<this.#t}#m(){let t=[{x:this.#i,y:this.#s,depth:0}];for(;t.length;){let n=t[t.length-1],i=[{deltaX:0,deltaY:-2},{deltaX:2,deltaY:0},{deltaX:0,deltaY:2},{deltaX:-2,deltaY:0}];for(let r=i.length-1;r>0;r--){let l=Math.random()*(r+1)|0;if(l!==r){let u=i[r];i[r]=i[l],i[l]=u}}let s=[];for(let r of i){let c=n.x+r.deltaX,l=n.y+r.deltaY;this.#l(c,l)&&(c<=0||l<=0||c>=this.#n-1||l>=this.#t-1||this.#e[l][c]===e.WALL&&s.push({nextX:c,nextY:l,wallX:n.x+r.deltaX/2,wallY:n.y+r.deltaY/2}))}if(s.length===0){t.pop();continue}let o=s[0];this.#e[o.wallY][o.wallX]=e.PATH,this.#e[o.nextY][o.nextX]=e.PATH;let a=n.depth+1;t.push({x:o.nextX,y:o.nextY,depth:a}),a>this.#o.depth&&(this.#o={x:o.nextX,y:o.nextY,depth:a})}}#f(){this.#e[this.#s][this.#i]=e.START,this.#u()}#d(){let t=Array.from({length:this.#t},()=>Array.from({length:this.#n},()=>-1)),n=[];n.push({x:this.#i,y:this.#s}),t[this.#s][this.#i]=0;let i=0;for(;i<n.length;){let s=n[i++],o=t[s.y][s.x],a=[{x:s.x,y:s.y-1},{x:s.x+1,y:s.y},{x:s.x,y:s.y+1},{x:s.x-1,y:s.y}];for(let r of a){if(!this.#l(r.x,r.y))continue;let c=this.#e[r.y][r.x];![e.PATH,e.START].includes(c)||t[r.y][r.x]!==-1||(t[r.y][r.x]=o+1,n.push(r))}}return t}#u(){let t=this.#d(),n=[];for(let s=1;s<this.#t-1;s++)for(let o=1;o<this.#n-1;o++)t[s][o]<0||this.#e[s][o]!==e.START&&(s===1&&n.push({interiorX:o,interiorY:s,borderX:o,borderY:0,distance:t[s][o]}),s===this.#t-2&&n.push({interiorX:o,interiorY:s,borderX:o,borderY:this.#t-1,distance:t[s][o]}),o===1&&n.push({interiorX:o,interiorY:s,borderX:0,borderY:s,distance:t[s][o]}),o===this.#n-2&&n.push({interiorX:o,interiorY:s,borderX:this.#n-1,borderY:s,distance:t[s][o]}));if(n.length===0){this.#e[this.#o.y][this.#o.x]=e.EXIT;return}n.sort((s,o)=>o.distance-s.distance);let i=n[0];this.#e[i.interiorY][i.interiorX]===e.EXIT&&(this.#e[i.interiorY][i.interiorX]=e.PATH),this.#e[i.borderY][i.borderX]=e.EXIT}#p(t,n){let i=(l,u)=>this.#l(l,u)&&![e.PATH,e.START,e.EXIT].includes(this.#e[u][l]),s=i(t,n-1),o=i(t+1,n),a=i(t,n+1),r=i(t-1,n);switch((s?1:0)|(o?2:0)|(a?4:0)|(r?8:0)){case 5:case 1:case 4:return"\u2551";case 10:case 2:case 8:return"\u2550";case 3:return"\u255A";case 9:return"\u255D";case 6:return"\u2554";case 12:return"\u2557";case 14:return"\u2566";case 11:return"\u2569";case 7:return"\u2560";case 13:return"\u2563";case 15:return"\u256C";default:return"\u2588"}}#M(){let t=[];for(let n=0;n<this.#t;n++){let i="";for(let s=0;s<this.#n;s++){let o=this.#e[n][s];o===e.PATH?i+=".":o===e.START?i+="S":o===e.EXIT?i+="E":n===0&&s===0?i+="\u2554":n===0&&s===this.#n-1?i+="\u2557":n===this.#t-1&&s===0?i+="\u255A":n===this.#t-1&&s===this.#n-1?i+="\u255D":n===0||n===this.#t-1?i+="\u2550":s===0||s===this.#n-1?i+="\u2551":i+=this.#p(s,n)}t.push(i)}return t}generate(){return this.#M()}};pt();function ds(e){if(!e)return;try{e.nodes.forEach(o=>{typeof o.squash!="function"&&(o.squash=et.Activation.logistic)})}catch{}let t=[],n=o=>[0,1,2,3].map(a=>a===o?.92:.02),i=(o,a)=>t.push({input:o,output:n(a)}),s=[0,.25,.5,.75];for(let o=0;o<4;o++){let a=s[o],r=[0,0,0,0];r[o]=1,i([a,...r,.85],o),i([a,...r,.65],o),i([a,...r,.55],o),i([a,...r,.5],o)}try{e.train(t,{iterations:220,error:.005,rate:.001,momentum:.1,batchSize:8,cost:et.Cost.softmaxCrossEntropy})}catch{}try{return e.clone()}catch{return e}}var ys="ascii-maze-output",ta=8,ea=120,na=20,ms=90,ia=50,sa=100,oa=1,aa=8,fs=40,ra=4,ca=600,la=20;function ua(e){return{agentMaxSteps:ca,popSize:la,maxStagnantGenerations:ia,maxGenerations:sa,lamarckianIterations:4,lamarckianSampleSize:12,mazeFactory:()=>new fe(e,e).generate()}}var nn=class{#n=new Set;add(t){return this.#n.add(t),()=>this.#n.delete(t)}dispatch(t){let n=Array.from(this.#n);for(let i of n)try{i(t)}catch{}}};async function en(e=ys,t={}){let n=typeof e=="string"?document.getElementById(e):e,i=n?n.querySelector("#ascii-maze-archive"):null,s=n?n.querySelector("#ascii-maze-live"):null,o=ee.createTerminalClearer(s??void 0),a=be(s??void 0),r=be(i??void 0),c=new ne(o,a,r),l=new nn;c._telemetryHook=x=>l.dispatch(x);try{let x=n??document.getElementById("ascii-maze-output");if(x&&typeof ResizeObserver<"u"){let w=x.clientWidth;new ResizeObserver(C=>{for(let F of C){let P=F.contentRect.width;if(Math.abs(P-w)>ta){w=P;try{c.redraw?.([],void 0)}catch{}}}}).observe(x)}else if(x){let w,I=()=>{typeof w=="number"&&clearTimeout(w),w=window.setTimeout(()=>{try{c.redraw?.([],void 0)}catch{}},ea)};window.addEventListener("resize",I)}}catch{}let u=!1,p=new AbortController,h=t.signal,d=(x=>{if(x){if(x.aborted)return x;if(typeof AbortSignal.any=="function")try{return AbortSignal.any([x,p.signal])}catch{}try{x.addEventListener("abort",()=>{try{p.abort()}catch{}},{once:!0})}catch{}}return p.signal})(h),f=!0;try{d.addEventListener("abort",()=>{u=!0,f=!1;try{g?.()}catch{}},{once:!0})}catch{}let b=aa,g,y=new Promise(x=>g=x),N,S=x=>{try{typeof requestAnimationFrame=="function"?requestAnimationFrame(x):setTimeout(x,0)}catch{setTimeout(x,0)}},v=async()=>{if(u){f=!1,g?.();return}let x=ua(b),w=x.mazeFactory(),I=!1;try{let C=await me.runMazeEvolution({mazeConfig:{maze:w},agentSimConfig:{maxSteps:x.agentMaxSteps},evolutionAlgorithmConfig:{allowRecurrent:!0,popSize:x.popSize,maxStagnantGenerations:x.maxStagnantGenerations,minProgressToPass:ms,maxGenerations:x.maxGenerations,autoPauseOnSolve:!1,stopOnlyOnSolve:!1,lamarckianIterations:x.lamarckianIterations,lamarckianSampleSize:x.lamarckianSampleSize,initialBestNetwork:N},reportingConfig:{dashboardManager:c,logEvery:oa,label:`browser-procedural-${b}x${b}`,paceEveryGeneration:!0},cancellation:{isCancelled:()=>u},signal:d}),F=C?.bestResult?.progress;try{let P=C?.bestNetwork;P&&(N=ds(P)||P)}catch{}I=typeof F=="number"&&F>=ms;try{console.log("[asciiMaze] maze complete",b,"solved?",I,"progress",F)}catch{}}catch(C){console.error("Error while running procedural maze",b,C)}!u&&I&&b<fs?(b=Math.min(b+ra,fs),S(()=>v())):(f=!1,g?.())};return v(),{stop:()=>{u=!0;try{p.abort()}catch{}f=!1},isRunning:()=>f&&!u&&!d.aborted,done:Promise.resolve(y).catch(()=>{}),onTelemetry:x=>l.add(x),getTelemetry:()=>c.getLastTelemetry?.()}}if(typeof window<"u"&&window.document){let e=window;e.asciiMaze=e.asciiMaze||{},e.asciiMaze.start=en,e.asciiMazeStart||(e.asciiMazeStart=t=>(console.warn("[asciiMaze] window.asciiMazeStart is deprecated; use import { start } ... or window.asciiMaze.start"),en(t))),e.asciiMaze._autoStarted||(e.asciiMaze._autoStarted=!0,setTimeout(()=>{try{document.getElementById(ys)&&en()}catch{}},na))}})();
//# sourceMappingURL=ascii-maze.bundle.js.map
